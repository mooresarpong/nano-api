require=function e(t,r,n){function s(o,a){if(!r[o]){if(!t[o]){var c="function"==typeof require&&require;if(!a&&c)return c(o,!0);if(i)return i(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var h=r[o]={exports:{}};t[o][0].call(h.exports,function(e){var r=t[o][1][e];return s(r||e)},h,h.exports,e,t,r,n)}return r[o].exports}for(var i="function"==typeof require&&require,o=0;o<n.length;o++)s(n[o]);return s}({1:[function(e,t,r){e("../../modules/es6.string.iterator");e("../../modules/es6.array.from");t.exports=e("../../modules/_core").Array.from},{"../../modules/_core":21,"../../modules/es6.array.from":84,"../../modules/es6.string.iterator":96}],2:[function(e,t,r){e("../modules/web.dom.iterable");e("../modules/es6.string.iterator");t.exports=e("../modules/core.get-iterator")},{"../modules/core.get-iterator":83,"../modules/es6.string.iterator":96,"../modules/web.dom.iterable":100}],3:[function(e,t,r){var n=e("../../modules/_core"),s=n.JSON||(n.JSON={stringify:JSON.stringify});t.exports=function stringify(e){return s.stringify.apply(s,arguments)}},{"../../modules/_core":21}],4:[function(e,t,r){e("../../modules/es6.math.clz32");t.exports=e("../../modules/_core").Math.clz32},{"../../modules/_core":21,"../../modules/es6.math.clz32":86}],5:[function(e,t,r){e("../../modules/es6.math.fround");t.exports=e("../../modules/_core").Math.fround},{"../../modules/_core":21,"../../modules/es6.math.fround":87}],6:[function(e,t,r){e("../../modules/es6.math.imul");t.exports=e("../../modules/_core").Math.imul},{"../../modules/_core":21,"../../modules/es6.math.imul":88}],7:[function(e,t,r){e("../../modules/es6.math.trunc");t.exports=e("../../modules/_core").Math.trunc},{"../../modules/_core":21,"../../modules/es6.math.trunc":89}],8:[function(e,t,r){e("../../modules/es6.number.is-integer");t.exports=e("../../modules/_core").Number.isInteger},{"../../modules/_core":21,"../../modules/es6.number.is-integer":90}],9:[function(e,t,r){e("../../modules/es6.number.max-safe-integer");t.exports=9007199254740991},{"../../modules/es6.number.max-safe-integer":91}],10:[function(e,t,r){e("../../modules/es6.object.freeze");t.exports=e("../../modules/_core").Object.freeze},{"../../modules/_core":21,"../../modules/es6.object.freeze":92}],11:[function(e,t,r){e("../../modules/es6.object.keys");t.exports=e("../../modules/_core").Object.keys},{"../../modules/_core":21,"../../modules/es6.object.keys":93}],12:[function(e,t,r){e("../../modules/es7.object.values");t.exports=e("../../modules/_core").Object.values},{"../../modules/_core":21,"../../modules/es7.object.values":97}],13:[function(e,t,r){e("../modules/es6.object.to-string");e("../modules/es6.string.iterator");e("../modules/web.dom.iterable");e("../modules/es6.promise");e("../modules/es7.promise.finally");e("../modules/es7.promise.try");t.exports=e("../modules/_core").Promise},{"../modules/_core":21,"../modules/es6.object.to-string":94,"../modules/es6.promise":95,"../modules/es6.string.iterator":96,"../modules/es7.promise.finally":98,"../modules/es7.promise.try":99,"../modules/web.dom.iterable":100}],14:[function(e,t,r){t.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},{}],15:[function(e,t,r){t.exports=function(){}},{}],16:[function(e,t,r){t.exports=function(e,t,r,n){if(!(e instanceof t)||n!==undefined&&n in e)throw TypeError(r+": incorrect invocation!");return e}},{}],17:[function(e,t,r){var n=e("./_is-object");t.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},{"./_is-object":40}],18:[function(e,t,r){var n=e("./_to-iobject"),s=e("./_to-length"),i=e("./_to-absolute-index");t.exports=function(e){return function(t,r,o){var a,c=n(t),l=s(c.length),h=i(o,l);if(e&&r!=r){for(;l>h;)if((a=c[h++])!=a)return!0}else for(;l>h;h++)if((e||h in c)&&c[h]===r)return e||h||0;return!e&&-1}}},{"./_to-absolute-index":74,"./_to-iobject":76,"./_to-length":77}],19:[function(e,t,r){var n=e("./_cof"),s=e("./_wks")("toStringTag"),i="Arguments"==n(function(){return arguments}());t.exports=function(e){var t,r,o;return e===undefined?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(r){}}(t=Object(e),s))?r:i?n(t):"Object"==(o=n(t))&&"function"==typeof t.callee?"Arguments":o}},{"./_cof":20,"./_wks":81}],20:[function(e,t,r){var n={}.toString;t.exports=function(e){return n.call(e).slice(8,-1)}},{}],21:[function(e,t,r){var n=t.exports={version:"2.5.3"};"number"==typeof __e&&(__e=n)},{}],22:[function(e,t,r){"use strict";var n=e("./_object-dp"),s=e("./_property-desc");t.exports=function(e,t,r){t in e?n.f(e,t,s(0,r)):e[t]=r}},{"./_object-dp":54,"./_property-desc":64}],23:[function(e,t,r){var n=e("./_a-function");t.exports=function(e,t,r){n(e);if(t===undefined)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,s){return e.call(t,r,n,s)}}return function(){return e.apply(t,arguments)}}},{"./_a-function":14}],24:[function(e,t,r){t.exports=function(e){if(e==undefined)throw TypeError("Can't call method on  "+e);return e}},{}],25:[function(e,t,r){t.exports=!e("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},{"./_fails":29}],26:[function(e,t,r){var n=e("./_is-object"),s=e("./_global").document,i=n(s)&&n(s.createElement);t.exports=function(e){return i?s.createElement(e):{}}},{"./_global":31,"./_is-object":40}],27:[function(e,t,r){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},{}],28:[function(e,t,r){var n=e("./_global"),s=e("./_core"),i=e("./_ctx"),o=e("./_hide"),a=function(e,t,r){var c,l,h,u=e&a.F,d=e&a.G,_=e&a.S,f=e&a.P,g=e&a.B,p=e&a.W,y=d?s:s[t]||(s[t]={}),m=y.prototype,C=d?n:_?n[t]:(n[t]||{}).prototype;d&&(r=t);for(c in r)if(!((l=!u&&C&&C[c]!==undefined)&&c in y)){h=l?C[c]:r[c];y[c]=d&&"function"!=typeof C[c]?r[c]:g&&l?i(h,n):p&&C[c]==h?function(e){var t=function(t,r,n){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,n)}return e.apply(this,arguments)};t.prototype=e.prototype;return t}(h):f&&"function"==typeof h?i(Function.call,h):h;if(f){(y.virtual||(y.virtual={}))[c]=h;e&a.R&&m&&!m[c]&&o(m,c,h)}}};a.F=1;a.G=2;a.S=4;a.P=8;a.B=16;a.W=32;a.U=64;a.R=128;t.exports=a},{"./_core":21,"./_ctx":23,"./_global":31,"./_hide":33}],29:[function(e,t,r){t.exports=function(e){try{return!!e()}catch(t){return!0}}},{}],30:[function(e,t,r){var n=e("./_ctx"),s=e("./_iter-call"),i=e("./_is-array-iter"),o=e("./_an-object"),a=e("./_to-length"),c=e("./core.get-iterator-method"),l={},h={};(r=t.exports=function(e,t,r,u,d){var _,f,g,p,y=d?function(){return e}:c(e),m=n(r,u,t?2:1),C=0;if("function"!=typeof y)throw TypeError(e+" is not iterable!");if(i(y)){for(_=a(e.length);_>C;C++)if((p=t?m(o(f=e[C])[0],f[1]):m(e[C]))===l||p===h)return p}else for(g=y.call(e);!(f=g.next()).done;)if((p=s(g,m,f.value,t))===l||p===h)return p}).BREAK=l;r.RETURN=h},{"./_an-object":17,"./_ctx":23,"./_is-array-iter":38,"./_iter-call":41,"./_to-length":77,"./core.get-iterator-method":82}],31:[function(e,t,r){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},{}],32:[function(e,t,r){var n={}.hasOwnProperty;t.exports=function(e,t){return n.call(e,t)}},{}],33:[function(e,t,r){var n=e("./_object-dp"),s=e("./_property-desc");t.exports=e("./_descriptors")?function(e,t,r){return n.f(e,t,s(1,r))}:function(e,t,r){e[t]=r;return e}},{"./_descriptors":25,"./_object-dp":54,"./_property-desc":64}],34:[function(e,t,r){var n=e("./_global").document;t.exports=n&&n.documentElement},{"./_global":31}],35:[function(e,t,r){t.exports=!e("./_descriptors")&&!e("./_fails")(function(){return 7!=Object.defineProperty(e("./_dom-create")("div"),"a",{get:function(){return 7}}).a})},{"./_descriptors":25,"./_dom-create":26,"./_fails":29}],36:[function(e,t,r){t.exports=function(e,t,r){var n=r===undefined;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},{}],37:[function(e,t,r){var n=e("./_cof");t.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==n(e)?e.split(""):Object(e)}},{"./_cof":20}],38:[function(e,t,r){var n=e("./_iterators"),s=e("./_wks")("iterator"),i=Array.prototype;t.exports=function(e){return e!==undefined&&(n.Array===e||i[s]===e)}},{"./_iterators":46,"./_wks":81}],39:[function(e,t,r){var n=e("./_is-object"),s=Math.floor;t.exports=function isInteger(e){return!n(e)&&isFinite(e)&&s(e)===e}},{"./_is-object":40}],40:[function(e,t,r){t.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},{}],41:[function(e,t,r){var n=e("./_an-object");t.exports=function(e,t,r,s){try{return s?t(n(r)[0],r[1]):t(r)}catch(o){var i=e["return"];i!==undefined&&n(i.call(e));throw o}}},{"./_an-object":17}],42:[function(e,t,r){"use strict";var n=e("./_object-create"),s=e("./_property-desc"),i=e("./_set-to-string-tag"),o={};e("./_hide")(o,e("./_wks")("iterator"),function(){return this});t.exports=function(e,t,r){e.prototype=n(o,{next:s(1,r)});i(e,t+" Iterator")}},{"./_hide":33,"./_object-create":53,"./_property-desc":64,"./_set-to-string-tag":68,"./_wks":81}],43:[function(e,t,r){"use strict";var n=e("./_library"),s=e("./_export"),i=e("./_redefine"),o=e("./_hide"),a=e("./_has"),c=e("./_iterators"),l=e("./_iter-create"),h=e("./_set-to-string-tag"),u=e("./_object-gpo"),d=e("./_wks")("iterator"),_=!([].keys&&"next"in[].keys()),f=function(){return this};t.exports=function(e,t,r,g,p,y,m){l(r,t,g);var C,S,A,T=function(e){if(!_&&e in b)return b[e];switch(e){case"keys":return function keys(){return new r(this,e)};case"values":return function values(){return new r(this,e)}}return function entries(){return new r(this,e)}},k=t+" Iterator",w="values"==p,E=!1,b=e.prototype,v=b[d]||b["@@iterator"]||p&&b[p],P=!_&&v||T(p),I=p?w?T("entries"):P:undefined,N="Array"==t&&b.entries||v;if(N&&(A=u(N.call(new e)))!==Object.prototype&&A.next){h(A,k,!0);n||a(A,d)||o(A,d,f)}if(w&&v&&"values"!==v.name){E=!0;P=function values(){return v.call(this)}}n&&!m||!_&&!E&&b[d]||o(b,d,P);c[t]=P;c[k]=f;if(p){C={values:w?P:T("values"),keys:y?P:T("keys"),entries:I};if(m)for(S in C)S in b||i(b,S,C[S]);else s(s.P+s.F*(_||E),t,C)}return C}},{"./_export":28,"./_has":32,"./_hide":33,"./_iter-create":42,"./_iterators":46,"./_library":47,"./_object-gpo":56,"./_redefine":66,"./_set-to-string-tag":68,"./_wks":81}],44:[function(e,t,r){var n=e("./_wks")("iterator"),s=!1;try{var i=[7][n]();i["return"]=function(){s=!0};Array.from(i,function(){throw 2})}catch(o){}t.exports=function(e,t){if(!t&&!s)return!1;var r=!1;try{var i=[7],a=i[n]();a.next=function(){return{done:r=!0}};i[n]=function(){return a};e(i)}catch(o){}return r}},{"./_wks":81}],45:[function(e,t,r){t.exports=function(e,t){return{value:t,done:!!e}}},{}],46:[function(e,t,r){t.exports={}},{}],47:[function(e,t,r){t.exports=!0},{}],48:[function(e,t,r){var n=e("./_math-sign"),s=Math.pow,i=s(2,-52),o=s(2,-23),a=s(2,127)*(2-o),c=s(2,-126);t.exports=Math.fround||function fround(e){var t,r,s=Math.abs(e),l=n(e);return s<c?l*(s/c/o+1/i-1/i)*c*o:(r=(t=(1+o/i)*s)-(t-s))>a||r!=r?l*Infinity:l*r}},{"./_math-sign":49}],49:[function(e,t,r){t.exports=Math.sign||function sign(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},{}],50:[function(e,t,r){var n=e("./_uid")("meta"),s=e("./_is-object"),i=e("./_has"),o=e("./_object-dp").f,a=0,c=Object.isExtensible||function(){return!0},l=!e("./_fails")(function(){return c(Object.preventExtensions({}))}),h=function(e){o(e,n,{value:{i:"O"+ ++a,w:{}}})},u=t.exports={KEY:n,NEED:!1,fastKey:function(e,t){if(!s(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!i(e,n)){if(!c(e))return"F";if(!t)return"E";h(e)}return e[n].i},getWeak:function(e,t){if(!i(e,n)){if(!c(e))return!0;if(!t)return!1;h(e)}return e[n].w},onFreeze:function(e){l&&u.NEED&&c(e)&&!i(e,n)&&h(e);return e}}},{"./_fails":29,"./_has":32,"./_is-object":40,"./_object-dp":54,"./_uid":80}],51:[function(e,t,r){var n=e("./_global"),s=e("./_task").set,i=n.MutationObserver||n.WebKitMutationObserver,o=n.process,a=n.Promise,c="process"==e("./_cof")(o);t.exports=function(){var e,t,r,l=function(){var n,s;c&&(n=o.domain)&&n.exit();for(;e;){s=e.fn;e=e.next;try{s()}catch(i){e?r():t=undefined;throw i}}t=undefined;n&&n.enter()};if(c)r=function(){o.nextTick(l)};else if(!i||n.navigator&&n.navigator.standalone)if(a&&a.resolve){var h=a.resolve();r=function(){h.then(l)}}else r=function(){s.call(n,l)};else{var u=!0,d=document.createTextNode("");new i(l).observe(d,{characterData:!0});r=function(){d.data=u=!u}}return function(n){var s={fn:n,next:undefined};t&&(t.next=s);if(!e){e=s;r()}t=s}}},{"./_cof":20,"./_global":31,"./_task":73}],52:[function(e,t,r){"use strict";var n=e("./_a-function");t.exports.f=function(e){return new function PromiseCapability(e){var t,r;this.promise=new e(function(e,n){if(t!==undefined||r!==undefined)throw TypeError("Bad Promise constructor");t=e;r=n});this.resolve=n(t);this.reject=n(r)}(e)}},{"./_a-function":14}],53:[function(e,t,r){var n=e("./_an-object"),s=e("./_object-dps"),i=e("./_enum-bug-keys"),o=e("./_shared-key")("IE_PROTO"),a=function(){},c=function(){var t,r=e("./_dom-create")("iframe"),n=i.length;r.style.display="none";e("./_html").appendChild(r);r.src="javascript:";(t=r.contentWindow.document).open();t.write("<script>document.F=Object<\/script>");t.close();c=t.F;for(;n--;)delete c.prototype[i[n]];return c()};t.exports=Object.create||function create(e,t){var r;if(null!==e){a.prototype=n(e);r=new a;a.prototype=null;r[o]=e}else r=c();return t===undefined?r:s(r,t)}},{"./_an-object":17,"./_dom-create":26,"./_enum-bug-keys":27,"./_html":34,"./_object-dps":55,"./_shared-key":69}],54:[function(e,t,r){var n=e("./_an-object"),s=e("./_ie8-dom-define"),i=e("./_to-primitive"),o=Object.defineProperty;r.f=e("./_descriptors")?Object.defineProperty:function defineProperty(e,t,r){n(e);t=i(t,!0);n(r);if(s)try{return o(e,t,r)}catch(a){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");"value"in r&&(e[t]=r.value);return e}},{"./_an-object":17,"./_descriptors":25,"./_ie8-dom-define":35,"./_to-primitive":79}],55:[function(e,t,r){var n=e("./_object-dp"),s=e("./_an-object"),i=e("./_object-keys");t.exports=e("./_descriptors")?Object.defineProperties:function defineProperties(e,t){s(e);for(var r,o=i(t),a=o.length,c=0;a>c;)n.f(e,r=o[c++],t[r]);return e}},{"./_an-object":17,"./_descriptors":25,"./_object-dp":54,"./_object-keys":58}],56:[function(e,t,r){var n=e("./_has"),s=e("./_to-object"),i=e("./_shared-key")("IE_PROTO"),o=Object.prototype;t.exports=Object.getPrototypeOf||function(e){e=s(e);return n(e,i)?e[i]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},{"./_has":32,"./_shared-key":69,"./_to-object":78}],57:[function(e,t,r){var n=e("./_has"),s=e("./_to-iobject"),i=e("./_array-includes")(!1),o=e("./_shared-key")("IE_PROTO");t.exports=function(e,t){var r,a=s(e),c=0,l=[];for(r in a)r!=o&&n(a,r)&&l.push(r);for(;t.length>c;)n(a,r=t[c++])&&(~i(l,r)||l.push(r));return l}},{"./_array-includes":18,"./_has":32,"./_shared-key":69,"./_to-iobject":76}],58:[function(e,t,r){var n=e("./_object-keys-internal"),s=e("./_enum-bug-keys");t.exports=Object.keys||function keys(e){return n(e,s)}},{"./_enum-bug-keys":27,"./_object-keys-internal":57}],59:[function(e,t,r){r.f={}.propertyIsEnumerable},{}],60:[function(e,t,r){var n=e("./_export"),s=e("./_core"),i=e("./_fails");t.exports=function(e,t){var r=(s.Object||{})[e]||Object[e],o={};o[e]=t(r);n(n.S+n.F*i(function(){r(1)}),"Object",o)}},{"./_core":21,"./_export":28,"./_fails":29}],61:[function(e,t,r){var n=e("./_object-keys"),s=e("./_to-iobject"),i=e("./_object-pie").f;t.exports=function(e){return function(t){for(var r,o=s(t),a=n(o),c=a.length,l=0,h=[];c>l;)i.call(o,r=a[l++])&&h.push(e?[r,o[r]]:o[r]);return h}}},{"./_object-keys":58,"./_object-pie":59,"./_to-iobject":76}],62:[function(e,t,r){t.exports=function(e){try{return{e:!1,v:e()}}catch(t){return{e:!0,v:t}}}},{}],63:[function(e,t,r){var n=e("./_an-object"),s=e("./_is-object"),i=e("./_new-promise-capability");t.exports=function(e,t){n(e);if(s(t)&&t.constructor===e)return t;var r=i.f(e);(0,r.resolve)(t);return r.promise}},{"./_an-object":17,"./_is-object":40,"./_new-promise-capability":52}],64:[function(e,t,r){t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},{}],65:[function(e,t,r){var n=e("./_hide");t.exports=function(e,t,r){for(var s in t)r&&e[s]?e[s]=t[s]:n(e,s,t[s]);return e}},{"./_hide":33}],66:[function(e,t,r){t.exports=e("./_hide")},{"./_hide":33}],67:[function(e,t,r){"use strict";var n=e("./_global"),s=e("./_core"),i=e("./_object-dp"),o=e("./_descriptors"),a=e("./_wks")("species");t.exports=function(e){var t="function"==typeof s[e]?s[e]:n[e];o&&t&&!t[a]&&i.f(t,a,{configurable:!0,get:function(){return this}})}},{"./_core":21,"./_descriptors":25,"./_global":31,"./_object-dp":54,"./_wks":81}],68:[function(e,t,r){var n=e("./_object-dp").f,s=e("./_has"),i=e("./_wks")("toStringTag");t.exports=function(e,t,r){e&&!s(e=r?e:e.prototype,i)&&n(e,i,{configurable:!0,value:t})}},{"./_has":32,"./_object-dp":54,"./_wks":81}],69:[function(e,t,r){var n=e("./_shared")("keys"),s=e("./_uid");t.exports=function(e){return n[e]||(n[e]=s(e))}},{"./_shared":70,"./_uid":80}],70:[function(e,t,r){var n=e("./_global"),s=n["__core-js_shared__"]||(n["__core-js_shared__"]={});t.exports=function(e){return s[e]||(s[e]={})}},{"./_global":31}],71:[function(e,t,r){var n=e("./_an-object"),s=e("./_a-function"),i=e("./_wks")("species");t.exports=function(e,t){var r,o=n(e).constructor;return o===undefined||(r=n(o)[i])==undefined?t:s(r)}},{"./_a-function":14,"./_an-object":17,"./_wks":81}],72:[function(e,t,r){var n=e("./_to-integer"),s=e("./_defined");t.exports=function(e){return function(t,r){var i,o,a=String(s(t)),c=n(r),l=a.length;return c<0||c>=l?e?"":undefined:(i=a.charCodeAt(c))<55296||i>56319||c+1===l||(o=a.charCodeAt(c+1))<56320||o>57343?e?a.charAt(c):i:e?a.slice(c,c+2):o-56320+(i-55296<<10)+65536}}},{"./_defined":24,"./_to-integer":75}],73:[function(e,t,r){var n,s,i,o=e("./_ctx"),a=e("./_invoke"),c=e("./_html"),l=e("./_dom-create"),h=e("./_global"),u=h.process,d=h.setImmediate,_=h.clearImmediate,f=h.MessageChannel,g=h.Dispatch,p=0,y={},m=function(){var e=+this;if(y.hasOwnProperty(e)){var t=y[e];delete y[e];t()}},C=function(e){m.call(e.data)};if(!d||!_){d=function setImmediate(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);y[++p]=function(){a("function"==typeof e?e:Function(e),t)};n(p);return p};_=function clearImmediate(e){delete y[e]};if("process"==e("./_cof")(u))n=function(e){u.nextTick(o(m,e,1))};else if(g&&g.now)n=function(e){g.now(o(m,e,1))};else if(f){i=(s=new f).port2;s.port1.onmessage=C;n=o(i.postMessage,i,1)}else if(h.addEventListener&&"function"==typeof postMessage&&!h.importScripts){n=function(e){h.postMessage(e+"","*")};h.addEventListener("message",C,!1)}else n="onreadystatechange"in l("script")?function(e){c.appendChild(l("script")).onreadystatechange=function(){c.removeChild(this);m.call(e)}}:function(e){setTimeout(o(m,e,1),0)}}t.exports={set:d,clear:_}},{"./_cof":20,"./_ctx":23,"./_dom-create":26,"./_global":31,"./_html":34,"./_invoke":36}],74:[function(e,t,r){var n=e("./_to-integer"),s=Math.max,i=Math.min;t.exports=function(e,t){return(e=n(e))<0?s(e+t,0):i(e,t)}},{"./_to-integer":75}],75:[function(e,t,r){var n=Math.ceil,s=Math.floor;t.exports=function(e){return isNaN(e=+e)?0:(e>0?s:n)(e)}},{}],76:[function(e,t,r){var n=e("./_iobject"),s=e("./_defined");t.exports=function(e){return n(s(e))}},{"./_defined":24,"./_iobject":37}],77:[function(e,t,r){var n=e("./_to-integer"),s=Math.min;t.exports=function(e){return e>0?s(n(e),9007199254740991):0}},{"./_to-integer":75}],78:[function(e,t,r){var n=e("./_defined");t.exports=function(e){return Object(n(e))}},{"./_defined":24}],79:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e))return e;var r,s;if(t&&"function"==typeof(r=e.toString)&&!n(s=r.call(e)))return s;if("function"==typeof(r=e.valueOf)&&!n(s=r.call(e)))return s;if(!t&&"function"==typeof(r=e.toString)&&!n(s=r.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":40}],80:[function(e,t,r){var n=0,s=Math.random();t.exports=function(e){return"Symbol(".concat(e===undefined?"":e,")_",(++n+s).toString(36))}},{}],81:[function(e,t,r){var n=e("./_shared")("wks"),s=e("./_uid"),i=e("./_global").Symbol,o="function"==typeof i;(t.exports=function(e){return n[e]||(n[e]=o&&i[e]||(o?i:s)("Symbol."+e))}).store=n},{"./_global":31,"./_shared":70,"./_uid":80}],82:[function(e,t,r){var n=e("./_classof"),s=e("./_wks")("iterator"),i=e("./_iterators");t.exports=e("./_core").getIteratorMethod=function(e){if(e!=undefined)return e[s]||e["@@iterator"]||i[n(e)]}},{"./_classof":19,"./_core":21,"./_iterators":46,"./_wks":81}],83:[function(e,t,r){var n=e("./_an-object"),s=e("./core.get-iterator-method");t.exports=e("./_core").getIterator=function(e){var t=s(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return n(t.call(e))}},{"./_an-object":17,"./_core":21,"./core.get-iterator-method":82}],84:[function(e,t,r){"use strict";var n=e("./_ctx"),s=e("./_export"),i=e("./_to-object"),o=e("./_iter-call"),a=e("./_is-array-iter"),c=e("./_to-length"),l=e("./_create-property"),h=e("./core.get-iterator-method");s(s.S+s.F*!e("./_iter-detect")(function(e){Array.from(e)}),"Array",{from:function from(e){var t,r,s,u,d=i(e),_="function"==typeof this?this:Array,f=arguments.length,g=f>1?arguments[1]:undefined,p=g!==undefined,y=0,m=h(d);p&&(g=n(g,f>2?arguments[2]:undefined,2));if(m==undefined||_==Array&&a(m))for(r=new _(t=c(d.length));t>y;y++)l(r,y,p?g(d[y],y):d[y]);else for(u=m.call(d),r=new _;!(s=u.next()).done;y++)l(r,y,p?o(u,g,[s.value,y],!0):s.value);r.length=y;return r}})},{"./_create-property":22,"./_ctx":23,"./_export":28,"./_is-array-iter":38,"./_iter-call":41,"./_iter-detect":44,"./_to-length":77,"./_to-object":78,"./core.get-iterator-method":82}],85:[function(e,t,r){"use strict";var n=e("./_add-to-unscopables"),s=e("./_iter-step"),i=e("./_iterators"),o=e("./_to-iobject");t.exports=e("./_iter-define")(Array,"Array",function(e,t){this._t=o(e);this._i=0;this._k=t},function(){var e=this._t,t=this._k,r=this._i++;if(!e||r>=e.length){this._t=undefined;return s(1)}return s(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])},"values");i.Arguments=i.Array;n("keys");n("values");n("entries")},{"./_add-to-unscopables":15,"./_iter-define":43,"./_iter-step":45,"./_iterators":46,"./_to-iobject":76}],86:[function(e,t,r){var n=e("./_export");n(n.S,"Math",{clz32:function clz32(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},{"./_export":28}],87:[function(e,t,r){var n=e("./_export");n(n.S,"Math",{fround:e("./_math-fround")})},{"./_export":28,"./_math-fround":48}],88:[function(e,t,r){var n=e("./_export"),s=Math.imul;n(n.S+n.F*e("./_fails")(function(){return-5!=s(4294967295,5)||2!=s.length}),"Math",{imul:function imul(e,t){var r=+e,n=+t,s=65535&r,i=65535&n;return 0|s*i+((65535&r>>>16)*i+s*(65535&n>>>16)<<16>>>0)}})},{"./_export":28,"./_fails":29}],89:[function(e,t,r){var n=e("./_export");n(n.S,"Math",{trunc:function trunc(e){return(e>0?Math.floor:Math.ceil)(e)}})},{"./_export":28}],90:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{isInteger:e("./_is-integer")})},{"./_export":28,"./_is-integer":39}],91:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},{"./_export":28}],92:[function(e,t,r){var n=e("./_is-object"),s=e("./_meta").onFreeze;e("./_object-sap")("freeze",function(e){return function freeze(t){return e&&n(t)?e(s(t)):t}})},{"./_is-object":40,"./_meta":50,"./_object-sap":60}],93:[function(e,t,r){var n=e("./_to-object"),s=e("./_object-keys");e("./_object-sap")("keys",function(){return function keys(e){return s(n(e))}})},{"./_object-keys":58,"./_object-sap":60,"./_to-object":78}],94:[function(e,t,r){},{}],95:[function(e,t,r){"use strict";var n,s,i,o,a=e("./_library"),c=e("./_global"),l=e("./_ctx"),h=e("./_classof"),u=e("./_export"),d=e("./_is-object"),_=e("./_a-function"),f=e("./_an-instance"),g=e("./_for-of"),p=e("./_species-constructor"),y=e("./_task").set,m=e("./_microtask")(),C=e("./_new-promise-capability"),S=e("./_perform"),A=e("./_promise-resolve"),T=c.TypeError,k=c.process,w=c.Promise,E="process"==h(k),b=function(){},v=s=C.f,P=!!function(){try{var t=w.resolve(1),r=(t.constructor={})[e("./_wks")("species")]=function(e){e(b,b)};return(E||"function"==typeof PromiseRejectionEvent)&&t.then(b)instanceof r}catch(n){}}(),I=function(e){var t;return!(!d(e)||"function"!=typeof(t=e.then))&&t},N=function(e,t){if(!e._n){e._n=!0;var r=e._c;m(function(){for(var n=e._v,s=1==e._s,i=0,o=function(t){var r,i,o=s?t.ok:t.fail,a=t.resolve,c=t.reject,l=t.domain;try{if(o){if(!s){2==e._h&&M(e);e._h=1}if(!0===o)r=n;else{l&&l.enter();r=o(n);l&&l.exit()}r===t.promise?c(T("Promise-chain cycle")):(i=I(r))?i.call(r,a,c):a(r)}else c(n)}catch(h){c(h)}};r.length>i;)o(r[i++]);e._c=[];e._n=!1;t&&!e._h&&B(e)})}},B=function(e){y.call(c,function(){var t,r,n,s=e._v,i=R(e);if(i){t=S(function(){E?k.emit("unhandledRejection",s,e):(r=c.onunhandledrejection)?r({promise:e,reason:s}):(n=c.console)&&n.error&&n.error("Unhandled promise rejection",s)});e._h=E||R(e)?2:1}e._a=undefined;if(i&&t.e)throw t.v})},R=function(e){return 1!==e._h&&0===(e._a||e._c).length},M=function(e){y.call(c,function(){var t;E?k.emit("rejectionHandled",e):(t=c.onrejectionhandled)&&t({promise:e,reason:e._v})})},O=function(e){var t=this;if(!t._d){t._d=!0;(t=t._w||t)._v=e;t._s=2;t._a||(t._a=t._c.slice());N(t,!0)}},L=function(e){var t,r=this;if(!r._d){r._d=!0;r=r._w||r;try{if(r===e)throw T("Promise can't be resolved itself");if(t=I(e))m(function(){var n={_w:r,_d:!1};try{t.call(e,l(L,n,1),l(O,n,1))}catch(s){O.call(n,s)}});else{r._v=e;r._s=1;N(r,!1)}}catch(n){O.call({_w:r,_d:!1},n)}}};if(!P){w=function Promise(e){f(this,w,"Promise","_h");_(e);n.call(this);try{e(l(L,this,1),l(O,this,1))}catch(t){O.call(this,t)}};(n=function Promise(e){this._c=[];this._a=undefined;this._s=0;this._d=!1;this._v=undefined;this._h=0;this._n=!1}).prototype=e("./_redefine-all")(w.prototype,{then:function then(e,t){var r=v(p(this,w));r.ok="function"!=typeof e||e;r.fail="function"==typeof t&&t;r.domain=E?k.domain:undefined;this._c.push(r);this._a&&this._a.push(r);this._s&&N(this,!1);return r.promise},"catch":function(e){return this.then(undefined,e)}});i=function(){var e=new n;this.promise=e;this.resolve=l(L,e,1);this.reject=l(O,e,1)};C.f=v=function(e){return e===w||e===o?new i(e):s(e)}}u(u.G+u.W+u.F*!P,{Promise:w});e("./_set-to-string-tag")(w,"Promise");e("./_set-species")("Promise");o=e("./_core").Promise;u(u.S+u.F*!P,"Promise",{reject:function reject(e){var t=v(this);(0,t.reject)(e);return t.promise}});u(u.S+u.F*(a||!P),"Promise",{resolve:function resolve(e){return A(a&&this===o?w:this,e)}});u(u.S+u.F*!(P&&e("./_iter-detect")(function(e){w.all(e)["catch"](b)})),"Promise",{all:function all(e){var t=this,r=v(t),n=r.resolve,s=r.reject,i=S(function(){var r=[],i=0,o=1;g(e,!1,function(e){var a=i++,c=!1;r.push(undefined);o++;t.resolve(e).then(function(e){if(!c){c=!0;r[a]=e;--o||n(r)}},s)});--o||n(r)});i.e&&s(i.v);return r.promise},race:function race(e){var t=this,r=v(t),n=r.reject,s=S(function(){g(e,!1,function(e){t.resolve(e).then(r.resolve,n)})});s.e&&n(s.v);return r.promise}})},{"./_a-function":14,"./_an-instance":16,"./_classof":19,"./_core":21,"./_ctx":23,"./_export":28,"./_for-of":30,"./_global":31,"./_is-object":40,"./_iter-detect":44,"./_library":47,"./_microtask":51,"./_new-promise-capability":52,"./_perform":62,"./_promise-resolve":63,"./_redefine-all":65,"./_set-species":67,"./_set-to-string-tag":68,"./_species-constructor":71,"./_task":73,"./_wks":81}],96:[function(e,t,r){"use strict";var n=e("./_string-at")(!0);e("./_iter-define")(String,"String",function(e){this._t=String(e);this._i=0},function(){var e,t=this._t,r=this._i;if(r>=t.length)return{value:undefined,done:!0};e=n(t,r);this._i+=e.length;return{value:e,done:!1}})},{"./_iter-define":43,"./_string-at":72}],97:[function(e,t,r){var n=e("./_export"),s=e("./_object-to-array")(!1);n(n.S,"Object",{values:function values(e){return s(e)}})},{"./_export":28,"./_object-to-array":61}],98:[function(e,t,r){"use strict";var n=e("./_export"),s=e("./_core"),i=e("./_global"),o=e("./_species-constructor"),a=e("./_promise-resolve");n(n.P+n.R,"Promise",{"finally":function(e){var t=o(this,s.Promise||i.Promise),r="function"==typeof e;return this.then(r?function(r){return a(t,e()).then(function(){return r})}:e,r?function(r){return a(t,e()).then(function(){throw r})}:e)}})},{"./_core":21,"./_export":28,"./_global":31,"./_promise-resolve":63,"./_species-constructor":71}],99:[function(e,t,r){"use strict";var n=e("./_export"),s=e("./_new-promise-capability"),i=e("./_perform");n(n.S,"Promise",{"try":function(e){var t=s.f(this),r=i(e);(r.e?t.reject:t.resolve)(r.v);return t.promise}})},{"./_export":28,"./_new-promise-capability":52,"./_perform":62}],100:[function(e,t,r){e("./es6.array.iterator");for(var n=e("./_global"),s=e("./_hide"),i=e("./_iterators"),o=e("./_wks")("toStringTag"),a="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),c=0;c<a.length;c++){var l=a[c],h=n[l],u=h&&h.prototype;u&&!u[o]&&s(u,o,l);i[l]=i.Array}},{"./_global":31,"./_hide":33,"./_iterators":46,"./_wks":81,"./es6.array.iterator":85}],101:[function(e,t,r){var n=function(){return this}()||Function("return this")(),s=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,i=s&&n.regeneratorRuntime;n.regeneratorRuntime=undefined;t.exports=e("./runtime");if(s)n.regeneratorRuntime=i;else try{delete n.regeneratorRuntime}catch(o){n.regeneratorRuntime=undefined}},{"./runtime":102}],102:[function(e,t,r){!function(e){"use strict";var r,n=Object.prototype,s=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag",l="object"==typeof t,h=e.regeneratorRuntime;if(h)l&&(t.exports=h);else{(h=e.regeneratorRuntime=l?t.exports:{}).wrap=wrap;var u="suspendedStart",d="suspendedYield",_="executing",f="completed",g={},p={};p[o]=function(){return this};var y=Object.getPrototypeOf,m=y&&y(y(values([])));m&&m!==n&&s.call(m,o)&&(p=m);var C=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);GeneratorFunction.prototype=C.constructor=GeneratorFunctionPrototype;GeneratorFunctionPrototype.constructor=GeneratorFunction;GeneratorFunctionPrototype[c]=GeneratorFunction.displayName="GeneratorFunction";h.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))};h.mark=function(e){if(Object.setPrototypeOf)Object.setPrototypeOf(e,GeneratorFunctionPrototype);else{e.__proto__=GeneratorFunctionPrototype;c in e||(e[c]="GeneratorFunction")}e.prototype=Object.create(C);return e};h.awrap=function(e){return{__await:e}};defineIteratorMethods(AsyncIterator.prototype);AsyncIterator.prototype[a]=function(){return this};h.AsyncIterator=AsyncIterator;h.async=function(e,t,r,n){var s=new AsyncIterator(wrap(e,t,r,n));return h.isGeneratorFunction(t)?s:s.next().then(function(e){return e.done?e.value:s.next()})};defineIteratorMethods(C);C[c]="Generator";C[o]=function(){return this};C.toString=function(){return"[object Generator]"};h.keys=function(e){var t=[];for(var r in e)t.push(r);t.reverse();return function next(){for(;t.length;){var r=t.pop();if(r in e){next.value=r;next.done=!1;return next}}next.done=!0;return next}};h.values=values;Context.prototype={constructor:Context,reset:function(e){this.prev=0;this.next=0;this.sent=this._sent=r;this.done=!1;this.delegate=null;this.method="next";this.arg=r;this.tryEntries.forEach(resetTryEntry);if(!e)for(var t in this)"t"===t.charAt(0)&&s.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function handle(n,s){o.type="throw";o.arg=e;t.next=n;if(s){t.method="next";t.arg=r}return!!s}for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n],o=i.completion;if("root"===i.tryLoc)return handle("end");if(i.tryLoc<=this.prev){var a=s.call(i,"catchLoc"),c=s.call(i,"finallyLoc");if(a&&c){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0);if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return handle(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return handle(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&s.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};o.type=e;o.arg=t;if(i){this.method="next";this.next=i.finallyLoc;return g}return this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;if("break"===e.type||"continue"===e.type)this.next=e.arg;else if("return"===e.type){this.rval=this.arg=e.arg;this.method="return";this.next="end"}else"normal"===e.type&&t&&(this.next=t);return g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e){this.complete(r.completion,r.afterLoc);resetTryEntry(r);return g}}},"catch":function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var s=n.arg;resetTryEntry(r)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){this.delegate={iterator:values(e),resultName:t,nextLoc:n};"next"===this.method&&(this.arg=r);return g}}}function wrap(e,t,r,n){var s=t&&t.prototype instanceof Generator?t:Generator,i=Object.create(s.prototype),o=new Context(n||[]);i._invoke=function makeInvokeMethod(e,t,r){var n=u;return function invoke(s,i){if(n===_)throw new Error("Generator is already running");if(n===f){if("throw"===s)throw i;return doneResult()}r.method=s;r.arg=i;for(;;){var o=r.delegate;if(o){var a=maybeInvokeDelegate(o,r);if(a){if(a===g)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===u){n=f;throw r.arg}r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=_;var c=tryCatch(e,t,r);if("normal"===c.type){n=r.done?f:d;if(c.arg===g)continue;return{value:c.arg,done:r.done}}if("throw"===c.type){n=f;r.method="throw";r.arg=c.arg}}}}(e,r,o);return i}function tryCatch(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(n){return{type:"throw",arg:n}}}function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}function defineIteratorMethods(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function AsyncIterator(e){var t;this._invoke=function enqueue(r,n){function callInvokeWithMethodAndArg(){return new Promise(function(t,i){!function invoke(t,r,n,i){var o=tryCatch(e[t],e,r);if("throw"!==o.type){var a=o.arg,c=a.value;return c&&"object"==typeof c&&s.call(c,"__await")?Promise.resolve(c.__await).then(function(e){invoke("next",e,n,i)},function(e){invoke("throw",e,n,i)}):Promise.resolve(c).then(function(e){a.value=e;n(a)},i)}i(o.arg)}(r,n,t,i)})}return t=t?t.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(e,t){var n=e.iterator[t.method];if(n===r){t.delegate=null;if("throw"===t.method){if(e.iterator["return"]){t.method="return";t.arg=r;maybeInvokeDelegate(e,t);if("throw"===t.method)return g}t.method="throw";t.arg=new TypeError("The iterator does not provide a 'throw' method")}return g}var s=tryCatch(n,e.iterator,t.arg);if("throw"===s.type){t.method="throw";t.arg=s.arg;t.delegate=null;return g}var i=s.arg;if(!i){t.method="throw";t.arg=new TypeError("iterator result is not an object");t.delegate=null;return g}if(!i.done)return i;t[e.resultName]=i.value;t.next=e.nextLoc;if("return"!==t.method){t.method="next";t.arg=r}t.delegate=null;return g}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]);if(2 in e){t.finallyLoc=e[2];t.afterLoc=e[3]}this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal";delete t.arg;e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}];e.forEach(pushTryEntry,this);this.reset(!0)}function values(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function next(){for(;++n<e.length;)if(s.call(e,n)){next.value=e[n];next.done=!1;return next}next.value=r;next.done=!0;return next};return i.next=i}}return{next:doneResult}}function doneResult(){return{value:r,done:!0}}}(function(){return this}()||Function("return this")())},{}],"babel-runtime/core-js/array/from":[function(e,t,r){t.exports={"default":e("core-js/library/fn/array/from"),__esModule:!0}},{"core-js/library/fn/array/from":1}],"babel-runtime/core-js/get-iterator":[function(e,t,r){t.exports={"default":e("core-js/library/fn/get-iterator"),__esModule:!0}},{"core-js/library/fn/get-iterator":2}],"babel-runtime/core-js/json/stringify":[function(e,t,r){t.exports={"default":e("core-js/library/fn/json/stringify"),__esModule:!0}},{"core-js/library/fn/json/stringify":3}],"babel-runtime/core-js/math/clz32":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/clz32"),__esModule:!0}},{"core-js/library/fn/math/clz32":4}],"babel-runtime/core-js/math/fround":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/fround"),__esModule:!0}},{"core-js/library/fn/math/fround":5}],"babel-runtime/core-js/math/imul":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/imul"),__esModule:!0}},{"core-js/library/fn/math/imul":6}],"babel-runtime/core-js/math/trunc":[function(e,t,r){t.exports={"default":e("core-js/library/fn/math/trunc"),__esModule:!0}},{"core-js/library/fn/math/trunc":7}],"babel-runtime/core-js/number/is-integer":[function(e,t,r){t.exports={"default":e("core-js/library/fn/number/is-integer"),__esModule:!0}},{"core-js/library/fn/number/is-integer":8}],"babel-runtime/core-js/number/max-safe-integer":[function(e,t,r){t.exports={"default":e("core-js/library/fn/number/max-safe-integer"),__esModule:!0}},{"core-js/library/fn/number/max-safe-integer":9}],"babel-runtime/core-js/object/freeze":[function(e,t,r){t.exports={"default":e("core-js/library/fn/object/freeze"),__esModule:!0}},{"core-js/library/fn/object/freeze":10}],"babel-runtime/core-js/object/keys":[function(e,t,r){t.exports={"default":e("core-js/library/fn/object/keys"),__esModule:!0}},{"core-js/library/fn/object/keys":11}],"babel-runtime/core-js/object/values":[function(e,t,r){t.exports={"default":e("core-js/library/fn/object/values"),__esModule:!0}},{"core-js/library/fn/object/values":12}],"babel-runtime/core-js/promise":[function(e,t,r){t.exports={"default":e("core-js/library/fn/promise"),__esModule:!0}},{"core-js/library/fn/promise":13}],"babel-runtime/helpers/asyncToGenerator":[function(e,t,r){"use strict";r.__esModule=!0;var n=function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}(e("../core-js/promise"));r["default"]=function(e){return function(){var t=e.apply(this,arguments);return new n["default"](function(e,r){return function step(s,i){try{var o=t[s](i),a=o.value}catch(c){r(c);return}if(!o.done)return n["default"].resolve(a).then(function(e){step("next",e)},function(e){step("throw",e)});e(a)}("next")})}}},{"../core-js/promise":"babel-runtime/core-js/promise"}],"babel-runtime/regenerator":[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":101}]},{},[]);var Proxy,_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}if("undefined"==typeof JDB)var JDB={};!function(e){e="undefined"!=typeof e?e:{};class Class{static register(t){"undefined"!=typeof e&&(e[t.name]=t)}}Class.register(Class);class IDBTools{static convertKeyRange(e){return e instanceof KeyRange?e.exactMatch?IDBKeyRange.only(e.lower):e.lower!==undefined&&e.upper===undefined?IDBKeyRange.lowerBound(e.lower,e.lowerOpen):e.upper!==undefined&&e.lower===undefined?IDBKeyRange.upperBound(e.upper,e.upperOpen):IDBKeyRange.bound(e.lower,e.upper,e.lowerOpen,e.upperOpen):e}}Class.register(IDBTools);class LogNative{constructor(){this._global_level=Log.TRACE;this._tag_levels={};try{if(window.localStorage)try{let t=window.localStorage.getItem("log_tag_levels");t&&"string"==typeof t&&(t=JSON.parse(t));t&&"object"==typeof t&&(this._tag_levels=t)}catch(e){console.warn("Failed to load log configuration from local storage.")}}catch(e){}}isLoggable(e,t){return e&&this._tag_levels[e]?this._tag_levels[e]<=t:this._tag_levels["*"]?this._tag_levels["*"]<=t:this._global_level<=t}setLoggable(e,t){e&&e.name&&(e=e.name);this._tag_levels[e]=t;window.localStorage&&window.localStorage.setItem("log_tag_levels",JSON.stringify(this._tag_levels))}msg(e,t,r){t&&t.name&&(t=t.name);if(this.isLoggable(t,e)){t&&r.unshift(t+":");r.unshift(`[${Log.Level.toStringTag(e)} ${(new Date).toTimeString().substr(0,8)}]`);console.error&&e>=Log.ERROR?console.error.apply(console,r):console.warn&&e>=Log.WARNING?console.warn.apply(console,r):console.info&&e>=Log.INFO?console.info.apply(console,r):console.debug&&e>=Log.DEBUG?console.debug.apply(console,r):console.trace&&e<=Log.TRACE?console.trace.apply(console,r):console.log.apply(console,r)}}}Class.register(LogNative);class EncodedTransaction{constructor(e){this._tableName=e;this._modified=new Map;this._removed=new Set;this._truncated=!1}get tableName(){return this._tableName}get modified(){return this._modified}get removed(){return this._removed}get truncated(){return this._truncated}truncate(){this._truncated=!0;this._modified.clear();this._removed.clear()}put(e,t){this._removed["delete"](e);this._modified.set(e,t)}remove(e){this._removed.add(e);this._modified["delete"](e)}}Class.register(EncodedTransaction);class IDBBackend{constructor(e,t,r=null){this._db=e;this._tableName=t;this._indices=new Map;this._indicesToDelete=[];this._codec=r}get connected(){return this._db.connected}get _backend(){if(!this.connected)throw new Error("Requires a connected database");return this._db.backend}get indices(){return this._indices}init(e){for(const t of this._indicesToDelete)e.deleteIndex(t);delete this._indicesToDelete;for(const[t,r]of this._indices){const n=Array.isArray(r.keyPath)?r.keyPath.join("."):r.keyPath;e.createIndex(t,n,{unique:!1,multiEntry:r.multiEntry})}}decode(e,t){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.decode(e,t):e}encode(e){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.encode(e):e}get(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName]).objectStore(t._tableName).get(e);i.onsuccess=function(r){return n(t.decode(r.target.result,e))};i.onerror=s})})()}put(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=r._backend;return new Promise(function(s,i){const o=n.transaction([r._tableName],"readwrite").objectStore(r._tableName).put(r.encode(t),e);o.onsuccess=function(e){return s(e.target.result)};o.onerror=i})})()}remove(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readwrite").objectStore(t._tableName)["delete"](e);i.onsuccess=function(e){return n(e.target.result)};i.onerror=s})})()}values(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(null!==e&&e instanceof Query)return e.values(t);e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=[],o=r.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(e);o.onsuccess=function(e){const r=e.target.result;if(r){i.push(t.decode(r.value,r.primaryKey));r["continue"]()}else n(i)};o.onerror=function(){return s(o.error)}})})()}keys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(null!==e&&e instanceof Query)return e.keys(t);e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=new Set,o=r.transaction([t._tableName],"readonly").objectStore(t._tableName),a=o.openKeyCursor?o.openKeyCursor(e):o.openCursor(e);a.onsuccess=function(e){const t=e.target.result;if(t){i.add(t.primaryKey);t["continue"]()}else n(i)};a.onerror=function(){return s(a.error)}})})()}keyStream(e,t=!0,r=null){r=IDBTools.convertKeyRange(r);const n=this._backend;return new Promise((s,i)=>{const o=n.transaction([this._tableName],"readonly").objectStore(this._tableName),a=o.openKeyCursor?o.openKeyCursor(r,t?"next":"prev"):o.openCursor(r,t?"next":"prev");a.onsuccess=(t=>{const r=t.target.result;r&&e(r.primaryKey)?r["continue"]():s()});a.onerror=(()=>i(a.error))})}valueStream(e,t=!0,r=null){r=IDBTools.convertKeyRange(r);const n=this._backend;return new Promise((s,i)=>{const o=n.transaction([this._tableName],"readonly").objectStore(this._tableName).openCursor(r,t?"next":"prev");o.onsuccess=(t=>{const r=t.target.result;r&&e(r.value,r.primaryKey)?r["continue"]():s()});o.onerror=(()=>i(o.error))})}maxValue(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(e,"prev");i.onsuccess=function(e){const r=e.target.result;n(r?t.decode(r.value,r.primaryKey):undefined)};i.onerror=function(){return s(i.error)}})})()}maxKey(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readonly").objectStore(t._tableName),o=i.openKeyCursor?i.openKeyCursor(e,"prev"):i.openCursor(e,"prev");o.onsuccess=function(){return n(o.result?o.result.primaryKey:undefined)};o.onerror=function(){return s(o.error)}})})()}minValue(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readonly").objectStore(t._tableName).openCursor(e,"next");i.onsuccess=function(e){const r=e.target.result;n(r?t.decode(r.value,r.primaryKey):undefined)};i.onerror=function(){return s(i.error)}})})()}minKey(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readonly").objectStore(t._tableName),o=i.openKeyCursor?i.openKeyCursor(e,"next"):i.openCursor(e,"next");o.onsuccess=function(){return n(o.result?o.result.primaryKey:undefined)};o.onerror=function(){return s(o.error)}})})()}count(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readonly").objectStore(t._tableName).count(e);i.onsuccess=function(){return n(i.result)};i.onerror=function(){return s(i.error)}})})()}index(e){return this._indices.get(e)}get backend(){return this._db.backend}get tableName(){return this._tableName}_apply(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t._backend;return new Promise(function(n,s){const i=r.transaction([t._tableName],"readwrite"),o=i.objectStore(t._tableName);e._truncated&&o.clear();for(const t of e._removed)o["delete"](t);for(const[r,a]of e._modified)o.put(t.encode(a),r);i.oncomplete=function(){return n(!0)};i.onerror=s;i.onabort=s})})()}truncate(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=e._backend;return new Promise(function(r,n){const s=t.transaction([e._tableName],"readonly").objectStore(e._tableName).clear();s.onsuccess=r;s.onerror=function(){return n(s.error)}})})()}createIndex(e,t,r=!1){if(this._db.connected)throw new Error("Cannot create index while connected");const n=new PersistentIndex(this,e,t=t||e,r);this._indices.set(e,n)}deleteIndex(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._db.connected)throw new Error("Cannot delete index while connected");t._indicesToDelete.push(e)})()}close(){return this._db.close()}applyCombined(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=new EncodedTransaction(t._tableName);e._truncated&&r.truncate();for(const t of e._removed)r.remove(t);for(const[n,s]of e._modified)r.put(n,t.encode(s));return r})()}isSynchronous(){return!1}}Class.register(IDBBackend);class JungleDB{constructor(e,t,r){if(t<=0)throw new Error("The version provided must not be less or equal to 0");this._databaseDir=e;this._dbVersion=t;this._onUpgradeNeeded=r;this._connected=!1;this._objectStores=new Map;this._objectStoreBackends=new Map;this._objectStoresToDelete=[]}get _indexedDB(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB}connect(){if(this._db)return Promise.resolve(this._db);const e=this._indexedDB.open(this._databaseDir,this._dbVersion),t=this;return new Promise((r,n)=>{e.onsuccess=(()=>{t._connected=!0;t._db=e.result;r(e.result)});e.onerror=n;e.onupgradeneeded=(e=>t._initDB(e))})}_initDB(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.target.result;for(const e of t._objectStoresToDelete)r.deleteObjectStore(e);delete t._objectStoresToDelete;for(const[e,n]of t._objectStoreBackends){const t=r.createObjectStore(e);n.init(t)}delete t._objectStoreBackends;t._onUpgradeNeeded&&(yield t._onUpgradeNeeded())})()}get backend(){return this._db}get connected(){return this._connected}getObjectStore(e){return this._objectStores.get(e)}static createVolatileObjectStore(e=null){return new ObjectStore(new InMemoryBackend("",e),null)}createObjectStore(e,t=null,r=!0){if(this._connected)throw new Error("Cannot create ObjectStore while connected");if(this._objectStores.has(e))return this._objectStores.get(e);const n=r?new IDBBackend(this,e,t):new InMemoryBackend(e,t),s=new CachedBackend(n),i=new ObjectStore(s,this,e);this._objectStores.set(e,i);this._objectStoreBackends.set(e,n);return i}deleteObjectStore(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._connected)throw new Error("Cannot delete ObjectStore while connected");t._objectStoresToDelete.push(e)})()}close(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(e._connected){e._connected=!1;e.backend.close()}})()}destroy(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){yield e.close();return new Promise(function(t,r){const n=e._indexedDB.deleteDatabase(e._databaseDir);n.onsuccess=t;n.onerror=r})})()}static commitCombined(e,t,...r){return(0,_asyncToGenerator3["default"])(function*(){if(e instanceof CombinedTransaction){const t=[],r=[],n=[],s=yield Promise.all(e.transactions.map(function(e){return e.objectStore._backend.applyCombined(e)}));for(const e of s){let s=e;Array.isArray(e)||(s=[e]);for(const e of s)if("function"==typeof e)t.push(e);else{r.push(e);n.push(e.tableName)}}const i=null!==e.backend?e.backend.backend:null;return new Promise(function(e,s){if(n.length>0){const o=i.transaction(n,"readwrite");for(const e of r){const t=o.objectStore(e.tableName);e.truncated&&t.clear();for(const r of e.removed)t["delete"](r);for(const[r,n]of e.modified)t.put(n,r)}o.oncomplete=function(){Promise.all(t.map(function(e){return e()})).then(function(){e(!0)})};o.onerror=s;o.onabort=s}else Promise.all(t.map(function(e){return e()})).then(function(){e(!0)})})}r.push(e);r.push(t);if(!r.every(function(e){return e instanceof Transaction}))throw new Error("Invalid arguments supplied");return new CombinedTransaction(...r).commit()})()}toString(){return`JungleDB{name=${this._databaseDir}}`}}Class.register(JungleDB);class PersistentIndex{constructor(e,t,r,n=!1){this._objectStore=e;this._indexName=t;this._keyPath=r;this._multiEntry=n}truncate(){return(0,_asyncToGenerator3["default"])(function*(){})()}get keyPath(){return this._keyPath}get multiEntry(){return this._multiEntry}_index(e){return e.transaction([this._objectStore.tableName],"readonly").objectStore(this._objectStore.tableName).index(this._indexName)}values(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=[],o=t._index(r).openCursor(e);o.onsuccess=function(e){const r=e.target.result;if(r){i.push(t._objectStore.decode(r.value,r.primaryKey));r["continue"]()}else n(i)};o.onerror=function(){return s(o.error)}})})()}keys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=new Set,o=t._index(r),a=o.openKeyCursor?o.openKeyCursor(e):o.openCursor(e);a.onsuccess=function(e){const t=e.target.result;if(t){i.add(t.primaryKey);t["continue"]()}else n(i)};a.onerror=function(){return s(a.error)}})})()}maxValues(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=[];let o=null;const a=t._index(r).openCursor(e,"prev");a.onsuccess=function(e){const r=e.target.result;null===o&&(o=r.key);if(r&&o===r.key){i.push(t._objectStore.decode(r.value,r.primaryKey));r["continue"]()}else n(i)};a.onerror=function(){return s(a.error)}})})()}maxKeys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=new Set;let o=null;const a=t._index(r),c=a.openKeyCursor?a.openKeyCursor(e,"prev"):a.openCursor(e,"prev");c.onsuccess=function(e){const t=e.target.result;null===o&&(o=t.key);if(t&&o===t.key){i.add(t.primaryKey);t["continue"]()}else n(i)};c.onerror=function(){return s(c.error)}})})()}minValues(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=[];let o=null;const a=t._index(r).openCursor(e,"next");a.onsuccess=function(e){const r=e.target.result;null===o&&(o=r.key);if(r&&o===r.key){i.push(t._objectStore.decode(r.value,r.primaryKey));r["continue"]()}else n(i)};a.onerror=function(){return s(a.error)}})})()}minKeys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=new Set;let o=null;const a=t._index(r),c=a.openKeyCursor?a.openKeyCursor(e,"next"):a.openCursor(e,"next");c.onsuccess=function(e){const t=e.target.result;null===o&&(o=t.key);if(t&&o===t.key){i.add(t.primaryKey);t["continue"]()}else n(i)};c.onerror=function(){return s(c.error)}})})()}count(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e=IDBTools.convertKeyRange(e);const r=yield t._objectStore.backend;return new Promise(function(n,s){const i=t._index(r).count(e);i.onsuccess=function(){return n(i.result)};i.onerror=function(){return s(i.error)}})})()}}Class.register(PersistentIndex);Array.prototype.iterator=function(e=!0){let t=e?0:this.length-1;return{next:()=>t>=0&&t<this.length?this[e?t++:t--]:undefined,hasNext:()=>t>=0&&t<this.length,peek:()=>t>=0&&t<this.length?this[t]:undefined}};class Node{constructor(e,t=[]){this._keys=t;this._id=e}get id(){return this._id}get keys(){return this._keys}toJSON(){return{_id:this._id,_keys:this._keys}}static fromJSON(e){return!0===e.isLeaf?LeafNode.fromJSON(e):!1===e.isLeaf?InnerNode.fromJSON(e):undefined}}Class.register(Node);class LeafNode extends Node{constructor(e,t=[],r=[]){if(t.length!==r.length)throw new Error("Keys and records must have the same length");super(e,t);this._records=r;this.prevLeaf=null;this.nextLeaf=null}get records(){return this._records}isLeaf(){return!0}toJSON(){const e=super.toJSON();e.isLeaf=!0;e._records=this._records;e.prevLeaf=this.prevLeaf?this.prevLeaf.id:this.prevLeaf;e.nextLeaf=this.nextLeaf?this.nextLeaf.id:this.nextLeaf;return e}static fromJSON(e){const t=new LeafNode(e._id,e._keys,e._records);t.prevLeaf=e.prevLeaf;t.nextLeaf=e.nextLeaf;return t}getItem(e,t){const r=this._keys;if(t===BTree.NEAR_MODE.GE){for(let n=0,s=r.length;n<s;++n)if(e<=r[n])return n}else if(t===BTree.NEAR_MODE.LE){for(let n=r.length-1;n>=0;--n)if(e>=r[n])return n}else for(let n=0,s=r.length;n<s;++n)if(e===r[n])return n;return-1}addKey(e,t){let r=this._keys.length;for(let n=0,s=r;n<s;++n){if(e===this._keys[n])return-1;if(e<=this._keys[n]){r=n;break}}this._keys.splice(r,0,e);this._records.splice(r,0,t);return r}split(e){const t=Math.floor(this._keys.length/2),r=[],n=[];for(let i=0;i<t;++i){r.unshift(this._keys.pop());n.unshift(this._records.pop())}const s=new LeafNode(e,r,n);s.prevLeaf=this;s.nextLeaf=this.nextLeaf;null!==this.nextLeaf&&(this.nextLeaf.prevLeaf=s);this.nextLeaf=s;return s}merge(e,t,r){for(let s=0,i=e.keys.length;s<i;++s){this._keys.push(e.keys[s]);this._records.push(e.records[s])}this.nextLeaf=e.nextLeaf;null!==e.nextLeaf&&(e.nextLeaf.prevLeaf=this);e.prevLeaf=null;e.nextLeaf=null;let n=t.keys.length-1;for(let s=n;s>=0;--s)if(t.keys[s]===r){n=s;break}t.keys.splice(n,1);t.nodePointers.splice(n+1,1)}}Class.register(LeafNode);class InnerNode extends Node{constructor(e,t=[],r=[]){super(e,t);this._nodePointers=r}isLeaf(){return!1}get nodePointers(){return this._nodePointers}toJSON(){const e=super.toJSON(),t=[];for(let r=0;r<this._nodePointers.length;++r)t.push(this._nodePointers[r]?this._nodePointers[r].id:this._nodePointers[r]);e.isLeaf=!1;e._nodePointers=t;return e}static fromJSON(e){return new InnerNode(e._id,e._keys,e._nodePointers)}getItem(e){const t=this._keys.length;for(let r=0;r<t;++r)if(e<this._keys[r])return r;return this._keys.length}addKey(e,t,r){const n=this._keys.length;let s=n;for(let i=0;i<n;++i)if(e<=this._keys[i]){s=i;break}this._keys.splice(s,0,e);this._nodePointers.splice(s,0,t);this._nodePointers[s+1]=r}split(e){const t=Math.ceil(this._keys.length/2)-1,r=[this._nodePointers.pop()],n=[];for(let s=t-1;s>=0;--s){n.unshift(this._keys.pop());r.unshift(this._nodePointers.pop())}return new InnerNode(e,n,r)}merge(e,t,r){const n=t.keys[r];this._keys.push(n);for(let s=0,i=e.keys.length;s<i;++s){this._keys.push(e.keys[s]);this._nodePointers.push(e.nodePointers[s])}this._nodePointers.push(e.nodePointers[e.nodePointers.length-1]);t.keys.splice(r,1);t.nodePointers.splice(r+1,1);return n}}Class.register(InnerNode);class BTree{constructor(e=7){this._nodeId=0;this._root=new LeafNode(this._nodeId++);this._maxkey=e-1;this._minkyl=Math.floor(e/2);this._minkyn=Math.floor(this._maxkey/2);this._leaf=null;this._item=-1;this._key=null;this._record=null;this._length=0;this._eof=!0;this._found=!1}get length(){return this._length}get currentKey(){return this._key}get currentRecord(){return this._record}transaction(){return new TreeTransaction(this)}insert(e,t,r=null){const n=[];this._leaf=this._root;for(;!this._leaf.isLeaf();){n.push(this._leaf);this._item=this._leaf.getItem(e);this._leaf=this._leaf.nodePointers[this._item]}this._item=this._leaf.addKey(e,t);this._key=e;this._eof=!1;if(-1===this._item){this._found=!0;this._item=this._leaf.getItem(e,!1);this._record=this._leaf.records[this._item]}else{BTree._modifyNode(r,this._leaf);this._found=!1;this._record=t;this._length++;if(this._leaf.keys.length>this._maxkey){let t=this._leaf,s=this._leaf.split(this._nodeId++);BTree._modifyNode(r,t);BTree._modifyNode(r,s);let i=s.keys[0];this._item=this._leaf.getItem(e,!1);if(-1===this._item){this._leaf=this._leaf.nextLeaf;this._item=this._leaf.getItem(e,!1)}for(;;){if(0===n.length){const e=new InnerNode(this._nodeId++);e.keys[0]=i;e.nodePointers[0]=t;e.nodePointers[1]=s;BTree._modifyNode(r,e);this._root=e;break}const e=n.pop();e.addKey(i,t,s);BTree._modifyNode(r,e);if(e.keys.length<=this._maxkey)break;t=e;s=e.split(this._nodeId++);BTree._modifyNode(r,t);BTree._modifyNode(r,s);i=e.keys.pop()}}}return!this._found}remove(e,t=null,r=null){if("undefined"==typeof e){if(-1===this._item){this._eof=!0;this._found=!1;return!1}e=this._leaf.keys[this._item]}this._del(e,t,r);if(this._found){this.seek(e,BTree.NEAR_MODE.GE);this._found=!0}else{this._item=-1;this._eof=!0;this._key=null;this._record=null}return this._found}seek(e,t=BTree.NEAR_MODE.NONE){this._leaf=this._root;for(;!this._leaf.isLeaf();){this._item=this._leaf.getItem(e);this._leaf=this._leaf.nodePointers[this._item]}this._item=this._leaf.getItem(e,t);if(t===BTree.NEAR_MODE.GE&&-1===this._item&&null!==this._leaf.nextLeaf){this._leaf=this._leaf.nextLeaf;this._item=0}if(t===BTree.NEAR_MODE.LE&&-1===this._item&&null!==this._leaf.prevLeaf){this._leaf=this._leaf.prevLeaf;this._item=this._leaf.records.length-1}if(-1===this._item){this._eof=!0;this._key=null;this._found=!1;this._record=null}else{this._eof=!1;this._found=this._leaf.keys[this._item]===e;this._key=this._leaf.keys[this._item];this._record=this._leaf.records[this._item]}return!this._eof}skip(e=1){"number"!=typeof e&&(e=1);-1!==this._item&&null!==this._leaf||(this._eof=!0);if(e>0){for(;!this._eof&&this._leaf.keys.length-this._item-1<e;){e=e-this._leaf.keys.length+this._item;this._leaf=this._leaf.nextLeaf;null===this._leaf?this._eof=!0:this._item=0}this._eof||(this._item=this._item+e)}else{e=-e;for(;!this._eof&&this._item<e;){e=e-this._item-1;this._leaf=this._leaf.prevLeaf;null===this._leaf?this._eof=!0:this._item=this._leaf.keys.length-1}this._eof||(this._item=this._item-e)}if(this._eof){this._item=-1;this._found=!1;this._key=null;this._record=null}else{this._found=!0;this._key=this._leaf.keys[this._item];this._record=this._leaf.records[this._item]}return this._found}goto(e){if(e<0){this.goBottom();this._eof||this.skip(e+1)}else{this.goTop();this._eof||this.skip(e-1)}return this._found}keynum(){if(null===this._leaf||-1===this._item)return-1;let e=this._item+1,t=this._leaf;for(;null!==t.prevLeaf;)e+=(t=t.prevLeaf).keys.length;return e}goTop(){this._leaf=this._root;for(;!this._leaf.isLeaf();)this._leaf=this._leaf.nodePointers[0];if(0===this._leaf.keys.length){this._item=-1;this._eof=!0;this._found=!1;this._key=null;this._record=null}else{this._item=0;this._eof=!1;this._found=!0;this._key=this._leaf.keys[0];this._record=this._leaf.records[0]}return this._found}goBottom(){this._leaf=this._root;for(;!this._leaf.isLeaf();)this._leaf=this._leaf.nodePointers[this._leaf.nodePointers.length-1];if(0===this._leaf.keys.length){this._item=-1;this._eof=!0;this._found=!1;this._key=null;this._record=null}else{this._item=this._leaf.keys.length-1;this._eof=!1;this._found=!0;this._key=this._leaf.keys[this._item];this._record=this._leaf.records[this._item]}return this._found}pack(e=null){let t,r;this.goTop(0);if(this._leaf===this._root)return!1;let n=new LeafNode(this._nodeId++),s=0,i=this._leaf,o=0,a=[],c=[];for(;;){BTree._modifyNode(e,n);BTree._modifyNode(e,i);n.keys[s]=i.keys[o];n.records[s]=i.records[o];0===s&&c.push(n);if(o===i.keys.length-1){if(null===i.nextLeaf)break;i=i.nextLeaf;o=0}else o++;if(s===this._maxkey-1){const e=new LeafNode(this._nodeId++);n.nextLeaf=e;e.prevLeaf=n;n=e;s=0}else s++}let l,h,u=this._minkyl-n.keys.length;i=n.prevLeaf;if(u>0&&null!==i){BTree._modifyNode(e,i);for(r=u-1;r>=0;--r){n.keys.unshift(i.keys.pop());n.records.unshift(i.records.pop())}}for(r=1,t=c.length;r<t;++r)a.push(c[r].keys[0]);a[a.length]=null;for(;null!==a[0];){l=a;h=c;a=[];c=[];s=this._maxkey+1;r=0;t=l.length;for(;r<t;r++){if(s>this._maxkey){n=new InnerNode(this._nodeId++);s=0;c.push(n)}n.keys[s]=l[r];n.nodePointers[s]=h[r];s++;BTree._modifyNode(e,n)}if((u=this._minkyn-n.keys.length+1)>0&&c.length>1){i=c[c.length-2];BTree._modifyNode(e,i);for(r=u-1;r>=0;--r){n.keys.unshift(i.keys.pop());n.nodePointers.unshift(i.nodePointers.pop())}}r=0;t=c.length;for(;r<t;++r)a.push(c[r].keys.pop())}this._root=c[0];this.goTop();return this._found}_del(e,t=null,r=null){const n=[];let s,i=null,o=-1;this._leaf=this._root;for(;!this._leaf.isLeaf();){n.push(this._leaf);i=this._leaf;o=this._leaf.getItem(e);this._leaf=this._leaf.nodePointers[o]}this._item=this._leaf.getItem(e,!1);if(-1===this._item){this._found=!1;return}this._found=!0;this._leaf.keys.splice(this._item,1);this._leaf.records.splice(this._item,1);BTree._modifyNode(t,this._leaf);this._length--;if(this._leaf===this._root)return;if(this._leaf.keys.length>=this._minkyl){0===this._item&&BTree._fixNodes(n,e,this._leaf.keys[0],t);return}let a=0===o?null:i.nodePointers[o-1];if(null!==a&&a.keys.length>this._minkyl){s=0===this._item?e:this._leaf.keys[0];this._leaf.keys.unshift(a.keys.pop());this._leaf.records.unshift(a.records.pop());BTree._fixNodes(n,s,this._leaf.keys[0],t);BTree._modifyNode(t,a);return}let c=o===i.keys.length?null:i.nodePointers[o+1];if(null!==c&&c.keys.length>this._minkyl){this._leaf.keys.push(c.keys.shift());this._leaf.records.push(c.records.shift());0===this._item&&BTree._fixNodes(n,e,this._leaf.keys[0],t);BTree._fixNodes(n,this._leaf.keys[this._leaf.keys.length-1],c.keys[0],t);BTree._modifyNode(t,c);return}if(null!==a){s=0===this._item?e:this._leaf.keys[0];a.merge(this._leaf,i,s);BTree._modifyNode(t,a);BTree._modifyNode(r,this._leaf);this._leaf=a}else{s=c.keys[0];this._leaf.merge(c,i,s);BTree._modifyNode(t,this._leaf);BTree._modifyNode(r,c);0===this._item&&BTree._fixNodes(n,e,this._leaf.keys[0],t)}if(1===n.length&&0===i.keys.length){this._root=this._leaf;return}let l,h=n.pop();for(;h.keys.length<this._minkyn&&n.length>0;){if(null!==(c=(l=(i=n.pop()).getItem(s))===i.keys.length?null:i.nodePointers[l+1])&&c.keys.length>this._minkyn){h.keys.push(i.keys[l]);i.keys[l]=c.keys.shift();h.nodePointers.push(c.nodePointers.shift());BTree._modifyNode(t,h);BTree._modifyNode(t,c);BTree._modifyNode(t,i);break}if(null!==(a=0===l?null:i.nodePointers[l-1])&&a.keys.length>this._minkyn){h.keys.unshift(i.keys[l-1]);i.keys[l-1]=a.keys.pop();h.nodePointers.unshift(a.nodePointers.pop());BTree._modifyNode(t,h);BTree._modifyNode(t,a);BTree._modifyNode(t,i);break}if(null!==a){s=a.merge(h,i,l-1);BTree._modifyNode(r,h);BTree._modifyNode(t,a);h=a}else if(null!==c){s=h.merge(c,i,l);BTree._modifyNode(r,c);BTree._modifyNode(t,h)}if(0===n.length&&0===i.keys.length){this._root=h;break}h=i}}static _fixNodes(e,t,r,n){let s,i=e.length,o=!0;do{for(let a=(s=e[--i].keys).length-1;a>=0;--a)if(s[a]===t){s[a]=r;BTree._modifyNode(n,e[i]);o=!1;break}}while(o&&i>0)}goToLowerBound(e,t=!1){if(e!==undefined){let r=this.seek(e,BTree.NEAR_MODE.GE);r&&t&&(r=this.skip());return r}return this.goTop()}goToUpperBound(e,t=!1){if(e!==undefined){let r=this.seek(e,BTree.NEAR_MODE.LE);r&&t&&(r=this.skip(-1));return r}return this.goBottom()}static _modifyNode(e,t){e instanceof Set&&t!==undefined&&e.add(t)}static loadFromJSON(e,t,r){const n=new BTree(r),s=t.get(e);n._root=s;const i=[s];let o=0;for(;i.length>0;){const e=i.shift();o=Math.max(e.id,o);if(e.isLeaf()){let r=t.get(prevLeaf);e.prevLeaf=r||null;e.prevLeaf&&i.push(e.prevLeaf);r=t.get(nextLeaf);e.nextLeaf=r||null;e.nextLeaf&&i.push(e.nextLeaf)}else for(let r=0;r<e.nodePointers.length;++r){let n=t.get(e.nodePointers[r]);(n=n||null)&&i.push(n);e.nodePointers[r]=n}}n._nodeId=o+1}dump(e){e.clear();const t=[this._root];for(;t.length>0;){const r=t.shift();e.set(r.id,r.toJSON());if(r.isLeaf()){r.prevLeaf&&t.push(r.prevLeaf);r.nextLeaf&&t.push(r.nextLeaf)}else for(let e=0;e<r.nodePointers.length;++e)r.nodePointers[e]&&t.push(r.nodePointers[e])}return this._root.id}}BTree.NEAR_MODE={NONE:0,LE:1,GE:2};Class.register(BTree);class TreeTransaction{constructor(e){this._tree=e;this._modified=new Set;this._removed=new Set}merge(e){if(!(e instanceof TreeTransaction))return this;this._removed=this._removed.union(e.removed);this._modified=this._modified.union(e.modified).difference(this._removed);return this}get modified(){return this._modified}get removed(){return this._removed}get root(){return this._tree._root}get length(){return this._tree.length}get currentKey(){return this._tree.currentKey}get currentRecord(){this._tree.currentLeaf!==undefined&&this._modified.add(this._tree.currentLeaf);return this._tree.currentRecord}insert(e,t){return this._tree.insert(e,t,this._modified)}remove(e){return this._tree.remove(e,this._modified,this._removed)}seek(e,t=BTree.NEAR_MODE.NONE){return this._tree.seek(e,t)}skip(e=1){return this._tree.skip(e)}goto(e){return this._tree.goto(e)}keynum(){return this._tree.keynum()}goTop(){return this._tree.goTop()}goBottom(){return this._tree.goBottom()}pack(){return this._tree.pack()}goToLowerBound(e,t=!1){return this._tree.goToLowerBound(e,t)}goToUpperBound(e,t=!1){return this._tree.goToUpperBound(e,t)}}Class.register(TreeTransaction);class BufferUtils{static _codePointTextDecoder(e){if("undefined"==typeof TextDecoder)throw new Error("TextDecoder not supported");if(null===BufferUtils._ISO_8859_15_DECODER)throw new Error("TextDecoder does not supprot iso-8859-15");if(BufferUtils._ISO_8859_15_DECODER===undefined)try{BufferUtils._ISO_8859_15_DECODER=new TextDecoder("iso-8859-15")}finally{BufferUtils._ISO_8859_15_DECODER=null}return BufferUtils._ISO_8859_15_DECODER.decode(e).replace("€","¤").replace("Š","¦").replace("š","¨").replace("Ž","´").replace("ž","¸").replace("Œ","¼").replace("œ","½").replace("Ÿ","¾")}static _tripletToBase64(e){return BufferUtils._BASE64_LOOKUP[e>>18&63]+BufferUtils._BASE64_LOOKUP[e>>12&63]+BufferUtils._BASE64_LOOKUP[e>>6&63]+BufferUtils._BASE64_LOOKUP[63&e]}static _base64encodeChunk(e,t,r){let n;const s=[];for(let i=t;i<r;i+=3){n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]);s.push(BufferUtils._tripletToBase64(n))}return s.join("")}static _base64fromByteArray(e){let t;const r=e.length,n=r%3;let s="";const i=[];for(let o=0,a=r-n;o<a;o+=16383)i.push(BufferUtils._base64encodeChunk(e,o,o+16383>a?a:o+16383));if(1===n){t=e[r-1];s+=BufferUtils._BASE64_LOOKUP[t>>2];s+=BufferUtils._BASE64_LOOKUP[t<<4&63];s+="=="}else if(2===n){t=(e[r-2]<<8)+e[r-1];s+=BufferUtils._BASE64_LOOKUP[t>>10];s+=BufferUtils._BASE64_LOOKUP[t>>4&63];s+=BufferUtils._BASE64_LOOKUP[t<<2&63];s+="="}i.push(s);return i.join("")}static toBase64(e){if("undefined"!=typeof Buffer&&"undefined"==typeof window)return new Buffer(e).toString("base64");if("undefined"!=typeof TextDecoder&&null!==BufferUtils._ISO_8859_15_DECODER)try{return btoa(BufferUtils._codePointTextDecoder(new Uint8Array(e)))}catch(t){}return BufferUtils._base64fromByteArray(new Uint8Array(e))}static fromBase64(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}BufferUtils.BASE64_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";BufferUtils._BASE64_LOOKUP=[];for(let t=0,r=BufferUtils.BASE64_ALPHABET.length;t<r;++t)BufferUtils._BASE64_LOOKUP[t]=BufferUtils.BASE64_ALPHABET[t];Class.register(BufferUtils);class JSONUtils{static stringify(e){return JSON.stringify(e,JSONUtils.jsonifyType)}static parse(e){return JSON.parse(e,JSONUtils.parseType)}static parseType(e,t){if(t[JSONUtils.TYPE_SYMBOL])switch(t[JSONUtils.TYPE_SYMBOL]){case"Uint8Array":return BufferUtils.fromBase64(t[JSONUtils.VALUE_SYMBOL]);case"Set":return Set.from(t[JSONUtils.VALUE_SYMBOL])}return t}static jsonifyType(e,t){return t instanceof Uint8Array?JSONUtils.typedObject("Uint8Array",BufferUtils.toBase64(t)):t instanceof Set?JSONUtils.typedObject("Set",Array.from(t)):t}static typedObject(e,t){const r={};r[JSONUtils.TYPE_SYMBOL]=e;r[JSONUtils.VALUE_SYMBOL]=t;return r}}JSONUtils.TYPE_SYMBOL="__";JSONUtils.VALUE_SYMBOL="value";Class.register(JSONUtils);class Log{static get instance(){Log._instance||(Log._instance=new Log(new LogNative));return Log._instance}constructor(e){this._native=e}setLoggable(e,t){this._native.setLoggable(e,t)}get level(){return this._native._global_level}set level(e){this._native._global_level=e}msg(e,t,r){if(this._native.isLoggable(t,e)){for(let e=0;e<r.length;++e){"function"==typeof r[e]&&(r[e]=r[e]());"object"==typeof r[e]&&("function"==typeof r[e].toString?r[e]=r[e].toString():r[e].constructor&&r[e].constructor.name?r[e]=`{Object: ${r[e].constructor.name}}`:r[e]="{Object}")}this._native.msg(e,t,r)}}static d(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.DEBUG,e,r)}static e(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.ERROR,e,r)}static i(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.INFO,e,r)}static v(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.VERBOSE,e,r)}static w(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.WARNING,e,r)}static t(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.TRACE,e,r)}}Log.Level={TRACE:1,VERBOSE:2,DEBUG:3,INFO:4,WARNING:5,ERROR:6,ASSERT:7,toStringTag:function(e){switch(e){case Log.TRACE:return"T";case Log.VERBOSE:return"V";case Log.DEBUG:return"D";case Log.INFO:return"I";case Log.WARNING:return"W";case Log.ERROR:return"E";case Log.ASSERT:return"A";default:return"*"}}};Log.TRACE=Log.Level.TRACE;Log.VERBOSE=Log.Level.VERBOSE;Log.DEBUG=Log.Level.DEBUG;Log.INFO=Log.Level.INFO;Log.WARNING=Log.Level.WARNING;Log.ERROR=Log.Level.ERROR;Log.ASSERT=Log.Level.ASSERT;Log._instance=null;Log.d.tag=(e=>Log.d.bind(null,e));Log.e.tag=(e=>Log.e.bind(null,e));Log.i.tag=(e=>Log.i.bind(null,e));Log.v.tag=(e=>Log.v.bind(null,e));Log.w.tag=(e=>Log.w.bind(null,e));Log.t.tag=(e=>Log.t.bind(null,e));Class.register(Log);class LRUMap{constructor(e){this._maxSize=e;this._map=new Map;this._numAccesses=new Map;this._accessQueue=[]}get size(){return this._map.size}clear(){this._numAccesses.clear();this._accessQueue=[];return this._map.clear()}"delete"(e){return this._map["delete"](e)}entries(){return this._map.entries()}forEach(e,t){return this._map.forEach(e,t)}get(e){this.access(e);return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}evict(e=1){for(;e>0&&this._accessQueue.length>0;){const t=this._accessQueue.shift();let r=this._numAccesses.get(t);--r;this._numAccesses.set(t,r);if(0===r){this._numAccesses["delete"](t);this["delete"](t)&&--e}}}access(e){if(!this._map.has(e))return;let t=0;this._numAccesses.has(e)&&(t=this._numAccesses.get(e));++t;this._numAccesses.set(e,t);this._accessQueue.push(e)}set(e,t){this.size>=this._maxSize&&this.evict();this._map.set(e,t);this.access(e)}values(){return this._map.values()}[Symbol.iterator](){return this._map.entries()}}Class.register(LRUMap);class ObjectUtils{static byKeyPath(e,t){if(!Array.isArray(t))return e[t];let r=e;for(const n of t){if(r===undefined)return undefined;r=r[n]}return r}}Class.register(ObjectUtils);class Observable{static get WILDCARD(){return"*"}constructor(){this._listeners=new Map}on(e,t){if(this._listeners.has(e))return this._listeners.get(e).push(t)-1;this._listeners.set(e,[t]);return 0}off(e,t){this._listeners.has(e)&&this._listeners.get(e)[t]&&delete this._listeners.get(e)[t]}fire(e,...t){if(this._listeners.has(e))for(const r in this._listeners.get(e)){this._listeners.get(e)[r].apply(null,t)}if(this._listeners.has(Observable.WILDCARD))for(const r in this._listeners.get(Observable.WILDCARD)){this._listeners.get(Observable.WILDCARD)[r].apply(null,arguments)}}bubble(e,...t){for(const r of t){let t;t=r==Observable.WILDCARD?function(){this.fire.apply(this,arguments)}:function(){this.fire.apply(this,[r,...arguments])};e.on(r,t.bind(this))}}}Class.register(Observable);Set.prototype.union=function(e){const t=new Set(this);for(const r of e)t.add(r);return t};Set.prototype.intersection=function(e){const t=new Set;for(const r of e)this.has(r)&&t.add(r);return t};Set.prototype.difference=function(e){const t=new Set(this);for(const r of e)t["delete"](r);return t};Set.prototype.equals=function(e){if(this.size!==e.size)return!1;for(const t of e)if(!this.has(t))return!1;return!0};Set.from=function(e){return e&&"function"==typeof e[Symbol.iterator]&&"string"!=typeof e?new Set(e):new Set([e])};Set.sampleElement=function(e){return e.size>0?e.values().next().value:undefined};class Synchronizer extends Observable{constructor(){super();this._queue=[];this._working=!1}push(e){return new Promise((t,r)=>{this._queue.push({fn:e,resolve:t,error:r});this._working||this._doWork()["catch"](Log.w.tag(Synchronizer))})}_doWork(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._working=!0;e.fire("work-start",e);for(;e._queue.length;){const r=e._queue.shift();try{const e=yield r.fn();r.resolve(e)}catch(t){r.error&&r.error(t)}}e._working=!1;e.fire("work-end",e)})()}get working(){return this._working}}Class.register(Synchronizer);class CachedBackend{constructor(e){this._backend=e;this._cache=new LRUMap(CachedBackend.MAX_CACHE_SIZE)}get connected(){return this._backend.connected}get indices(){return this._backend.indices}_retrieveValues(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=[];for(const n of e)r.push(t.get(n));return Promise.all(r)})()}get(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._cache.has(e))return t._cache.get(e);const r=yield t._backend.get(e);t._cache.set(e,r);return r})()}put(e,t){this._cache.set(e,t);return this._backend.put(e,t)}remove(e){this._cache["delete"](e);return this._backend.remove(e)}keys(e=null){return this._backend.keys(e)}values(e=null){return this._backend.values(e)}keyStream(e,t=!0,r=null){return this._backend.keyStream(e,t,r)}valueStream(e,t=!0,r=null){return this._backend.valueStream(e,t,r)}maxValue(e=null){return this._backend.maxValue(e)}maxKey(e=null){return this._backend.maxKey(e)}minKey(e=null){return this._backend.minKey(e)}minValue(e=null){return this._backend.minValue(e)}count(e=null){return this._backend.count(e)}commit(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation")})()}abort(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation")})()}_apply(e){this._applyLocally(e);return this._backend._apply(e)}_applyLocally(e){e._truncated&&this._cache.clear();for(const t of e._removed)this._cache["delete"](t);for(const[t,r]of e._modified)this._cache.set(t,r)}truncate(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._cache.clear();return e._backend.truncate()})()}index(e){return this._backend.index(e)}createIndex(e,t,r=!1){return this._backend.createIndex(e,t,r)}deleteIndex(e){return this._backend.deleteIndex(e)}close(){return this._backend.close()}transaction(){throw new Error("Unsupported operation")}applyCombined(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return[yield t._backend.applyCombined(e),function(){return t._applyLocally(e)}]})()}isSynchronous(){return!1}}CachedBackend.MAX_CACHE_SIZE=5e3;Class.register(CachedBackend);class InMemoryIndex{constructor(e,t,r=!1,n=!1){this._objectStore=e;this._keyPath=t;this._multiEntry=r;this._unique=n;this._tree=new BTree}truncate(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._tree=new BTree})()}_indexKey(e,t){return this.keyPath?t===undefined?undefined:ObjectUtils.byKeyPath(t,this.keyPath):e}get keyPath(){return this._keyPath}get multiEntry(){return this._multiEntry}_insert(e,t,r){r=r||this._tree;this._multiEntry&&Array.isArray(t)||(t=[t]);for(const n of t)if(r.seek(n)){if(this._unique)throw new Error(`Uniqueness constraint violated for key ${e} on path ${this._keyPath}`);r.currentRecord.add(e)}else r.insert(n,this._unique?e:Set.from(e))}put(e,t,r){const n=this._tree.transaction(),s=this._indexKey(e,r),i=this._indexKey(e,t);s!==undefined&&this._remove(e,s,n);i!==undefined&&this._insert(e,i,n);return n}remove(e,t){const r=this._tree.transaction();if(t!==undefined){const n=this._indexKey(e,t);this._remove(e,n,r)}return r}_remove(e,t,r){r=r||this._tree;this._multiEntry&&Array.isArray(t)||(t=[t]);for(const n of t)r.seek(n)&&(!this._unique&&r.currentRecord.size>1?r.currentRecord["delete"](e):r.remove(n))}_retrieveValues(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=[];for(const n of e)r.push(t._objectStore.get(n));return Promise.all(r)})()}values(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.keys(e);return t._retrieveValues(r)})()}keys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r=new Set;if(e instanceof KeyRange&&e.exactMatch){t._tree.seek(e.lower)&&(r=Set.from(t._tree.currentRecord));return r}if(e instanceof KeyRange){if(!t._tree.goToLowerBound(e.lower,e.lowerOpen))return r}else t._tree.goTop();for(;!(e instanceof KeyRange)||e.includes(t._tree.currentKey);){r=r.union(Set.from(t._tree.currentRecord));if(!t._tree.skip())break}return r})()}keyStream(e,t=!0,r=null){if(!this._unique)throw new Error("Unsupported operation for non-unique indices");if(r instanceof KeyRange){if(t){if(!this._tree.goToLowerBound(r.lower,r.lowerOpen))return Promise.resolve()}else if(!this._tree.goToUpperBound(r.upper,r.upperOpen))return Promise.resolve()}else t?this._tree.goTop():this._tree.goBottom();for(;(!(r instanceof KeyRange)||r.includes(this._tree.currentKey))&&e(this._tree.currentRecord)&&this._tree.skip(t?1:-1););return Promise.resolve()}valueStream(e,t=!0,r=null){var n=this;return(0,_asyncToGenerator3["default"])(function*(){if(!n._unique)throw new Error("Unsupported operation for non-unique indices");if(r instanceof KeyRange){if(t){if(!n._tree.goToLowerBound(r.lower,r.lowerOpen))return}else if(!n._tree.goToUpperBound(r.upper,r.upperOpen))return}else t?n._tree.goTop():n._tree.goBottom();for(;(!(r instanceof KeyRange)||r.includes(n._tree.currentKey))&&e(yield n._objectStore.get(n._tree.currentRecord),n._tree.currentRecord)&&n._tree.skip(t?1:-1););})()}maxValues(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.maxKeys(e);return t._retrieveValues(r)})()}maxKeys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e instanceof KeyRange;return t._tree.goToUpperBound(r?e.upper:undefined,!!r&&e.upperOpen)?Set.from(t._tree.currentRecord):new Set})()}minValues(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.minKeys(e);return t._retrieveValues(r)})()}minKeys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e instanceof KeyRange;return t._tree.goToLowerBound(r?e.lower:undefined,!!r&&e.lowerOpen)?Set.from(t._tree.currentRecord):new Set})()}count(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield t.keys(e)).size})()}}Class.register(InMemoryIndex);class InMemoryBackend{constructor(e,t=null){this._cache=new Map;this._indices=new Map;this._primaryIndex=new InMemoryIndex(this,undefined,!1,!0);this._tableName=e;this._codec=t}get connected(){return!0}get indices(){return this._indices}getSync(e){return this.decode(this._cache.get(e),e)}get(e){return Promise.resolve(this.getSync(e))}putSync(e,t){const r=this.getSync(e);this._cache.set(e,this.encode(t));this._primaryIndex.put(e,t,r);for(const n of this._indices.values())n.put(e,t,r)}put(e,t){this.putSync(e,t);return Promise.resolve()}removeSync(e){const t=this.getSync(e);this._cache["delete"](e);this._primaryIndex.remove(e,t);for(const r of this._indices.values())r.remove(e,t)}remove(e){this.removeSync(e);return Promise.resolve()}values(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(null!==e&&e instanceof Query)return e.values(t);const r=[];for(const n of t.keys(e))r.push(yield t.get(n));return Promise.resolve(r)})()}keys(e=null){return null!==e&&e instanceof Query?e.keys(this):this._primaryIndex.keys(e)}keyStream(e,t=!0,r=null){return this._primaryIndex.keyStream(e,t,r)}valueStream(e,t=!0,r=null){return this._primaryIndex.valueStream(e,t,r)}maxValue(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.maxKey(e);return t.get(r)})()}maxKey(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._primaryIndex.maxKeys(e);return Set.sampleElement(r)})()}minValue(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.minKey(e);return t.get(r)})()}minKey(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._primaryIndex.minKeys(e);return Set.sampleElement(r)})()}count(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield t.keys(e)).size})()}index(e){return this._indices.get(e)}_apply(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){e._truncated&&(yield t.truncate());for(const n of e._removed)yield t._cache["delete"](n);for(const[n,s]of e._modified)yield t._cache.set(n,t.encode(s));const r=[InMemoryBackend._indexApply(t._primaryIndex,e)];for(const n of t._indices.values())r.push(InMemoryBackend._indexApply(n,e));return Promise.all(r)})()}static _indexApply(e,t){return(0,_asyncToGenerator3["default"])(function*(){t._truncated&&(yield e.truncate());for(const r of t._removed)yield e.remove(r,t._originalValues.get(r));for(const[r,n]of t._modified)yield e.put(r,n,t._originalValues.get(r))})()}truncate(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._cache.clear();const t=[e._primaryIndex.truncate()];for(const r of e._indices.values())t.push(r.truncate());return Promise.all(t)})()}map(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){for(const[r,n]of t._cache)e(r,n)})()}createIndex(e,t,r=!1){const n=new InMemoryIndex(this,t=t||e,r);this._indices.set(e,n)}decode(e,t){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.decode(e,t):e}encode(e){return e===undefined?undefined:null!==this._codec&&this._codec!==undefined?this._codec.encode(e):e}get tableName(){return this._tableName}applyCombined(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return function(){return t._apply(e)}})()}isSynchronous(){return!0}isCached(e){return!0}}Class.register(InMemoryBackend);class KeyRange{constructor(e,t,r,n){this._lower=e;this._upper=t;this._lowerOpen=r;this._upperOpen=n}get lower(){return this._lower}get upper(){return this._upper}get lowerOpen(){return this._lowerOpen}get upperOpen(){return this._upperOpen}get exactMatch(){return this._lower===this._upper&&!this._lowerOpen&&!this.upperOpen}includes(e){return(this._lower===undefined||this._lower<e||!this._lowerOpen&&this._lower===e)&&(this._upper===undefined||this._upper>e||!this._upperOpen&&this._upper===e)}static upperBound(e,t=!1){return new KeyRange(undefined,e,!1,t)}static lowerBound(e,t=!1){return new KeyRange(e,undefined,t,!1)}static bound(e,t,r=!1,n=!1){return new KeyRange(e,t,r,n)}static only(e){return new KeyRange(e,e,!1,!1)}}Class.register(KeyRange);class ObjectStore{constructor(e,t,r){this._backend=e;this._db=t;this._name=r;this._stateStack=[];this._backendInfo=new TransactionInfo(this._backend,null);this._transactions=new Map;this._transactions.set(ObjectStore.BACKEND_ID,this._backendInfo);this._snapshotManager=new SnapshotManager;this._synchronizer=new Synchronizer}get jungleDB(){return this._db}get connected(){return this._backend.connected}get _currentState(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].transaction:this._backend}get _currentStateInfo(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1]:this._backendInfo}get _currentStateId(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].id:ObjectStore.BACKEND_ID}get indices(){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.indices}get(e){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.get(e)}put(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(!r._backend.connected)throw new Error("JungleDB is not connected");const n=r.transaction();yield n.put(e,t);return n.commit()})()}remove(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._backend.connected)throw new Error("JungleDB is not connected");const r=t.transaction();yield r.remove(e);return r.commit()})()}keys(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return null!==e&&e instanceof Query?e.keys(this._currentState):this._currentState.keys(e)}values(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return null!==e&&e instanceof Query?e.values(this._currentState):this._currentState.values(e)}keyStream(e,t=!0,r=null){return this._currentState.keyStream(e,t,r)}valueStream(e,t=!0,r=null){return this._currentState.valueStream(e,t,r)}maxValue(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.maxValue(e)}maxKey(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.maxKey(e)}minKey(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.minKey(e)}minValue(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.minValue(e)}count(e=null){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.count(e)}commit(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._isCommittable(e)){yield t.abort(e);return!1}yield t._commitInternal(e);return!0})()}_isCommittable(e){if(!this._backend.connected)throw new Error("JungleDB is not connected");if(!(e instanceof Transaction&&e.state===Transaction.STATE.OPEN&&this._transactions.has(e.id)))throw new Error("Can only commit open transactions");return this._transactions.get(e.id).isCommittable()}_commitBackend(){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Cannot commit object stores")})()}_commitInternal(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t._transactions.get(e.id);if(t._stateStack.length>=ObjectStore.MAX_STACK_SIZE){Log.e(ObjectStore,`Transaction stack size exceeded ${t.toStringFull()}`);throw new Error("Transaction stack size exceeded")}t._stateStack.push(r);r.close();r.isFlushable()&&(yield t._flattenState(e))})()}_setParent(e){throw new Error("Unsupported operation")}abort(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._backend.connected)throw new Error("JungleDB is not connected");if(e instanceof Snapshot)return t._snapshotManager.abortSnapshot(e);if(!(e instanceof Transaction&&e.state===Transaction.STATE.OPEN&&t._transactions.has(e.id)))throw new Error("Can only abort open transactions");const r=t._transactions.get(e.id);r.abort();r.parent&&0===r.parent.numOpenChildren&&(yield t._flattenState());return!0})()}_flattenState(e){return this._synchronizer.push(()=>this._flattenStateInternal(e))}_flattenStateInternal(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(e&&e instanceof Transaction){const r=t._transactions.get(e.id);if(!r.isFlushable())return!1;const n=r.parent.transaction,s=function(){r.flush();t._transactions["delete"](e.id);const n=t._stateStack.indexOf(r);n>=0&&t._stateStack.splice(n,1);t._flattenState()["catch"](Log.w.tag(ObjectStore))};if(null===e.dependency){r.parent.isBackend()&&(yield t._snapshotManager.applyTx(e,n));yield n._apply(e);s();return!0}return yield e.dependency.onFlushable(e,s,function(){return t._snapshotManager.applyTx(e,n)})}for(;t._stateStack.length>0&&(yield t._flattenStateInternal(t._currentState)););for(;t._stateStack.length>0&&(yield t._flattenStateInternal(t._stateStack[0].transaction)););return!1})()}index(e){if(!this._backend.connected)throw new Error("JungleDB is not connected");return this._currentState.index(e)}createIndex(e,t,r=!1){return this._backend.createIndex(e,t,r)}deleteIndex(e){return this._backend.deleteIndex(e)}transaction(e=!0){if(!this._backend.connected)throw new Error("JungleDB is not connected");const t=new Transaction(this,this._currentState,this,e);this._transactions.set(t.id,new TransactionInfo(t,this._currentStateInfo));return t}synchronousTransaction(e=!0){if(!this._backend.connected)throw new Error("JungleDB is not connected");const t=new SynchronousTransaction(this,this._currentState,this,e);this._transactions.set(t.id,new TransactionInfo(t,this._currentStateInfo));return t}isSynchronous(){return!1}snapshot(){return this._currentStateId!==ObjectStore.BACKEND_ID?this._currentState.snapshot():this._snapshotManager.createSnapshot(this,this._currentState)}_apply(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation")})()}truncate(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(!e._backend.connected)throw new Error("JungleDB is not connected");const t=e.transaction();yield t.truncate();return t.commit()})()}close(){if(this._stateStack.length>0)throw new Error("Cannot close database while transactions are active");return this._backend.close()}toStringFull(){return`ObjectStore{\n    stack=[${this._stateStack.map(e=>`{tx=${e.toStringShort()}, open=${this._openTransactions.get(e.id)?this._openTransactions.get(e.id).size:0}}`)}],\n    db=${this._db}/${this._name?this._name:"unnamed"}\n}`}toString(){return`ObjectStore{stackSize=${this._stateStack.length}, db=${this._db}/${this._name?this._name:"unnamed"}}`}}ObjectStore.MAX_STACK_SIZE=10;ObjectStore.BACKEND_ID="backend";Class.register(ObjectStore);class TransactionInfo{constructor(e,t,r=[]){this.transaction=e;this.children=r;this._parentInfo=t;this._open=!0;this._parentInfo&&this._parentInfo.addChild(this)}addChild(e){this.children.push(e)}removeChild(e){const t=this.children.indexOf(e);t>=0&&this.children.splice(t,1)}flush(){if(!this.isBackend()){const e=this.parent;this.parent.removeChild(this);for(const t of this.children.slice())t.parent=e;this.children=[];this._parentInfo=null}}abort(){this.isBackend()||this.parent.removeChild(this)}close(){this._open=!1}get parent(){return this._parentInfo}set parent(e){this.parent.removeChild(this);this._parentInfo=e;this.parent.addChild(this);this.transaction._setParent(e.transaction)}get id(){return this.isBackend()?ObjectStore.BACKEND_ID:this.transaction.id}isBackend(){return null===this._parentInfo}isOpen(){return this._open}get numOpenChildren(){return this.children.filter(e=>e.isOpen()).length}isCommittable(){return this._parentInfo&&this._parentInfo.children.every(e=>e.isOpen())}isFlushable(){return this.parent&&0===this.parent.numOpenChildren&&(null===this.transaction.dependency||this.parent.isBackend())}}class Query{static _parseKeyRange(e,t,r){switch(e){case Query.OPERATORS.GT:return KeyRange.lowerBound(t,!0);case Query.OPERATORS.GE:return KeyRange.lowerBound(t,!1);case Query.OPERATORS.LT:return KeyRange.upperBound(t,!0);case Query.OPERATORS.LE:return KeyRange.upperBound(t,!1);case Query.OPERATORS.EQ:return KeyRange.only(t);case Query.OPERATORS.BETWEEN:return KeyRange.bound(t,r,!0,!0);case Query.OPERATORS.WITHIN:return KeyRange.bound(t,r,!1,!1)}throw new Error("Unknown operator")}static and(e){const t=Array.from(arguments);return new Query(t,Query.OPERATORS.AND)}static or(e){const t=Array.from(arguments);return new Query(t,Query.OPERATORS.OR)}static max(e){return new Query(e,Query.OPERATORS.MAX)}static min(e){return new Query(e,Query.OPERATORS.MIN)}static lt(e,t){return new Query(e,Query.OPERATORS.LT,t)}static le(e,t){return new Query(e,Query.OPERATORS.LE,t)}static gt(e,t){return new Query(e,Query.OPERATORS.GT,t)}static ge(e,t){return new Query(e,Query.OPERATORS.GE,t)}static eq(e,t){return new Query(e,Query.OPERATORS.EQ,t)}static between(e,t,r){return new Query(e,Query.OPERATORS.BETWEEN,t,r)}static within(e,t,r){return new Query(e,Query.OPERATORS.WITHIN,t,r)}constructor(e,t,r,n){if(Array.isArray(e)){if(e.some(e=>!(e instanceof Query)))throw new Error("Invalid query");if(Query.COMBINED_OPERATORS.indexOf(t)<0)throw new Error("Unknown operator");this._queryType=Query.Type.COMBINED;this._queries=e;this._op=t}else{if(Query.RANGE_OPERATORS.indexOf(t)>=0){this._queryType=Query.Type.RANGE;this._keyRange=Query._parseKeyRange(t,r,n)}else{if(!(Query.ADVANCED_OPERATORS.indexOf(t)>=0))throw new Error("Unknown operator");this._queryType=Query.Type.ADVANCED;this._op=t}this._indexName=e}}values(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._execute(e),n=[];for(const t of r)n.push(e.get(t));return Promise.all(n)})()}keys(e){return this._execute(e)}_execute(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){switch(t._queryType){case Query.Type.COMBINED:return Promise.resolve(t._executeCombined(e));case Query.Type.ADVANCED:return Promise.resolve(t._executeAdvanced(e));case Query.Type.RANGE:return t._executeRange(e)}return Promise.resolve(new Set)})()}_executeCombined(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=[];for(const s of t._queries)r.push(s._execute(e));const n=yield Promise.all(r);if(t._op===Query.OPERATORS.AND){if(0===n.length)return new Set;if(1===n.length)return n[0];const e=n.shift(),t=new Set;for(const r of e)n.every(function(e){return e.has(r)})&&t.add(r);return t}if(t._op===Query.OPERATORS.OR){const e=new Set;for(const t of n)t.forEach(function(t){return e.add(t)});return e}return new Set})()}_executeAdvanced(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.index(t._indexName);let n=new Set;switch(t._op){case Query.OPERATORS.MAX:n=yield r.maxKeys();break;case Query.OPERATORS.MIN:n=yield r.minKeys()}return new Set(n)})()}_executeRange(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.index(t._indexName);return new Set(yield r.keys(t._keyRange))})()}}Query.OPERATORS={GT:0,GE:1,LT:2,LE:3,EQ:4,BETWEEN:7,WITHIN:8,MAX:9,MIN:10,AND:11,OR:12};Query.RANGE_OPERATORS=[Query.OPERATORS.GT,Query.OPERATORS.GE,Query.OPERATORS.LT,Query.OPERATORS.LE,Query.OPERATORS.EQ,Query.OPERATORS.BETWEEN,Query.OPERATORS.WITHIN];Query.ADVANCED_OPERATORS=[Query.OPERATORS.MAX,Query.OPERATORS.MIN];Query.COMBINED_OPERATORS=[Query.OPERATORS.AND,Query.OPERATORS.OR];Query.Type={RANGE:0,ADVANCED:1,COMBINED:2};Class.register(Query);class TransactionIndex extends InMemoryIndex{static derive(e,t){const r=new Map;for(const[n,s]of t.indices)r.set(n,new TransactionIndex(e,t,n,s.keyPath,s.multiEntry));return r}get _index(){return this._backend.index(this._databaseDir)}constructor(e,t,r,n,s=!1){super(e,n,s);this._backend=t;this._databaseDir=r}keys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=[];t._objectStore._truncated?r.push(new Set):r.push(t._index.keys(e));r.push(InMemoryIndex.prototype.keys.call(t,e));let[n,s]=yield Promise.all(r);return(n=(n=n.difference(t._objectStore._removed)).difference(t._objectStore._modified.keys())).union(s)})()}values(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.keys(e);return InMemoryIndex.prototype._retrieveValues.call(t,r)})()}maxValues(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.maxKeys(e);return InMemoryIndex.prototype._retrieveValues.call(t,r)})()}maxKeys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r;r=t._objectStore._truncated?new Set:yield t._index.maxKeys(e);let n=Set.sampleElement(r);const s=yield t._backend.get(n);let i=n?ObjectUtils.byKeyPath(s,t.keyPath):undefined;r=(r=r.difference(t._objectStore._removed)).difference(t._objectStore._modified.keys());for(;n!==undefined&&0===r.size;){const s=KeyRange.upperBound(i,!0);r=yield t._index.maxKeys(s);n=Set.sampleElement(r);const o=yield t._backend.get(n);i=n?ObjectUtils.byKeyPath(o,t.keyPath):undefined;r=(r=r.difference(t._objectStore._removed)).difference(t._objectStore._modified.keys());if(i&&null!==e&&!e.includes(i)){r=new Set;break}}const o=yield InMemoryIndex.prototype.maxKeys.call(t,e);if(0===r.size)return o;if(0===o.size)return r;const a=yield t._objectStore.get(Set.sampleElement(o)),c=i,l=ObjectUtils.byKeyPath(a,t.keyPath);return c>l?r:c<l?o:r.union(o)})()}minValues(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.minKeys(e);return InMemoryIndex.prototype._retrieveValues.call(t,r)})()}minKeys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r;r=t._objectStore._truncated?new Set:yield t._index.minKeys(e);let n=Set.sampleElement(r);const s=yield t._backend.get(n);let i=n?ObjectUtils.byKeyPath(s,t.keyPath):undefined;r=(r=r.difference(t._objectStore._removed)).difference(t._objectStore._modified.keys());for(;n!==undefined&&0===r.size;){const s=KeyRange.lowerBound(i,!0);r=yield t._index.minKeys(s);n=Set.sampleElement(r);const o=yield t._backend.get(n);i=n?ObjectUtils.byKeyPath(o,t.keyPath):undefined;r=(r=r.difference(t._objectStore._removed)).difference(t._objectStore._modified.keys());if(i&&null!==e&&!e.includes(i)){r=new Set;break}}const o=yield InMemoryIndex.prototype.minKeys.call(t,e);if(0===r.size)return o;if(0===o.size)return r;const a=yield t._objectStore.get(Set.sampleElement(o)),c=i,l=ObjectUtils.byKeyPath(a,t.keyPath);return c<l?r:c>l?o:r.union(o)})()}count(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield t.keys(e)).size})()}}Class.register(TransactionIndex);class Transaction{constructor(e,t,r,n=!0){this._id=Transaction._instanceCount++;this._objectStore=e;this._parent=t;this._managingBackend=r||t;this._modified=new Map;this._removed=new Set;this._originalValues=new Map;this._truncated=!1;this._indices=TransactionIndex.derive(this,t);this._state=Transaction.STATE.OPEN;this._nested=new Set;this._nestedCommitted=!1;this._dependency=null;this._snapshotManager=new SnapshotManager;this._startTime=Date.now();this._enableWatchdog=n;this._enableWatchdog&&(this._watchdog=setTimeout(()=>{Log.w(Transaction,`Violation: tx id ${this._id} took longer than expected (still open after ${Transaction.WATCHDOG_TIMER/1e3}s), ${this.toString()}.`)},Transaction.WATCHDOG_TIMER))}get objectStore(){return this._objectStore}get nested(){return this._managingBackend instanceof Transaction}get dependency(){return this._dependency}get connected(){return this._managingBackend.connected}get id(){return this._id}get indices(){return this._indices}get state(){return this._state}_apply(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!(e instanceof Transaction))throw new Error("Can only apply transactions");yield t._snapshotManager.applyTx(e,t);t._applySync(e)})()}_applySync(e){e._truncated&&this._truncateSync();for(const[t,r]of e._modified){let n;if(this._originalValues.has(t))n=this._originalValues.get(t);else{n=e._originalValues.get(t);this._originalValues.set(t,n)}this._put(t,r,n)}for(const t of e._removed){let r;if(this._originalValues.has(t))r=this._originalValues.get(t);else{r=e._originalValues.get(t);this._originalValues.set(t,r)}this._remove(t,r)}}truncate(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){return e._truncateSync()})()}_truncateSync(){if(this._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed");this._truncated=!0;this._modified.clear();this._removed.clear();this._originalValues.clear();for(const e of this._indices.values())e.truncate()}commit(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(e!==undefined){if(!t._isCommittable(e)){yield t.abort(e);return!1}yield t._commitInternal(e);return!0}return null!==t._dependency?t._dependency.commit():t._commitBackend()})()}_commitBackend(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(e._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed or in nested state");e._enableWatchdog&&clearTimeout(e._watchdog);const t=Date.now();if(yield e._managingBackend.commit(e)){e._state=Transaction.STATE.COMMITTED;e._performanceCheck(t,"commit");e._performanceCheck();return!0}e._state=Transaction.STATE.CONFLICTED;e._performanceCheck(t,"commit");e._performanceCheck();return!1})()}_performanceCheck(e=this._startTime,t=null){const r=Date.now()-e;t=t?` function '${t}'`:"";r>Transaction.WATCHDOG_TIMER&&Log.w(Transaction,`Violation: tx id ${this._id}${t} took ${(r/1e3).toFixed(2)}s (${this.toString()}).`)}_isCommittable(e){if(e!==undefined){if(!this._nested.has(e)||e.state!==Transaction.STATE.OPEN)throw new Error("Can only commit open, nested transactions");return!this._nestedCommitted}return this._managingBackend._isCommittable(this)}_commitInternal(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){t._nested["delete"](e);t._nestedCommitted=!0;yield t._apply(e);if(0===t._nested.size){t._state=Transaction.STATE.OPEN;t._nestedCommitted=!1}})()}_setParent(e){this._parent=e}abort(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(e!==undefined){if(e instanceof Snapshot)return t._snapshotManager.abortSnapshot(e);if(!t._nested.has(e)||e.state!==Transaction.STATE.OPEN)throw new Error("Can only abort open, nested transactions");t._nested["delete"](e);if(0===t._nested.size){t._state=Transaction.STATE.OPEN;t._nestedCommitted=!1}return!0}return null!==t._dependency?t._dependency.abort():t._abortBackend()})()}_abortBackend(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(e._state===Transaction.STATE.ABORTED||e._state===Transaction.STATE.CONFLICTED)return!0;if(e._state!==Transaction.STATE.OPEN&&e._state!==Transaction.STATE.NESTED)throw new Error("Transaction already closed");e._state===Transaction.STATE.NESTED&&(yield Promise.all(Array.from(e._nested).map(function(e){return e.abort()})));e._enableWatchdog&&clearTimeout(e._watchdog);const t=Date.now();yield e._managingBackend.abort(e);e._state=Transaction.STATE.ABORTED;e._performanceCheck(t,"abort");e._performanceCheck();return!0})()}get(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return t._removed.has(e)?undefined:t._modified.has(e)?t._modified.get(e):t._truncated?undefined:yield t._parent.get(e)})()}put(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(r._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed");const n=yield r.get(e);r._originalValues.has(e)||r._originalValues.set(e,n);r._put(e,t,n)})()}_put(e,t,r){this._removed["delete"](e);this._modified.set(e,t);for(const n of this._indices.values())n.put(e,t,r)}remove(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed");const r=yield t.get(e);if(r!==undefined){t._originalValues.has(e)||t._originalValues.set(e,r);t._remove(e,r)}})()}_remove(e,t){this._removed.add(e);this._modified["delete"](e);for(const r of this._indices.values())r.remove(e,t)}keys(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(null!==e&&e instanceof Query)return e.keys(t);let r=new Set;t._truncated||(r=yield t._parent.keys(e));r=r.difference(t._removed);for(const n of t._modified.keys())(null===e||e.includes(n))&&r.add(n);return r})()}values(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(null!==e&&e instanceof Query)return e.values(t);const r=yield t.keys(e),n=[];for(const e of r)n.push(t.get(e));return Promise.all(n)})()}keyStream(e,t=!0,r=null){var n=this;return(0,_asyncToGenerator3["default"])(function*(){let s=Array.from(n._modified.keys());r instanceof KeyRange&&(s=s.filter(function(e){return r.includes(e)}));let i=(s=s.sort()).iterator(t);if(!n._truncated){let s=!1;yield n._parent.keyStream(function(r){for(;i.hasNext()&&(t&&i.peek()<r||!t&&i.peek()>r);){const t=i.next();if(!e(t)){s=!0;return!1}}if(i.hasNext()&&i.peek()===r){const t=i.next();if(!e(t)){s=!0;return!1}return!0}if(!n._removed.has(r)&&!e(r)){s=!0;return!1}return!0},t,r);if(s)return}for(;i.hasNext()&&e(i.next()););})()}valueStream(e,t=!0,r=null){var n=this;return(0,_asyncToGenerator3["default"])(function*(){let s=Array.from(n._modified.keys());r instanceof KeyRange&&(s=s.filter(function(e){return r.includes(e)}));let i=(s=s.sort()).iterator(t);if(!n._truncated){let s=!1;yield n._parent.valueStream(function(r,o){for(;i.hasNext()&&(t&&i.peek()<o||!t&&i.peek()>o);){const t=i.next(),r=n._modified.get(t);if(!e(r,t)){s=!0;return!1}}if(i.hasNext()&&i.peek()===o){const t=i.next(),r=n._modified.get(t);if(!e(r,t)){s=!0;return!1}return!0}if(!n._removed.has(o)&&!e(r,o)){s=!0;return!1}return!0},t,r);if(s)return}for(;i.hasNext();){const t=i.next(),r=yield n.get(t);if(!e(r,t))break}})()}maxValue(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.maxKey(e);return t.get(r)})()}maxKey(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r=undefined;t._truncated||(r=yield t._parent.maxKey(e));for(;r!==undefined&&t._removed.has(r);){const n=KeyRange.upperBound(r,!0);r=yield t._parent.maxKey(n);if(null!==e&&!e.includes(r)){r=undefined;break}}for(const n of t._modified.keys())(null===e||e.includes(n))&&(r===undefined||n>r)&&(r=n);return r})()}minValue(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.minKey(e);return t.get(r)})()}minKey(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r=undefined;t._truncated||(r=yield t._parent.minKey(e));for(;r!==undefined&&t._removed.has(r);){const n=KeyRange.lowerBound(r,!0);r=yield t._parent.minKey(n);if(null!==e&&!e.includes(r)){r=undefined;break}}for(const n of t._modified.keys())(null===e||e.includes(n))&&(r===undefined||n<r)&&(r=n);return r})()}count(e=null){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield t.keys(e)).size})()}index(e){return this._indices.get(e)}createIndex(){throw new Error("Cannot create index in transaction")}deleteIndex(){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Cannot delete index in transaction")})()}close(){return this.abort()}transaction(e=!0){if(this._state!==Transaction.STATE.OPEN&&this._state!==Transaction.STATE.NESTED)throw new Error("Transaction already closed");const t=new Transaction(this._objectStore,this,this,e);this._nested.add(t);this._state=Transaction.STATE.NESTED;return t}synchronousTransaction(e=!0){if(this._state!==Transaction.STATE.OPEN&&this._state!==Transaction.STATE.NESTED)throw new Error("Transaction already closed");const t=new SynchronousTransaction(this._objectStore,this,this,e);this._nested.add(t);this._state=Transaction.STATE.NESTED;return t}isSynchronous(){return!1}snapshot(){if(this.state!==Transaction.STATE.COMMITTED){const e=this._managingBackend.snapshot();e.inherit(this);return e}return this._snapshotManager.createSnapshot(this._objectStore,this)}toString(){return`Transaction{id=${this._id}, changes=±${this._modified.size+this._removed.size}, truncated=${this._truncated}, objectStore=${this._objectStore}, state=${this._state}, dependency=${this._dependency}}`}toStringShort(){return`Transaction{id=${this._id}, changes=±${this._modified.size+this._removed.size}, truncated=${this._truncated}, state=${this._state}, dependency=${this._dependency}}`}}Transaction.WATCHDOG_TIMER=5e3;Transaction.STATE={OPEN:0,COMMITTED:1,ABORTED:2,CONFLICTED:3,NESTED:4};Transaction._instanceCount=0;Class.register(Transaction);class SynchronousTransaction extends Transaction{constructor(e,t,r,n=!0){super(e,t,r,n);this._cache=new Map}preload(e){e=e.filter(e=>!this.isCached(e));return Promise.all(e.map(e=>this.get(e)))}isCached(e){return this._cache.has(e)||!!this._parent.isSynchronous()&&this._parent.isCached(e)}get(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r=t.getSync(e,!1);if(!r){r=yield Transaction.prototype.get.call(t,e);t._cache.set(e,r)}return r})()}_getCached(e,t=!0){const r=this._cache.get(e);if(!r&&this._parent.isSynchronous())return this._parent.getSync(e,t);if(t&&!r)throw new Error(`Missing key in cache: ${e}`);return r}getSync(e,t=!0){return this._removed.has(e)?undefined:this._modified.has(e)?this._modified.get(e):this._truncated?undefined:this._getCached(e,t)}putSync(e,t){if(this._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed");const r=this.getSync(e,!1);this._originalValues.has(e)||this._originalValues.set(e,r);this._put(e,t,r)}removeSync(e){if(this._state!==Transaction.STATE.OPEN)throw new Error("Transaction already closed");const t=this.getSync(e,!1);this._originalValues.has(e)||this._originalValues.set(e,t);this._remove(e,t)}snapshot(){throw new Error("Invalid call on SynchronousTransaction")}isSynchronous(){return!0}_commitBackend(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(!e._truncated){for(const t of e._modified.keys())e._originalValues.get(t)||e._originalValues.set(t,e._getCached(t,!1)||(yield e._parent.get(t)));for(const t of new Set(e._removed).values()){if(e._originalValues.get(t))continue;const r=e._getCached(t,!1)||(yield e._parent.get(t));r?e._originalValues.set(t,r):e._removed["delete"](t)}}return Transaction.prototype._commitBackend.call(e)})()}}Class.register(SynchronousTransaction);class Snapshot extends Transaction{constructor(e,t){super(e,t,e,!1)}inherit(e){if(!(e instanceof Transaction))throw new Error("Can only inherit transactions");return super._applySync(e)}_apply(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!(e instanceof Transaction))throw new Error("Can only apply transactions");e._truncated&&(yield t.valueStream(function(e,r){t._modified.has(r)||t._put(r,e);return!0}));for(const[r,n]of e._modified){if(t._modified.has(r))continue;let s=e._originalValues.get(r);s?t._put(r,s,n):t._remove(r,n)}for(const r of e._removed)t._modified.has(r)||t._put(r,e._originalValues.get(r))})()}truncate(){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation on snapshots")})()}commit(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Cannot commit snapshots")})()}_isCommittable(e){return!1}_commitInternal(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Cannot commit snapshots")})()}_commitBackend(){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Cannot commit snapshots")})()}abort(e){return this._abortBackend()}_abortBackend(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(e._state!==Transaction.STATE.OPEN)throw new Error("Snapshot already closed");if(!(yield e._managingBackend.abort(e)))return!1;e._state=Transaction.STATE.ABORTED;e._truncated=!0;e._modified.clear();e._removed.clear();e._originalValues.clear();for(const t of e._indices.values())t.truncate();return!0})()}put(e,t){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation on snapshots")})()}remove(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation on snapshots")})()}createIndex(){throw new Error("Unsupported operation on snapshots")}deleteIndex(){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Unsupported operation on snapshots")})()}close(){return this.abort()}transaction(){throw new Error("Unsupported operation on snapshots")}snapshot(){throw new Error("Unsupported operation on snapshots")}}Class.register(Snapshot);class SnapshotManager{constructor(){this._snapshots=new Set}createSnapshot(e,t){const r=new Snapshot(e,t);this._snapshots.add(r);return r}abortSnapshot(e){return this._snapshots["delete"](e)}applyTx(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(!(e instanceof Transaction))throw new Error("Can only apply transactions");const n=[];for(const t of r._snapshots)n.push(t._apply(e));for(const s of e._snapshotManager){s._backend=t;r._snapshots.add(s)}return Promise.all(n)})()}[Symbol.iterator](){return this._snapshots.values()}}Class.register(SnapshotManager);class CombinedTransaction{constructor(...e){if(!this.isConsistent(e))throw new Error("Given set of transactions violates rules for combined transactions");this._transactions=e;this._flushable=new Map;this._preprocessing=[];this._dependency=this}get backend(){return this._jdb}get transactions(){return this._transactions}isConsistent(e){const t=new Set;this._jdb=null;for(const r of e){if(r.state!==Transaction.STATE.OPEN)return!1;if(r.nested)return!1;if(t.has(r._objectStore))return!1;if(null===this._jdb)this._jdb=r._objectStore.jungleDB;else if(this._jdb!==r._objectStore.jungleDB&&null!==r._objectStore.jungleDB)return!1;t.add(r._objectStore)}return!0}onFlushable(e,t=null,r=null){var n=this;return(0,_asyncToGenerator3["default"])(function*(){n._flushable.set(e,t);null!==r&&n._preprocessing.push(r);if(n._transactions.every(function(e){return n._flushable.has(e)})){const e=[];for(const t of n._preprocessing)e.push(t());yield Promise.all(e);yield JungleDB.commitCombined(n);for(const t of n._flushable.values())t();return!0}return!1})()}commit(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(e._isCommittable()){yield e._commitBackend();return!0}yield e.abort();return!1})()}abort(){return this._abortBackend()}_abortBackend(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield Promise.all(e._transactions.map(function(e){return e._abortBackend()}))).every(function(e){return e})})()}transaction(e){throw new Error("Unsupported operation")}snapshot(){throw new Error("Unsupported operation")}_isCommittable(){return this._transactions.every(e=>e._isCommittable())}_commitBackend(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield Promise.all(e._transactions.map(function(e){return e._commitBackend()}))).every(function(e){return e})})()}_commitInternal(e){return(0,_asyncToGenerator3["default"])(function*(){throw new Error("Cannot commit transactions to a combined transaction")})()}_setParent(e){throw new Error("Unsupported operation")}set _dependency(e){for(const t of this._transactions)t._dependency=e}get dependency(){return this}get objectStore(){throw new Error("Unsupported operation")}toString(){return`CombinedTransaction{size=${this._transactions.length}, states=[${this._transactions.map(e=>e.state)}]}`}}Class.register(CombinedTransaction);e._loaded=!0;"function"==typeof e._onload&&e._onload()}(JDB);if("undefined"==typeof Nimiq)var Nimiq="undefined"!=typeof window?window:{};!function(e){(Nimiq=e="undefined"!=typeof e?e:{})._currentScript||(Nimiq._currentScript=document.currentScript);if(!Nimiq._currentScript){const e=document.getElementsByTagName("script");Nimiq._currentScript=e[e.length-1]}Nimiq._path||(Nimiq._currentScript&&-1!==Nimiq._currentScript.src.indexOf("/")?Nimiq._path=Nimiq._currentScript.src.substring(0,Nimiq._currentScript.src.lastIndexOf("/")+1):Nimiq._path="./");class Class{static register(t){"undefined"!=typeof e&&(e[t.name]=t)}}Class.register(Class);class LogNative{constructor(){this._global_level=Log.INFO;this._tag_levels={};try{if(window.localStorage)try{let t=window.localStorage.getItem("log_tag_levels");t&&"string"==typeof t&&(t=JSON.parse(t));t&&"object"==typeof t&&(this._tag_levels=t)}catch(e){console.warn("Failed to load log configuration from local storage.")}}catch(e){}}isLoggable(e,t){return e&&this._tag_levels[e]?this._tag_levels[e]<=t:this._tag_levels["*"]?this._tag_levels["*"]<=t:this._global_level<=t}setLoggable(e,t){e&&e.name&&(e=e.name);this._tag_levels[e]=t;window.localStorage&&window.localStorage.setItem("log_tag_levels",JSON.stringify(this._tag_levels))}msg(e,t,r){t&&t.name&&(t=t.name);if(this.isLoggable(t,e)){t&&r.unshift(t+":");r.unshift(`[${Log.Level.toStringTag(e)} ${(new Date).toTimeString().substr(0,8)}]`);console.error&&e>=Log.ERROR?console.error.apply(console,r):console.warn&&e>=Log.WARNING?console.warn.apply(console,r):console.info&&e>=Log.INFO?console.info.apply(console,r):console.debug&&e>=Log.DEBUG?console.debug.apply(console,r):console.trace&&e<=Log.TRACE?console.trace.apply(console,r):console.log.apply(console,r)}}}Class.register(LogNative);class Log{static get instance(){Log._instance||(Log._instance=new Log(new LogNative));return Log._instance}constructor(e){this._native=e}setLoggable(e,t){this._native.setLoggable(e,t)}get level(){return this._native._global_level}set level(e){this._native._global_level=e}msg(e,t,r){if(this._native.isLoggable(t,e)){for(let e=0;e<r.length;++e){"function"==typeof r[e]&&(r[e]=r[e]());"object"==typeof r[e]&&("function"==typeof r[e].toString?r[e]=r[e].toString():r[e].constructor&&r[e].constructor.name?r[e]=`{Object: ${r[e].constructor.name}}`:r[e]="{Object}")}this._native.msg(e,t,r)}}static d(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.DEBUG,e,r)}static e(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.ERROR,e,r)}static i(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.INFO,e,r)}static v(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.VERBOSE,e,r)}static w(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.WARNING,e,r)}static t(e,t,...r){if(arguments.length>=2){e=arguments[0];r=Array.prototype.slice.call(arguments,1)}else{e=undefined;r=Array.prototype.slice.call(arguments,0)}Log.instance.msg(Log.TRACE,e,r)}}Log.Level={TRACE:1,VERBOSE:2,DEBUG:3,INFO:4,WARNING:5,ERROR:6,ASSERT:7,toStringTag:function(e){switch(e){case Log.TRACE:return"T";case Log.VERBOSE:return"V";case Log.DEBUG:return"D";case Log.INFO:return"I";case Log.WARNING:return"W";case Log.ERROR:return"E";case Log.ASSERT:return"A";default:return"*"}}};Log.TRACE=Log.Level.TRACE;Log.VERBOSE=Log.Level.VERBOSE;Log.DEBUG=Log.Level.DEBUG;Log.INFO=Log.Level.INFO;Log.WARNING=Log.Level.WARNING;Log.ERROR=Log.Level.ERROR;Log.ASSERT=Log.Level.ASSERT;Log._instance=null;Log.d.tag=(e=>Log.d.bind(null,e));Log.e.tag=(e=>Log.e.bind(null,e));Log.i.tag=(e=>Log.i.bind(null,e));Log.v.tag=(e=>Log.v.bind(null,e));Log.w.tag=(e=>Log.w.bind(null,e));Log.t.tag=(e=>Log.t.bind(null,e));Class.register(Log);class Observable{static get WILDCARD(){return"*"}constructor(){this._listeners=new Map}on(e,t){if(this._listeners.has(e))return this._listeners.get(e).push(t)-1;this._listeners.set(e,[t]);return 0}off(e,t){this._listeners.has(e)&&this._listeners.get(e)[t]&&delete this._listeners.get(e)[t]}fire(e,...t){if(this._listeners.has(e))for(const r in this._listeners.get(e)){this._listeners.get(e)[r].apply(null,t)}if(this._listeners.has(Observable.WILDCARD))for(const r in this._listeners.get(Observable.WILDCARD)){this._listeners.get(Observable.WILDCARD)[r].apply(null,arguments)}}bubble(e,...t){for(const r of t){let t;t=r==Observable.WILDCARD?function(){this.fire.apply(this,arguments)}:function(){this.fire.apply(this,[r,...arguments])};e.on(r,t.bind(this))}}}Class.register(Observable);class DataChannel extends Observable{constructor(){super();this._buffer=null;this._msgType=0;this._receivingTag=-1;this._sendingTag=0;this._expectedMessagesByType=new Map;this._timers=new Timers}isExpectingMessage(e){return this._expectedMessagesByType.has(e)}expectMessage(e,t,r=DataChannel.MESSAGE_TIMEOUT,n=DataChannel.CHUNK_TIMEOUT){Array.isArray(e)||(e=[e]);if(0===e.length)return;const s=new ExpectedMessage(e,t,r,n);for(const i of e)this._expectedMessagesByType.set(i,s);this._timers.resetTimeout(`chunk-${s.id}`,this._onTimeout.bind(this,s),n);this._timers.resetTimeout(`msg-${s.id}`,this._onTimeout.bind(this,s),r)}close(){throw new Error("Not implemented")}_onClose(){this._timers.clearAll();this.fire("close",this)}_error(e){this.fire("error",e,this);Log.e(DataChannel,e);this.close()}_onMessage(e){try{if(this.readyState!==DataChannel.ReadyState.OPEN)return;const r=new SerialBuffer(e);if(0===r.byteLength)return;if(r.byteLength>DataChannel.CHUNK_SIZE_MAX){this._error("Received chunk larger than maximum chunk size, discarding");return}const n=r.readUint8(),s=r.byteLength-r.readPos,i=r.read(s);if(null===this._buffer&&n===(this._receivingTag+1)%NumberUtils.UINT8_MAX){const e=new SerialBuffer(i),t=Message.peekLength(e);if(t>DataChannel.MESSAGE_SIZE_MAX){this._error(`Received message with excessive message size ${t} > ${DataChannel.MESSAGE_SIZE_MAX}`);return}this._buffer=new SerialBuffer(t);this._receivingTag=n;this._msgType=Message.peekType(e)}if(null===this._buffer){Log.e(DataChannel,`Message does not start next tag ${this._receivingTag+1} (but ${n}), but buffer is null`);return}if(n!==this._receivingTag){this._error(`Received message with wrong message tag ${n}, expected ${this._receivingTag}`);return}let o=this._buffer.byteLength-this._buffer.writePos;if(s>o){this._error("Received chunk larger than remaining bytes to read, discarding");return}this._buffer.write(i);o-=s;const a=this._expectedMessagesByType.get(this._msgType);if(0===o){if(a){this._timers.clearTimeout(`chunk-${a.id}`);this._timers.clearTimeout(`msg-${a.id}`);for(const e of a.types)this._expectedMessagesByType["delete"](e)}const e=this._buffer.buffer;this._buffer=null;this.fire("message",e,this)}else{a&&this._timers.resetTimeout(`chunk-${a.id}`,this._onTimeout.bind(this,a),a.chunkTimeout);this.fire("chunk",this._buffer)}}catch(t){this._error(`Error occurred while parsing incoming message, ${t.message}`)}}_onTimeout(e){if(e){this._timers.clearTimeout(`chunk-${e.id}`);this._timers.clearTimeout(`msg-${e.id}`);for(const t of e.types)this._expectedMessagesByType["delete"](t);e.timeoutCallback()}Log.e(DataChannel,"Timeout while receiving chunked message");this._buffer=null}send(e){Assert.that(e.byteLength<=DataChannel.MESSAGE_SIZE_MAX,"DataChannel.send() max message size exceeded");const t=this._sendingTag;this._sendingTag=(this._sendingTag+1)%NumberUtils.UINT8_MAX;this._sendChunked(e,t)}_sendChunked(e,t){let r=e.byteLength,n=null;for(;r>0;){let s=null;if(r+1>=DataChannel.CHUNK_SIZE_MAX){(s=new SerialBuffer(DataChannel.CHUNK_SIZE_MAX)).writeUint8(t);n=new Uint8Array(e.buffer,e.byteLength-r,DataChannel.CHUNK_SIZE_MAX-1)}else{(s=new SerialBuffer(r+1)).writeUint8(t);n=new Uint8Array(e.buffer,e.byteLength-r,r)}s.write(n);this.sendChunk(s);r-=n.byteLength}}sendChunk(e){throw new Error("Not implemented")}get readyState(){throw new Error("Not implemented")}}DataChannel.CHUNK_SIZE_MAX=16384;DataChannel.MESSAGE_SIZE_MAX=10485760;DataChannel.CHUNK_TIMEOUT=5e3;DataChannel.MESSAGE_TIMEOUT=DataChannel.MESSAGE_SIZE_MAX/DataChannel.CHUNK_SIZE_MAX*DataChannel.CHUNK_TIMEOUT;class ExpectedMessage{constructor(e,t,r=DataChannel.MESSAGE_TIMEOUT,n=DataChannel.CHUNK_TIMEOUT){this.id=e.join(":");this.types=e;this.timeoutCallback=t;this.msgTimeout=r;this.chunkTimeout=n}}DataChannel.ReadyState={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};DataChannel.ReadyState.fromString=function(e){switch(e){case"connecting":return DataChannel.ReadyState.CONNECTING;case"open":return DataChannel.ReadyState.OPEN;case"closing":return DataChannel.ReadyState.CLOSING;case"closed":return DataChannel.ReadyState.CLOSED;default:throw new Error("Invalid string")}};Class.register(DataChannel);class CryptoLib{static get instance(){if(!CryptoLib._instance){const e={};e.getRandomValues=(window.crypto||window.msCrypto).getRandomValues.bind(window.crypto);CryptoLib._instance=e}return CryptoLib._instance}}CryptoLib._instance=null;Class.register(CryptoLib);class WebRtcFactory{static newPeerConnection(e){return new RTCPeerConnection(e)}static newSessionDescription(e){return new RTCSessionDescription(e)}static newIceCandidate(e){return new RTCIceCandidate(e)}}Class.register(WebRtcFactory);class WebSocketFactory{static newWebSocketServer(){return new Observable}static newWebSocket(e){return new WebSocket(e)}}Class.register(WebSocketFactory);class Services{constructor(e=Services.NONE,t=Services.NONE){this._provided=e;this._accepted=t}get provided(){return this._provided}get accepted(){return this._accepted}set provided(e){this._provided=e}set accepted(e){this._accepted=e}static isFullNode(e){return 0!=(e&Services.FULL)}static isLightNode(e){return 0!=(e&Services.LIGHT)}static isNanoNode(e){return e===Services.NANO}}Services.NONE=0;Services.NANO=1;Services.LIGHT=2;Services.FULL=4;Class.register(Services);class Synchronizer extends Observable{constructor(){super();this._queue=[];this._working=!1}push(e){return new Promise((t,r)=>{this._queue.push({fn:e,resolve:t,reject:r});this._working||this._doWork()["catch"](Log.w.tag(Synchronizer))})}clear(){for(const e of this._queue)e.reject&&e.reject();this._queue=[]}_doWork(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._working=!0;e.fire("work-start",e);for(;e._queue.length;){const r=e._queue.shift();try{const e=yield r.fn();r.resolve(e)}catch(t){r.reject&&r.reject(t)}}e._working=!1;e.fire("work-end",e)})()}get working(){return this._working}}Class.register(Synchronizer);class Timers{constructor(){this._timeouts={};this._intervals={}}setTimeout(e,t,r){if(this._timeouts[e])throw"Duplicate timeout for key "+e;this._timeouts[e]=setTimeout(t,r)}clearTimeout(e){clearTimeout(this._timeouts[e]);delete this._timeouts[e]}resetTimeout(e,t,r){clearTimeout(this._timeouts[e]);this._timeouts[e]=setTimeout(t,r)}timeoutExists(e){return this._timeouts[e]!==undefined}setInterval(e,t,r){if(this._intervals[e])throw"Duplicate interval for key "+e;this._intervals[e]=setInterval(t,r)}clearInterval(e){clearInterval(this._intervals[e]);delete this._intervals[e]}resetInterval(e,t,r){clearInterval(this._intervals[e]);this._intervals[e]=setInterval(t,r)}intervalExists(e){return this._intervals[e]!==undefined}clearAll(){for(const e in this._timeouts)this.clearTimeout(e);for(const e in this._intervals)this.clearInterval(e)}}Class.register(Timers);class Version{static isCompatible(e){return e>=Version.CODE}}Version.CODE=1;Class.register(Version);class Time{constructor(e=0){this._offset=e}set offset(e){this._offset=e}now(){return Date.now()+this._offset}}Class.register(Time);class ArrayUtils{static randomElement(e){return e[Math.floor(Math.random()*e.length)]}static subarray(e,t,r){function clamp(e,t,r){return e<t?t:e>r?r:e}t===undefined&&(t=0);r===undefined&&(r=e.byteLength);t=clamp(t,0,e.byteLength);let n=(r=clamp(r,0,e.byteLength))-t;n<0&&(n=0);return new Uint8Array(e.buffer,e.byteOffset+t,n)}static*k_combinations(e,t){const r=e.length;if(t>r)return;const n=Array.from(new Array(t),(e,t)=>t);yield n.map(t=>e[t]);const s=Array.from(new Array(t),(e,r)=>t-r-1);for(;;){let i=t-1,o=!1;for(i of s)if(n[i]!==i+r-t){o=!0;break}if(!o)return;n[i]+=1;for(const e of Array.from(new Array(t-i-1),(e,t)=>i+t+1))n[e]=n[e-1]+1;yield n.map(t=>e[t])}}}Class.register(ArrayUtils);class HashMap{constructor(e=HashMap._hash){this._map=new Map;this._fnHash=e}static _hash(e){return e.hashCode?e.hashCode():e.toString()}get(e){return this._map.get(this._fnHash(e))}put(e,t){this._map.set(this._fnHash(e),t)}remove(e){this._map["delete"](this._fnHash(e))}clear(){this._map.clear()}contains(e){return this._map.has(this._fnHash(e))}keys(){return Array.from(this._map.keys())}keyIterator(){return this._map.keys()}values(){return Array.from(this._map.values())}valueIterator(){return this._map.values()}get length(){return this._map.size}isEmpty(){return 0===this._map.size}}Class.register(HashMap);class HashSet{constructor(e=HashSet._hash){this._map=new Map;this._fnHash=e}static _hash(e){return e.hashCode?e.hashCode():e.toString()}add(e){this._map.set(this._fnHash(e),e)}addAll(e){for(const t of e)this.add(t)}get(e){return this._map.get(this._fnHash(e))}remove(e){this._map["delete"](this._fnHash(e))}removeAll(e){for(const t of e)this.remove(t)}clear(){this._map.clear()}contains(e){return this._map.has(this._fnHash(e))}values(){return Array.from(this._map.values())}valueIterator(){return this._map.values()}[Symbol.iterator](){return this.valueIterator()}get length(){return this._map.size}isEmpty(){return 0===this._map.size}}Class.register(HashSet);class LimitIterable{constructor(e,t){this._iterator=e[Symbol.iterator]?e[Symbol.iterator]():e;this._limit=t}[Symbol.iterator](){return LimitIterable.iterator(this._iterator,this._limit)}static iterator(e,t){let r=0;return{next:()=>{const n=r++>=t,s=e.next();return{value:n?undefined:s.value,done:n||s.done}}}}}Class.register(LimitIterable);class Queue{constructor(e){this._queue=[];this._fnHash=e||Queue._hash}static _hash(e){return e.hashCode?e.hashCode():e.toString()}enqueue(e){this._queue.push(e)}dequeue(){return this._queue.shift()}peek(){return this._queue[0]}indexOf(e){const t=this._fnHash(e);for(let r=0;r<this._queue.length;++r)if(t===this._fnHash(this._queue[r]))return r;return-1}remove(e){const t=this.indexOf(e);t>-1&&this._queue.splice(t,1)}dequeueMulti(e){return this._queue.splice(0,e)}dequeueUntil(e){const t=this.indexOf(e);return t>-1?this._queue.splice(0,t+1):[]}clear(){this._queue=[]}values(){return this._queue}get length(){return this._queue.length}}Class.register(Queue);class SortedList{constructor(e=[],t){this._list=e;this._compare=t||SortedList._compare}static _compare(e,t){return e.compare?e.compare(t):e>t?1:e<t?-1:0}indexOf(e){let t=0,r=this._list.length-1,n=null,s=null;for(;t<=r;){n=Math.round((t+r)/2);s=this._list[n];if(this._compare(s,e)<0)t=n+1;else{if(!(this._compare(s,e)>0))return n;r=n-1}}return-1}_insertionIndex(e){let t=0,r=this._list.length-1,n=null,s=null;for(;t<=r;){n=Math.round((t+r)/2);s=this._list[n];if(this._compare(s,e)<0)t=n+1;else{if(!(this._compare(s,e)>0))break;r=n-1}}return t}add(e){this._list.splice(this._insertionIndex(e),0,e)}shift(){return this._list.shift()}pop(){return this._list.pop()}remove(e){const t=this.indexOf(e);t>-1&&this._list.splice(t,1)}clear(){this._list=[]}values(){return this._list}copy(){return new SortedList(this._list.slice(),this._compare)}get length(){return this._list.length}}Class.register(SortedList);class Assert{static that(e,t="Assertion failed"){if(!e)throw new Error(t)}}Class.register(Assert);class BufferUtils{static toAscii(e){return String.fromCharCode.apply(null,new Uint8Array(e))}static fromAscii(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;++r)t[r]=e.charCodeAt(r);return t}static _codePointTextDecoder(e){if("undefined"==typeof TextDecoder)throw new Error("TextDecoder not supported");if(null===BufferUtils._ISO_8859_15_DECODER)throw new Error("TextDecoder does not supprot iso-8859-15");if(BufferUtils._ISO_8859_15_DECODER===undefined)try{BufferUtils._ISO_8859_15_DECODER=new TextDecoder("iso-8859-15")}finally{BufferUtils._ISO_8859_15_DECODER=null}return BufferUtils._ISO_8859_15_DECODER.decode(e).replace("€","¤").replace("Š","¦").replace("š","¨").replace("Ž","´").replace("ž","¸").replace("Œ","¼").replace("œ","½").replace("Ÿ","¾")}static _tripletToBase64(e){return BufferUtils._BASE64_LOOKUP[e>>18&63]+BufferUtils._BASE64_LOOKUP[e>>12&63]+BufferUtils._BASE64_LOOKUP[e>>6&63]+BufferUtils._BASE64_LOOKUP[63&e]}static _base64encodeChunk(e,t,r){let n;const s=[];for(let i=t;i<r;i+=3){n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]);s.push(BufferUtils._tripletToBase64(n))}return s.join("")}static _base64fromByteArray(e){let t;const r=e.length,n=r%3;let s="";const i=[];for(let o=0,a=r-n;o<a;o+=16383)i.push(BufferUtils._base64encodeChunk(e,o,o+16383>a?a:o+16383));if(1===n){t=e[r-1];s+=BufferUtils._BASE64_LOOKUP[t>>2];s+=BufferUtils._BASE64_LOOKUP[t<<4&63];s+="=="}else if(2===n){t=(e[r-2]<<8)+e[r-1];s+=BufferUtils._BASE64_LOOKUP[t>>10];s+=BufferUtils._BASE64_LOOKUP[t>>4&63];s+=BufferUtils._BASE64_LOOKUP[t<<2&63];s+="="}i.push(s);return i.join("")}static toBase64(e){if(PlatformUtils.isNodeJs())return new Buffer(e).toString("base64");if("undefined"!=typeof TextDecoder&&null!==BufferUtils._ISO_8859_15_DECODER)try{return btoa(BufferUtils._codePointTextDecoder(new Uint8Array(e)))}catch(t){}return BufferUtils._base64fromByteArray(new Uint8Array(e))}static fromBase64(e){return new SerialBuffer(Uint8Array.from(atob(e),e=>e.charCodeAt(0)))}static toBase64Url(e){return BufferUtils.toBase64(e).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,".")}static fromBase64Url(e){return new SerialBuffer(Uint8Array.from(atob(e.replace(/_/g,"/").replace(/-/g,"+").replace(/\./g,"=")),e=>e.charCodeAt(0)))}static toBase32(e,t=BufferUtils.BASE32_ALPHABET.NIMIQ){let r,n,s,i=3,o=0,a="";for(s=0;s<e.length;s++){a+=t[31&(n=o|(r=e[s])>>i)];i>5&&(a+=t[31&(n=r>>(i-=5))]);o=r<<(i=5-i);i=8-i}3!==i&&(a+=t[31&o]);for(;a.length%8!=0&&33===t.length;)a+=t[32];return a}static fromBase32(e,t=BufferUtils.BASE32_ALPHABET.NIMIQ){const r=[];t.toUpperCase().split("").forEach((e,t)=>{e in r||(r[e]=t)});let n,s=8,i=0,o=[];e.toUpperCase().split("").forEach(e=>{if(33!==t.length||e!==t[32]){n=255&r[e];if((s-=5)>0)i|=n<<s;else if(s<0){o.push(i|n>>-s);i=n<<(s+=8)&255}else{o.push(i|n);s=8;i=0}}});8!==s&&0!==i&&o.push(i);return new Uint8Array(o)}static toHex(e){let t="";for(let r=0;r<e.length;r++){const n=e[r];t+=BufferUtils.HEX_ALPHABET[n>>>4];t+=BufferUtils.HEX_ALPHABET[15&n]}return t}static fromHex(e){e=e.trim();return StringUtils.isHexBytes(e)?new SerialBuffer(Uint8Array.from(e.match(/.{2}/g)||[],e=>parseInt(e,16))):null}static concatTypedArrays(e,t){const r=new e.constructor(e.length+t.length);r.set(e,0);r.set(t,e.length);return r}static equals(e,t){if(e.length!==t.length)return!1;const r=new Uint8Array(e),n=new Uint8Array(t);for(let s=0;s<e.length;s++)if(r[s]!==n[s])return!1;return!0}static compare(e,t){if(e.length<t.length)return-1;if(e.length>t.length)return 1;for(let r=0;r<e.length;r++){if(e[r]<t[r])return-1;if(e[r]>t[r])return 1}return 0}static xor(e,t){const r=new Uint8Array(e.byteLength);for(let n=0;n<e.byteLength;++n)r[n]=e[n]^t[n];return r}}BufferUtils.BASE64_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";BufferUtils.BASE32_ALPHABET={RFC4648:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",RFC4648_HEX:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",NIMIQ:"0123456789ABCDEFGHJKLMNPQRSTUVXY"};BufferUtils.HEX_ALPHABET="0123456789abcdef";BufferUtils._BASE64_LOOKUP=[];for(let t=0,r=BufferUtils.BASE64_ALPHABET.length;t<r;++t)BufferUtils._BASE64_LOOKUP[t]=BufferUtils.BASE64_ALPHABET[t];Class.register(BufferUtils);class SerialBuffer extends Uint8Array{constructor(e){super(e);this._view=new DataView(this.buffer);this._readPos=0;this._writePos=0}subarray(e,t){return ArrayUtils.subarray(this,e,t)}get readPos(){return this._readPos}set readPos(e){if(e<0||e>this.byteLength)throw`Invalid readPos ${e}`;this._readPos=e}get writePos(){return this._writePos}set writePos(e){if(e<0||e>this.byteLength)throw`Invalid writePos ${e}`;this._writePos=e}reset(){this._readPos=0;this._writePos=0}read(e){const t=this.subarray(this._readPos,this._readPos+e);this._readPos+=e;return t}write(e){this.set(e,this._writePos);this._writePos+=e.byteLength}readUint8(){return this._view.getUint8(this._readPos++)}writeUint8(e){this._view.setUint8(this._writePos++,e)}readUint16(){const e=this._view.getUint16(this._readPos);this._readPos+=2;return e}writeUint16(e){this._view.setUint16(this._writePos,e);this._writePos+=2}readUint32(){const e=this._view.getUint32(this._readPos);this._readPos+=4;return e}writeUint32(e){this._view.setUint32(this._writePos,e);this._writePos+=4}readUint64(){const e=this._view.getUint32(this._readPos)*Math.pow(2,32)+this._view.getUint32(this._readPos+4);if(!NumberUtils.isUint64(e))throw new Error("Malformed value");this._readPos+=8;return e}writeUint64(e){if(!NumberUtils.isUint64(e))throw new Error("Malformed value");this._view.setUint32(this._writePos,Math.floor(e/Math.pow(2,32)));this._view.setUint32(this._writePos+4,e);this._writePos+=8}readVarUint(){const e=this.readUint8();return e<253?e:253===e?this.readUint16():254===e?this.readUint32():this.readUint64()}writeVarUint(e){if(!NumberUtils.isUint64(e))throw new Error("Malformed value");if(e<253)this.writeUint8(e);else if(e<=65535){this.writeUint8(253);this.writeUint16(e)}else if(e<=4294967295){this.writeUint8(254);this.writeUint32(e)}else{this.writeUint8(255);this.writeUint64(e)}}static varUintSize(e){if(!NumberUtils.isUint64(e))throw new Error("Malformed value");return e<253?1:e<=65535?3:e<=4294967295?5:9}readFloat64(){const e=this._view.getFloat64(this._readPos);this._readPos+=8;return e}writeFloat64(e){this._view.setFloat64(this._writePos,e);this._writePos+=8}readString(e){const t=this.read(e);return BufferUtils.toAscii(t)}writeString(e,t){if(StringUtils.isMultibyte(e)||e.length!==t)throw"Malformed value/length";const r=BufferUtils.fromAscii(e);this.write(r)}readPaddedString(e){const t=this.read(e);let r=0;for(;r<e&&0!==t[r];)r++;const n=new Uint8Array(t.buffer,t.byteOffset,r);return BufferUtils.toAscii(n)}writePaddedString(e,t){if(StringUtils.isMultibyte(e)||e.length>t)throw"Malformed value/length";const r=BufferUtils.fromAscii(e);this.write(r);const n=t-r.byteLength;this.write(new Uint8Array(n))}readVarLengthString(){const e=this.readUint8();if(this._readPos+e>this.length)throw"Malformed length";const t=this.read(e);return BufferUtils.toAscii(t)}writeVarLengthString(e){if(StringUtils.isMultibyte(e)||!NumberUtils.isUint8(e.length))throw new Error("Malformed value");const t=BufferUtils.fromAscii(e);this.writeUint8(t.byteLength);this.write(t)}static varLengthStringSize(e){if(StringUtils.isMultibyte(e)||!NumberUtils.isUint8(e.length))throw new Error("Malformed value");return 1+e.length}}Class.register(SerialBuffer);class Crypto{static get lib(){return CryptoLib.instance}static prepareSyncCryptoWorker(){return(0,_asyncToGenerator3["default"])(function*(){const e=IWorker._workerImplementation[CryptoWorker.name];yield e.init("crypto");Crypto._workerSync=e;return e})()}static _cryptoWorkerSync(){if(null===Crypto._workerSync)throw new Error("Synchronous crypto worker not yet prepared");return Crypto._workerSync}static _cryptoWorkerAsync(){return(0,_asyncToGenerator3["default"])(function*(){Crypto._workerAsync||(Crypto._workerAsync=yield IWorker.startWorkerPoolForProxy(CryptoWorker,"crypto",4));return Crypto._workerAsync})()}static get publicKeyType(){return Uint8Array}static get publicKeySize(){return 32}static publicKeySerialize(e){return e}static publicKeyUnserialize(e){return e}static publicKeyDerive(e){return Crypto._cryptoWorkerSync().publicKeyDerive(e)}static get privateKeyType(){return Uint8Array}static get privateKeySize(){return 32}static privateKeySerialize(e){return e}static privateKeyUnserialize(e){return e}static privateKeyGenerate(){const e=new Uint8Array(Crypto.privateKeySize);Crypto.lib.getRandomValues(e);return e}static get keyPairType(){return Object}static keyPairGenerate(){return Crypto.keyPairDerive(Crypto.privateKeyGenerate())}static keyPairDerive(e){return{privateKey:e,publicKey:Crypto.publicKeyDerive(e)}}static keyPairPrivate(e){return e.privateKey}static keyPairPublic(e){return e.publicKey}static keyPairFromKeys(e,t){return{privateKey:e,publicKey:t}}static get signatureType(){return Uint8Array}static get signatureSize(){return 64}static signatureSerialize(e){return e}static signatureUnserialize(e){return e}static signatureCreate(e,t,r){return Crypto._cryptoWorkerSync().signatureCreate(e,t,r)}static signatureVerify(e,t,r){return Crypto._cryptoWorkerSync().signatureVerify(e,t,r)}static blockVerify(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){return(yield Crypto._cryptoWorkerAsync()).blockVerify(e,t,r,Block.GENESIS.HASH.serialize())})()}static get hashType(){return Uint8Array}static get hashSize(){return 32}static get blake2bSize(){return 32}static blake2bSync(e){return Crypto._cryptoWorkerSync().computeBlake2b(e)}static blake2bAsync(e){return(0,_asyncToGenerator3["default"])(function*(){return(yield Crypto._cryptoWorkerAsync()).computeBlake2b(e)})()}static get argon2dSize(){return 32}static argon2d(e){return(0,_asyncToGenerator3["default"])(function*(){return(yield Crypto._cryptoWorkerAsync()).computeArgon2d(e)})()}static get sha256Size(){return 32}static sha256(e){return Crypto._cryptoWorkerSync().computeSha256(e)}static get randomnessSize(){return 32}static get commitmentPairType(){return Object}static commitmentPairGenerate(){const e=new Uint8Array(Crypto.randomnessSize);Crypto.lib.getRandomValues(e);return Crypto._cryptoWorkerSync().commitmentCreate(e)}static commitmentPairFromValues(e,t){return{secret:e,commitment:t}}static commitmentPairRandomSecret(e){return e.secret}static commitmentPairCommitment(e){return e.commitment}static get randomSecretType(){return Uint8Array}static get randomSecretSize(){return 32}static randomSecretSerialize(e){return e}static randomSecretUnserialize(e){return e}static get commitmentType(){return Uint8Array}static get commitmentSize(){return 32}static commitmentSerialize(e){return e}static commitmentUnserialize(e){return e}static get partialSignatureType(){return Uint8Array}static get partialSignatureSize(){return 32}static partialSignatureSerialize(e){return e}static partialSignatureUnserialize(e){return e}static hashPublicKeys(e){return Crypto._cryptoWorkerSync().publicKeysHash(e)}static delinearizePublicKey(e,t){const r=Crypto._cryptoWorkerSync(),n=r.publicKeysHash(e);return r.publicKeyDelinearize(t,n)}static delinearizePrivateKey(e,t,r){const n=Crypto._cryptoWorkerSync(),s=n.publicKeysHash(e);return n.privateKeyDelinearize(r,t,s)}static delinearizeAndAggregatePublicKeys(e){const t=Crypto._cryptoWorkerSync(),r=t.publicKeysHash(e);return t.publicKeysDelinearizeAndAggregate(e,r)}static delinearizedPartialSignatureCreate(e,t,r,n,s,i){return Crypto._cryptoWorkerSync().delinearizedPartialSignatureCreate(r,e,t,n,s,i)}static aggregateCommitments(e){return Crypto._cryptoWorkerSync().commitmentsAggregate(e)}static aggregatePartialSignatures(e){const t=Crypto._cryptoWorkerSync();return e.reduce((e,r)=>t.scalarsAdd(e,r))}static combinePartialSignatures(e,t){const r=Crypto.aggregatePartialSignatures(t);return BufferUtils.concatTypedArrays(e,r)}static kdf(e,t,r=256){return(0,_asyncToGenerator3["default"])(function*(){return(yield Crypto._cryptoWorkerAsync()).kdf(e,t,r)})()}static manyPow(e){return(0,_asyncToGenerator3["default"])(function*(){const t=yield Crypto._cryptoWorkerAsync(),r=t.poolSize||1,n=[];let s=0;for(let a=0;a<r;++a){n.push([]);for(;s<(a+1)/r*e.length;++s)n[a].push(e[s].serialize())}const i=[];for(const e of n)i.push(t.computeArgon2dBatch(e));const o=(yield Promise.all(i)).reduce(function(e,t){return[...e,...t]},[]);for(let a=0;a<e.length;++a)e[a]._pow=new Hash(o[a])})()}}Crypto._workerSync=null;Crypto._workerAsync=null;Class.register(Crypto);class CRC32{static _createTable(){let e;const t=[];for(let r=0;r<256;++r){e=r;for(let t=0;t<8;++t)e=1&e?CRC32._POLYNOMIAL^e>>>1:e>>>1;t[r]=e>>>0}return t}static compute(e){CRC32._table||(CRC32._table=CRC32._createTable());CRC32._hex_chars||(CRC32._hex_chars="0123456789abcdef".split(""));const t=new Uint8Array(e);let r=-1,n="";for(let s=0;s<t.length;++s)r=CRC32._table[255&(r^t[s])]^r>>>8;r^=-1;n+=CRC32._hex_chars[r>>28&15]+CRC32._hex_chars[r>>24&15]+CRC32._hex_chars[r>>20&15]+CRC32._hex_chars[r>>16&15]+CRC32._hex_chars[r>>12&15]+CRC32._hex_chars[r>>8&15]+CRC32._hex_chars[r>>4&15]+CRC32._hex_chars[15&r];return parseInt(n,16)}}CRC32._table=null;CRC32._hex_chars=null;CRC32._POLYNOMIAL=3988292384;Class.register(CRC32);class NumberUtils{static isUint8(e){return Number.isInteger(e)&&e>=0&&e<=NumberUtils.UINT8_MAX}static isUint16(e){return Number.isInteger(e)&&e>=0&&e<=NumberUtils.UINT16_MAX}static isUint32(e){return Number.isInteger(e)&&e>=0&&e<=NumberUtils.UINT32_MAX}static isUint64(e){return Number.isInteger(e)&&e>=0&&e<=NumberUtils.UINT64_MAX}static randomUint32(){return Math.floor(Math.random()*(NumberUtils.UINT32_MAX+1))}static randomUint64(){return Math.floor(Math.random()*(NumberUtils.UINT64_MAX+1))}}NumberUtils.UINT8_MAX=255;NumberUtils.UINT16_MAX=65535;NumberUtils.UINT32_MAX=4294967295;NumberUtils.UINT64_MAX=Number.MAX_SAFE_INTEGER;Class.register(NumberUtils);class MerkleTree{static computeRoot(e,t=MerkleTree._hash){return MerkleTree._computeRoot(e,t)}static _computeRoot(e,t){const r=e.length;if(0===r)return Hash.light(new Uint8Array(0));if(1===r)return t(e[0]);const n=Math.round(r/2),s=e.slice(0,n),i=e.slice(n),o=MerkleTree._computeRoot(s,t),a=MerkleTree._computeRoot(i,t);return Hash.light(BufferUtils.concatTypedArrays(o.serialize(),a.serialize()))}static _hash(e){if(e instanceof Hash)return e;if("function"==typeof e.hash)return e.hash();if("function"==typeof e.serialize)return Hash.light(e.serialize());if(e instanceof Uint8Array)return Hash.light(e);throw new Error("MerkleTree objects must be Uint8Array or have a .hash()/.serialize() method")}}Class.register(MerkleTree);class MerklePath{constructor(e){if(!Array.isArray(e)||!NumberUtils.isUint8(e.length)||e.some(e=>!(e instanceof MerklePathNode)))throw new Error("Malformed nodes");this._nodes=e}static compute(e,t,r=MerkleTree._hash){const n=r(t),s=[];MerklePath._compute(e,n,s,r);return new MerklePath(s)}static _compute(e,t,r,n){const s=e.length;let i;if(0===s)return{containsLeaf:!1,inner:i=Hash.light(new Uint8Array(0))};if(1===s)return{containsLeaf:(i=n(e[0])).equals(t),inner:i};const o=Math.round(s/2),a=e.slice(0,o),c=e.slice(o),{containsLeaf:l,inner:h}=MerklePath._compute(a,t,r,n),{containsLeaf:u,inner:d}=MerklePath._compute(c,t,r,n);i=Hash.light(BufferUtils.concatTypedArrays(h.serialize(),d.serialize()));if(l){r.push(new MerklePathNode(d,!1));return{containsLeaf:!0,inner:i}}if(u){r.push(new MerklePathNode(h,!0));return{containsLeaf:!0,inner:i}}return{containsLeaf:!1,inner:i}}computeRoot(e,t=MerkleTree._hash){let r=t(e);for(const n of this._nodes){const e=n.left,t=n.hash,s=new SerialBuffer(2*t.serializedSize);e&&t.serialize(s);r.serialize(s);e||t.serialize(s);r=Hash.light(s)}return r}static _compress(e){const t=e.length,r=Math.ceil(t/8),n=new Uint8Array(r);for(let s=0;s<t;s++)e[s].left&&(n[Math.floor(s/8)]|=128>>>s%8);return n}static unserialize(e){const t=e.readUint8(),r=Math.ceil(t/8),n=e.read(r),s=[];for(let i=0;i<t;i++){const t=0!=(n[Math.floor(i/8)]&128>>>i%8),r=Hash.unserialize(e);s.push(new MerklePathNode(r,t))}return new MerklePath(s)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(this._nodes.length);e.write(MerklePath._compress(this._nodes));for(const t of this._nodes)t.hash.serialize(e);return e}get serializedSize(){return 1+Math.ceil(this._nodes.length/8)+this._nodes.reduce((e,t)=>e+t.hash.serializedSize,0)}equals(e){return e instanceof MerklePath&&this._nodes.length===e._nodes.length&&this._nodes.every((t,r)=>t.equals(e._nodes[r]))}get nodes(){return this._nodes}}Class.register(MerklePath);class MerklePathNode{constructor(e,t){this._hash=e;this._left=t}get hash(){return this._hash}get left(){return this._left}equals(e){return e instanceof MerklePathNode&&this._hash.equals(e.hash)&&this._left===e.left}}Class.register(MerklePathNode);class MerkleProof{constructor(e,t){if(!Array.isArray(e)||!NumberUtils.isUint16(e.length))throw new Error("Malformed nodes");if(!Array.isArray(t)||!NumberUtils.isUint16(t.length))throw new Error("Malformed operations");this._nodes=e;this._operations=t}static compute(e,t,r=MerkleTree._hash){const n=t.map(r),{containsLeaf:s,operations:i,path:o,inner:a}=MerkleProof._compute(e,n,r);return new MerkleProof(o,i)}static computeWithAbsence(e,t,r,n=MerkleTree._hash){const s=new Set;(t=t.slice()).sort(r);let i=0,o=0;for(;o<e.length&&i<t.length;){const n=e[o],a=r(n,t[i]);if(0===a){s.add(t[i]);++i}else if(a>0){o>0&&s.add(e[o-1]);s.add(n);++i}else++o}i<t.length&&e.length>0&&s.add(e[e.length-1]);return MerkleProof.compute(e,Array.from(s),n)}static _compute(e,t,r){const n=e.length;let s;if(0===n){s=Hash.light(new Uint8Array(0));return{containsLeaf:!1,operations:[MerkleProof.Operation.CONSUME_PROOF],path:[s],inner:s}}if(1===n){s=r(e[0]);const n=t.some(e=>s.equals(e));return{containsLeaf:n,operations:[n?MerkleProof.Operation.CONSUME_INPUT:MerkleProof.Operation.CONSUME_PROOF],path:n?[]:[s],inner:s}}const i=Math.round(n/2),o=e.slice(0,i),a=e.slice(i),{containsLeaf:c,operations:l,path:h,inner:u}=MerkleProof._compute(o,t,r),{containsLeaf:d,operations:_,path:f,inner:g}=MerkleProof._compute(a,t,r);s=Hash.light(BufferUtils.concatTypedArrays(u.serialize(),g.serialize()));if(!c&&!d)return{containsLeaf:!1,operations:[MerkleProof.Operation.CONSUME_PROOF],path:[s],inner:s};let p=l;p=p.concat(_);let y=h;y=y.concat(f);p.push(MerkleProof.Operation.HASH);return{containsLeaf:!0,operations:p,path:y,inner:s}}computeRoot(e,t=MerkleTree._hash){const r=e.map(t),n=[],s=this._nodes.slice();for(const i of this._operations)switch(i){case MerkleProof.Operation.CONSUME_PROOF:if(0===s.length)throw new Error("Invalid operation.");n.push(s.shift());break;case MerkleProof.Operation.CONSUME_INPUT:if(0===r.length)throw new Error("Invalid operation.");n.push(r.shift());break;case MerkleProof.Operation.HASH:{if(n.length<2)throw new Error("Invalid operation.");const e=n.splice(-2,2),t=new SerialBuffer(e.reduce((e,t)=>e+t.serializedSize,0)),[r,s]=e;r.serialize(t);s.serialize(t);n.push(Hash.light(t));break}default:throw new Error("Invalid operation.")}if(1!==n.length||0!==s.length||0!==r.length)throw Error("Did not consume all nodes.");return n[0]}static _compress(e){const t=e.length,r=Math.ceil(t/4),n=new Uint8Array(r);for(let s=0;s<t;s++){const t=3&e[s];n[Math.floor(s/4)]|=t<<s%4*2}return n}static unserialize(e){const t=e.readUint16(),r=Math.ceil(t/4),n=e.read(r),s=[];for(let a=0;a<t;a++){const e=n[Math.floor(a/4)]>>>a%4*2&3;s.push(e)}const i=e.readUint16(),o=[];for(let a=0;a<i;a++)o.push(Hash.unserialize(e));return new MerkleProof(o,s)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._operations.length);e.write(MerkleProof._compress(this._operations));e.writeUint16(this._nodes.length);for(const t of this._nodes)t.serialize(e);return e}get serializedSize(){return 4+Math.ceil(this._operations.length/4)+this._nodes.reduce((e,t)=>e+t.serializedSize,0)}equals(e){return e instanceof MerkleProof&&this._nodes.length===e._nodes.length&&this._nodes.every((t,r)=>t.equals(e._nodes[r]))&&this._operations.length===e._operations.length&&this._operations.every((t,r)=>t===e._operations[r])}get nodes(){return this._nodes}}MerkleProof.Operation={CONSUME_PROOF:0,CONSUME_INPUT:1,HASH:2};Class.register(MerkleProof);class PlatformUtils{static isBrowser(){return"undefined"!=typeof window}static isNodeJs(){return!PlatformUtils.isBrowser()&&"object"==typeof process&&"function"==typeof require}static supportsWebRTC(){return!!(PlatformUtils.isBrowser()?window.RTCPeerConnection||window.webkitRTCPeerConnection:null)}static isOnline(){return!PlatformUtils.isBrowser()||!("onLine"in window.navigator)||window.navigator.onLine}}Class.register(PlatformUtils);class StringUtils{static isMultibyte(e){return/[\uD800-\uDFFF]/.test(e)}static isHex(e){return/[0-9A-Fa-f]*/.test(e)}static isHexBytes(e,t){return!!StringUtils.isHex(e)&&(e.length%2==0&&("number"!=typeof t||e.length/2===t))}static commonPrefix(e,t){let r=0;for(;r<e.length&&e[r]===t[r];++r);return e.substr(0,r)}}Class.register(StringUtils);class Policy{static coinsToSatoshis(e){return Math.round(e*Policy.SATOSHIS_PER_COIN)}static satoshisToCoins(e){return e/Policy.SATOSHIS_PER_COIN}static supplyAfter(e){let t=Math.floor(e/Policy._supplyCacheInterval)*Policy._supplyCacheInterval;const r=(t=Math.max(0,Math.min(t,Policy._supplyCacheMax)))/Policy._supplyCacheInterval,n=Math.floor(e/Policy._supplyCacheInterval);let s=0===t?Policy.INITIAL_SUPPLY:Policy._supplyCache.get(t);for(let i=r;i<n;++i){t=i*Policy._supplyCacheInterval;const e=(i+1)*Policy._supplyCacheInterval-1;s=Policy._supplyAfter(s,e,t);Policy._supplyCache.set(e+1,s);Policy._supplyCacheMax=e+1}return Policy._supplyAfter(s,e,n*Policy._supplyCacheInterval)}static _supplyAfter(e,t,r=0){let n=e;for(let s=r;s<=t;++s)n+=Policy._blockRewardAt(n,s);return n}static blockRewardAt(e){const t=Policy.supplyAfter(e-1);return Policy._blockRewardAt(t,e)}static _blockRewardAt(e,t){if(t<=0)return 0;const r=Policy.TOTAL_SUPPLY-e;return t>=Policy.EMISSION_TAIL_START&&r>=Policy.EMISSION_TAIL_REWARD?Policy.EMISSION_TAIL_REWARD:(r-r%Policy.EMISSION_SPEED)/Policy.EMISSION_SPEED}}Policy.BLOCK_TIME=60;Policy.BLOCK_SIZE_MAX=1e6;Policy.BLOCK_TARGET_MAX=Math.pow(2,240);Policy.DIFFICULTY_BLOCK_WINDOW=120;Policy.DIFFICULTY_MAX_ADJUSTMENT_FACTOR=2;Policy.TRANSACTION_VALIDITY_WINDOW=120;Policy.SATOSHIS_PER_COIN=1e5;Policy.TOTAL_SUPPLY=21e14;Policy.INITIAL_SUPPLY=252e12;Policy.EMISSION_SPEED=Math.pow(2,22);Policy.EMISSION_TAIL_START=48692960;Policy.EMISSION_TAIL_REWARD=4e3;Policy.M=240;Policy.K=120;Policy.DELTA=.1;Policy.NUM_BLOCKS_VERIFICATION=250;Policy.NUM_SNAPSHOTS_MAX=20;Policy._supplyCache=new Map;Policy._supplyCacheMax=0;Policy._supplyCacheInterval=5e3;Class.register(Policy);class Primitive{constructor(e,t,r){if(t&&!(e instanceof t))throw new Error("Primitive: Invalid type");if(r!==undefined&&e.length!==undefined&&e.length!==r)throw new Error("Primitive: Invalid length");this._obj=e}equals(e){return e instanceof Primitive&&BufferUtils.equals(this.serialize(),e.serialize())}compare(e){if("function"==typeof this._obj.compare)return this._obj.compare(e._obj);if(this._obj.prototype===e._obj.prototype)return BufferUtils.compare(this.serialize(),e.serialize());throw new Error(`Incomparable types: ${this._obj.constructor.name} and ${e._obj.constructor.name}`)}hashCode(){return this.toBase64()}serialize(e){}toString(){return this.toBase64()}toBase64(){return BufferUtils.toBase64(this.serialize())}toHex(){return BufferUtils.toHex(this.serialize())}}Class.register(Primitive);class Hash extends Primitive{static copy(e){if(!e)return e;const t=new Uint8Array(e._obj);return new Hash(t)}constructor(e,t=Hash.Algorithm.BLAKE2B){null===e&&(e=new Uint8Array(Hash.getSize(t)));super(e,Crypto.hashType,Hash.getSize(t));this._algorithm=t}static light(e){return Hash.blake2b(e)}static blake2b(e){return new Hash(Crypto.blake2bSync(e),Hash.Algorithm.BLAKE2B)}static lightAsync(e){return Hash.blake2bAsync(e)}static blake2bAsync(e){return(0,_asyncToGenerator3["default"])(function*(){return new Hash(yield Crypto.blake2bAsync(e),Hash.Algorithm.BLAKE2B)})()}static hard(e){return Hash.argon2d(e)}static argon2d(e){return(0,_asyncToGenerator3["default"])(function*(){return new Hash(yield Crypto.argon2d(e),Hash.Algorithm.ARGON2D)})()}static sha256(e){return new Hash(Crypto.sha256(e),Hash.Algorithm.SHA256)}static compute(e,t){switch(t){case Hash.Algorithm.BLAKE2B:return Hash.blake2b(e);case Hash.Algorithm.SHA256:return Hash.sha256(e);default:throw new Error("Invalid hash algorithm")}}static unserialize(e,t=Hash.Algorithm.BLAKE2B){return new Hash(e.read(Hash.getSize(t)),t)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(this._obj);return e}subarray(e,t){return this._obj.subarray(e,t)}get serializedSize(){return Hash.SIZE.get(this._algorithm)}get array(){return this._obj}get algorithm(){return this._algorithm}equals(e){return e instanceof Hash&&e._algorithm===this._algorithm&&super.equals(e)}static fromBase64(e){return new Hash(BufferUtils.fromBase64(e))}static fromHex(e){return new Hash(BufferUtils.fromHex(e))}static fromString(e){try{return Hash.fromHex(e)}catch(t){}try{return Hash.fromBase64(e)}catch(t){}throw new Error("Invalid hash format")}static isHash(e){return e instanceof Hash}static getSize(e){const t=Hash.SIZE.get(e);if(!t)throw new Error("Invalid hash algorithm");return t}}Hash.Algorithm={BLAKE2B:1,ARGON2D:2,SHA256:3};Hash.SIZE=new Map;Hash.SIZE.set(Hash.Algorithm.BLAKE2B,Crypto.blake2bSize);Hash.SIZE.set(Hash.Algorithm.ARGON2D,Crypto.argon2dSize);Hash.SIZE.set(Hash.Algorithm.SHA256,Crypto.sha256Size);Hash.NULL=new Hash(new Uint8Array(Crypto.hashSize));Class.register(Hash);class PrivateKey extends Primitive{constructor(e){super(e,Crypto.privateKeyType,Crypto.privateKeySize)}static generate(){return new PrivateKey(Crypto.privateKeyGenerate())}static unserialize(e){return new PrivateKey(Crypto.privateKeyUnserialize(e.read(Crypto.privateKeySize)))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(Crypto.privateKeySerialize(this._obj));return e}get serializedSize(){return Crypto.privateKeySize}overwrite(e){this._obj.set(e._obj)}equals(e){return e instanceof PrivateKey&&super.equals(e)}}Class.register(PrivateKey);class PublicKey extends Primitive{static copy(e){return e?new PublicKey(new Uint8Array(e._obj)):e}constructor(e){super(e,Crypto.publicKeyType,Crypto.publicKeySize)}static derive(e){return new PublicKey(Crypto.publicKeyDerive(e._obj))}static sum(e){(e=e.slice()).sort((e,t)=>e.compare(t));return new PublicKey(Crypto.delinearizeAndAggregatePublicKeys(e.map(e=>e._obj)))}static unserialize(e){return new PublicKey(Crypto.publicKeyUnserialize(e.read(Crypto.publicKeySize)))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(Crypto.publicKeySerialize(this._obj));return e}get serializedSize(){return Crypto.publicKeySize}equals(e){return e instanceof PublicKey&&super.equals(e)}hash(){return Hash.light(this.serialize())}hashAsync(){return Hash.lightAsync(this.serialize())}compare(e){return BufferUtils.compare(this._obj,e._obj)}toAddress(){return Address.fromHash(this.hash())}toPeerId(){return new PeerId(this.hash().subarray(0,16))}}Class.register(PublicKey);class KeyPair extends Primitive{constructor(e,t=!1,r=null){super(e,Crypto.keyPairType);this._locked=t;this._lockedInternally=t;this._lockSalt=r;this._internalPrivateKey=new PrivateKey(Crypto.keyPairPrivate(this._obj))}static generate(){return new KeyPair(Crypto.keyPairGenerate())}static fromPrivateKey(e){return new KeyPair(Crypto.keyPairDerive(e._obj))}static fromHex(e){return KeyPair.unserialize(BufferUtils.fromHex(e))}static fromEncrypted(e,t){return(0,_asyncToGenerator3["default"])(function*(){if(1!==e.readUint8())throw new Error("Unsupported type");const r=e.readUint8();if(r>32)throw new Error("Rounds out-of-bounds");const n=Math.pow(2,r),s=PrivateKey.unserialize(e),i=e.read(KeyPair.EXPORT_SALT_LENGTH),o=e.read(KeyPair.EXPORT_CHECKSUM_LENGTH),a=new PrivateKey(yield KeyPair._otpKdf(s.serialize(),t,i,n)),c=KeyPair.fromPrivateKey(a),l=c.publicKey.hash();if(!BufferUtils.equals(l.subarray(0,4),o))throw new Error("Invalid key");return c})()}static unserialize(e){const t=PrivateKey.unserialize(e),r=PublicKey.unserialize(e);let n=!1,s=null;if(e.readPos<e.byteLength){if(1===e.readUint8()){n=!0;s=e.read(32)}}return new KeyPair(Crypto.keyPairFromKeys(t._obj,r._obj),n,s)}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._privateKey.serialize(e);this.publicKey.serialize(e);if(this._locked){e.writeUint8(1);e.write(this._lockSalt)}else e.writeUint8(0);return e}get privateKey(){if(this.isLocked)throw new Error("Wallet is locked");return this._privateKey}get _privateKey(){return this._unlockedPrivateKey||this._internalPrivateKey}get publicKey(){return this._publicKey||(this._publicKey=new PublicKey(Crypto.keyPairPublic(this._obj)))}get serializedSize(){return this._privateKey.serializedSize+this.publicKey.serializedSize+(this._locked?this._lockSalt.byteLength+1:1)}exportEncrypted(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=r._locked;if(r._locked)try{yield r.unlock(t||e)}catch(o){throw new Error("KeyPair is locked and lock key mismatches")}const s=new Uint8Array(KeyPair.EXPORT_SALT_LENGTH);Crypto.lib.getRandomValues(s);const i=new SerialBuffer(r.encryptedSize);i.writeUint8(1);i.writeUint8(Math.log2(KeyPair.EXPORT_KDF_ROUNDS));i.write(yield KeyPair._otpKdf(r.privateKey.serialize(),e,s,KeyPair.EXPORT_KDF_ROUNDS));i.write(s);i.write(r.publicKey.hash().subarray(0,KeyPair.EXPORT_CHECKSUM_LENGTH));n&&r.relock();return i})()}get encryptedSize(){return 2+this.privateKey.serializedSize+KeyPair.EXPORT_SALT_LENGTH+KeyPair.EXPORT_CHECKSUM_LENGTH}lock(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(r._locked)throw new Error("KeyPair already locked");t&&(r._lockSalt=t);if(!r._lockSalt||0===r._lockSalt.length){r._lockSalt=new Uint8Array(32);Crypto.lib.getRandomValues(r._lockSalt)}r._internalPrivateKey.overwrite(yield r._otpPrivateKey(e));r._clearUnlockedPrivateKey();r._locked=!0;r._lockedInternally=!0})()}unlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._locked)throw new Error("KeyPair not locked");const r=yield t._otpPrivateKey(e);if(!PublicKey.derive(r).equals(t.publicKey))throw new Error("Invalid key");t._unlockedPrivateKey=r;t._locked=!1})()}relock(){if(this._locked)throw new Error("KeyPair already locked");if(!this._lockedInternally)throw new Error("KeyPair was never locked");this._clearUnlockedPrivateKey();this._locked=!0}_clearUnlockedPrivateKey(){if(this._lockedInternally&&!this._locked){this._unlockedPrivateKey.overwrite(PrivateKey.unserialize(new SerialBuffer(this._unlockedPrivateKey.serializedSize)));this._unlockedPrivateKey=null}}_otpPrivateKey(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return new PrivateKey(yield KeyPair._otpKdf(t._privateKey.serialize(),e,t._lockSalt,KeyPair.LOCK_KDF_ROUNDS))})()}static _otpKdf(e,t,r,n){return(0,_asyncToGenerator3["default"])(function*(){return BufferUtils.xor(e,yield Crypto.kdf(t,r,n))})()}get isLocked(){return this._locked}equals(e){return e instanceof KeyPair&&super.equals(e)}}KeyPair.LOCK_KDF_ROUNDS=256;KeyPair.EXPORT_KDF_ROUNDS=256;KeyPair.EXPORT_CHECKSUM_LENGTH=4;KeyPair.EXPORT_SALT_LENGTH=16;Class.register(KeyPair);class RandomSecret extends Primitive{constructor(e){super(e,Crypto.randomSecretType,Crypto.randomSecretSize)}static unserialize(e){return new RandomSecret(Crypto.randomSecretUnserialize(e.read(Crypto.randomSecretSize)))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(Crypto.randomSecretSerialize(this._obj));return e}get serializedSize(){return Crypto.randomSecretSize}equals(e){return e instanceof RandomSecret&&super.equals(e)}}Class.register(RandomSecret);class Commitment extends Primitive{static copy(e){return e?new Commitment(new Uint8Array(e._obj)):e}static sum(e){return new Commitment(Crypto.aggregateCommitments(e.map(e=>e._obj)))}constructor(e){super(e,Crypto.commitmentType,Crypto.commitmentSize)}static unserialize(e){return new Commitment(Crypto.commitmentUnserialize(e.read(Crypto.commitmentSize)))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(Crypto.commitmentSerialize(this._obj));return e}get serializedSize(){return Crypto.commitmentSize}equals(e){return e instanceof Commitment&&super.equals(e)}}Class.register(Commitment);class CommitmentPair extends Primitive{constructor(e){super(e,Crypto.commitmentPairType)}static generate(){return new CommitmentPair(Crypto.commitmentPairGenerate())}static unserialize(e){const t=RandomSecret.unserialize(e),r=Commitment.unserialize(e);return new CommitmentPair(Crypto.commitmentPairFromValues(t._obj,r._obj))}static fromHex(e){return this.unserialize(BufferUtils.fromHex(e))}serialize(e){e=e||new SerialBuffer(this.serializedSize);this.secret.serialize(e);this.commitment.serialize(e);return e}get secret(){return this._secret||(this._secret=new RandomSecret(Crypto.commitmentPairRandomSecret(this._obj)))}get commitment(){return this._commitment||(this._commitment=new Commitment(Crypto.commitmentPairCommitment(this._obj)))}get serializedSize(){return this.secret.serializedSize+this.commitment.serializedSize}equals(e){return e instanceof CommitmentPair&&super.equals(e)}}CommitmentPair.SERIALIZED_SIZE=Crypto.randomSecretSize+Crypto.commitmentSize;Class.register(CommitmentPair);class Signature extends Primitive{static copy(e){if(!e)return e;const t=new Uint8Array(e._obj);return new Signature(t)}constructor(e){super(e,Crypto.signatureType,Crypto.signatureSize)}static create(e,t,r){return new Signature(Crypto.signatureCreate(e._obj,t._obj,r))}static fromPartialSignatures(e,t){return new Signature(Crypto.combinePartialSignatures(e._obj,t.map(e=>e._obj)))}static unserialize(e){return new Signature(Crypto.signatureUnserialize(e.read(Crypto.signatureSize)))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(Crypto.signatureSerialize(this._obj));return e}get serializedSize(){return Crypto.signatureSize}verify(e,t){return Crypto.signatureVerify(e._obj,t,this._obj)}equals(e){return e instanceof Signature&&super.equals(e)}}Class.register(Signature);class PartialSignature extends Primitive{constructor(e){super(e,Crypto.partialSignatureType,Crypto.partialSignatureSize)}static create(e,t,r,n,s,i){return new PartialSignature(Crypto.delinearizedPartialSignatureCreate(e._obj,t._obj,r.map(e=>e._obj),n._obj,s._obj,i))}static unserialize(e){return new PartialSignature(Crypto.partialSignatureUnserialize(e.read(Crypto.signatureSize)))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(Crypto.partialSignatureSerialize(this._obj));return e}get serializedSize(){return Crypto.partialSignatureSize}equals(e){return e instanceof PartialSignature&&super.equals(e)}}Class.register(PartialSignature);class Address extends Primitive{static copy(e){if(!e)return e;const t=new Uint8Array(e._obj);return new Address(t)}static fromHash(e){return new Address(e.subarray(0,Address.SERIALIZED_SIZE))}constructor(e){super(e,Uint8Array,Address.SERIALIZED_SIZE)}static unserialize(e){return new Address(e.read(Address.SERIALIZED_SIZE))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(this._obj);return e}subarray(e,t){return this._obj.subarray(e,t)}get serializedSize(){return Address.SERIALIZED_SIZE}equals(e){return e instanceof Address&&super.equals(e)}static fromString(e){try{return Address.fromUserFriendlyAddress(e)}catch(t){}try{return Address.fromHex(e)}catch(t){}try{return Address.fromBase64(e)}catch(t){}throw new Error("Invalid address format")}static fromBase64(e){return new Address(BufferUtils.fromBase64(e))}static fromHex(e){return new Address(BufferUtils.fromHex(e))}static fromUserFriendlyAddress(e){if((e=e.replace(/ /g,"")).substr(0,2).toUpperCase()!==Address.CCODE)throw new Error("Invalid Address: Wrong country code");if(36!==e.length)throw new Error("Invalid Address: Should be 36 chars (ignoring spaces)");if(1!==Address._ibanCheck(e.substr(4)+e.substr(0,4)))throw new Error("Invalid Address: Checksum invalid");return new Address(BufferUtils.fromBase32(e.substr(4)))}static _ibanCheck(e){const t=e.split("").map(e=>{const t=e.toUpperCase().charCodeAt(0);return t>=48&&t<=57?e:(t-55).toString()}).join("");let r="";for(let n=0;n<Math.ceil(t.length/6);n++)r=(parseInt(r+t.substr(6*n,6))%97).toString();return parseInt(r)}toUserFriendlyAddress(e=!0){const t=BufferUtils.toBase32(this.serialize()),r=("00"+(98-Address._ibanCheck(t+Address.CCODE+"00"))).slice(-2);let n=Address.CCODE+r+t;e&&(n=n.replace(/.{4}/g,"$& ").trim());return n}}Address.CCODE="NQ";Address.SERIALIZED_SIZE=20;Address.HEX_SIZE=40;Address.NULL=new Address(new Uint8Array(Address.SERIALIZED_SIZE));Address.CONTRACT_CREATION=new Address(new Uint8Array(Address.SERIALIZED_SIZE));Class.register(Address);class Account{constructor(e,t){if(!NumberUtils.isUint8(e))throw new Error("Malformed type");if(!NumberUtils.isUint64(t))throw new Error("Malformed balance");this._type=e;this._balance=t}static unserialize(e){const t=e.readUint8();e.readPos--;if(!Account.TYPE_MAP.has(t))throw new Error("Unknown account type");return Account.TYPE_MAP.get(t).unserialize(e)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(this._type);e.writeUint64(this._balance);return e}get serializedSize(){return 9}equals(e){return BufferUtils.equals(this.serialize(),e.serialize())}toString(){return`Account{type=${this._type}, balance=${this._balance.toString()}`}get balance(){return this._balance}get type(){return this._type}withBalance(e){throw new Error("Not yet implemented.")}withOutgoingTransaction(e,t,r,n=!1){if(n){if(t<e.validityStartHeight||t>=e.validityStartHeight+Policy.TRANSACTION_VALIDITY_WINDOW)throw new Error("Validity Error!");return this.withBalance(this._balance+e.value+e.fee)}{const n=this._balance-e.value-e.fee;if(n<0)throw new Error("Balance Error!");if(t<e.validityStartHeight||t>=e.validityStartHeight+Policy.TRANSACTION_VALIDITY_WINDOW)throw new Error("Validity Error!");if(r.containsTransaction(e))throw new Error("Double Transaction Error!");return this.withBalance(n)}}withIncomingTransaction(e,t,r=!1){if(r){const t=this._balance-e.value;if(t<0)throw new Error("Balance Error!");return this.withBalance(t)}return this.withBalance(this._balance+e.value)}withContractCommand(e,t,r=!1){throw new Error("Not yet implemented")}isInitial(){return this===Account.INITIAL}isToBePruned(){return 0===this._balance&&!this.isInitial()}}Account.Type={BASIC:0,VESTING:1,HTLC:2};Account.TYPE_MAP=new Map;Class.register(Account);class PrunedAccount{constructor(e,t){if(!(e instanceof Address))throw new Error("Malformed address");this._address=e;this._account=t}static unserialize(e){return new PrunedAccount(Address.unserialize(e),Account.unserialize(e))}compare(e){return this._address.compare(e._address)}get address(){return this._address}get account(){return this._account}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._address.serialize(e);this._account.serialize(e);return this}get serializedSize(){return this._address.serializedSize+this._account.serializedSize}}Class.register(PrunedAccount);class BasicAccount extends Account{static copy(e){return e?new BasicAccount(e._balance):e}constructor(e=0){super(Account.Type.BASIC,e)}static unserialize(e){if(e.readUint8()!==Account.Type.BASIC)throw new Error("Invalid account type");const t=e.readUint64();return new BasicAccount(t)}equals(e){return e instanceof BasicAccount&&this._type===e._type&&this._balance===e._balance}toString(){return`BasicAccount{balance=${this._balance}}`}static verifyOutgoingTransaction(e){return SignatureProof.verifyTransaction(e)}static verifyIncomingTransaction(e){return!(e.data.byteLength>64)}withBalance(e){return new BasicAccount(e)}withIncomingTransaction(e,t,r=!1){if(!r){if(e.hasFlag(Transaction.Flag.CONTRACT_CREATION)!==(e.recipientType!==this._type))throw new Error("Data Error!")}return super.withIncomingTransaction(e,t,r)}withContractCommand(e,t,r=!1){return!r&&e.recipientType!==this._type&&e.hasFlag(Transaction.Flag.CONTRACT_CREATION)?Account.TYPE_MAP.get(e.recipientType).create(this._balance,t,e):this}isInitial(){return 0===this._balance}}Account.INITIAL=new BasicAccount(0);Account.TYPE_MAP.set(Account.Type.BASIC,BasicAccount);Class.register(BasicAccount);class Contract extends Account{constructor(e,t){super(e,t)}static verifyIncomingTransaction(e){return!!e.recipient.equals(e.getContractCreationAddress())}withIncomingTransaction(e,t,r=!1){if(!r&&e.hasFlag(Transaction.Flag.CONTRACT_CREATION))throw new Error("Data error");return super.withIncomingTransaction(e,t,r)}withContractCommand(e,t,r=!1){return r&&e.hasFlag(Transaction.Flag.CONTRACT_CREATION)?new BasicAccount(this.balance):this}}Class.register(Contract);class HashedTimeLockedContract extends Contract{constructor(e=0,t=Address.NULL,r=Address.NULL,n=Hash.NULL,s=1,i=0,o=e){super(Account.Type.HTLC,e);if(!(t instanceof Address))throw new Error("Malformed address");if(!(r instanceof Address))throw new Error("Malformed address");if(!(n instanceof Hash))throw new Error("Malformed address");if(!NumberUtils.isUint8(s)||0===s)throw new Error("Malformed hashCount");if(!NumberUtils.isUint32(i))throw new Error("Malformed timeout");if(!NumberUtils.isUint64(o))throw new Error("Malformed totalAmount");this._sender=t;this._recipient=r;this._hashRoot=n;this._hashCount=s;this._timeout=i;this._totalAmount=o}static create(e,t,r){const n=new SerialBuffer(r.data),s=Address.unserialize(n),i=Address.unserialize(n),o=n.readUint8(),a=Hash.unserialize(n,o),c=n.readUint8(),l=n.readUint32();return new HashedTimeLockedContract(e,s,i,a,c,l)}static unserialize(e){if(e.readUint8()!==Account.Type.HTLC)throw new Error("Invalid account type");const t=e.readUint64(),r=Address.unserialize(e),n=Address.unserialize(e),s=e.readUint8(),i=Hash.unserialize(e,s),o=e.readUint8(),a=e.readUint32(),c=e.readUint64();return new HashedTimeLockedContract(t,r,n,i,o,a,c)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._sender.serialize(e);this._recipient.serialize(e);e.writeUint8(this._hashRoot.algorithm);this._hashRoot.serialize(e);e.writeUint8(this._hashCount);e.writeUint32(this._timeout);e.writeUint64(this._totalAmount);return e}get serializedSize(){return super.serializedSize+this._sender.serializedSize+this._recipient.serializedSize+1+this._hashRoot.serializedSize+1+4+8}get sender(){return this._sender}get recipient(){return this._recipient}get hashRoot(){return this._hashRoot}get hashCount(){return this._hashCount}get timeout(){return this._timeout}get totalAmount(){return this._totalAmount}toString(){return`HashedTimeLockedContract{balance=${this._balance}, sender=${this._sender.toUserFriendlyAddress(!1)}, recipient=${this._sender.toUserFriendlyAddress(!1)}, amount=${this._totalAmount}/${this._hashCount}, timeout=${this._timeout}}`}equals(e){return e instanceof HashedTimeLockedContract&&this._type===e._type&&this._balance===e._balance&&this._sender.equals(e._sender)&&this._recipient.equals(e._recipient)&&this._hashRoot.equals(e._hashRoot)&&this._hashCount===e._hashCount&&this._timeout===e._timeout&&this._totalAmount===e._totalAmount}static verifyOutgoingTransaction(e){try{const r=new SerialBuffer(e.proof);switch(r.readUint8()){case HashedTimeLockedContract.ProofType.REGULAR_TRANSFER:{const t=r.readUint8(),n=r.readUint8(),s=Hash.unserialize(r,t);let i=Hash.unserialize(r,t);for(let e=0;e<n;++e)i=Hash.compute(i.array,t);if(!s.equals(i))return!1;if(!SignatureProof.unserialize(r).verify(null,e.serializeContent()))return!1;break}case HashedTimeLockedContract.ProofType.EARLY_RESOLVE:if(!SignatureProof.unserialize(r).verify(null,e.serializeContent()))return!1;if(!SignatureProof.unserialize(r).verify(null,e.serializeContent()))return!1;break;case HashedTimeLockedContract.ProofType.TIMEOUT_RESOLVE:if(!SignatureProof.unserialize(r).verify(null,e.serializeContent()))return!1;break;default:return!1}return r.readPos===r.byteLength}catch(t){return!1}}static verifyIncomingTransaction(e){try{const r=new SerialBuffer(e.data);Address.unserialize(r);Address.unserialize(r);const n=r.readUint8();Hash.unserialize(r,n);r.readUint8();r.readUint32();return n!==Hash.Algorithm.ARGON2D&&(r.readPos===r.byteLength&&Contract.verifyIncomingTransaction(e))}catch(t){return!1}}withBalance(e){return new HashedTimeLockedContract(e,this._sender,this._recipient,this._hashRoot,this._hashCount,this._timeout,this._totalAmount)}withOutgoingTransaction(e,t,r,n=!1){const s=new SerialBuffer(e.proof);let i=0;switch(s.readUint8()){case HashedTimeLockedContract.ProofType.REGULAR_TRANSFER:{if(this._timeout<t)throw new Error("Proof Error!");const e=s.readUint8(),r=s.readUint8();if(!Hash.unserialize(s,e).equals(this._hashRoot))throw new Error("Proof Error!");Hash.unserialize(s,e);if(!SignatureProof.unserialize(s).isSignedBy(this._recipient))throw new Error("Proof Error!");i=Math.max(0,Math.floor((1-r/this._hashCount)*this._totalAmount));break}case HashedTimeLockedContract.ProofType.EARLY_RESOLVE:if(!SignatureProof.unserialize(s).isSignedBy(this._recipient))throw new Error("Proof Error!");if(!SignatureProof.unserialize(s).isSignedBy(this._sender))throw new Error("Proof Error!");break;case HashedTimeLockedContract.ProofType.TIMEOUT_RESOLVE:if(this._timeout>=t)throw new Error("Proof Error!");if(!SignatureProof.unserialize(s).isSignedBy(this._sender))throw new Error("Proof Error!");break;default:throw new Error("Proof Error!")}if(!n){if(this._balance-e.value-e.fee<i)throw new Error("Balance Error!")}return super.withOutgoingTransaction(e,t,r,n)}withIncomingTransaction(e,t,r=!1){throw new Error("Illegal incoming transaction")}}HashedTimeLockedContract.ProofType={REGULAR_TRANSFER:1,EARLY_RESOLVE:2,TIMEOUT_RESOLVE:3};Account.TYPE_MAP.set(Account.Type.HTLC,HashedTimeLockedContract);Class.register(HashedTimeLockedContract);class VestingContract extends Contract{constructor(e=0,t=Address.NULL,r=0,n=0,s=e,i=e){super(Account.Type.VESTING,e);if(!(t instanceof Address))throw new Error("Malformed address");if(!NumberUtils.isUint32(r))throw new Error("Malformed vestingStart");if(!NumberUtils.isUint32(n))throw new Error("Malformed vestingStepBlocks");if(!NumberUtils.isUint64(s))throw new Error("Malformed vestingStepAmount");if(!NumberUtils.isUint64(i))throw new Error("Malformed lowerCap");this._owner=t;this._vestingStart=r;this._vestingStepBlocks=n;this._vestingStepAmount=s;this._vestingTotalAmount=i}static create(e,t,r){let n,s,i,o;const a=new SerialBuffer(r.data),c=Address.unserialize(a);o=r.value;switch(r.data.length){case Address.SERIALIZED_SIZE+4:n=0;s=a.readUint32();i=o;break;case Address.SERIALIZED_SIZE+16:n=a.readUint32();s=a.readUint32();i=a.readUint64();break;case Address.SERIALIZED_SIZE+24:n=a.readUint32();s=a.readUint32();i=a.readUint64();o=a.readUint64();break;default:throw new Error("Invalid transaction data")}return new VestingContract(e,c,n,s,i,o)}static unserialize(e){if(e.readUint8()!==Account.Type.VESTING)throw new Error("Invalid account type");const t=e.readUint64(),r=Address.unserialize(e),n=e.readUint32(),s=e.readUint32(),i=e.readUint64(),o=e.readUint64();return new VestingContract(t,r,n,s,i,o)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._owner.serialize(e);e.writeUint32(this._vestingStart);e.writeUint32(this._vestingStepBlocks);e.writeUint64(this._vestingStepAmount);e.writeUint64(this._vestingTotalAmount);return e}get serializedSize(){return super.serializedSize+this._owner.serializedSize+4+4+8+8}get owner(){return this._owner}get vestingStart(){return this._vestingStart}get vestingStepBlocks(){return this._vestingStepBlocks}get vestingStepAmount(){return this._vestingStepAmount}get vestingTotalAmount(){return this._vestingTotalAmount}toString(){return`VestingAccount{balance=${this._balance}, owner=${this._owner.toUserFriendlyAddress()}`}equals(e){return e instanceof VestingContract&&this._type===e._type&&this._balance===e._balance&&this._owner.equals(e._owner)&&this._vestingStart===e._vestingStart&&this._vestingStepBlocks===e._vestingStepBlocks&&this._vestingStepAmount===e._vestingStepAmount&&this._vestingTotalAmount===e._vestingTotalAmount}static verifyOutgoingTransaction(e){const t=new SerialBuffer(e.proof);return!!SignatureProof.unserialize(t).verify(null,e.serializeContent())&&t.readPos===t.byteLength}static verifyIncomingTransaction(e){switch(e.data.length){case Address.SERIALIZED_SIZE+4:case Address.SERIALIZED_SIZE+16:case Address.SERIALIZED_SIZE+24:return Contract.verifyIncomingTransaction(e);default:return!1}}withBalance(e){return new VestingContract(e,this._owner,this._vestingStart,this._vestingStepBlocks,this._vestingStepAmount,this._vestingTotalAmount)}withOutgoingTransaction(e,t,r,n=!1){if(!n){const r=this.getMinCap(t);if(this._balance-e.value-e.fee<r)throw new Error("Balance Error!");const n=new SerialBuffer(e.proof);if(!SignatureProof.unserialize(n).isSignedBy(this._owner))throw new Error("Proof Error!")}return super.withOutgoingTransaction(e,t,r,n)}withIncomingTransaction(e,t,r=!1){throw new Error("Illegal incoming transaction")}getMinCap(e){return this._vestingStepBlocks&&this._vestingStepAmount>0?Math.max(0,this._vestingTotalAmount-Math.floor((e-this._vestingStart)/this._vestingStepBlocks)*this._vestingStepAmount):0}}Account.TYPE_MAP.set(Account.Type.VESTING,VestingContract);Class.register(VestingContract);class AccountsTreeNode{static terminalNode(e,t){return new AccountsTreeNode(AccountsTreeNode.TERMINAL,e,t)}static branchNode(e,t=[],r=[]){if(t.length!==r.length)throw new Error("Invalid list of children for branch node");return new AccountsTreeNode(AccountsTreeNode.BRANCH,e,t,r)}static copy(e){return e?AccountsTreeNode.unserialize(new SerialBuffer(e)):e}constructor(e,t="",r,n=[]){this._type=e;this._prefix=t;if(this.isBranch()){this._childrenSuffixes=r;this._childrenHashes=n}else{if(!this.isTerminal())throw`Invalid AccountsTreeNode type: ${e}`;this._account=r}}static isTerminalType(e){return e===AccountsTreeNode.TERMINAL}static isBranchType(e){return e===AccountsTreeNode.BRANCH}static unserialize(e){const t=e.readUint8(),r=e.readVarLengthString();if(AccountsTreeNode.isTerminalType(t)){const t=Account.unserialize(e);return AccountsTreeNode.terminalNode(r,t)}if(AccountsTreeNode.isBranchType(t)){const t=[],n=[],s=e.readUint8();for(let r=0;r<s;++r){const r=e.readVarLengthString(),s=Hash.unserialize(e),i=parseInt(r[0],16);t[i]=r;n[i]=s}return AccountsTreeNode.branchNode(r,t,n)}throw`Invalid AccountsTreeNode type: ${t}`}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(this._type);e.writeVarLengthString(this._prefix);if(this.isTerminal())this._account.serialize(e);else{const t=this._childrenSuffixes.reduce((e,t)=>e+!!t,0);e.writeUint8(t);for(let r=0;r<this._childrenSuffixes.length;++r)if(this._childrenHashes[r]){e.writeVarLengthString(this._childrenSuffixes[r]);this._childrenHashes[r].serialize(e)}}return e}get serializedSize(){let e;if(this.isTerminal())e=this._account.serializedSize;else{e=1+this._childrenHashes.reduce((e,t,r)=>e+(t?t.serializedSize+SerialBuffer.varLengthStringSize(this._childrenSuffixes[r]):0),0)}return 1+SerialBuffer.varLengthStringSize(this._prefix)+e}stripDown(){return this.serialize()}getChildHash(e){return this._childrenHashes&&this._childrenHashes[this._getChildIndex(e)]}getChild(e){const t=this._childrenSuffixes&&this._childrenSuffixes[this._getChildIndex(e)];return t?this.prefix+t:t}withChild(e,t){const r=this._childrenSuffixes.slice()||[],n=this._childrenHashes.slice()||[];r[this._getChildIndex(e)]=e.substr(this.prefix.length);n[this._getChildIndex(e)]=t;return AccountsTreeNode.branchNode(this._prefix,r,n)}withoutChild(e){const t=this._childrenSuffixes.slice()||[],r=this._childrenHashes.slice()||[];delete t[this._getChildIndex(e)];delete r[this._getChildIndex(e)];return AccountsTreeNode.branchNode(this._prefix,t,r)}hasChildren(){return this._childrenSuffixes&&this._childrenSuffixes.some(e=>!!e)}hasSingleChild(){return this._childrenSuffixes&&1===this._childrenSuffixes.reduce((e,t)=>e+!!t,0)}getFirstChild(){if(!this._childrenSuffixes)return undefined;const e=this._childrenSuffixes.find(e=>!!e);return e?this.prefix+e:undefined}getLastChild(){if(!this._childrenSuffixes)return undefined;for(let e=this._childrenSuffixes.length-1;e>=0;--e)if(this._childrenSuffixes[e])return this.prefix+this._childrenSuffixes[e];return undefined}getChildren(){return this._childrenSuffixes?this._childrenSuffixes.filter(e=>!!e).map(e=>this.prefix+e):undefined}get account(){return this._account}get prefix(){return this._prefix}set prefix(e){this._prefix=e;this._hash=undefined}withAccount(e){return AccountsTreeNode.terminalNode(this._prefix,e)}hash(){this._hash||(this._hash=Hash.light(this.serialize()));return this._hash}isChildOf(e){return e.getChildren()&&e.getChildren().includes(this._prefix)}isTerminal(){return AccountsTreeNode.isTerminalType(this._type)}isBranch(){return AccountsTreeNode.isBranchType(this._type)}_getChildIndex(e){Assert.that(e.substr(0,this.prefix.length)===this.prefix,`Prefix ${e} is not a child of the current node ${this.prefix}`);return parseInt(e[this.prefix.length],16)}equals(e){if(!(e instanceof AccountsTreeNode))return!1;if(!Object.is(this.prefix,e.prefix))return!1;if(this.isTerminal())return e.isTerminal()&&e._account.equals(this._account);if(!e.isBranch())return!1;if(this._childrenSuffixes.length!==e._childrenSuffixes.length)return!1;if(e._childrenSuffixes.length!==e._childrenHashes.length)return!1;for(let t=0;t<this._childrenSuffixes.length;++t){const r=this._childrenHashes[t],n=e._childrenHashes[t];if(r){if(!n||!r.equals(n))return!1}else if(n)return!1;if(this._childrenSuffixes[t]!==e._childrenSuffixes[t])return!1}return!0}}AccountsTreeNode.BRANCH=0;AccountsTreeNode.TERMINAL=255;Class.register(AccountsTreeNode);class AccountsTreeStore{static initPersistent(e){e.createObjectStore("Accounts",new AccountsTreeStoreCodec)}static getPersistent(e){return new AccountsTreeStore(e.getObjectStore("Accounts"))}static createVolatile(){const e=JDB.JungleDB.createVolatileObjectStore();return new AccountsTreeStore(e)}constructor(e){this._store=e}get(e){return this._store.get(e)}put(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.prefix;yield t._store.put(r,e);return r})()}remove(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.prefix;yield t._store.remove(r);return r})()}getRootNode(){return this.get("")}getTerminalNodes(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=[];yield r._store.keyStream(function(e){if(e.length===Address.HEX_SIZE){n.push(e);if(n.length===t)return!1}return!0},!0,JDB.KeyRange.lowerBound(e,!0));const s=[];for(const e of n)s.push(r._store.get(e));return Promise.all(s)})()}snapshot(e){const t=this._store.snapshot();e&&t.inherit(e._store);return new AccountsTreeStore(t)}transaction(e=!0){const t=this._store.transaction(e);return new AccountsTreeStore(t)}synchronousTransaction(e=!0){const t=this._store.synchronousTransaction(e);return new SynchronousAccountsTreeStore(t)}truncate(){return this._store.truncate()}commit(){return this._store.commit()}abort(){return this._store.abort()}get tx(){return this._store instanceof JDB.Transaction?this._store:undefined}}Class.register(AccountsTreeStore);class AccountsTreeStoreCodec{encode(e){return e.stripDown()}decode(e,t){return AccountsTreeNode.copy(e)}get valueEncoding(){return JDB.JungleDB.JSON_ENCODING}}class SynchronousAccountsTreeStore extends AccountsTreeStore{constructor(e){super(e);this._syncStore=e}preload(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){yield t._syncStore.preload(e)})()}getSync(e,t=!0){return this._syncStore.getSync(e,t)}putSync(e){const t=e.prefix;this._syncStore.putSync(t,e);return t}removeSync(e){const t=e.prefix;this._syncStore.removeSync(t);return t}getRootNodeSync(){return this.getSync("")}}Class.register(SynchronousAccountsTreeStore);class AccountsProof{constructor(e){if(!e||!Array.isArray(e)||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof AccountsTreeNode)))throw"Malformed nodes";this._nodes=e;this._index=null}static unserialize(e){const t=e.readUint16(),r=[];for(let n=0;n<t;n++)r.push(AccountsTreeNode.unserialize(e));return new AccountsProof(r)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._nodes.length);for(const t of this._nodes)t.serialize(e);return e}get serializedSize(){let e=2;for(const t of this._nodes)e+=t.serializedSize;return e}verify(){const e=[];this._index=new HashMap;for(const t of this._nodes){if(t.isBranch()){let r;for(;r=e.pop();){if(!r.isChildOf(t)){e.push(r);break}{const e=r.hash();if(!t.getChildHash(r.prefix).equals(e)||t.getChild(r.prefix)!==r.prefix)return!1;this._index.put(e,r)}}}e.push(t)}return 1===e.length&&""===e[0].prefix&&e[0].isBranch()}getAccount(e){Assert.that(!!this._index,"AccountsProof must be verified before retrieving accounts. Call verify() first.");const t=this._nodes[this._nodes.length-1],r=e.toHex();return this._getAccount(t,r)}_getAccount(e,t){const r=StringUtils.commonPrefix(e.prefix,t);if(r.length!==e.prefix.length)return null;if(r===t)return e.account;const n=e.getChildHash(t);if(n){const e=this._index.get(n);if(!e)throw new Error("Requested address not part of AccountsProof");return this._getAccount(e,t)}return null}toString(){return`AccountsProof{length=${this.length}}`}root(){return this._nodes[this._nodes.length-1].hash()}get length(){return this._nodes.length}get nodes(){return this._nodes}}Class.register(AccountsProof);class AccountsTreeChunk{constructor(e,t){if(!e||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof AccountsTreeNode&&e.isTerminal())))throw"Malformed nodes";this._nodes=e;this._proof=t}static unserialize(e){const t=e.readUint16(),r=[];for(let s=0;s<t;s++)r.push(AccountsTreeNode.unserialize(e));const n=AccountsProof.unserialize(e);return new AccountsTreeChunk(r,n)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._nodes.length);for(const t of this._nodes)t.serialize(e);this._proof.serialize(e);return e}get serializedSize(){let e=2;for(const t of this._nodes)e+=t.serializedSize;return e+=this._proof.serializedSize}verify(){if(!this._proof.verify())return!1;let e=null;for(let t=0;t<=this._nodes.length;++t){const r=t<this._nodes.length?this._nodes[t]:this.tail;if(e&&e>=r.prefix)return!1;e=r.prefix}return!0}toString(){return`AccountsTreeChunk{length=${this.length}}`}root(){return this._proof.root()}get terminalNodes(){return this._nodes.concat([this.tail])}get proof(){return this._proof}get head(){return this._nodes[0]}get tail(){return this._proof.nodes[0]}get length(){return this._nodes.length+1}}AccountsTreeChunk.SIZE_MAX=1e3;AccountsTreeChunk.EMPTY=new AccountsTreeChunk([],new AccountsProof([]));Class.register(AccountsTreeChunk);class AccountsTree extends Observable{static getPersistent(e){return(0,_asyncToGenerator3["default"])(function*(){const t=AccountsTreeStore.getPersistent(e);return new AccountsTree(t)._init()})()}static createVolatile(){return(0,_asyncToGenerator3["default"])(function*(){const e=AccountsTreeStore.createVolatile();return new AccountsTree(e)._init()})()}constructor(e){super();this._store=e;this._synchronizer=new Synchronizer}_init(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){let t=yield e._store.getRootNode();if(!t){t=AccountsTreeNode.branchNode("",[],[]);yield e._store.put(t)}return e})()}put(e,t){return this._synchronizer.push(()=>this._put(e,t))}_put(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(t.isInitial()&&!(yield r.get(e)))return;const n=yield r._store.getRootNode();Assert.that(!!n,"Corrupted store: Failed to fetch AccountsTree root node");const s=e.toHex();yield r._insert(n,s,t,[])})()}_insert(e,t,r,n){var s=this;return(0,_asyncToGenerator3["default"])(function*(){const i=StringUtils.commonPrefix(e.prefix,t);if(i.length!==e.prefix.length){const o=AccountsTreeNode.terminalNode(t,r),a=o.hash();yield s._store.put(o);const c=AccountsTreeNode.branchNode(i).withChild(e.prefix,e.hash()).withChild(o.prefix,a),l=c.hash();yield s._store.put(c);return s._updateKeys(c.prefix,l,n)}if(i===t){if(r.isInitial()){yield s._store.remove(e);return s._prune(e.prefix,n)}const t=(e=e.withAccount(r)).hash();yield s._store.put(e);return s._updateKeys(e.prefix,t,n)}const o=e.getChild(t);if(o){const i=yield s._store.get(o);n.push(e);return s._insert(i,t,r,n)}const a=AccountsTreeNode.terminalNode(t,r),c=a.hash();yield s._store.put(a);const l=(e=e.withChild(a.prefix,c)).hash();yield s._store.put(e);return s._updateKeys(e.prefix,l,n)})()}_prune(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){let n=t.length-1;for(;n>=0;--n){let s=t[n];if((s=s.withoutChild(e)).hasSingleChild()&&""!==s.prefix){yield r._store.remove(s);const e=s.getFirstChild(),i=yield r._store.get(e);yield r._store.put(i);const o=i.hash();return r._updateKeys(i.prefix,o,t.slice(0,n))}if(s.hasChildren()||""===s.prefix){const e=s.hash();yield r._store.put(s);return r._updateKeys(s.prefix,e,t.slice(0,n))}e=s.prefix}return undefined})()}_updateKeys(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){let s=r.length-1;for(;s>=0;--s){let i=r[s];i=i.withChild(e,t);yield n._store.put(i);t=i.hash();e=i.prefix}return t})()}get(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._store.get(e.toHex());return r!==undefined?r.account:null})()}getAccountsProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._store.getRootNode();Assert.that(!!r,"Corrupted store: Failed to fetch AccountsTree root node");const n=[];for(const t of e)n.push(t.toHex());n.sort();const s=[];yield t._getAccountsProof(r,n,s);return new AccountsProof(s)})()}_getAccountsProof(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){let s=!1;for(let i=0;i<t.length;){let o=t[i];if(StringUtils.commonPrefix(e.prefix,o).length!==e.prefix.length||e.prefix===o){s=!0;i++;continue}const a=e.getChild(o);if(a){const e=yield n._store.get(a),c=[o];let l=i+1;for(;l<t.length&&t[l].startsWith(e.prefix);++l)c.push(t[l]);i=l;s=(yield n._getAccountsProof(e,c,r))||s}else{s=!0;i++}}s&&r.push(e);return s})()}getChunk(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r._store.getTerminalNodes(e,t),s=n.pop();let i;i=s?yield r.getAccountsProof([Address.fromHex(s.prefix)]):yield r.getAccountsProof([Address.fromHex("ffffffffffffffffffffffffffffffffffffffff")]);return new AccountsTreeChunk(n,i)})()}transaction(e=!0){return new AccountsTree(this._store.transaction(e))._init()}synchronousTransaction(e=!0){const t=this._store.synchronousTransaction(e);return new SynchronousAccountsTree(t)._init()}partialTree(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=e._store.synchronousTransaction(!1);yield t.truncate();return new PartialAccountsTree(t)._init()})()}snapshot(e){return new AccountsTree(this._store.snapshot(e?e._store:undefined))._init()}commit(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){Assert.that(!(yield e.root()).equals(new Hash(null)));return e._store.commit()})()}abort(){return this._store.abort()}root(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield e._store.getRootNode();return t&&t.hash()})()}get tx(){return this._store.tx}isEmpty(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){return!(yield e._store.getRootNode()).hasChildren()})()}}Class.register(AccountsTree);class SynchronousAccountsTree extends AccountsTree{constructor(e){super(e);this._syncStore=e}preloadAddresses(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._syncStore.getRootNode();Assert.that(!!r,"Corrupted store: Failed to fetch AccountsTree root node");const n=[];for(const t of e)n.push(t.toHex());n.sort();yield t._preloadAddresses(r,n)})()}_preloadAddresses(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){e.hasChildren()&&(yield r._syncStore.preload(e.getChildren()));for(let n=0;n<t.length;){const s=t[n];if(StringUtils.commonPrefix(e.prefix,s).length!==e.prefix.length||e.prefix===s){n++;continue}const i=e.getChild(s);if(i){const e=r._syncStore.getSync(i),o=[s];let a=n+1;for(;a<t.length&&t[a].startsWith(e.prefix);++a)o.push(t[a]);n=a;yield r._preloadAddresses(e,o)}else n++}})()}putSync(e,t){this.putBatch(e,t);this.finalizeBatch()}finalizeBatch(){const e=this._syncStore.getRootNodeSync();this._updateHashes(e)}putBatch(e,t){if(t.isInitial()&&!this.getSync(e,!1))return;const r=this._syncStore.getRootNodeSync();Assert.that(!!r,"Corrupted store: Failed to fetch AccountsTree root node");const n=e.toHex();this._insertBatch(r,n,t,[])}_insertBatch(e,t,r,n){const s=StringUtils.commonPrefix(e.prefix,t);if(s.length!==e.prefix.length){const i=AccountsTreeNode.terminalNode(t,r);this._syncStore.putSync(i);const o=AccountsTreeNode.branchNode(s).withChild(e.prefix,new Hash(null)).withChild(i.prefix,new Hash(null));this._syncStore.putSync(o);return this._updateKeysBatch(o.prefix,n)}if(s===t){if(r.isInitial()){this._syncStore.removeSync(e);return this._pruneBatch(e.prefix,n)}e=e.withAccount(r);this._syncStore.putSync(e);return this._updateKeysBatch(e.prefix,n)}const i=e.getChild(t);if(i){const s=this._syncStore.getSync(i);n.push(e);return this._insertBatch(s,t,r,n)}const o=AccountsTreeNode.terminalNode(t,r);this._syncStore.putSync(o);e=e.withChild(o.prefix,new Hash(null));this._syncStore.putSync(e);return this._updateKeysBatch(e.prefix,n)}_pruneBatch(e,t){let r=t.length-1;for(;r>=0;--r){let n=t[r];if((n=n.withoutChild(e)).hasSingleChild()&&""!==n.prefix){this._syncStore.removeSync(n);const e=n.getFirstChild(),s=this._syncStore.getSync(e);this._syncStore.putSync(s);return this._updateKeysBatch(s.prefix,t.slice(0,r))}if(n.hasChildren()||""===n.prefix){this._syncStore.putSync(n);return this._updateKeysBatch(n.prefix,t.slice(0,r))}e=n.prefix}return undefined}_updateKeysBatch(e,t){let r=t.length-1;for(;r>=0;--r){let n=t[r];n=n.withChild(e,new Hash(null));this._syncStore.putSync(n);e=n.prefix}}_updateHashes(e){if(e.isTerminal())return e.hash();const t=new Hash(null),r=e.getChildren().map(r=>{const n=e.getChildHash(r);if(!n.equals(t))return n;const s=this._syncStore.getSync(r);return this._updateHashes(s)});let n=e;e.getChildren().forEach((e,t)=>{n=n.withChild(e,r[t])});this._syncStore.putSync(n);return n.hash()}getSync(e,t=!0){const r=this._syncStore.getSync(e.toHex(),t);return r!==undefined?r.account:null}rootSync(){const e=this._syncStore.getRootNodeSync();return e&&e.hash()}}Class.register(SynchronousAccountsTree);class PartialAccountsTree extends SynchronousAccountsTree{constructor(e){super(e);this._complete=!1;this._lastPrefix=""}pushChunk(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!e.verify())return PartialAccountsTree.Status.ERR_INCORRECT_PROOF;const r=t.synchronousTransaction();r._putLight(e.terminalNodes);if(!r._mergeProof(e.proof,e.tail.prefix)){yield r.abort();return PartialAccountsTree.Status.ERR_UNMERGEABLE}t._complete=r.complete;yield r.commit();t._lastPrefix=e.tail.prefix;return t._complete?PartialAccountsTree.Status.OK_COMPLETE:PartialAccountsTree.Status.OK_UNFINISHED})()}_mergeProof(e,t){let r=this._store.getRootNodeSync(),n=r.getChildren(),s=!0,i=e.length-1;for(;i>0;--i){const o=e.nodes[i];if(StringUtils.commonPrefix(r.prefix,o.prefix)!==r.prefix)return!1;const a=o.getChildren();if(n.length>a.length)return!1;const c=r.getLastChild();let l=!1,h=0;for(const e of a){if(!(e<=t.substr(0,e.length)))break;{const t=n.shift();if(StringUtils.commonPrefix(c,e)===e){e!==c&&(l=!0);continue}if(t!==e)return!1;const s=r.getChildHash(t),i=o.getChildHash(t);if(!s||!i||!s.equals(i))return!1}++h}if(0!==n.length)return!1;s=s&&h===a.length-1;if(l)n=[c];else{if(r.isTerminal())return!1;n=(r=this._store.getSync(r.getLastChild())).getChildren();if(r.isTerminal())break}}if(!r.equals(e.nodes[0]))return!1;this._complete=s;return!0}_putLight(e){Assert.that(e.every(e=>e.isTerminal()),"Can only build tree from terminal nodes");let t=this._store.getRootNodeSync();Assert.that(!!t,"Corrupted store: Failed to fetch AccountsTree root node");for(const r of e){this._insertBatch(t,r.prefix,r.account,[]);t=this._store.getRootNodeSync();Assert.that(!!t,"Corrupted store: Failed to fetch AccountsTree root node")}this._updateHashes(t)}get complete(){return this._complete}get missingPrefix(){return this._lastPrefix}synchronousTransaction(e=!0){const t=new PartialAccountsTree(this._store.synchronousTransaction(e));t._complete=this._complete;t._lastPrefix=this._lastPrefix;return t}transaction(e=!0){if(!this.complete)throw new Error("Can only construct AccountsTree from complete PartialAccountsTree");return new AccountsTree(this._store.synchronousTransaction(e))}commit(){return this._store.commit()}abort(){return this._store.abort()}}PartialAccountsTree.Status={ERR_HASH_MISMATCH:-3,ERR_INCORRECT_PROOF:-2,ERR_UNMERGEABLE:-1,OK_COMPLETE:0,OK_UNFINISHED:1};Class.register(PartialAccountsTree);class Accounts extends Observable{static getPersistent(e){return(0,_asyncToGenerator3["default"])(function*(){const t=yield AccountsTree.getPersistent(e);return new Accounts(t)})()}static createVolatile(){return(0,_asyncToGenerator3["default"])(function*(){const e=yield AccountsTree.createVolatile();return new Accounts(e)})()}constructor(e){super();this._tree=e;this.bubble(this._tree,"*")}initialize(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){Assert.that(yield r._tree.isEmpty());const n=yield r._tree.synchronousTransaction();try{const s=BufferUtils.fromBase64(t),o=s.readUint16();for(let e=0;e<o;e++){const e=Address.unserialize(s),t=Account.unserialize(s);n.putSync(e,t)}yield r._commitBlockBody(n,e.body,e.height,new TransactionCache);n.finalizeBatch()}catch(i){yield n.abort();throw i}const s=n.rootSync();if(!e.accountsHash.equals(s)){yield n.abort();throw new Error("Genesis AccountsHash mismatch")}return n.commit()})()}getAccountsProof(e){return this._tree.getAccountsProof(e)}getAccountsTreeChunk(e){return this._tree.getChunk(e,AccountsTreeChunk.SIZE_MAX)}commitBlock(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r._tree.synchronousTransaction();yield n.preloadAddresses(e.body.getAddresses());try{r._commitBlockBody(n,e.body,e.height,t)}catch(i){yield n.abort();throw i}n.finalizeBatch();const s=n.rootSync();if(!e.accountsHash.equals(s)){yield n.abort();throw new Error("AccountsHash mismatch")}return n.commit()})()}commitBlockBody(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=yield n._tree.synchronousTransaction();yield s.preloadAddresses(e.getAddresses());try{n._commitBlockBody(s,e,t,r)}catch(i){yield s.abort();throw i}s.finalizeBatch();return s.commit()})()}gatherToBePrunedAccounts(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=yield n._tree.synchronousTransaction(),i=[];for(const t of e)i.push(t.sender,t.recipient);yield s.preloadAddresses(i);try{n._processSenderAccounts(s,e,t,r);n._processRecipientAccounts(s,e,t);n._processContracts(s,e,t);const i=[];for(const t of e){const e=n._getSync(t.sender,undefined,s);e.isToBePruned()&&i.push(new PrunedAccount(t.sender,e))}return i.sort(function(e,t){return e.compare(t)})}finally{yield s.abort()}})()}revertBlock(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(!e)throw new Error("block undefined");const n=yield r._tree.root();if(!e.accountsHash.equals(n))throw new Error("AccountsHash mismatch");return r.revertBlockBody(e.body,e.height,t)})()}revertBlockBody(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=yield n._tree.synchronousTransaction();yield s.preloadAddresses(e.getAddresses());try{n._revertBlockBody(s,e,t,r)}catch(i){yield s.abort();throw i}s.finalizeBatch();return s.commit()})()}get(e,t,r=this._tree){return(0,_asyncToGenerator3["default"])(function*(){const n=yield r.get(e);if(!n){if("undefined"==typeof t)return Account.INITIAL;throw new Error("Account type was given but account not present")}if("undefined"!=typeof t&&n.type!==t)throw new Error("Account type does match actual account");return n})()}_getSync(e,t,r){const n=r.getSync(e,!1);if(!n){if("undefined"==typeof t)return Account.INITIAL;throw new Error("Account type was given but account not present")}if("undefined"!=typeof t&&n.type!==t)throw new Error("Account type does match actual account");return n}transaction(e=!0){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return new Accounts(yield t._tree.transaction(e))})()}snapshot(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return new Accounts(yield t._tree.snapshot(e?e._tree:undefined))})()}partialAccountsTree(){return this._tree.partialTree()}commit(){return this._tree.commit()}abort(){return this._tree.abort()}_processSenderAccounts(e,t,r,n,s=!1){for(const i of t){const t=this._getSync(i.sender,s?undefined:i.senderType,e);e.putBatch(i.sender,t.withOutgoingTransaction(i,r,n,s))}}_processRecipientAccounts(e,t,r,n=!1){for(const s of t){const t=this._getSync(s.recipient,undefined,e);e.putBatch(s.recipient,t.withIncomingTransaction(s,r,n))}}_processContracts(e,t,r,n=!1){n&&(t=t.slice().reverse());for(const s of t){const t=this._getSync(s.recipient,n?s.recipientType:undefined,e);e.putBatch(s.recipient,t.withContractCommand(s,r,n))}}_commitBlockBody(e,t,r,n){this._processSenderAccounts(e,t.transactions,r,n);this._processRecipientAccounts(e,t.transactions,r);this._processContracts(e,t.transactions,r);const s=t.prunedAccounts.slice();for(const i of t.transactions){const t=this._getSync(i.sender,undefined,e);if(t.isToBePruned()){const r=s.findIndex(e=>e.address.equals(i.sender));if(-1===r||!t.equals(s[r].account))throw new Error("Account was not pruned correctly");e.putBatch(i.sender,Account.INITIAL);s.splice(r,1)}}if(s.length>0)throw new Error("Account was invalidly pruned");this._rewardMiner(e,t,r,!1)}_revertBlockBody(e,t,r,n){this._rewardMiner(e,t,r,!0);for(const s of t.prunedAccounts)e.putBatch(s.address,s.account);this._processContracts(e,t.transactions,r,!0);this._processRecipientAccounts(e,t.transactions,r,!0);this._processSenderAccounts(e,t.transactions,r,n,!0)}_rewardMiner(e,t,r,n=!1){const s=t.transactions.reduce((e,t)=>e+t.fee,0),i=new ExtendedTransaction(Address.NULL,Account.Type.BASIC,t.minerAddr,Account.Type.BASIC,s+Policy.blockRewardAt(r),0,0,Transaction.Flag.NONE,new Uint8Array(0)),o=this._getSync(t.minerAddr,undefined,e);e.putBatch(t.minerAddr,o.withIncomingTransaction(i,r,n))}hash(){return this._tree.root()}get tx(){return this._tree.tx}}Class.register(Accounts);class BlockHeader{static copy(e){if(!e)return e;const t=Hash.copy(e._prevHash),r=Hash.copy(e._interlinkHash),n=Hash.copy(e._bodyHash),s=Hash.copy(e._accountsHash);return new BlockHeader(t,r,n,s,e._nBits,e._height,e._timestamp,e._nonce,e._version)}constructor(e,t,r,n,s,i,o,a,c=BlockHeader.CURRENT_VERSION){if(!NumberUtils.isUint16(c))throw"Malformed version";if(!Hash.isHash(e))throw"Malformed prevHash";if(!Hash.isHash(t))throw"Malformed interlinkHash";if(!Hash.isHash(r))throw"Malformed bodyHash";if(!Hash.isHash(n))throw"Malformed accountsHash";if(!NumberUtils.isUint32(s)||!BlockUtils.isValidCompact(s))throw"Malformed nBits";if(!NumberUtils.isUint32(i))throw"Invalid height";if(!NumberUtils.isUint32(o))throw"Malformed timestamp";if(!NumberUtils.isUint32(a))throw"Malformed nonce";this._version=c;this._prevHash=e;this._interlinkHash=t;this._bodyHash=r;this._accountsHash=n;this._nBits=s;this._height=i;this._timestamp=o;this._nonce=a}static unserialize(e){const t=e.readUint16();if(!BlockHeader.SUPPORTED_VERSIONS.includes(t))throw new Error(`Unsupported block version ${t}`);const r=Hash.unserialize(e),n=Hash.unserialize(e),s=Hash.unserialize(e),i=Hash.unserialize(e),o=e.readUint32(),a=e.readUint32(),c=e.readUint32(),l=e.readUint32();return new BlockHeader(r,n,s,i,o,a,c,l,t)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._version);this._prevHash.serialize(e);this._interlinkHash.serialize(e);this._bodyHash.serialize(e);this._accountsHash.serialize(e);e.writeUint32(this._nBits);e.writeUint32(this._height);e.writeUint32(this._timestamp);e.writeUint32(this._nonce);return e}get serializedSize(){return 2+this._prevHash.serializedSize+this._interlinkHash.serializedSize+this._bodyHash.serializedSize+this._accountsHash.serializedSize+4+4+4+4}verifyProofOfWork(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.pow(e);return BlockUtils.isProofOfWork(r,t.target)})()}isImmediateSuccessorOf(e){if(this.height!==e.height+1)return!1;if(this.timestamp<e.timestamp)return!1;const t=e.hash();return!!this.prevHash.equals(t)}hash(e){this._hash=this._hash||Hash.light(this.serialize(e));return this._hash}hashAsync(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){t._hash=t._hash||(yield Hash.lightAsync(t.serialize(e)));return t._hash})()}pow(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){t._pow=t._pow||(yield Hash.hard(t.serialize(e)));return t._pow})()}equals(e){return e instanceof BlockHeader&&this._prevHash.equals(e.prevHash)&&this._interlinkHash.equals(e.interlinkHash)&&this._bodyHash.equals(e.bodyHash)&&this._accountsHash.equals(e.accountsHash)&&this._nBits===e.nBits&&this._height===e.height&&this._timestamp===e.timestamp&&this._nonce===e.nonce}toString(){return"BlockHeader{"+`prevHash=${this._prevHash}, `+`interlinkHash=${this._interlinkHash}, `+`bodyHash=${this._bodyHash}, `+`accountsHash=${this._accountsHash}, `+`nBits=${this._nBits.toString(16)}, `+`height=${this._height}, `+`timestamp=${this._timestamp}, `+`nonce=${this._nonce}`+"}"}get version(){return this._version}get prevHash(){return this._prevHash}get interlinkHash(){return this._interlinkHash}get bodyHash(){return this._bodyHash}get accountsHash(){return this._accountsHash}get nBits(){return this._nBits}get target(){return BlockUtils.compactToTarget(this._nBits)}get difficulty(){return BlockUtils.compactToDifficulty(this._nBits)}get height(){return this._height}get timestamp(){return this._timestamp}get nonce(){return this._nonce}set nonce(e){this._nonce=e;this._hash=null;this._pow=null}}BlockHeader.Version={V1:1};BlockHeader.CURRENT_VERSION=BlockHeader.Version.V1;BlockHeader.SUPPORTED_VERSIONS=[BlockHeader.Version.V1];BlockHeader.SERIALIZED_SIZE=146;Class.register(BlockHeader);class BlockInterlink{static copy(e){if(!e)return e;const t=e._hashes.map(e=>Hash.copy(e)),r=new Uint8Array(e._repeatBits),n=e._compressed.map(e=>Hash.copy(e));return new BlockInterlink(t,undefined,r,n)}static _compress(e,t){const r=e.length,n=Math.ceil(r/8),s=new Uint8Array(n);let i=t;const o=[];for(let a=0;a<r;a++){const t=e[a];if(t.equals(i))s[Math.floor(a/8)]|=128>>>a%8;else{o.push(t);i=t}}return{repeatBits:s,compressed:o}}constructor(e,t,r,n){if(!Array.isArray(e)||!NumberUtils.isUint8(e.length)||e.some(e=>!(e instanceof Hash)))throw new Error("Malformed hashes");if((r||n)&&(!r||!n))throw new Error("Malformed repeatBits/compressed");if(!t&&!r)throw new Error("Either prevHash or repeatBits/compressed required");r||({repeatBits:r,compressed:n}=BlockInterlink._compress(e,t));this._hashes=e;this._repeatBits=r;this._compressed=n}static unserialize(e,t){const r=e.readUint8(),n=Math.ceil(r/8),s=e.read(n);let i=t;const o=[],a=[];for(let c=0;c<r;c++){if(!(0!=(s[Math.floor(c/8)]&128>>>c%8))){i=Hash.unserialize(e);a.push(i)}o.push(i)}return new BlockInterlink(o,t,s,a)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(this._hashes.length);e.write(this._repeatBits);for(const t of this._compressed)t.serialize(e);return e}get serializedSize(){return 1+this._repeatBits.length+this._compressed.reduce((e,t)=>e+t.serializedSize,0)}equals(e){return e instanceof BlockInterlink&&this._hashes.length===e._hashes.length&&this._hashes.every((t,r)=>t.equals(e.hashes[r]))}hash(){this._hash||(this._hash=MerkleTree.computeRoot([this._repeatBits,Block.GENESIS.HASH,...this._compressed]));return this._hash}get hashes(){return this._hashes}get length(){return this._hashes.length}}Class.register(BlockInterlink);class BlockBody{static getMetadataSize(e){return Address.SERIALIZED_SIZE+1+e.byteLength+2}constructor(e,t,r=new Uint8Array(0),n=[]){if(!(e instanceof Address))throw"Malformed minerAddr";if(!Array.isArray(t)||t.some(e=>!(e instanceof Transaction)))throw"Malformed transactions";if(!(r instanceof Uint8Array&&NumberUtils.isUint8(r.byteLength)))throw"Malformed extraData";this._minerAddr=e;this._extraData=r;this._transactions=t;this._prunedAccounts=n;this._hash=null}static unserialize(e){const t=Address.unserialize(e),r=e.readUint8(),n=e.read(r),s=e.readUint16(),i=new Array(s);for(let c=0;c<s;c++)i[c]=Transaction.unserialize(e);const o=e.readUint16(),a=[];for(let c=0;c<o;c++)a.push(PrunedAccount.unserialize(e));return new BlockBody(t,i,n,a)}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._minerAddr.serialize(e);e.writeUint8(this._extraData.byteLength);e.write(this._extraData);e.writeUint16(this._transactions.length);for(const t of this._transactions)t.serialize(e);e.writeUint16(this._prunedAccounts.length);for(const t of this._prunedAccounts)t.serialize(e);return e}get serializedSize(){let e=this._minerAddr.serializedSize+1+this._extraData.byteLength+2+2;for(const t of this._transactions)e+=t.serializedSize;return e+=this._prunedAccounts.reduce((e,t)=>e+t.serializedSize,0)}verify(){let e=null;for(const r of this._transactions){if(e&&e.compareBlockOrder(r)>=0){Log.w(BlockBody,"Invalid block - transactions not ordered.");return!1}e=r;if(!r.verify()){Log.w(BlockBody,"Invalid block - invalid transaction");return!1}}let t=null;for(const r of this._prunedAccounts){if(t&&t.compare(r)>=0){Log.w(BlockBody,"Invalid block - pruned accounts not ordered.");return!1}t=r;if(!r.account.isToBePruned()){Log.w(BlockBody,"Invalid block - invalid pruned account");return!1}}return!0}getMerkleLeafs(){return[this._minerAddr,this._extraData,...this._transactions,...this.prunedAccounts]}hash(){this._hash||(this._hash=MerkleTree.computeRoot(this.getMerkleLeafs()));return this._hash}equals(e){return e instanceof BlockBody&&this._minerAddr.equals(e.minerAddr)&&BufferUtils.equals(this._extraData,e.extraData)&&this._transactions.length===e.transactions.length&&this._transactions.every((t,r)=>t.equals(e.transactions[r]))}getAddresses(){const e=[this._minerAddr];for(const t of this._transactions)e.push(t.sender,t.recipient);return e}get extraData(){return this._extraData}get minerAddr(){return this._minerAddr}get transactions(){return this._transactions}get transactionCount(){return this._transactions.length}get prunedAccounts(){return this._prunedAccounts}}Class.register(BlockBody);class BlockUtils{static compactToTarget(e){return(16777215&e)*Math.pow(2,8*((e>>24)-3))}static targetToCompact(e){if(!Number.isFinite(e)||Number.isNaN(e))throw"Invalid Target";let t=Math.max(Math.ceil(Math.log2(e)/8),1);e/Math.pow(2,8*(t-1))>=128&&t++;return(t<<24)+(e/Math.pow(2,8*(t-3))&16777215)}static getTargetHeight(e){return Math.ceil(Math.log2(e))}static getTargetDepth(e){return BlockUtils.getTargetHeight(Policy.BLOCK_TARGET_MAX)-BlockUtils.getTargetHeight(e)}static compactToDifficulty(e){return Policy.BLOCK_TARGET_MAX/BlockUtils.compactToTarget(e)}static difficultyToCompact(e){return BlockUtils.targetToCompact(BlockUtils.difficultyToTarget(e))}static difficultyToTarget(e){return Policy.BLOCK_TARGET_MAX/e}static targetToDifficulty(e){return Policy.BLOCK_TARGET_MAX/e}static hashToTarget(e){return parseInt(e.toHex(),16)}static realDifficulty(e){return BlockUtils.targetToDifficulty(BlockUtils.hashToTarget(e))}static isProofOfWork(e,t){return parseInt(e.toHex(),16)<=t}static isValidCompact(e){return BlockUtils.isValidTarget(BlockUtils.compactToTarget(e))}static isValidTarget(e){return e>=1&&e<=Policy.BLOCK_TARGET_MAX}static getNextTarget(e,t,r){Assert.that(e.height-t.height===Policy.DIFFICULTY_BLOCK_WINDOW||e.height<=Policy.DIFFICULTY_BLOCK_WINDOW&&1===t.height,`Tail and head block must be ${Policy.DIFFICULTY_BLOCK_WINDOW} blocks apart`);let n=e.timestamp-t.timestamp;if(e.height<=Policy.DIFFICULTY_BLOCK_WINDOW){n+=(Policy.DIFFICULTY_BLOCK_WINDOW-e.height+1)*Policy.BLOCK_TIME;r+=Policy.DIFFICULTY_BLOCK_WINDOW-e.height+1}let s=n/(Policy.DIFFICULTY_BLOCK_WINDOW*Policy.BLOCK_TIME);s=Math.max(s,1/Policy.DIFFICULTY_MAX_ADJUSTMENT_FACTOR);s=Math.min(s,Policy.DIFFICULTY_MAX_ADJUSTMENT_FACTOR);const i=r/Policy.DIFFICULTY_BLOCK_WINDOW;let o=BlockUtils.difficultyToTarget(i)*s;o=Math.min(o,Policy.BLOCK_TARGET_MAX);o=Math.max(o,1);const a=BlockUtils.targetToCompact(o);return BlockUtils.compactToTarget(a)}}Class.register(BlockUtils);class Subscription{static fromAddresses(e){return new Subscription(Subscription.Type.ADDRESSES,e)}static fromMinFeePerByte(e){return new Subscription(Subscription.Type.MIN_FEE,e)}constructor(e,t=null){if(!NumberUtils.isUint8(e))throw new Error("Invalid type");if(e===Subscription.Type.ADDRESSES&&(!Array.isArray(t)||!NumberUtils.isUint16(t.length)||t.some(e=>!(e instanceof Address))))throw new Error("Invalid addresses");if(e===Subscription.Type.MIN_FEE&&!NumberUtils.isUint64(t))throw new Error("Invalid minFeePerByte");this._type=e;this._addresses=new HashSet;this._minFeePerByte=0;switch(e){case Subscription.Type.ADDRESSES:this._addresses.addAll(t);break;case Subscription.Type.MIN_FEE:this._minFeePerByte=t}}static unserialize(e){const t=e.readUint8();let r=null;switch(t){case Subscription.Type.ADDRESSES:{r=[];const t=e.readUint16();for(let n=0;n<t;++n)r.push(Address.unserialize(e));break}case Subscription.Type.MIN_FEE:r=e.readUint64()}return new Subscription(t,r)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(this._type);switch(this._type){case Subscription.Type.ADDRESSES:e.writeUint16(this._addresses.length);for(const t of this._addresses)t.serialize(e);break;case Subscription.Type.MIN_FEE:e.writeUint64(this._minFeePerByte)}return e}get serializedSize(){let e=0;switch(this._type){case Subscription.Type.ADDRESSES:e=2;for(const t of this._addresses)e+=t.serializedSize;break;case Subscription.Type.MIN_FEE:e=8}return 1+e}matchesBlock(e){switch(this._type){case Subscription.Type.NONE:return!1;case Subscription.Type.ANY:case Subscription.Type.ADDRESSES:case Subscription.Type.MIN_FEE:return!0;default:throw new Error("Unknown type")}}matchesTransaction(e){switch(this._type){case Subscription.Type.NONE:return!1;case Subscription.Type.ANY:return!0;case Subscription.Type.ADDRESSES:return this._addresses.contains(e.recipient)||this._addresses.contains(e.sender);case Subscription.Type.MIN_FEE:return e.fee/e.serializedSize>=this._minFeePerByte;default:throw new Error("Unknown type")}}toString(){return`Subscription{type=${this._type}, addresses=[${this._addresses.values()}], minFeePerByte=${this._minFeePerByte}}`}get type(){return this._type}get addresses(){return this._addresses.values()}get minFeePerByte(){return this._minFeePerByte}}Subscription.Type={NONE:0,ANY:1,ADDRESSES:2,MIN_FEE:3};Subscription.NONE=new Subscription(Subscription.Type.NONE);Subscription.BLOCKS_ONLY=new Subscription(Subscription.Type.ADDRESSES,[]);Subscription.ANY=new Subscription(Subscription.Type.ANY);Class.register(Subscription);class Transaction{constructor(e,t,r,n,s,i,o,a,c,l,h){if(!(t instanceof Address))throw new Error("Malformed sender");if(!NumberUtils.isUint8(r))throw new Error("Malformed sender type");if(!(n instanceof Address))throw new Error("Malformed recipient");if(!NumberUtils.isUint8(s))throw new Error("Malformed recipient type");if(!NumberUtils.isUint64(i)||0===i)throw new Error("Malformed value");if(!NumberUtils.isUint64(o))throw new Error("Malformed fee");if(!NumberUtils.isUint32(a))throw new Error("Malformed validityStartHeight");if(!NumberUtils.isUint8(c)&&(c&~Transaction.Flag.ALL)>0)throw new Error("Malformed flags");if(!(l instanceof Uint8Array&&NumberUtils.isUint16(l.byteLength)))throw new Error("Malformed data");if(h&&(!(h instanceof Uint8Array)||!NumberUtils.isUint16(h.byteLength)))throw new Error("Malformed proof");this._format=e;this._sender=t;this._senderType=r;this._recipient=n;this._recipientType=s;this._value=i;this._fee=o;this._validityStartHeight=a;this._flags=c;this._data=l;this._proof=h;this._recipient===Address.CONTRACT_CREATION&&(this._recipient=this.getContractCreationAddress())}static unserialize(e){const t=e.readUint8();e.readPos--;if(!Transaction.FORMAT_MAP.has(t))throw new Error("Invalid transaction type");return Transaction.FORMAT_MAP.get(t).unserialize(e)}serializeContent(e){(e=e||new SerialBuffer(this.serializedContentSize)).writeUint16(this._data.byteLength);e.write(this._data);this._sender.serialize(e);e.writeUint8(this._senderType);this._recipient.serialize(e);e.writeUint8(this._recipientType);e.writeUint64(this._value);e.writeUint64(this._fee);e.writeUint32(this._validityStartHeight);e.writeUint8(this._flags);return e}get serializedContentSize(){return 2+this._data.byteLength+this._sender.serializedSize+1+this._recipient.serializedSize+1+8+8+4+1}verify(){this._valid===undefined&&(this._valid=this._verify());return this._valid}_verify(){if(this._recipient.equals(this._sender)){Log.w(Transaction,"Sender and recipient must not match",this);return!1}if(!Account.TYPE_MAP.has(this._senderType)||!Account.TYPE_MAP.has(this._recipientType)){Log.w(Transaction,"Invalid account type",this);return!1}if(!Account.TYPE_MAP.get(this._senderType).verifyOutgoingTransaction(this)){Log.w(Transaction,"Invalid for sender",this);return!1}if(!Account.TYPE_MAP.get(this._recipientType).verifyIncomingTransaction(this)){Log.w(Transaction,"Invalid for recipient",this);return!1}return!0}get serializedSize(){throw new Error("Getter needs to be overwritten by subclasses")}serialize(e){throw new Error("Method needs to be overwritten by subclasses")}hash(){this._hash=this._hash||Hash.light(this.serializeContent());return this._hash}hashAsync(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._hash=e._hash||(yield Hash.lightAsync(e.serializeContent()));return e._hash})()}compare(e){return this.fee/this.serializedSize>e.fee/e.serializedSize?-1:this.fee/this.serializedSize<e.fee/e.serializedSize?1:this.serializedSize>e.serializedSize?-1:this.serializedSize<e.serializedSize?1:this.fee>e.fee?-1:this.fee<e.fee?1:this.value>e.value?-1:this.value<e.value?1:this.compareBlockOrder(e)}compareBlockOrder(e){const t=this._recipient.compare(e._recipient);if(0!==t)return t;if(this._validityStartHeight<e._validityStartHeight)return-1;if(this._validityStartHeight>e._validityStartHeight)return 1;if(this._fee>e._fee)return-1;if(this._fee<e._fee)return 1;if(this._value>e._value)return-1;if(this._value<e._value)return 1;const r=this._sender.compare(e._sender);return 0!==r?r:this._recipientType<e._recipientType?-1:this._recipientType>e._recipientType?1:this._senderType<e._senderType?-1:this._senderType>e._senderType?1:this._flags<e._flags?-1:this._flags>e._flags?1:BufferUtils.compare(this._data,e._data)}equals(e){return e instanceof Transaction&&this._sender.equals(e._sender)&&this._senderType===e._senderType&&this._recipient.equals(e._recipient)&&this._recipientType===e._recipientType&&this._value===e._value&&this._fee===e._fee&&this._validityStartHeight===e._validityStartHeight&&this._flags===e._flags&&BufferUtils.equals(this._data,e._data)}toString(){return"Transaction{"+`sender=${this._sender.toBase64()}, `+`recipient=${this._recipient.toBase64()}, `+`value=${this._value}, `+`fee=${this._fee}, `+`validityStartHeight=${this._validityStartHeight}`+"}"}getContractCreationAddress(){const e=Transaction.unserialize(this.serialize());e._recipient=Address.NULL;e._hash=null;return Address.fromHash(e.hash())}get sender(){return this._sender}get senderType(){return this._senderType}get recipient(){return this._recipient}get recipientType(){return this._recipientType}get value(){return this._value}get fee(){return this._fee}get feePerByte(){return this._fee/this.serializedSize}get validityStartHeight(){return this._validityStartHeight}get flags(){return this._flags}hasFlag(e){return(this._flags&e)>0}get data(){return this._data}get proof(){return this._proof}set proof(e){this._proof=e}}Transaction.Format={BASIC:0,EXTENDED:1};Transaction.Flag={NONE:0,CONTRACT_CREATION:1,ALL:1};Transaction.FORMAT_MAP=new Map;Class.register(Transaction);class SignatureProof{static verifyTransaction(e){try{const r=new SerialBuffer(e.proof),n=SignatureProof.unserialize(r);if(r.readPos!==r.byteLength){Log.w(SignatureProof,"Invalid SignatureProof - overlong");return!1}return n.verify(e.sender,e.serializeContent())}catch(t){Log.w(SignatureProof,`Failed to verify transaction: ${t.message||t}`,t);return!1}}static singleSig(e,t){return new SignatureProof(e,new MerklePath([]),t)}static multiSig(e,t,r){const n=MerklePath.compute(t,e);return new SignatureProof(e,n,r)}constructor(e,t,r){if(!(e instanceof PublicKey))throw new Error("Malformed publickKey");if(!(t instanceof MerklePath))throw new Error("Malformed merklePath");if(r&&!(r instanceof Signature))throw new Error("Malformed signature");this._publicKey=e;this._merklePath=t;this._signature=r}static unserialize(e){const t=PublicKey.unserialize(e),r=MerklePath.unserialize(e),n=Signature.unserialize(e);return new SignatureProof(t,r,n)}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._publicKey.serialize(e);this._merklePath.serialize(e);this._signature&&this._signature.serialize(e);return e}get serializedSize(){return this._publicKey.serializedSize+this._merklePath.serializedSize+(this._signature?this._signature.serializedSize:0)}equals(e){return e instanceof SignatureProof&&this._publicKey.equals(e._publicKey)&&this._merklePath.equals(e._merklePath)&&(this._signature?this._signature.equals(e._signature):this._signature===e._signature)}verify(e,t){if(null!==e&&!this.isSignedBy(e)){Log.w(SignatureProof,"Invalid SignatureProof - signer does not match sender address");return!1}if(!this._signature){Log.w(SignatureProof,"Invalid SignatureProof - signature is missing");return!1}if(!this._signature.verify(this._publicKey,t)){Log.w(SignatureProof,"Invalid SignatureProof - signature is invalid");return!1}return!0}isSignedBy(e){const t=this._merklePath.computeRoot(this._publicKey);return Address.fromHash(t).equals(e)}get publicKey(){return this._publicKey}get merklePath(){return this._merklePath}get signature(){return this._signature}set signature(e){this._signature=e}}Class.register(SignatureProof);class BasicTransaction extends Transaction{constructor(e,t,r,n,s,i){if(!(e instanceof PublicKey))throw new Error("Malformed senderPubKey");if(i!==undefined&&!(i instanceof Signature))throw new Error("Malformed signature");const o=SignatureProof.singleSig(e,i);super(Transaction.Format.BASIC,e.toAddress(),Account.Type.BASIC,t,Account.Type.BASIC,r,n,s,Transaction.Flag.NONE,new Uint8Array(0),o.serialize());this._signatureProof=o}static unserialize(e){const t=e.readUint8();Assert.that(t===Transaction.Format.BASIC);const r=PublicKey.unserialize(e),n=Address.unserialize(e),s=e.readUint64(),i=e.readUint64(),o=e.readUint32(),a=Signature.unserialize(e);return new BasicTransaction(r,n,s,i,o,a)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(Transaction.Format.BASIC);this.senderPubKey.serialize(e);this._recipient.serialize(e);e.writeUint64(this._value);e.writeUint64(this._fee);e.writeUint32(this._validityStartHeight);this.signature.serialize(e);return e}get serializedSize(){return 1+this.senderPubKey.serializedSize+this._recipient.serializedSize+8+8+4+this.signature.serializedSize}get senderPubKey(){return this._signatureProof.publicKey}get signature(){return this._signatureProof.signature}set signature(e){this._signatureProof.signature=e;this._proof=this._signatureProof.serialize()}}Transaction.FORMAT_MAP.set(Transaction.Format.BASIC,BasicTransaction);Class.register(BasicTransaction);class ExtendedTransaction extends Transaction{constructor(e,t,r,n,s,i,o,a,c,l=new Uint8Array(0)){super(Transaction.Format.EXTENDED,e,t,r,n,s,i,o,a,c,l)}static unserialize(e){const t=e.readUint8();Assert.that(t===Transaction.Format.EXTENDED);const r=e.readUint16(),n=e.read(r),s=Address.unserialize(e),i=e.readUint8(),o=Address.unserialize(e),a=e.readUint8(),c=e.readUint64(),l=e.readUint64(),h=e.readUint32(),u=e.readUint8(),d=e.readUint16(),_=e.read(d);return new ExtendedTransaction(s,i,o,a,c,l,h,u,n,_)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint8(Transaction.Format.EXTENDED);this.serializeContent(e);e.writeUint16(this._proof.byteLength);e.write(this._proof);return e}get serializedSize(){return 1+this.serializedContentSize+2+this._proof.byteLength}}Transaction.FORMAT_MAP.set(Transaction.Format.EXTENDED,ExtendedTransaction);Class.register(ExtendedTransaction);class TransactionsProof{constructor(e,t){if(!e||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof Transaction)))throw new Error("Malformed transactions");if(!(t instanceof MerkleProof))throw new Error("Malformed merkle proof");this._transactions=e;this._proof=t}static unserialize(e){const t=e.readUint16(),r=[];for(let s=0;s<t;++s)r.push(Transaction.unserialize(e));const n=MerkleProof.unserialize(e);return new TransactionsProof(r,n)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._transactions.length);for(const t of this._transactions)t.serialize(e);this._proof.serialize(e);return e}get serializedSize(){return 2+this._transactions.reduce((e,t)=>e+t.serializedSize,0)+this._proof.serializedSize}toString(){return`TransactionsProof{length=${this.length}}`}root(){return this._proof.computeRoot(this._transactions)}get length(){return this._transactions.length}get transactions(){return this._transactions}get proof(){return this._proof}}Class.register(TransactionsProof);class TransactionCache{constructor(e=[],t=[]){this._transactions=new HashSet(e=>e.hash().toBase64());this._transactions.addAll(e);this._blockOrder=t}containsTransaction(e){return this._transactions.contains(e)}pushBlock(e){this._blockOrder.push(e);this._transactions.addAll(e.transactions);this._blockOrder.length>Policy.TRANSACTION_VALIDITY_WINDOW&&this.shiftBlock()}shiftBlock(){const e=this._blockOrder.shift();e&&this._transactions.removeAll(e.transactions)}revertBlock(e){if(this._transactions.isEmpty())return this.missingBlocks;const t=this._blockOrder.pop();Assert.that(t.equals(e),"Invalid block to revert");e&&this._transactions.removeAll(e.transactions);return this.missingBlocks}prependBlocks(e){if(e.length+this._blockOrder.length>Policy.TRANSACTION_VALIDITY_WINDOW)throw new Error("Exceeding transaction cache size");this._blockOrder.unshift(...e);e.forEach(e=>this._transactions.addAll(e.transactions))}get missingBlocks(){return Policy.TRANSACTION_VALIDITY_WINDOW-this._blockOrder.length}get transactions(){return this._transactions}clone(){return new TransactionCache(this._transactions,this._blockOrder.slice())}}Class.register(TransactionCache);class TransactionStoreEntry{constructor(e,t,r,n,s,i){this._transactionHash=e;this._sender=t;this._recipient=r;this._blockHeight=n;this._blockHash=s;this._index=i;this.senderKey=t.toBase64();this.recipientKey=r.toBase64()}static fromBlock(e){const t=e.hash(),r=[];for(let n=0;n<e.transactions.length;++n){const s=e.transactions[n];r.push(new TransactionStoreEntry(s.hash(),s.sender,s.recipient,e.height,t,n))}return r}static fromJSON(e,t){return new TransactionStoreEntry(Hash.fromBase64(e),Address.fromBase64(t.senderKey),Address.fromBase64(t.recipientKey),t.blockHeight,Hash.fromBase64(t.blockHash),t.index)}toJSON(){return{senderKey:this.senderKey,recipientKey:this.recipientKey,blockHeight:this.blockHeight,blockHash:this.blockHash.toBase64(),index:this.index}}get transactionHash(){return this._transactionHash}get sender(){return this._sender}get recipient(){return this._recipient}get blockHeight(){return this._blockHeight}get blockHash(){return this._blockHash}get index(){return this._index}get key(){return this.transactionHash.toBase64()}}Class.register(TransactionStoreEntry);class TransactionStore{static initPersistent(e){const t=e.createObjectStore("Transactions",new TransactionStoreCodec);t.createIndex("sender","senderKey",!0);t.createIndex("recipient","recipientKey",!0)}static getPersistent(e){return new TransactionStore(e.getObjectStore("Transactions"))}static createVolatile(){const e=JDB.JungleDB.createVolatileObjectStore();e.createIndex("sender","senderKey",!0);e.createIndex("recipient","recipientKey",!0);return new TransactionStore(e)}constructor(e){this._store=e}get(e){return this._store.get(e.toBase64())}getBySender(e){return this._store.index("sender").values(JDB.KeyRange.only(e.toBase64()))}getByRecipient(e){return this._store.index("recipient").values(JDB.KeyRange.only(e.toBase64()))}put(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield TransactionStoreEntry.fromBlock(e),n=t._store.transaction(),s=[];for(const e of r)s.push(n.put(e.key,e));yield Promise.all(s);return n.commit()})()}remove(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t._store.transaction(),n=[];for(const t of e.transactions)n.push(r.remove(t.hash().toBase64()));yield Promise.all(n);return r.commit()})()}snapshot(e){const t=this._store.snapshot();e&&t.inherit(e._store);return new TransactionStore(t)}transaction(e=!0){const t=this._store.transaction(e);return new TransactionStore(t)}truncate(){return this._store.truncate()}commit(){return this._store.commit()}abort(){return this._store.abort()}get tx(){return this._store instanceof JDB.Transaction?this._store:undefined}}Class.register(TransactionStore);class TransactionStoreCodec{encode(e){return e.toJSON()}decode(e,t){return TransactionStoreEntry.fromJSON(t,e)}get valueEncoding(){return JDB.JungleDB.JSON_ENCODING}}class TransactionReceipt{constructor(e,t){this._transactionHash=e;this._blockHash=t}static unserialize(e){const t=Hash.unserialize(e),r=Hash.unserialize(e);return new TransactionReceipt(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._transactionHash.serialize(e);this._blockHash.serialize(e);return e}get serializedSize(){return this._transactionHash.serializedSize+this._blockHash.serializedSize}get transactionHash(){return this._transactionHash}get blockHash(){return this._blockHash}}Class.register(TransactionReceipt);class Block{static copy(e){return e?new Block(BlockHeader.copy(e._header),BlockInterlink.copy(e._interlink),BlockBody.copy(e._body)):e}constructor(e,t,r){if(!(e instanceof BlockHeader))throw"Malformed header";if(!(t instanceof BlockInterlink))throw"Malformed interlink";if(r&&!(r instanceof BlockBody))throw"Malformed body";this._header=e;this._interlink=t;this._body=r}static unserialize(e){const t=BlockHeader.unserialize(e),r=BlockInterlink.unserialize(e,t.prevHash);let n=undefined;e.readUint8()&&(n=BlockBody.unserialize(e));return new Block(t,r,n)}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._header.serialize(e);this._interlink.serialize(e);if(this._body){e.writeUint8(1);this._body.serialize(e)}else e.writeUint8(0);return e}get serializedSize(){return this._header.serializedSize+this._interlink.serializedSize+1+(this._body?this._body.serializedSize:0)}verify(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._valid===undefined)if(t.isLight()||t.body.transactions.length<150||!IWorker.areWorkersAsync)t._valid=yield t._verify(e.now());else{const r=t.body.transactions.map(function(e){return e._valid}),{valid:n,pow:s,interlinkHash:i,bodyHash:o}=yield Crypto.blockVerify(t.serialize(),r,e.now());t._valid=n;t.header._pow=Hash.unserialize(new SerialBuffer(s));t.interlink._hash=Hash.unserialize(new SerialBuffer(i));t.body._hash=Hash.unserialize(new SerialBuffer(o))}return t._valid})()}_verify(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(1e3*t._header.timestamp>e+1e3*Block.TIMESTAMP_DRIFT_MAX){Log.w(Block,"Invalid block - timestamp too far in the future");return!1}if(!(yield t._header.verifyProofOfWork())){Log.w(Block,"Invalid block - PoW verification failed");return!1}if(t.serializedSize>Policy.BLOCK_SIZE_MAX){Log.w(Block,"Invalid block - max block size exceeded");return!1}return!!t._verifyInterlink()&&!(t.isFull()&&!t._verifyBody())})()}_verifyInterlink(){if(1===this.height&&this._header.interlinkHash.equals(new Hash(null)))return!0;const e=this._interlink.hash();if(!this._header.interlinkHash.equals(e)){Log.w(Block,"Invalid block - interlink hash mismatch");return!1}return!0}_verifyBody(){if(!this._body.verify())return!1;const e=this._body.hash();if(!this._header.bodyHash.equals(e)){Log.w(Block,"Invalid block - body hash mismatch");return!1}return!0}isImmediateSuccessorOf(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._header.isImmediateSuccessorOf(e.header))return!1;const r=yield e.getNextInterlink(t.target,t.version);return!!t._interlink.equals(r)})()}isInterlinkSuccessorOf(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._header.height<=e.header.height){Log.v(Block,"No interlink successor - height");return!1}if(t._header.timestamp<e.header.timestamp){Log.v(Block,"No interlink successor - timestamp");return!1}const r=e.hash();if(!Block.GENESIS.HASH.equals(r)){const n=yield e.pow(),s=BlockUtils.getTargetHeight(t.target);let i=!1,o=0;for(;o<t._interlink.length;o++)if(r.equals(t._interlink.hashes[o])){i=!0;if(!BlockUtils.isProofOfWork(n,Math.pow(2,s-o))){Log.v(Block,"No interlink successor - invalid position in interlink");return!1}}if(!i){Log.v(Block,"No interlink successor - not in interlink");return!1}}if(t._header.prevHash.equals(r)){if(t._header.height!==e.header.height+1){Log.v(Block,"No interlink successor - immediate height");return!1}const r=(yield e.getNextInterlink(t.target,t.version)).hash();if(!t._header.interlinkHash.equals(r)){Log.v(Block,"No interlink successor - immediate interlink");return!1}}else{if(t._header.height===e.height.height+1){Log.v(Block,"No interlink successor - immediate height (2)");return!1}{const r=new HashSet;r.addAll(t._interlink.hashes);r.removeAll(e.interlink.hashes);if(r.length>t._header.height-e.header.height){Log.v(Block,"No interlink successor - too many new blocks");return!1}const n=BlockUtils.getTargetDepth(t.target)-BlockUtils.getTargetDepth(e.target);if(t._interlink.length<e.interlink.length-n){Log.v(Block,"No interlink successor - interlink too short");return!1}let s=!1;const i=t._interlink.hashes,o=e.interlink.hashes;for(let e=1;e<o.length&&e-n<i.length;e++)if(o[e].equals(i[e-n]))s=!0;else if(s){Log.v(Block,"No interlink successor - invalid common suffix");return!1}}}return!0})()}isSuccessorOf(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield t.isImmediateSuccessorOf(e))||(yield t.isInterlinkSuccessorOf(e))})()}getNextInterlink(e,t=BlockHeader.CURRENT_VERSION){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield r.pow(),n=BlockUtils.getTargetDepth(BlockUtils.hashToTarget(t)),s=BlockUtils.getTargetDepth(e);let i=n-s;const o=[],a=r.hash();for(let e=0;e<=i;e++)o.push(a);for(let e=i+(s-BlockUtils.getTargetDepth(r.target))+1;e<r.interlink.length;e++)o.push(r.interlink.hashes[e]);return new BlockInterlink(o,a)})()}equals(e){return e instanceof Block&&this._header.equals(e._header)&&this._interlink.equals(e._interlink)&&(this._body?this._body.equals(e._body):!e._body)}isLight(){return!this._body}isFull(){return!!this._body}toLight(){return this.isLight()?this:new Block(this._header,this._interlink)}toFull(e){return this.isFull()?this:new Block(this._header,this._interlink,e)}get header(){return this._header}get interlink(){return this._interlink}get body(){if(this.isLight())throw"Cannot access body of light block";return this._body}get version(){return this._header.version}get prevHash(){return this._header.prevHash}get bodyHash(){return this._header.bodyHash}get accountsHash(){return this._header.accountsHash}get nBits(){return this._header.nBits}get target(){return this._header.target}get difficulty(){return this._header.difficulty}get height(){return this._header.height}get timestamp(){return this._header.timestamp}get nonce(){return this._header.nonce}get minerAddr(){return this._body.minerAddr}get transactions(){return this._body.transactions}get transactionCount(){return this._body.transactionCount}hash(e){return this._header.hash(e)}hashAsync(e){return this._header.hashAsync(e)}pow(e){return this._header.pow(e)}}Block.TIMESTAMP_DRIFT_MAX=600;Class.register(Block);class IBlockchain extends Observable{get head(){}get headHash(){}get height(){}}Class.register(IBlockchain);class BaseChain extends IBlockchain{constructor(e){super();this._store=e}getBlock(e,t=!1){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r._store.getChainData(e);return n&&(n.onMainChain||t)?n.head:null})()}getBlockAt(e){return this._store.getBlockAt(e)||null}getNextTarget(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r;if(e){const n=e.hash();r=yield t._store.getChainData(n);Assert.that(!!r)}else{e=t.head;r=t._mainChain}const n=Math.max(e.height-Policy.DIFFICULTY_BLOCK_WINDOW,1);let s;if(r.onMainChain)s=yield t._store.getChainDataAt(n);else{let e=r;for(let r=0;r<Policy.DIFFICULTY_BLOCK_WINDOW&&!e.onMainChain;r++)if(!(e=yield t._store.getChainData(e.head.prevHash)))return-1;s=e.onMainChain&&e.head.height>n?yield t._store.getChainDataAt(n):e}if(!s||s.totalDifficulty<1)return-1;const i=r.totalDifficulty-s.totalDifficulty;return BlockUtils.getNextTarget(r.head.header,s.head.header,i)})()}_getChainProof(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=e._store.snapshot(),r=yield new BaseChainSnapshot(t,e.head)._prove(Policy.M,Policy.K,Policy.DELTA);t.abort()["catch"](Log.w.tag(BaseChain));return r})()}_prove(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){Assert.that(e>=1,"m must be >= 1");Assert.that(r>0,"delta must be > 0");let s=new BlockChain([]),i=1;const o=yield n.getBlockAt(Math.max(n.height-t,1));for(let t=Math.max(BlockUtils.getTargetDepth(o.target)+o.interlink.length-1,0);t>=0;t--){const a=yield n._getSuperChain(t,o,i);s=BlockChain.merge(s,a);if(BaseChain._isGoodSuperChain(a,t,e,r)){Assert.that(a.length>=e,`Good superchain expected to be at least ${e} long`);Log.v(BaseChain,`Found good superchain at depth ${t} with length ${a.length} (#${i} - #${o.height})`);i=a.blocks[a.length-e].height}}const a=yield n._getHeaderChain(n.height-o.height);return new ChainProof(s,a)})()}_getSuperChain(e,t=this.head,r=1){var n=this;return(0,_asyncToGenerator3["default"])(function*(){Assert.that(r>=1,"tailHeight must be >= 1");const s=[],i=yield t.pow();BlockUtils.getTargetDepth(BlockUtils.hashToTarget(i))>=e&&s.push(t.toLight());let o=Math.max(e-BlockUtils.getTargetDepth(t.target),-1);for(;o<t.interlink.hashes.length&&t.height>r;){const r=o<0?t.prevHash:t.interlink.hashes[o];if(!(t=yield n.getBlock(r))){Log.w(BaseChain,`Failed to find block ${r} while constructing SuperChain at depth ${e} - returning truncated chain`);break}s.push(t.toLight());o=Math.max(e-BlockUtils.getTargetDepth(t.target),-1)}(0===s.length||s[s.length-1].height>1)&&1===r&&s.push(Block.GENESIS.toLight());return new BlockChain(s.reverse())})()}static _isGoodSuperChain(e,t,r,n){return BaseChain._hasSuperQuality(e,t,r,n)}static _hasSuperQuality(e,t,r,n){Assert.that(r>=1,"m must be >= 1");if(e.length<r)return!1;for(let s=r;s<=e.length;s++){const r=e.head.height-e.blocks[e.length-s].height+1;if(!BaseChain._isLocallyGood(s,r,t,n))return!1}return!0}static _isLocallyGood(e,t,r,n){return e>(1-n)*Math.pow(2,-r)*t}_getHeaderChain(e,t=this.head){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=[];for(;t&&n.length<e;){n.push(t.header);t=yield r.getBlock(t.prevHash)}return new HeaderChain(n.reverse())})()}_extendChainProof(e,t,r=!0){return(0,_asyncToGenerator3["default"])(function*(){const n=e.suffix.headers.slice();n.push(t);const s=e.prefix.blocks.slice();if(n.length<=Policy.K)return new ChainProof(new BlockChain(s),new HeaderChain(n));const i=n.shift(),o=yield e.prefix.head.getNextInterlink(i.target,i.version),a=new Block(i,o);s.push(a);const c=(yield e.getSuperChains()).slice(),l=BlockUtils.hashToTarget(yield a.pow()),h=BlockUtils.getTargetDepth(l);for(let e=h;e>=0;e--)c[e]?c[e]=new BlockChain([...c[e].blocks,a]):c[e]=new BlockChain([a]);if(h-BlockUtils.getTargetDepth(a.target)<=0)return new ChainProof(new BlockChain(s),new HeaderChain(n),c);const u=new Set;for(let e=h;e>=0;e--){const t=c[e];if(!(t.length<Policy.M))if(BaseChain._isGoodSuperChain(t,e,Policy.M,Policy.DELTA)){const r=t.blocks[t.length-Policy.M];for(let t=e-1;t>=0;t--){let e=0,n=c[t].blocks[e];for(;n.height<=r.height;){const r=BlockUtils.hashToTarget(yield n.pow());BlockUtils.getTargetDepth(r)===t&&n.height>1&&u.add(n.height);e++;n=c[t].blocks[e]}e>0&&(c[t]=new BlockChain(c[t].blocks.slice(e)))}}else{Log.w(BaseChain,`Chain quality badness detected at depth ${e}`);if(r)return null}}const d=new BlockChain(s.filter(function(e){return!u.has(e.height)}));return new ChainProof(d,new HeaderChain(n),c)})()}static isBetterProof(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){const n=BlockChain.lowestCommonAncestor(e.prefix,t.prefix),s=yield NanoChain._getProofScore(e.prefix,n,r),i=yield NanoChain._getProofScore(t.prefix,n,r);return s===i?e.suffix.totalDifficulty()>=t.suffix.totalDifficulty():s>i})()}static _getProofScore(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){const n=[];for(const r of e.blocks){if(r.height<t.height)continue;const e=BlockUtils.hashToTarget(yield r.pow()),s=BlockUtils.getTargetDepth(e);n[s]=n[s]?n[s]+1:1}let s,i=0;for(s=n.length-1;i<r&&s>=0;s--)i+=n[s]?n[s]:0;let o=Math.pow(2,s+1)*i,a=i;for(let e=s;e>=0;e--){a+=n[e]?n[e]:0;const t=Math.pow(2,e)*a;o=Math.max(o,t)}return o})()}}Class.register(BaseChain);class BaseChainSnapshot extends BaseChain{constructor(e,t){super(e);this._head=t}get head(){return this._head}get height(){return this._head.height}}Class.register(BaseChainSnapshot);class BlockChain{static merge(e,t){const r=[];let n=0,s=0;for(;n<e.length&&s<t.length;){const i=e.blocks[n],o=t.blocks[s];if(i.height===o.height){Assert.that(i.equals(o),"Encountered different blocks at same height during chain merge");r.push(i);n++;s++}else if(i.height<o.height){r.push(i);n++}else{r.push(o);s++}}for(;n<e.length;n++)r.push(e.blocks[n]);for(;s<t.length;s++)r.push(t.blocks[s]);return new BlockChain(r)}static lowestCommonAncestor(e,t){let r=e.length-1,n=t.length-1;for(;r>=0&&n>=0;){const s=e.blocks[r],i=t.blocks[n];if(s.equals(i))return s;s.height>i.height?r--:n--}return undefined}constructor(e){if(!e||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof Block&&e.isLight())))throw new Error("Malformed blocks");this._blocks=e}static unserialize(e){const t=e.readUint16(),r=[];for(let n=0;n<t;n++)r.push(Block.unserialize(e));return new BlockChain(r)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._blocks.length);for(const t of this._blocks)t.serialize(e);return e}get serializedSize(){return 2+this._blocks.reduce((e,t)=>e+t.serializedSize,0)}verify(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){for(let t=e._blocks.length-1;t>=1;t--)if(!(yield e._blocks[t].isSuccessorOf(e._blocks[t-1])))return!1;return!0})()}denseSuffix(){const e=[this.head];let t=this.head;for(let r=this.length-2;r>=0;r--){const n=this.blocks[r];if(!n.hash().equals(t.prevHash))break;e.push(n);t=n}e.reverse();return e}isAnchored(){return Block.GENESIS.HASH.equals(this.tail.hash())}toString(){return`BlockChain{length=${this.length}}`}get length(){return this._blocks.length}get blocks(){return this._blocks}get head(){return this._blocks[this.length-1]}get tail(){return this._blocks[0]}totalDifficulty(){return this._blocks.reduce((e,t)=>e+BlockUtils.targetToDifficulty(t.target),0)}}Class.register(BlockChain);class HeaderChain{constructor(e){if(!e||!Array.isArray(e)||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof BlockHeader)))throw new Error("Malformed headers");this._headers=e}static unserialize(e){const t=e.readUint16(),r=[];for(let n=0;n<t;n++)r.push(BlockHeader.unserialize(e));return new HeaderChain(r)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint16(this._headers.length);for(const t of this._headers)t.serialize(e);return e}get serializedSize(){return 2+this._headers.reduce((e,t)=>e+t.serializedSize,0)}verify(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){for(let t=e._headers.length-1;t>=1;t--)if(!e._headers[t].isImmediateSuccessorOf(e._headers[t-1]))return!1;return!0})()}toString(){return`HeaderChain{length=${this.length}}`}get length(){return this._headers.length}get headers(){return this._headers}get head(){return this._headers[this.length-1]}get tail(){return this._headers[0]}totalDifficulty(){return this._headers.reduce((e,t)=>e+BlockUtils.targetToDifficulty(t.target),0)}}Class.register(HeaderChain);class ChainProof{constructor(e,t,r){if(!(e instanceof BlockChain&&e.length))throw new Error("Malformed prefix");if(!(t instanceof HeaderChain))throw new Error("Malformed suffix");this._prefix=e;this._suffix=t;this._chains=r}static unserialize(e){const t=BlockChain.unserialize(e),r=HeaderChain.unserialize(e);return new ChainProof(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);this._prefix.serialize(e);this._suffix.serialize(e);return e}get serializedSize(){return this._prefix.serializedSize+this._suffix.serializedSize}verify(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){return!!e._prefix.isAnchored()&&(!(!(yield e._prefix.verify())||!(yield e._suffix.verify()))&&(!(e._suffix.length>0&&!e._suffix.tail.isImmediateSuccessorOf(e._prefix.head.header))&&!!e._verifyDifficulty()))})()}_verifyDifficulty(){const e=this.prefix.denseSuffix().map(e=>e.header).concat(this.suffix.headers);let t=0;const r=[];for(let i=0;i<e.length;i++){t+=e[i].difficulty;r[i]=t}let n=e.length-2,s=n-Policy.DIFFICULTY_BLOCK_WINDOW;for(;s>=0&&n>=0;){const t=e[n],i=e[s],o=r[n]-r[s],a=BlockUtils.getNextTarget(t,i,o),c=BlockUtils.targetToCompact(a),l=e[n+1];if(l.nBits!==c){Log.w(ChainProof,`Block target mismatch: expected=${c}, got=${l.nBits}`);return!1}--n;0===s&&1===i.height||--s}return!0}getSuperChains(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(!e._chains){e._chains=[];for(let t=0;t<e._prefix.length;t++){const r=e._prefix.blocks[t],n=BlockUtils.hashToTarget(yield r.pow()),s=BlockUtils.getTargetDepth(n);e._chains[s]?e._chains[s].blocks.push(r):e._chains[s]||(e._chains[s]=new BlockChain([r]));for(let t=s-1;t>=0;t--)e._chains[t]?e._chains[t].blocks.push(r):e._chains[t]=new BlockChain([])}}return e._chains})()}toString(){return`ChainProof{prefix=${this._prefix.length}, suffix=${this._suffix.length}, height=${this.head.height}}`}get prefix(){return this._prefix}get suffix(){return this._suffix}get head(){return this._suffix.length>0?this._suffix.head:this._prefix.head.header}}Class.register(ChainProof);class ChainData{static copy(e){if(!e)return e;const t=Block.unserialize(new SerialBuffer(e._head));t.header._pow=Hash.unserialize(new SerialBuffer(e._pow));return new ChainData(t,e._totalDifficulty,e._totalWork,e._onMainChain)}constructor(e,t,r,n=!1){this._head=e;this._totalDifficulty=t;this._totalWork=r;this._onMainChain=n;this._height=e.height}stripDown(){Assert.that(this._head.header._pow instanceof Hash,"Expected cashed PoW hash");return{_head:this._head.serialize(),_totalDifficulty:this._totalDifficulty,_totalWork:this._totalWork,_onMainChain:this._onMainChain,_height:this._height,_pow:this._head.header._pow.serialize()}}get head(){return this._head}get totalDifficulty(){return this._totalDifficulty}get totalWork(){return this._totalWork}get onMainChain(){return this._onMainChain}set onMainChain(e){this._onMainChain=e}}Class.register(ChainData);class ChainDataStore{static initPersistent(e){const t=e.createObjectStore("ChainData",new ChainDataStoreCodec);ChainDataStore._createIndexes(t)}static getPersistent(e){return new ChainDataStore(e.getObjectStore("ChainData"))}static createVolatile(){const e=JDB.JungleDB.createVolatileObjectStore();ChainDataStore._createIndexes(e);return new ChainDataStore(e)}static _createIndexes(e){e.createIndex("height",["_height"])}constructor(e){this._store=e}getChainData(e){return this._store.get(e.toBase64())}putChainData(e,t){return this._store.put(e.toBase64(),t)}getBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.getChainData(e);return r?r.head:undefined})()}getChainDataAt(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._store.values(JDB.Query.eq("height",e));if(!r||!r.length)return undefined;for(const e of r)if(e.onMainChain)return e;return undefined})()}getBlockAt(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t.getChainDataAt(e);return r?r.head:undefined})()}getNearestBlockAt(e,t=!0){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=r._store.index("height"),s=t?yield n.maxValues(JDB.KeyRange.upperBound(e)):yield n.minValues(JDB.KeyRange.lowerBound(e));if(!s||!s.length)return undefined;for(const e of s)if(e.onMainChain)return e.head;throw new Error(`Failed to find main chain block at height ${e}`)})()}getBlocks(e,t=500,r=!0){var n=this;return(0,_asyncToGenerator3["default"])(function*(){if(t<=0)return[];r||(e-=t);let s=yield n._store.values(JDB.Query.within("height",e,e+t-1));s=s.filter(function(e){return e.onMainChain}).map(function(e){return e.head});const i=r?function(e,t){return e.height-t.height}:function(e,t){return t.height-e.height};s.sort(i);return s})()}getHead(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield e._store.get("main");return t?Hash.fromBase64(t):undefined})()}setHead(e){return this._store.put("main",e.toBase64())}transaction(e=!0){const t=this._store.transaction(e);return new ChainDataStore(t)}commit(){return this._store.commit()}abort(){return this._store.abort()}snapshot(){const e=this._store.snapshot();return new ChainDataStore(e)}truncate(){return this._store.truncate()}get tx(){return this._store instanceof JDB.Transaction?this._store:undefined}}Class.register(ChainDataStore);class ChainDataStoreCodec{encode(e){return"string"==typeof e?e:e.stripDown()}decode(e,t){return"string"==typeof e?e:ChainData.copy(e)}get valueEncoding(){return JDB.JungleDB.JSON_ENCODING}}class MempoolTransactionSet{constructor(e){this._transactions=new SortedList(e)}add(e){this._transactions.add(e);return this}remove(e){this._transactions.remove(e);return this}copyAndAdd(e){const t=this._transactions.copy();t.add(e);return new MempoolTransactionSet(t.values())}get transactions(){return this._transactions.values()}get sender(){return this._transactions.length>0?this._transactions.values()[0].sender:null}get senderType(){return this._transactions.length>0?this._transactions.values()[0].senderType:undefined}get length(){return this._transactions.length}numBelowFeePerByte(e){return this._transactions.values().filter(t=>t.fee/t.serializedSize<e).length}toString(){return`MempoolTransactionSet{length=${this.length}}`}}Class.register(MempoolTransactionSet);class Mempool extends Observable{constructor(e,t){super();this._blockchain=e;this._accounts=t;this._transactionsByHash=new HashMap;this._transactionSetByAddress=new HashMap;this._synchronizer=new Synchronizer;e.on("head-changed",()=>this._evictTransactions())}pushTransaction(e){return this._synchronizer.push(()=>this._pushTransaction(e))}_pushTransaction(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(t._transactionsByHash.contains(r)){Log.v(Mempool,function(){return`Ignoring known transaction ${r.toBase64()}`});return Mempool.ReturnCode.KNOWN}const n=t._transactionSetByAddress.get(e.sender)||new MempoolTransactionSet;if(e.fee/e.serializedSize<Mempool.TRANSACTION_RELAY_FEE_MIN&&n.numBelowFeePerByte(Mempool.TRANSACTION_RELAY_FEE_MIN)>=Mempool.FREE_TRANSACTIONS_PER_SENDER_MAX)return Mempool.ReturnCode.FEE_TOO_LOW;if(!e.verify())return Mempool.ReturnCode.INVALID;let s,i;try{(s=yield t._accounts.get(e.recipient)).withIncomingTransaction(e,t._blockchain.height+1)}catch(c){Log.w(Mempool,`Rejected transaction - ${c.message}`,e);return Mempool.ReturnCode.INVALID}try{i=yield t._accounts.get(e.sender,e.senderType)}catch(c){Log.w(Mempool,`Rejected transaction - ${c.message}`,e);return Mempool.ReturnCode.INVALID}const o=[];let a=i;for(const l of n.copyAndAdd(e).transactions)try{a=a.withOutgoingTransaction(l,t._blockchain.height+1,t._blockchain.transactionCache);o.push(l)}catch(c){if(l.equals(e)){Log.w(Mempool,`Rejected transaction - ${c.message}`,e);return Mempool.ReturnCode.INVALID}t._transactionsByHash.remove(l.hash())}t._transactionsByHash.put(r,e);t._transactionSetByAddress.put(e.sender,new MempoolTransactionSet(o));t.fire("transaction-added",e);return Mempool.ReturnCode.ACCEPTED})()}getTransaction(e){return this._transactionsByHash.get(e)}getTransactions(e=Infinity){const t=[];let r=0;for(const n of this._transactionsByHash.values().sort((e,t)=>e.compare(t))){const s=n.serializedSize;if(!(r+s>=e)){t.push(n);r+=s}}return t}getTransactionsForBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t.getTransactions(e);let n=(yield t._accounts.gatherToBePrunedAccounts(r,t._blockchain.height+1,t._blockchain.transactionCache)).reduce(function(e,t){return e+t.serializedSize},0)+r.reduce(function(e,t){return e+t.serializedSize},0);for(;n>e;)n-=r.pop().serializedSize;r.sort(function(e,t){return e.compareBlockOrder(t)});return r})()}getPendingTransactions(e){const t=this._transactionSetByAddress.get(e);return t?t.transactions:[]}_evictTransactions(){return this._synchronizer.push(()=>this.__evictTransactions())}__evictTransactions(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){for(const r of e._transactionSetByAddress.keys()){const n=e._transactionSetByAddress.get(r);try{const s=yield e._accounts.get(n.sender,n.senderType),i=[];let o=s;for(const r of n.transactions)try{const n=o.withOutgoingTransaction(r,e._blockchain.height+1,e._blockchain.transactionCache);(yield e._accounts.get(r.recipient)).withIncomingTransaction(r,e._blockchain.height+1);i.push(r);o=n}catch(t){e._transactionsByHash.remove(r.hash())}0===i.length?e._transactionSetByAddress.remove(r):e._transactionSetByAddress.put(r,new MempoolTransactionSet(i))}catch(t){for(const r of n.transactions)e._transactionsByHash.remove(r.hash());e._transactionSetByAddress.remove(r)}}e.fire("transactions-ready")})()}}Mempool.TRANSACTION_RELAY_FEE_MIN=1;Mempool.FREE_TRANSACTIONS_PER_SENDER_MAX=10;Mempool.ReturnCode={FEE_TOO_LOW:-2,INVALID:-1,ACCEPTED:1,KNOWN:2};Class.register(Mempool);class BaseConsensusAgent extends Observable{constructor(e){super();this._peer=e;this._synced=!1;this._knownObjects=new HashSet;this._knownObjects.add(new InvVector(InvVector.Type.BLOCK,e.headHash));this._objectsToRequest=new HashSet;this._objectsInFlight=new HashSet;this._objectsThatFlew=new HashSet;this._objectsProcessing=new HashSet;this._remoteSubscription=Subscription.NONE;this._timers=new Timers;this._waitingInvVectors=new Queue;this._timers.setInterval("invVectors",()=>this._sendWaitingInvVectors(),BaseConsensusAgent.TRANSACTION_RELAY_INTERVAL);this._waitingFreeInvVectors=new Queue;this._timers.setInterval("freeInvVectors",()=>this._sendFreeWaitingInvVectors(),BaseConsensusAgent.FREE_TRANSACTION_RELAY_INTERVAL);e.channel.on("inv",e=>this._onInv(e));e.channel.on("block",e=>this._onBlock(e));e.channel.on("header",e=>this._onHeader(e));e.channel.on("tx",e=>this._onTx(e));e.channel.on("not-found",e=>this._onNotFound(e));e.channel.on("subscribe",e=>this._onSubscribe(e));e.channel.on("get-data",e=>this._onGetData(e));e.channel.on("get-header",e=>this._onGetHeader(e));e.channel.on("close",()=>this._onClose())}relayBlock(e){if(!this._synced)return!1;if(!this._remoteSubscription.matchesBlock(e))return!1;const t=InvVector.fromBlock(e);if(this._knownObjects.contains(t))return!1;this._peer.channel.inv([t,...this._waitingInvVectors.dequeueMulti(BaseInventoryMessage.VECTORS_MAX_COUNT-1)]);this._knownObjects.add(t);return!0}_sendWaitingInvVectors(){const e=this._waitingInvVectors.dequeueMulti(BaseInventoryMessage.VECTORS_MAX_COUNT);if(e.length>0){this._peer.channel.inv(e);Log.v(BaseConsensusAgent,`[INV] Sent ${e.length} vectors to ${this._peer.peerAddress}`)}}_sendFreeWaitingInvVectors(){const e=[];let t=0;for(;e.length<=BaseInventoryMessage.VECTORS_MAX_COUNT&&this._waitingFreeInvVectors.length>0&&t<BaseConsensusAgent.FREE_TRANSACTION_SIZE_PER_INTERVAL;){const{serializedSize:r,vector:n}=this._waitingFreeInvVectors.dequeue();e.push(n);t+=r}if(e.length>0){this._peer.channel.inv(e);Log.v(BaseConsensusAgent,`[INV] Sent ${e.length} vectors to ${this._peer.peerAddress}`)}}relayTransaction(e){if(!this._remoteSubscription.matchesTransaction(e))return!1;const t=InvVector.fromTransaction(e);if(this._knownObjects.contains(t))return!1;const r=e.serializedSize;e.fee/r<BaseConsensusAgent.TRANSACTION_RELAY_FEE_MIN?this._waitingFreeInvVectors.enqueue({serializedSize:r,vector:t}):this._waitingInvVectors.enqueue(t);this._knownObjects.add(t);return!0}knowsBlock(e){const t=new InvVector(InvVector.Type.BLOCK,e);return this._knownObjects.contains(t)}_onSubscribe(e){Log.d(BaseConsensusAgent,`[SUBSCRIBE] ${this._peer.peerAddress} ${e.subscription}`);this._remoteSubscription=e.subscription}_onInv(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){for(const n of e.vectors){t._knownObjects.add(n);t._waitingInvVectors.remove(n)}const r=[];for(const n of e.vectors)if(!t._objectsInFlight.contains(n)&&!t._objectsProcessing.contains(n)&&t._shouldRequestData(n))switch(n.type){case InvVector.Type.BLOCK:{const e=yield t._getBlock(n.hash,!0);if(e)t._onKnownBlockAnnounced(n.hash,e);else{r.push(n);t._onNewBlockAnnounced(n.hash)}break}case InvVector.Type.TRANSACTION:{const e=yield t._getTransaction(n.hash);if(e)t._onKnownTransactionAnnounced(n.hash,e);else{r.push(n);t._onNewTransactionAnnounced(n.hash)}break}default:throw`Invalid inventory type: ${n.type}`}Log.v(BaseConsensusAgent,`[INV] ${e.vectors.length} vectors (${r.length} new) received from ${t._peer.peerAddress}`);if(r.length>0){t._objectsToRequest.addAll(r);t._timers.clearTimeout("inv");t._objectsToRequest.length>=BaseConsensusAgent.REQUEST_THRESHOLD?t._requestData():t._timers.setTimeout("inv",function(){return t._requestData()},BaseConsensusAgent.REQUEST_THROTTLE)}else t._onNoUnknownObjects()})()}_shouldRequestData(e){return!0}_getBlock(e,t=!1){throw new Error("not implemented")}_getTransaction(e){throw new Error("not implemented")}_onNewBlockAnnounced(e){}_onKnownBlockAnnounced(e,t){}_onNewTransactionAnnounced(e){}_onKnownTransactionAnnounced(e,t){}_requestData(){if(!this._objectsInFlight.isEmpty())return;if(this._objectsToRequest.isEmpty())return;const e=BaseInventoryMessage.VECTORS_MAX_COUNT,t=Array.from(new LimitIterable(this._objectsToRequest.valueIterator(),e));this._objectsInFlight.addAll(t);this._objectsToRequest.removeAll(t);this._doRequestData(t);this._timers.setTimeout("getData",()=>this._noMoreData(),BaseConsensusAgent.REQUEST_TIMEOUT)}_doRequestData(e){this._peer.channel.getData(e)}_onBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.block.hash(),n=new InvVector(InvVector.Type.BLOCK,r);if(!t._objectsInFlight.contains(n)&&!t._objectsThatFlew.contains(n)){Log.w(BaseConsensusAgent,`Unsolicited block ${r} received from ${t._peer.peerAddress}, discarding`);return}const s=e.block.isFull()?e.block.body.transactions:[],i=s.map(function(e){return t._getTransaction(e.hash())});for(let e=0;e<s.length;e++){const t=yield i[e];t&&(s[e]=t)}t._onObjectReceived(n);t._objectsProcessing.add(n);yield t._processBlock(r,e.block);t._onObjectProcessed(n)})()}_processBlock(e,t){return(0,_asyncToGenerator3["default"])(function*(){})()}_onHeader(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.header.hash(),n=new InvVector(InvVector.Type.BLOCK,r);if(t._objectsInFlight.contains(n)||t._objectsThatFlew.contains(n)){t._onObjectReceived(n);t._objectsProcessing.add(n);yield t._processHeader(r,e.header);t._onObjectProcessed(n)}else Log.w(BaseConsensusAgent,`Unsolicited header ${r} received from ${t._peer.peerAddress}, discarding`)})()}_processHeader(e,t){return(0,_asyncToGenerator3["default"])(function*(){})()}_onTx(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.transaction.hash(),n=new InvVector(InvVector.Type.TRANSACTION,r);if(t._objectsInFlight.contains(n)||t._objectsThatFlew.contains(n)){t._onObjectReceived(n);t._objectsProcessing.add(n);yield t._processTransaction(r,e.transaction);t._onObjectProcessed(n)}else Log.w(BaseConsensusAgent,`Unsolicited transaction ${r} received from ${t._peer.peerAddress}, discarding`)})()}_processTransaction(e,t){return(0,_asyncToGenerator3["default"])(function*(){})()}_onNotFound(e){Log.d(BaseConsensusAgent,`[NOTFOUND] ${e.vectors.length} unknown objects received from ${this._peer.peerAddress}`);for(const t of e.vectors)this._objectsInFlight.contains(t)&&this._onObjectReceived(t)}_onObjectReceived(e){if(!this._objectsInFlight.isEmpty()){this._objectsInFlight.remove(e);this._objectsInFlight.isEmpty()?this._noMoreData():this._timers.resetTimeout("getData",()=>this._noMoreData(),BaseConsensusAgent.REQUEST_TIMEOUT)}}_noMoreData(){this._timers.clearTimeout("getData");this._objectsThatFlew.addAll(this._objectsInFlight.values());this._objectsInFlight.clear();this._objectsToRequest.isEmpty()?this._onAllObjectsReceived():this._requestData()}_onNoUnknownObjects(){}_onAllObjectsReceived(){}_onObjectProcessed(e){this._objectsProcessing.remove(e);this._objectsProcessing.isEmpty()&&this._onAllObjectsProcessed()}_onAllObjectsProcessed(){}_onGetData(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){for(const n of e.vectors)t._knownObjects.add(n);const r=[];for(const n of e.vectors)switch(n.type){case InvVector.Type.BLOCK:{const e=yield t._getBlock(n.hash);e&&e.isFull()?t._peer.channel.block(e):r.push(n);break}case InvVector.Type.TRANSACTION:{const e=yield t._getTransaction(n.hash);e?t._peer.channel.tx(e):r.push(n);break}default:throw`Invalid inventory type: ${n.type}`}r.length&&t._peer.channel.notFound(r)})()}_onGetHeader(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){for(const n of e.vectors)t._knownObjects.add(n);const r=[];for(const n of e.vectors)switch(n.type){case InvVector.Type.BLOCK:{const e=yield t._getBlock(n.hash);e?t._peer.channel.header(e.header):r.push(n);break}case InvVector.Type.TRANSACTION:default:throw`Invalid inventory type: ${n.type}`}r.length&&t._peer.channel.notFound(r)})()}_onClose(){this._timers.clearAll();this.fire("close",this)}get peer(){return this._peer}get synced(){return this._synced}}BaseConsensusAgent.REQUEST_THRESHOLD=50;BaseConsensusAgent.REQUEST_THROTTLE=500;BaseConsensusAgent.REQUEST_TIMEOUT=1e4;BaseConsensusAgent.TRANSACTION_RELAY_INTERVAL=5e3;BaseConsensusAgent.FREE_TRANSACTION_RELAY_INTERVAL=6e3;BaseConsensusAgent.FREE_TRANSACTION_SIZE_PER_INTERVAL=15e3;BaseConsensusAgent.TRANSACTION_RELAY_FEE_MIN=1;Class.register(BaseConsensusAgent);class FullChain extends BaseChain{static getPersistent(e,t,r,n){const s=ChainDataStore.getPersistent(e);return new FullChain(s,t,r,n)._init()}static createVolatile(e,t,r){const n=ChainDataStore.createVolatile();return new FullChain(n,e,t,r)._init()}constructor(e,t,r,n){super(e);this._accounts=t;this._time=r;this._snapshots=new HashMap;this._snapshotOrder=[];this._mainChain=null;this._proof=null;this._transactionCache=new TransactionCache;this._transactionStore=n;this._synchronizer=new Synchronizer;this._blockKnownCount=this._blockInvalidCount=this._blockOrphanCount=this._blockExtendedCount=this._blockRebranchedCount=this._blockForkedCount=0}_init(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._headHash=yield e._store.getHead();if(e._headHash){e._mainChain=yield e._store.getChainData(e._headHash);Assert.that(!!e._mainChain,"Failed to load main chain from storage");Assert.that(e._mainChain.head.accountsHash.equals(yield e._accounts.hash()),"Corrupted store: Inconsistent chain/accounts state");const t=yield e.getBlocks(e.head.height,e._transactionCache.missingBlocks-1,!1);e._transactionCache.prependBlocks([...t.reverse(),e._mainChain.head])}else{e._mainChain=new ChainData(Block.GENESIS,Block.GENESIS.difficulty,BlockUtils.realDifficulty(yield Block.GENESIS.pow()),!0);e._headHash=Block.GENESIS.HASH;const t=e._store.transaction();yield t.putChainData(Block.GENESIS.HASH,e._mainChain);yield t.setHead(Block.GENESIS.HASH);yield t.commit();yield e._accounts.initialize(Block.GENESIS,Accounts.GENESIS)}return e})()}pushBlock(e){return this._synchronizer.push(()=>this._pushBlock(e))}_pushBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(yield t._store.getBlock(r)){Log.v(FullChain,`Ignoring known block ${r}`);t._blockKnownCount++;return FullChain.OK_KNOWN}if(!e.isFull()){Log.w(FullChain,"Rejecting block - body missing");t._blockInvalidCount++;return FullChain.ERR_INVALID}if(!(yield e.verify(t._time))){t._blockInvalidCount++;return FullChain.ERR_INVALID}const n=yield t._store.getChainData(e.prevHash);if(!n){Log.w(FullChain,"Rejecting block - unknown predecessor");t._blockOrphanCount++;return FullChain.ERR_ORPHAN}const s=n.head;if(!(yield e.isImmediateSuccessorOf(s))){Log.w(FullChain,"Rejecting block - not a valid immediate successor");t._blockInvalidCount++;return FullChain.ERR_INVALID}const i=yield t.getNextTarget(s);Assert.that(BlockUtils.isValidTarget(i),"Failed to compute next target in FullChain");if(e.nBits!==BlockUtils.targetToCompact(i)){Log.w(FullChain,"Rejecting block - difficulty mismatch");t._blockInvalidCount++;return FullChain.ERR_INVALID}const o=n.totalDifficulty+e.difficulty,a=n.totalWork+BlockUtils.realDifficulty(yield e.pow()),c=new ChainData(e,o,a);if(e.prevHash.equals(t.headHash)){if(!(yield t._extend(r,c))){t._blockInvalidCount++;return FullChain.ERR_INVALID}t._blockExtendedCount++;return FullChain.OK_EXTENDED}if(o>t.totalDifficulty){if(!(yield t._rebranch(r,c))){t._blockInvalidCount++;return FullChain.ERR_INVALID}t._blockRebranchedCount++;return FullChain.OK_REBRANCHED}Log.v(FullChain,`Creating/extending fork with block ${r}, height=${e.height}, totalDifficulty=${c.totalDifficulty}, totalWork=${c.totalWork}`);yield t._store.putChainData(r,c);t._blockForkedCount++;return FullChain.OK_FORKED})()}_verifyInterlink(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){for(let r=0;r<e.interlink.length;r++){const n=yield t._store.getBlock(e.interlink.hashes[r]);if(!n||!(yield e.isInterlinkSuccessorOf(n)))return!1}return!0})()}_extend(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r._accounts.transaction();try{yield n.commitBlock(t.head,r._transactionCache)}catch(i){Log.w(FullChain,`Rejecting block - failed to commit to AccountsTree: ${i.message||i}`);n.abort()["catch"](Log.w.tag(FullChain));return!1}t.onMainChain=!0;const s=yield r._store.transaction();yield s.putChainData(e,t);yield s.setHead(e);if(r._transactionStore){const e=r._transactionStore.transaction();yield e.put(t.head);yield JDB.JungleDB.commitCombined(s.tx,n.tx,e.tx)}else yield JDB.JungleDB.commitCombined(s.tx,n.tx);yield r._saveSnapshot(e);r._transactionCache.pushBlock(t.head);r._proof&&(r._proof=yield r._extendChainProof(r._proof,t.head.header));r._mainChain=t;r._headHash=e;r.fire("head-changed",r.head,!1);return!0})()}_rebranch(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){Log.v(FullChain,`Rebranching to fork ${e}, height=${t.head.height}, totalDifficulty=${t.totalDifficulty}, totalWork=${t.totalWork}`);for(const e of r._snapshotOrder){r._snapshots.get(e).abort()}r._snapshots.clear();r._snapshotOrder=[];const n=[],s=[];let i=t,o=e;for(;!i.onMainChain;){n.push(i);s.push(o);o=i.head.prevHash;i=yield r._store.getChainData(o);Assert.that(!!i,"Corrupted store: Failed to find fork predecessor while rebranching")}Log.v(FullChain,function(){return`Found common ancestor ${o.toBase64()} ${n.length} blocks up`});const a=yield r._accounts.transaction(!1),c=r._transactionCache.clone(),l=r._transactionStore?r._transactionStore.transaction():null;let h=r._headHash,u=r._mainChain.head;for(;!h.equals(o);){try{yield a.revertBlock(u,c);c.revertBlock(u);r._transactionStore&&(yield l.remove(u))}catch(p){Log.e(FullChain,"Failed to revert main chain while rebranching",p);a.abort()["catch"](Log.w.tag(FullChain));r._transactionStore&&l.abort()["catch"](Log.w.tag(FullChain));return!1}h=u.prevHash;u=yield r._store.getBlock(h);Assert.that(!!u,"Corrupted store: Failed to find main chain predecessor while rebranching");Assert.that(u.accountsHash.equals(yield a.hash()),"Failed to revert main chain - inconsistent state")}const d=c.missingBlocks,_=yield r.getBlocks(u.height,d,!1);c.prependBlocks(_.reverse());for(let e=n.length-1;e>=0;e--)try{yield a.commitBlock(n[e].head,c);c.pushBlock(n[e].head);r._transactionStore&&(yield l.put(n[e].head))}catch(p){Log.e(FullChain,"Failed to apply fork block while rebranching",p);a.abort()["catch"](Log.w.tag(FullChain));r._transactionStore&&l.abort()["catch"](Log.w.tag(FullChain));return!1}const f=r._store.transaction(!1);h=r._headHash;let g=r._mainChain;for(;!h.equals(o);){g.onMainChain=!1;yield f.putChainData(h,g);h=g.head.prevHash;g=yield f.getChainData(h);Assert.that(!!g,"Corrupted store: Failed to find main chain predecessor while rebranching")}for(let e=n.length-1;e>=0;e--){const t=n[e];t.onMainChain=!0;yield f.putChainData(s[e],t)}yield f.setHead(e);r._transactionStore?yield JDB.JungleDB.commitCombined(f.tx,a.tx,l.tx):yield JDB.JungleDB.commitCombined(f.tx,a.tx);r._transactionCache=c;r._proof=null;for(let e=n.length-1;e>=0;e--){r._mainChain=n[e];r._headHash=s[e];r.fire("head-changed",r.head,e>0)}return!0})()}getBlocks(e,t=500,r=!0){return this._store.getBlocks(e,t,r)}getChainProof(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._proof||(e._proof=yield e._getChainProof());return e._proof})()}getAccountsTreeChunk(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r._getSnapshot(e);return n&&(yield n.getAccountsTreeChunk(t))})()}getAccountsProof(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r._getSnapshot(e);return n&&(yield n.getAccountsProof(t))})()}getTransactionsProof(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=yield r.getBlock(e);if(!n||!n.isFull())return null;const s=[],i=new HashSet;i.addAll(t);for(const e of n.transactions)(i.contains(e.sender)||i.contains(e.recipient))&&s.push(e);const o=MerkleProof.compute(n.body.getMerkleLeafs(),s);return new TransactionsProof(s,o)})()}getTransactionReceiptsByAddress(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._transactionStore)throw new Error("Invalid request");const r=[],n=yield t._transactionStore.getBySender(e),s=yield t._transactionStore.getByRecipient(e);n.forEach(function(e){r.push(new TransactionReceipt(e.transactionHash,e.blockHash))});s.forEach(function(e){r.push(new TransactionReceipt(e.transactionHash,e.blockHash))});return r})()}getTransactionInfoByHash(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._transactionStore)throw new Error("Invalid request");const r=yield t._transactionStore.get(e);return r||null})()}_getSnapshot(e){var t=this;return this._synchronizer.push((0,_asyncToGenerator3["default"])(function*(){const r=yield t.getBlock(e);if(!r||t._mainChain.head.height-r.height>Policy.NUM_SNAPSHOTS_MAX)return null;let n=null;if(t._snapshots.contains(e))n=t._snapshots.get(e);else{const e=yield t._accounts.transaction(),s=t._transactionCache.clone();let i=t._headHash;for(;!r.prevHash.equals(i);){const r=yield t.getBlock(i);if(!t._snapshots.contains(i)){n=yield t._accounts.snapshot(e);t._snapshots.put(i,n);t._snapshotOrder.unshift(i)}yield e.revertBlock(r,s);s.revertBlock(r);i=r.prevHash}yield e.abort()}Assert.that(r.accountsHash.equals(yield n.hash()),"AccountsHash mismatch for snapshot of block ${blockHash}");return n}))}_saveSnapshot(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._snapshotOrder.length>0){const r=t._snapshotOrder.shift(),n=t._snapshots.get(r);n?yield n.abort():Log.e(FullChain,function(){return`Snapshot with hash ${r.toBase64()} not found.`});t._snapshots.remove(r);const s=yield t._accounts.snapshot();t._snapshots.put(e,s);t._snapshotOrder.push(e)}})()}get head(){return this._mainChain.head}get headHash(){return this._headHash}get height(){return this._mainChain.head.height}get totalDifficulty(){return this._mainChain.totalDifficulty}get totalWork(){return this._mainChain.totalWork}get accounts(){return this._accounts}get transactionCache(){return this._transactionCache}get blockForkedCount(){return this._blockForkedCount}get blockRebranchedCount(){return this._blockRebranchedCount}get blockExtendedCount(){return this._blockExtendedCount}get blockOrphanCount(){return this._blockOrphanCount}get blockInvalidCount(){return this._blockInvalidCount}get blockKnownCount(){return this._blockKnownCount}accountsHash(){return this._accounts.hash()}}FullChain.ERR_ORPHAN=-2;FullChain.ERR_INVALID=-1;FullChain.OK_KNOWN=0;FullChain.OK_EXTENDED=1;FullChain.OK_REBRANCHED=2;FullChain.OK_FORKED=3;Class.register(FullChain);class FullConsensusAgent extends BaseConsensusAgent{constructor(e,t,r){super(r);this._blockchain=e;this._mempool=t;this._syncing=!1;this._numBlocksExtending=-1;this._numBlocksForking=-1;this._forkHead=null;this._failedSyncs=0;this._syncTarget=r.headHash;r.channel.on("get-blocks",e=>this._onGetBlocks(e));r.channel.on("get-chain-proof",e=>this._onGetChainProof(e));r.channel.on("get-accounts-proof",e=>this._onGetAccountsProof(e));r.channel.on("get-accounts-tree-chunk",e=>this._onGetAccountsTreeChunk(e));r.channel.on("get-transactions-proof",e=>this._onGetTransactionsProof(e));r.channel.on("get-transaction-receipts",e=>this._onGetTransactions(e));r.channel.on("mempool",e=>this._onMempool(e))}syncBlockchain(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._syncing=!0;if(!Services.isFullNode(e._peer.peerAddress.services)){e._syncFinished();return}if(!e._objectsInFlight.isEmpty()){Log.v(FullConsensusAgent,`Waiting for ${e._objectsInFlight.length} objects to arrive ...`);return}if(!e._objectsProcessing.isEmpty()){Log.v(FullConsensusAgent,`Waiting for ${e._objectsProcessing.length} objects to be processed ...`);return}(yield e._blockchain.getBlock(e._syncTarget,!0))?e._syncFinished():0===e._numBlocksExtending&&++e._failedSyncs>=FullConsensusAgent.SYNC_ATTEMPTS_MAX?e._peer.channel.close(CloseType.BLOCKCHAIN_SYNC_FAILED,"blockchain sync failed"):e._requestBlocks()["catch"](Log.w.tag(FullConsensusAgent))})()}_syncFinished(){this._peer.channel.subscribe(Subscription.ANY);const e=FullConsensusAgent.MEMPOOL_DELAY_MIN+Math.random()*(FullConsensusAgent.MEMPOOL_DELAY_MAX-FullConsensusAgent.MEMPOOL_DELAY_MIN);setTimeout(()=>this._peer.channel.mempool(),e);this._syncing=!1;this._synced=!0;this._numBlocksExtending=0;this._numBlocksForking=0;this._forkHead=null;this._failedSyncs=0;this.fire("sync")}_requestBlocks(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._peer.channel.isExpectingMessage(Message.Type.INV)){Log.e(FullConsensusAgent,"Duplicate _requestBlocks()");return}t._peer.channel.expectMessage(Message.Type.INV,function(){t._peer.channel.close(CloseType.GET_BLOCKS_TIMEOUT,"getBlocks timeout")},BaseConsensusAgent.REQUEST_TIMEOUT);const r=[];if(t._forkHead&&0===t._numBlocksExtending&&t._numBlocksForking>0)r.push(t._forkHead.hash());else{r.push(t._blockchain.headHash);let e=t._blockchain.head;for(let s=Math.min(10,t._blockchain.height)-1;s>0&&e;s--){r.push(e.prevHash);e=yield t._blockchain.getBlock(e.prevHash)}let n=2;for(let s=t._blockchain.height-10-n;s>0;s-=n){(e=yield t._blockchain.getBlockAt(s))&&r.push(e.hash());n*=2}0!==r.length&&r[r.length-1].equals(Block.GENESIS.HASH)||r.push(Block.GENESIS.HASH)}t._numBlocksExtending=0;t._numBlocksForking=0;t._peer.channel.getBlocks(r,e)})()}_onInv(e){return super._onInv(e)}_shouldRequestData(e){return!(Services.isNanoNode(this._peer.peerAddress.services)&&e.type===InvVector.Type.BLOCK)}_getBlock(e,t=!1){return this._blockchain.getBlock(e,t)}_getTransaction(e){return Promise.resolve(this._mempool.getTransaction(e))}_onKnownBlockAnnounced(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(r._syncing){r._numBlocksForking++;r._forkHead=t}})()}_onNoUnknownObjects(){this._syncing&&this.syncBlockchain()["catch"](Log.w.tag(FullConsensusAgent))}_onAllObjectsReceived(){this._syncing&&this.syncBlockchain()["catch"](Log.w.tag(FullConsensusAgent))}_onHeader(e){Log.w(FullConsensusAgent,`Unsolicited header message received from ${this._peer.peerAddress}, discarding`)}_processBlock(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){switch(yield r._blockchain.pushBlock(t)){case FullChain.ERR_INVALID:r._peer.channel.close(CloseType.RECEIVED_INVALID_BLOCK,"received invalid block");break;case FullChain.OK_EXTENDED:case FullChain.OK_REBRANCHED:r._syncing&&r._numBlocksExtending++;break;case FullChain.OK_FORKED:if(r._syncing){r._numBlocksForking++;r._forkHead=t}break;case FullChain.ERR_ORPHAN:r._onOrphanBlock(e,t);break;case FullChain.OK_KNOWN:Log.v(FullConsensusAgent,`Received known block ${e} (height=${t.height}, prevHash=${t.prevHash}) from ${r._peer.peerAddress}`)}})()}_onOrphanBlock(e,t){if(this._synced){Log.d(FullConsensusAgent,`Received orphan block ${e} (height=${t.height}, prevHash=${t.prevHash}) from ${this._peer.peerAddress}`);this._timers.timeoutExists("outOfSync")||this._peer.channel.subscribe(Subscription.NONE);this._syncTarget=e;this._timers.resetTimeout("outOfSync",()=>this._outOfSync(),FullConsensusAgent.RESYNC_THROTTLE)}else Log.w(FullConsensusAgent,`Received orphan block ${e} (height=${t.height}, prevHash=${t.prevHash}) while syncing`)}_outOfSync(){this._timers.clearTimeout("outOfSync");this._synced=!1;this.fire("out-of-sync")}_processTransaction(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){switch(yield r._mempool.pushTransaction(t)){case Mempool.ReturnCode.ACCEPTED:return!0;case Mempool.ReturnCode.KNOWN:return!1;case Mempool.ReturnCode.FEE_TOO_LOW:r.peer.channel.reject(Message.Type.TX,RejectMessage.Code.REJECT_INSUFFICIENT_FEE,"Sender has too many free transactions",t.hash().serialize());return!1;case Mempool.ReturnCode.INVALID:r.peer.channel.reject(Message.Type.TX,RejectMessage.Code.REJECT_INVALID,"Invalid transaction",t.hash().serialize());return!1;default:return!1}})()}_onAllObjectsProcessed(){this._syncing&&this.syncBlockchain()["catch"](Log.w.tag(FullConsensusAgent))}_onGetBlocks(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Log.v(FullConsensusAgent,`[GETBLOCKS] ${e.locators.length} block locators maxInvSize ${e.maxInvSize} received from ${t._peer.peerAddress}`);let r=Block.GENESIS;for(const i of e.locators){const e=yield t._blockchain.getBlock(i);if(e){r=e;break}}const n=yield t._blockchain.getBlocks(r.height+1,Math.min(e.maxInvSize,FullConsensusAgent.GETBLOCKS_VECTORS_MAX),e.direction===GetBlocksMessage.Direction.FORWARD),s=[];for(const e of n)s.push(InvVector.fromBlock(e));t._peer.channel.inv(s)})()}_onGetChainProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const e=yield t._blockchain.getChainProof();t._peer.channel.chainProof(e)})()}_onGetAccountsProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._blockchain.getAccountsProof(e.blockHash,e.addresses);t._peer.channel.accountsProof(e.blockHash,r)})()}_onGetTransactionsProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._blockchain.getTransactionsProof(e.blockHash,e.addresses);t._peer.channel.transactionsProof(e.blockHash,r)})()}_onGetAccountsTreeChunk(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._blockchain.getAccountsTreeChunk(e.blockHash,e.startPrefix);t._peer.channel.accountsTreeChunk(e.blockHash,r)})()}_onGetTransactions(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._blockchain.getTransactionReceiptsByAddress(e.address);let n=0;for(;n<TransactionReceiptsMessage.RECEIPTS_MAX_COUNT;){const e=r.slice(n,n+TransactionReceiptsMessage.RECEIPTS_MAX_COUNT);t._peer.channel.transactionReceipts(e);n+=TransactionReceiptsMessage.RECEIPTS_MAX_COUNT}})()}_onMempool(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const e=t._mempool.getTransactions(),r=new LimitIterable(e,FullConsensusAgent.MEMPOOL_ENTRIES_MAX);let n=[];for(const s of r){n.push(InvVector.fromTransaction(s));if(n.length>=BaseInventoryMessage.VECTORS_MAX_COUNT){t._peer.channel.inv(n);n=[];yield new Promise(function(e){return setTimeout(e,FullConsensusAgent.MEMPOOL_THROTTLE)})}}n.length>0&&t._peer.channel.inv(n)})()}}FullConsensusAgent.SYNC_ATTEMPTS_MAX=25;FullConsensusAgent.GETBLOCKS_VECTORS_MAX=500;FullConsensusAgent.RESYNC_THROTTLE=3e3;FullConsensusAgent.MEMPOOL_DELAY_MIN=2e3;FullConsensusAgent.MEMPOOL_DELAY_MAX=2e4;FullConsensusAgent.MEMPOOL_THROTTLE=1e3;FullConsensusAgent.MEMPOOL_ENTRIES_MAX=1e4;Class.register(FullConsensusAgent);class FullConsensus extends Observable{constructor(e,t,r){super();this._blockchain=e;this._mempool=t;this._network=r;this._agents=new HashMap;this._timers=new Timers;this._established=!1;this._syncPeer=null;r.on("peer-joined",e=>this._onPeerJoined(e));r.on("peer-left",e=>this._onPeerLeft(e));e.on("head-changed",e=>{if(this._established)for(const t of this._agents.values())t.relayBlock(e)});t.on("transaction-added",e=>{if(this._established)for(const t of this._agents.values())t.relayTransaction(e)})}_onPeerJoined(e){const t=new FullConsensusAgent(this._blockchain,this._mempool,e);this._agents.put(e.id,t);t.on("close",()=>this._onPeerLeft(t.peer));t.on("sync",()=>this._onPeerSynced(t.peer));t.on("out-of-sync",()=>this._onPeerOutOfSync(t.peer));this._timers.resetTimeout("sync",this._syncBlockchain.bind(this),FullConsensus.SYNC_THROTTLE)}_onPeerLeft(e){if(e.equals(this._syncPeer)){Log.w(FullConsensus,`Peer ${e.peerAddress} left during sync`);this._syncPeer=null}this._agents.remove(e.id);this._syncBlockchain()}_syncBlockchain(){if(this._syncPeer)return;const e=ArrayUtils.randomElement(this._agents.values().filter(e=>!e.synced));if(e){this._syncPeer=e.peer;this._established||this.fire("syncing");Log.v(FullConsensus,`Syncing blockchain with peer ${e.peer.peerAddress}`);e.syncBlockchain()["catch"](Log.w.tag(FullConsensusAgent))}else if(this._agents.length>0){if(!this._established){Log.i(FullConsensus,`Synced with all connected peers (${this._agents.length}), consensus established.`);Log.d(FullConsensus,`Blockchain: height=${this._blockchain.height}, headHash=${this._blockchain.headHash}`);this._established=!0;this.fire("established")}}else{this._established=!1;this.fire("lost")}}_onPeerSynced(e){if(e.equals(this._syncPeer)){Log.v(FullConsensus,`Finished sync with peer ${e.peerAddress}`);this._syncPeer=null}this._syncBlockchain()}_onPeerOutOfSync(e){Log.w(FullConsensus,`Peer ${e.peerAddress} out of sync, resyncing`);this._syncBlockchain()}get established(){return this._established}get blockchain(){return this._blockchain}get mempool(){return this._mempool}get network(){return this._network}}FullConsensus.SYNC_THROTTLE=1500;Class.register(FullConsensus);class LightChain extends FullChain{static getPersistent(e,t,r){const n=ChainDataStore.getPersistent(e);return new LightChain(n,t,r)._init()}static createVolatile(e,t){const r=ChainDataStore.createVolatile();return new LightChain(r,e,t)._init()}constructor(e,t,r){super(e,t,r)}_init(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){yield FullChain.prototype._init.call(e);e._proof||(e._proof=yield e._getChainProof());return e})()}partialChain(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield e.getChainProof(),r=new PartialLightChain(e._store,e._accounts,e._time,t);r.on("committed",(n=(0,_asyncToGenerator3["default"])(function*(t,r,n){e._proof=t;e._headHash=r;e._mainChain=n;e.fire("head-changed",e.head)}),function(e,t,r){return n.apply(this,arguments)}));var n;yield r._init();return r})()}}Class.register(LightChain);class LightConsensusAgent extends FullConsensusAgent{constructor(e,t,r){super(e,t,r);this._blockchain=e;this._partialChain=null;this._syncing=!1;this._catchup=!1;this._onMainChain=!1;this._orphanedBlocks=[];this._busy=!1;this._accountsRequest=null;this._requestedChainProof=!1;r.channel.on("chain-proof",e=>this._onChainProof(e));r.channel.on("accounts-tree-chunk",e=>this._onAccountsTreeChunk(e))}syncBlockchain(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(Services.isNanoNode(e._peer.peerAddress.services)){e._syncFinished();return}if(!e._objectsInFlight.isEmpty()){Log.v(LightConsensusAgent,`Waiting for ${e._objectsInFlight.length} objects to arrive ...`);return}if(!e._objectsProcessing.isEmpty()){Log.v(LightConsensusAgent,`Waiting for ${e._objectsProcessing.length} objects to be processed ...`);return}if(e._failedSyncs>=LightConsensusAgent.SYNC_ATTEMPTS_MAX){e._peer.channel.close(CloseType.BLOCKCHAIN_SYNC_FAILED,"blockchain sync failed");if(e._partialChain){yield e._partialChain.abort();e._partialChain=null}return}const t=yield e._blockchain.getBlock(e._syncTarget);if(!t||e._syncing){if(!t&&!e._syncing){e._syncing=!0;e._onMainChain=!1;let t;try{t=yield e.getHeader(e._syncTarget)}catch(r){e._peer.channel.close(CloseType.DID_NOT_GET_REQUESTED_HEADER,"Did not get requested header");return}e._catchup=t.height-e._blockchain.height<=Policy.NUM_BLOCKS_VERIFICATION;Log.d(LightConsensusAgent,`Start syncing, catchup mode: ${e._catchup}`)}if(e._syncing&&!e._busy)if(e._catchup)yield FullConsensusAgent.prototype.syncBlockchain.call(e);else{e._partialChain||(yield e._initChainProofSync());switch(e._partialChain.state){case PartialLightChain.State.PROVE_CHAIN:e._requestChainProof();e.fire("sync-chain-proof",e._peer.peerAddress);break;case PartialLightChain.State.PROVE_ACCOUNTS_TREE:e._requestAccountsTree();e.fire("sync-accounts-tree",e._peer.peerAddress);break;case PartialLightChain.State.PROVE_BLOCKS:e._requestProofBlocks();e.fire("verify-accounts-tree",e._peer.peerAddress);break;case PartialLightChain.State.COMPLETE:e.fire("sync-finalize",e._peer.peerAddress);e._busy=!0;yield e._partialChain.commit();yield e._applyOrphanedBlocks();e._syncFinished();break;case PartialLightChain.State.ABORTED:e._peer.channel.close(CloseType.ABORTED_SYNC,"aborted sync")}}}else e._syncFinished()})()}_initChainProofSync(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._peer.channel.subscribe(Subscription.ANY);e._syncing=!0;e._synced=!1;e._catchup=!1;e._onMainChain=!0;e._partialChain&&(yield e._partialChain.abort());e._partialChain=yield e._blockchain.partialChain()})()}_syncFinished(){this._partialChain&&(this._partialChain=null);this._busy=!1;super._syncFinished()}_applyOrphanedBlocks(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){for(const t of e._orphanedBlocks){if((yield e._blockchain.pushBlock(t))===LightChain.ERR_INVALID){e._peer.channel.close(CloseType.RECEIVED_INVALID_BLOCK,"received invalid block");break}}e._orphanedBlocks=[]})()}_requestChainProof(){Assert.that(this._partialChain&&this._partialChain.state===PartialLightChain.State.PROVE_CHAIN);Assert.that(!this._requestedChainProof);this._busy=!0;this._peer.channel.getChainProof();this._requestedChainProof=!0;this._peer.channel.expectMessage(Message.Type.CHAIN_PROOF,()=>{this._peer.channel.close(CloseType.GET_CHAIN_PROOF_TIMEOUT,"getChainProof timeout")},LightConsensusAgent.CHAINPROOF_REQUEST_TIMEOUT,LightConsensusAgent.CHAINPROOF_CHUNK_TIMEOUT)}_onChainProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Assert.that(t._partialChain&&t._partialChain.state===PartialLightChain.State.PROVE_CHAIN);Log.d(LightConsensusAgent,`[CHAIN-PROOF] Received from ${t._peer.peerAddress}: ${e.proof}`);if(t._requestedChainProof){t._requestedChainProof=!1;t._syncing&&t.fire("verify-chain-proof",t._peer.peerAddress);if(yield t._partialChain.pushProof(e.proof)){t._busy=!1;t.syncBlockchain()["catch"](Log.w.tag(LightConsensusAgent))}else{Log.w(LightConsensusAgent,`Invalid chain proof received from ${t._peer.peerAddress} - verification failed`);t._peer.channel.close(CloseType.INVALID_CHAIN_PROOF,"invalid chain proof")}}else Log.w(LightConsensusAgent,`Unsolicited chain proof received from ${t._peer.peerAddress}`)})()}_requestAccountsTree(){Assert.that(this._partialChain&&this._partialChain.state===PartialLightChain.State.PROVE_ACCOUNTS_TREE);Assert.that(!this._accountsRequest);this._busy=!0;const e=this._partialChain.getMissingAccountsPrefix(),t=this._partialChain.headHash;Log.d(LightConsensusAgent,`Requesting AccountsTreeChunk starting at ${e} from ${this._peer.peerAddress}`);this._accountsRequest={startPrefix:e,blockHash:t};this._peer.channel.getAccountsTreeChunk(t,e);this._peer.channel.expectMessage(Message.Type.ACCOUNTS_TREE_CHUNK,()=>{this._peer.channel.close(CloseType.GET_ACCOUNTS_TREE_CHUNK_TIMEOUT,"getAccountsTreeChunk timeout")},LightConsensusAgent.ACCOUNTS_TREE_CHUNK_REQUEST_TIMEOUT)}_onAccountsTreeChunk(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Log.d(LightConsensusAgent,`[ACCOUNTS-TREE-CHUNK] Received from ${t._peer.peerAddress}: blockHash=${e.blockHash}, proof=${e.chunk}`);if(!t._accountsRequest){Log.w(LightConsensusAgent,`Unsolicited accounts tree chunk received from ${t._peer.peerAddress}`);return}Assert.that(t._partialChain&&t._partialChain.state===PartialLightChain.State.PROVE_ACCOUNTS_TREE);const r=t._accountsRequest.startPrefix,n=t._accountsRequest.blockHash;t._accountsRequest=null;if(!e.hasChunk()){yield t._partialChain.abort();t._partialChain=null;t._busy=!1;t._failedSyncs++;return}if(!n.equals(e.blockHash)||e.chunk.head.prefix<=r){Log.w(LightConsensusAgent,`Received AccountsTreeChunk for block != head or wrong start prefix from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.INVALID_ACCOUNTS_TREE_CHUNK,"Invalid AccountsTreeChunk");return}const s=e.chunk;if(!s.verify()){Log.w(LightConsensusAgent,`Invalid AccountsTreeChunk received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.INVALID_ACCOUNTS_TREE_CHUNK,"Invalid AccountsTreeChunk");return}const i=s.root();if(!(yield t._partialChain.getBlock(n)).accountsHash.equals(i)){Log.w(LightConsensusAgent,`Invalid AccountsTreeChunk (root hash) received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.ACCOUNTS_TREE_CHUNCK_ROOT_HASH_MISMATCH,"AccountsTreeChunk root hash mismatch");return}const o=yield t._partialChain.pushAccountsTreeChunk(s);if(o<0){Log.e(`AccountsTree sync failed with error code ${o} from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.ACCOUNTS_TREE_CHUNCK_ROOT_HASH_MISMATCH,"AccountsTreeChunk root hash mismatch")}t._busy=!1;t.syncBlockchain()["catch"](Log.w.tag(LightConsensusAgent))})()}_requestProofBlocks(){Assert.that(this._partialChain&&this._partialChain.state===PartialLightChain.State.PROVE_BLOCKS);this._lastChainHeight===this._partialChain.proofHeadHeight&&this._failedSyncs++;this._lastChainHeight=this._partialChain.proofHeadHeight;if(this._peer.channel.isExpectingMessage(Message.Type.INV))Log.e(LightConsensusAgent,"Duplicate _requestProofBlocks()");else{this._peer.channel.expectMessage(Message.Type.INV,()=>{this._peer.channel.close(CloseType.GET_BLOCKS_TIMEOUT,"getBlocks timeout")},BaseConsensusAgent.REQUEST_TIMEOUT);this._peer.channel.getBlocks(this._partialChain.getBlockLocators(),this._partialChain.numBlocksNeeded(),!1)}}_requestBlocks(){return this._syncing&&!this._onMainChain?super._requestBlocks(1):super._requestBlocks()}_processBlock(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(t.height<r._chain.height-Policy.NUM_BLOCKS_VERIFICATION&&(!r._partialChain||r._partialChain.state!==PartialLightChain.State.PROVE_BLOCKS)){r._onMainChain=!1;yield r._initChainProofSync();r.syncBlockchain()["catch"](Log.w.tag(LightConsensusAgent));return}r._onMainChain=!0;switch(yield r._chain.pushBlock(t)){case FullChain.ERR_INVALID:r._peer.channel.close(CloseType.RECEIVED_INVALID_BLOCK,"received invalid block");break;case FullChain.OK_EXTENDED:case FullChain.OK_REBRANCHED:r._syncing&&r._numBlocksExtending++;break;case FullChain.OK_FORKED:if(r._syncing){r._numBlocksForking++;r._forkHead=t}break;case LightChain.ERR_ORPHAN:r._onOrphanBlock(e,t)}})()}_onKnownBlockAnnounced(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){if(r._syncing&&r._catchup){if(t.height<r._chain.height-Policy.NUM_BLOCKS_VERIFICATION&&(!r._partialChain||r._partialChain.state!==PartialLightChain.State.PROVE_BLOCKS)){r._onMainChain=!1;yield r._initChainProofSync();r.syncBlockchain()["catch"](function(e){return Log.e(LightConsensusAgent,e)});return}r._onMainChain=!0;FullConsensusAgent.prototype._onKnownBlockAnnounced.call(r,e,t)}})()}_onOrphanBlock(e,t){this._syncing&&!this._catchup?this._orphanedBlocks.push(t):super._onOrphanBlock(e,t)}getHeader(e){Assert.that(!this._headerRequest);return new Promise((t,r)=>{const n=new InvVector(InvVector.Type.BLOCK,e);this._headerRequest={hash:e,resolve:t,reject:r};this._peer.channel.getHeader([n]);this._peer.channel.expectMessage(Message.Type.HEADER,()=>{this._headerRequest=null;this._peer.channel.close(CloseType.GET_HEADER_TIMEOUT,"getHeader timeout");r(new Error("timeout"))},BaseConsensusAgent.REQUEST_TIMEOUT)})}_onHeader(e){const t=e.header,r=t.hash();if(!this._headerRequest){Log.w(NanoConsensusAgent,`Unsolicited header ${r} received from ${this._peer.peerAddress}, discarding`);return}const n=this._headerRequest.hash,s=this._headerRequest.resolve,i=this._headerRequest.reject;if(n.equals(r))s(t);else{Log.w(LightConsensusAgent,`Received wrong header from ${this._peer.peerAddress}`);this._peer.channel.close(CloseType.RECEIVED_WRONG_HEADER,"Received wrong header");i(new Error("Received wrong header"))}}_onClose(){this._partialChain&&this._partialChain.abort()["catch"](Log.w.tag(LightConsensusAgent));super._onClose()}get _chain(){return this._syncing&&!this._catchup&&this._partialChain?this._partialChain:this._blockchain}}LightConsensusAgent.CHAINPROOF_REQUEST_TIMEOUT=45e3;LightConsensusAgent.CHAINPROOF_CHUNK_TIMEOUT=1e4;LightConsensusAgent.ACCOUNTS_TREE_CHUNK_REQUEST_TIMEOUT=8e3;LightConsensusAgent.SYNC_ATTEMPTS_MAX=5;LightConsensusAgent.GETBLOCKS_VECTORS_MAX=500;Class.register(LightConsensusAgent);class LightConsensus extends Observable{constructor(e,t,r){super();this._blockchain=e;this._mempool=t;this._network=r;this._agents=new HashMap;this._timers=new Timers;this._established=!1;this._syncPeer=null;this._synchronizer=new Synchronizer;r.on("peer-joined",e=>this._onPeerJoined(e));r.on("peer-left",e=>this._onPeerLeft(e));e.on("head-changed",e=>{if(this._established)for(const t of this._agents.values())t.relayBlock(e)});t.on("transaction-added",e=>{if(this._established)for(const t of this._agents.values())t.relayTransaction(e)})}_onPeerJoined(e){const t=new LightConsensusAgent(this._blockchain,this._mempool,e);this._agents.put(e.id,t);t.on("close",()=>this._onPeerLeft(t.peer));t.on("sync",()=>this._onPeerSynced(t.peer));t.on("out-of-sync",()=>this._onPeerOutOfSync(t.peer));this.bubble(t,"sync-chain-proof","verify-chain-proof","sync-accounts-tree","verify-accounts-tree","sync-finalize");this._timers.resetTimeout("sync",this._syncBlockchain.bind(this),LightConsensus.SYNC_THROTTLE)}_onPeerLeft(e){if(e.equals(this._syncPeer)){Log.w(LightConsensus,`Peer ${e.peerAddress} left during sync`);this._syncPeer=null;this.fire("sync-failed",e.peerAddress)}this._agents.remove(e.id);this._syncBlockchain()}_syncBlockchain(){return this._synchronizer.push(()=>{if(this._syncPeer)return;const e=this._agents.values().filter(e=>!e.synced),t=ArrayUtils.randomElement(e);if(t){this._syncPeer=t.peer;this._established||this.fire("syncing",t.peer.peerAddress,e.length-1);Log.v(LightConsensus,`Syncing blockchain with peer ${t.peer.peerAddress}`);t.syncBlockchain()["catch"](Log.w.tag(LightConsensusAgent))}else if(this._agents.length>0){if(!this._established){Log.i(LightConsensus,`Synced with all connected peers (${this._agents.length}), consensus established.`);Log.d(LightConsensus,`Blockchain: height=${this._blockchain.height}, headHash=${this._blockchain.headHash}`);this._established=!0;this.fire("established")}}else{this._established=!1;this.fire("lost")}})}_onPeerSynced(e){if(e.equals(this._syncPeer)){Log.v(LightConsensus,`Finished sync with peer ${e.peerAddress}`);this._syncPeer=null;this.fire("sync-finished",e.peerAddress)}this._syncBlockchain()}_onPeerOutOfSync(e){Log.w(LightConsensus,`Peer ${e.peerAddress} out of sync, resyncing`);this._syncBlockchain()}get established(){return this._established}get blockchain(){return this._blockchain}get mempool(){return this._mempool}get network(){return this._network}}LightConsensus.SYNC_THROTTLE=1e3;Class.register(LightConsensus);class PartialLightChain extends LightChain{constructor(e,t,r,n){super(e.transaction(!1),t,r);this._proof=n;this._state=PartialLightChain.State.PROVE_CHAIN;this._partialTree=null;this._accountsTx=null;this._proofHead=null}pushProof(e){return this._synchronizer.push(()=>this._pushProof(e))}_pushProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=[];for(let o=0;o<e.prefix.length;++o){const n=e.prefix.blocks[o],s=n.hash();(yield t._store.getBlock(s))||n.header._pow||r.push(n.header)}for(let o=0;o<e.suffix.length;++o){const n=e.suffix.headers[o],s=n.hash();(yield t._store.getBlock(s))||n._pow||r.push(n)}yield Crypto.manyPow(r);for(let o=0;o<e.prefix.length;o++){const r=e.prefix.blocks[o],n=r.hash(),s=yield t._store.getBlock(n);if(s)e.prefix.blocks[o]=s.toLight();else if(!(yield r.verify(t._time))){Log.w(PartialLightChain,"Rejecting proof - prefix contains invalid block");return!1}}for(let o=0;o<e.suffix.length;o++){const r=e.suffix.headers[o],n=r.hash(),s=yield t._store.getBlock(n);if(s)e.suffix.headers[o]=s.header;else if(!(yield r.verifyProofOfWork())){Log.w(PartialLightChain,"Rejecting proof - suffix contains invalid header");return!1}}if(!(yield e.verify())){Log.w(PartialLightChain,"Rejecting proof - verification failed");return!1}if(e.suffix.length!==Policy.K&&e.suffix.length!==e.head.height-1){Log.w(PartialLightChain,"Rejecting proof - invalid suffix length");return!1}if(e.prefix.denseSuffix().length<Policy.M&&e.prefix.length>0&&e.prefix.head.height>=Policy.M){Log.w(NanoChain,"Rejecting proof - dense suffix too short");return!1}const n=[];let s=e.prefix.head;for(const t of e.suffix.headers){const e=yield s.getNextInterlink(t.target,t.version),r=e.hash();if(!t.interlinkHash.equals(r)){Log.w(PartialLightChain,"Rejecting proof - invalid interlink hash in proof suffix");return!1}s=new Block(t,e);n.push(s)}const i=yield t.getChainProof();(yield BaseChain.isBetterProof(e,i,Policy.M))?yield t._acceptProof(e,n):yield t.abort();return!0})()}_acceptProof(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=e.prefix.head.hash(),s=yield r._store.getChainData(n);if(!s||s.totalDifficulty<=0){yield r._store.truncate();const t=e.prefix.denseSuffix();for(let s=0;s<e.prefix.length-t.length;s++){const t=e.prefix.blocks[s],n=t.hash(),i=new ChainData(t,-1,-1,!0);yield r._store.putChainData(n,i)}const n=t[0];r._headHash=n.hash();r._mainChain=new ChainData(n,n.difficulty,BlockUtils.realDifficulty(yield n.pow()),!0);yield r._store.putChainData(r._headHash,r._mainChain);for(let e=1;e<t.length;e++){const n=t[e],s=yield r._pushLightBlock(n);Assert.that(s>=0)}}for(const e of t){const t=yield r._pushLightBlock(e);Assert.that(t>=0)}r._state=PartialLightChain.State.PROVE_ACCOUNTS_TREE;r._partialTree=yield r._accounts.partialAccountsTree();r._proofHead=r._mainChain;yield r._store.setHead(r.headHash);r._proof=e})()}_pushLightBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(yield t._store.getBlock(r))return NanoChain.OK_KNOWN;const n=yield t._store.getChainData(e.prevHash);return!n||n.totalDifficulty<=0?NanoChain.ERR_ORPHAN:t._pushBlockInternal(e,r,n)})()}_pushBlockInternal(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=r.totalDifficulty+e.difficulty,i=r.totalWork+BlockUtils.realDifficulty(yield e.pow()),o=new ChainData(e,s,i);if(e.prevHash.equals(n.headHash)){o.onMainChain=!0;yield n._store.putChainData(t,o);n._mainChain=o;n._headHash=t;if(n._proof){const t=n._proof.head.hash();e.prevHash.equals(t)&&(n._proof=yield n._extendChainProof(n._proof,e.header))}n.fire("head-changed",n.head,!1);return NanoChain.OK_EXTENDED}if(s>n._mainChain.totalDifficulty){yield n._rebranch(t,o);return NanoChain.OK_REBRANCHED}Log.v(NanoChain,`Creating/extending fork with block ${t}, height=${e.height}, totalDifficulty=${o.totalDifficulty}, totalWork=${o.totalWork}`);yield n._store.putChainData(t,o);return NanoChain.OK_FORKED})()}_pushBlock(e){if(this._state===PartialLightChain.State.PROVE_BLOCKS){const t=e.hash();if(this._proofHead.head.prevHash.equals(t))return this._pushBlockBackwards(e);if(this._proofHead.head.hash().equals(t))return this._pushHeadBlock(e)}return FullChain.ERR_ORPHAN}_pushHeadBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(!e.isFull()){Log.w(PartialLightChain,"Rejecting block - body missing");return FullChain.ERR_INVALID}if(!(yield e.verify(t._time)))return FullChain.ERR_INVALID;if(!(yield t._verifyInterlink(e))){Log.w(PartialLightChain,"Rejecting block - interlink verification failed");return FullChain.ERR_INVALID}const n=yield t._store.getChainData(e.prevHash);if(!n){Log.w(PartialLightChain,"Rejecting block - unknown predecessor");return FullChain.ERR_ORPHAN}const s=n.head;if(!(yield e.isImmediateSuccessorOf(s))){Log.w(PartialLightChain,"Rejecting block - not a valid immediate successor");return FullChain.ERR_INVALID}const i=yield t.getNextTarget(s);if(BlockUtils.isValidTarget(i)){if(e.nBits!==BlockUtils.targetToCompact(i)){Log.w(PartialLightChain,"Rejecting block - difficulty mismatch");return FullChain.ERR_INVALID}}else Log.w(PartialLightChain,"Skipping difficulty verification - not enough blocks available");const o=n.totalDifficulty+e.difficulty,a=n.totalWork+BlockUtils.realDifficulty(yield e.pow()),c=new ChainData(e,o,a);if(!(yield t._prepend(r,c)))return FullChain.ERR_INVALID;t._mainChain=c;t._proofHead=c;t._headHash=r;t.needsMoreBlocks()||(yield t._complete());return FullChain.OK_EXTENDED})()}_pushBlockBackwards(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(!e.isFull()){Log.w(PartialLightChain,"Rejecting block - body missing");return FullChain.ERR_INVALID}if(!(yield e.verify(t._time)))return FullChain.ERR_INVALID;if(!(yield t._verifyInterlink(e))){Log.w(PartialLightChain,"Rejecting block - interlink verification failed");return FullChain.ERR_INVALID}if(!(yield t._proofHead.head.isImmediateSuccessorOf(e))){Log.w(PartialLightChain,"Rejecting block - not a valid immediate predecessor");return FullChain.ERR_INVALID}const n=yield t.getNextTarget(e);if(BlockUtils.isValidTarget(n)){if(t._proofHead.head.nBits!==BlockUtils.targetToCompact(n)){Log.w(PartialLightChain,"Rejecting block - difficulty mismatch");return FullChain.ERR_INVALID}}else Log.w(NanoChain,"Skipping difficulty verification - not enough blocks available");const s=t._proofHead.totalDifficulty-t._proofHead.head.difficulty,i=t._proofHead.totalWork-BlockUtils.realDifficulty(yield t._proofHead.head.pow()),o=new ChainData(e,s,i);return(yield t._prepend(r,o))?FullChain.OK_EXTENDED:FullChain.ERR_INVALID})()}_prepend(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){try{const e=new TransactionCache;yield r._accountsTx.revertBlock(t.head,e)}catch(n){Log.w(PartialLightChain,`Rejecting block - failed to commit to AccountsTree: ${n.message||n}`);return!1}t.onMainChain=!0;yield r._store.putChainData(e,t);r._proofHead=t;r.needsMoreBlocks()||(yield r._complete());return!0})()}pushAccountsTreeChunk(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._state!==PartialLightChain.State.PROVE_ACCOUNTS_TREE)return PartialAccountsTree.Status.ERR_INCORRECT_PROOF;const r=yield t._partialTree.pushChunk(e);if(r===PartialAccountsTree.Status.OK_COMPLETE){t._state=PartialLightChain.State.PROVE_BLOCKS;t._accountsTx=new Accounts(t._partialTree.transaction(!1))}return r})()}_complete(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._state=PartialLightChain.State.COMPLETE;if(e._accountsTx){yield e._accountsTx.abort();e._accountsTx=null}const t=yield e.getChainProof();e.fire("complete",t,e._headHash,e._mainChain)})()}commit(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._accountsTx&&(yield e._accountsTx.abort());const t=yield JDB.JungleDB.commitCombined(e._store.tx,e._partialTree.tx);e._partialTree=null;const r=yield e.getChainProof();e.fire("committed",r,e._headHash,e._mainChain);return t})()}abort(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._state=PartialLightChain.State.ABORTED;e._accountsTx&&(yield e._accountsTx.abort());e._partialTree&&(yield e._partialTree.abort());yield e._store.abort();e.fire("aborted")})()}getMissingAccountsPrefix(){return this._partialTree?this._partialTree.missingPrefix:""}getBlockLocators(){return this._proofHead?[this._proofHead.head.hash()]:[this.headHash]}numBlocksNeeded(){if(!this._proofHead)return Policy.NUM_BLOCKS_VERIFICATION;let e=Policy.NUM_BLOCKS_VERIFICATION-(this.height-this._proofHead.head.height+1);this._proofHead.head.isFull()||e++;return e}needsMoreBlocks(){return this.numBlocksNeeded()>0}get state(){return this._state}get proofHeadHeight(){return this._proofHead.head.height}}PartialLightChain.State={ABORTED:-1,PROVE_CHAIN:0,PROVE_ACCOUNTS_TREE:1,PROVE_BLOCKS:2,COMPLETE:3};Class.register(PartialLightChain);class NanoChain extends BaseChain{constructor(e){super(ChainDataStore.createVolatile());this._time=e;this._proof=new ChainProof(new BlockChain([Block.GENESIS.toLight()]),new HeaderChain([]));this._headHash=Block.GENESIS.HASH;this._synchronizer=new Synchronizer;return this._init()}_init(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._mainChain=new ChainData(Block.GENESIS,Block.GENESIS.difficulty,BlockUtils.realDifficulty(yield Block.GENESIS.pow()),!0);yield e._store.putChainData(Block.GENESIS.HASH,e._mainChain);return e})()}pushProof(e){return this._synchronizer.push(()=>this._pushProof(e))}_pushProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=[];for(let o=0;o<e.prefix.length;++o){const n=e.prefix.blocks[o],s=n.hash();(yield t._store.getBlock(s))||n.header._pow||r.push(n.header)}for(let o=0;o<e.suffix.length;++o){const n=e.suffix.headers[o],s=n.hash();(yield t._store.getBlock(s))||n._pow||r.push(n)}yield Crypto.manyPow(r);for(let o=0;o<e.prefix.length;o++){const r=e.prefix.blocks[o],n=r.hash(),s=yield t._store.getBlock(n);if(s)e.prefix.blocks[o]=s.toLight();else if(!(yield r.verify(t._time))){Log.w(NanoChain,"Rejecting proof - prefix contains invalid block");return!1}}for(let o=0;o<e.suffix.length;o++){const r=e.suffix.headers[o],n=r.hash(),s=yield t._store.getBlock(n);if(s)e.suffix.headers[o]=s.header;else if(!(yield r.verifyProofOfWork())){Log.w(NanoChain,"Rejecting proof - suffix contains invalid header");return!1}}if(!(yield e.verify())){Log.w(NanoChain,"Rejecting proof - verification failed");return!1}if(e.suffix.length!==Policy.K&&e.suffix.length!==e.head.height-1){Log.w(NanoChain,"Rejecting proof - invalid suffix length");return!1}if(e.prefix.denseSuffix().length<Policy.M&&e.prefix.length>0&&e.prefix.head.height>=Policy.M){Log.w(NanoChain,"Rejecting proof - dense suffix too short");return!1}const n=[];let s=e.prefix.head;for(const t of e.suffix.headers){const e=yield s.getNextInterlink(t.target,t.version),r=e.hash();if(!t.interlinkHash.equals(r)){Log.w(NanoChain,"Rejecting proof - invalid interlink hash in proof suffix");return!1}s=new Block(t,e);n.push(s)}const i=yield t.getChainProof();(yield BaseChain.isBetterProof(e,i,Policy.M))&&(yield t._acceptProof(e,n));return!0})()}_acceptProof(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){r._proof=e;const n=e.prefix.head.hash(),s=yield r._store.getChainData(n);if(!s||s.totalDifficulty<=0){yield r._store.truncate();const t=e.prefix.denseSuffix();for(let s=0;s<e.prefix.length-t.length;s++){const t=e.prefix.blocks[s],n=t.hash(),i=new ChainData(t,-1,-1,!0);yield r._store.putChainData(n,i)}const n=t[0];r._headHash=n.hash();r._mainChain=new ChainData(n,n.difficulty,BlockUtils.realDifficulty(yield n.pow()),!0);yield r._store.putChainData(r._headHash,r._mainChain);for(let e=1;e<t.length;e++){const n=t[e],s=yield r._pushBlock(n);Assert.that(s>=0)}}for(const e of t){const t=yield r._pushBlock(e);Assert.that(t>=0)}})()}_pushBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield e.hash();if(yield t._store.getBlock(r))return NanoChain.OK_KNOWN;const n=yield t._store.getChainData(e.prevHash);return!n||n.totalDifficulty<=0?NanoChain.ERR_ORPHAN:t._pushBlockInternal(e,r,n)})()}pushHeader(e){return this._synchronizer.push(()=>this._pushHeader(e))}_pushHeader(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(yield t._store.getBlock(r))return NanoChain.OK_KNOWN;if(!(yield e.verifyProofOfWork())){Log.w(NanoChain,"Rejecting header - PoW verification failed");return NanoChain.ERR_INVALID}const n=yield t._store.getChainData(e.prevHash);if(!n||n.totalDifficulty<=0){Log.w(NanoChain,"Rejecting header - unknown predecessor");return NanoChain.ERR_ORPHAN}const s=n.head;if(!e.isImmediateSuccessorOf(s.header)){Log.w(NanoChain,"Rejecting header - not a valid successor");return NanoChain.ERR_INVALID}const i=yield t.getNextTarget(s);if(BlockUtils.isValidTarget(i)){if(e.nBits!==BlockUtils.targetToCompact(i)){Log.w(NanoChain,"Rejecting header - difficulty mismatch");return NanoChain.ERR_INVALID}}else Log.w(NanoChain,"Skipping difficulty verification - not enough blocks available");const o=yield s.getNextInterlink(e.target,e.version);if(!o.hash().equals(e.interlinkHash)){Log.w(NanoChain,"Rejecting header - interlink verification failed");return NanoChain.ERR_INVALID}const a=new Block(e,o);return t._pushBlockInternal(a,r,n)})()}_pushBlockInternal(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=r.totalDifficulty+e.difficulty,i=r.totalWork+BlockUtils.realDifficulty(yield e.pow()),o=new ChainData(e,s,i);if(e.prevHash.equals(n.headHash)){o.onMainChain=!0;yield n._store.putChainData(t,o);n._mainChain=o;n._headHash=t;if(n._proof){const t=n._proof.head.hash();e.prevHash.equals(t)&&(n._proof=yield n._extendChainProof(n._proof,e.header))}n.fire("head-changed",n.head,!1);return NanoChain.OK_EXTENDED}if(s>n._mainChain.totalDifficulty){yield n._rebranch(t,o);return NanoChain.OK_REBRANCHED}Log.v(NanoChain,`Creating/extending fork with block ${t}, height=${e.height}, totalDifficulty=${o.totalDifficulty}, totalWork=${o.totalWork}`);yield n._store.putChainData(t,o);return NanoChain.OK_FORKED})()}_rebranch(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){Log.v(NanoChain,`Rebranching to fork ${e}, height=${t.head.height}, totalDifficulty=${t.totalDifficulty}, totalWork=${t.totalWork}`);const n=[],s=[];let i=t,o=e;for(;!i.onMainChain;){n.push(i);s.push(o);o=i.head.prevHash;i=yield r._store.getChainData(o);Assert.that(!!i,"Failed to find fork predecessor while rebranching")}Log.v(NanoChain,function(){return`Found common ancestor ${o.toBase64()} ${n.length} blocks up`});let a=r._headHash,c=r._mainChain;for(;!a.equals(o);){c.onMainChain=!1;yield r._store.putChainData(a,c);a=c.head.prevHash;c=yield r._store.getChainData(a);Assert.that(!!c,"Failed to find main chain predecessor while rebranching")}r._proof=null;for(let e=n.length-1;e>=0;e--){const t=n[e];t.onMainChain=!0;yield r._store.putChainData(s[e],t);r._mainChain=n[e];r._headHash=s[e];r.fire("head-changed",r.head,e>0)}})()}getChainProof(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._proof||(e._proof=yield e._getChainProof());return e._proof})()}get head(){return this._mainChain.head}get headHash(){return this._headHash}get height(){return this._mainChain.head.height}}NanoChain.ERR_ORPHAN=-2;NanoChain.ERR_INVALID=-1;NanoChain.OK_KNOWN=0;NanoChain.OK_EXTENDED=1;NanoChain.OK_REBRANCHED=2;NanoChain.OK_FORKED=3;Class.register(NanoChain);class NanoConsensusAgent extends BaseConsensusAgent{constructor(e,t,r,n){super(n);this._blockchain=e;this._mempool=t;this._time=r;this._syncing=!1;this._orphanedBlocks=[];this._synchronizer=new Synchronizer;this._accountsRequest=null;this._transactionsRequest=null;this._blockRequest=null;this._requestedChainProof=!1;this._requestedTransactionReceipts=!1;n.channel.on("chain-proof",e=>this._onChainProof(e));n.channel.on("accounts-proof",e=>this._onAccountsProof(e));n.channel.on("transactions-proof",e=>this._onTransactionsProof(e));n.channel.on("transaction-receipts",e=>this._onTransactionReceipts(e));n.channel.on("get-chain-proof",e=>this._onGetChainProof(e));this._localSubscription=Subscription.BLOCKS_ONLY;this._peer.channel.subscribe(this._localSubscription)}subscribeAccounts(e){this._localSubscription=Subscription.fromAddresses(e);this._peer.channel.subscribe(Subscription.BLOCKS_ONLY);this._timers.resetTimeout("subscription-change",()=>{this._peer.channel.subscribe(this._localSubscription)},NanoConsensusAgent.SUBSCRIPTION_CHANGE_THROTTLE)}syncBlockchain(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._syncing=!0;if(yield e._blockchain.getBlock(e._peer.headHash))e._syncFinished();else{e._requestChainProof();e.fire("sync-chain-proof",e._peer.peerAddress)}})()}_syncFinished(){this._syncing=!1;this._synced=!0;this.fire("sync")}_requestChainProof(){if(!this._requestedChainProof){this._peer.channel.getChainProof();this._requestedChainProof=!0;this._peer.channel.expectMessage(Message.Type.CHAIN_PROOF,()=>{this._peer.channel.close(CloseType.GET_CHAIN_PROOF_TIMEOUT,"getChainProof timeout")},NanoConsensusAgent.CHAINPROOF_REQUEST_TIMEOUT,NanoConsensusAgent.CHAINPROOF_CHUNK_TIMEOUT)}}_onChainProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Log.d(NanoConsensusAgent,`[CHAIN-PROOF] Received from ${t._peer.peerAddress}: ${e.proof}`);if(t._requestedChainProof){t._requestedChainProof=!1;t._syncing&&t.fire("verify-chain-proof",t._peer.peerAddress);if(yield t._blockchain.pushProof(e.proof)){yield t._applyOrphanedBlocks();t._syncing&&t._syncFinished()}else{Log.w(NanoConsensusAgent,`Invalid chain proof received from ${t._peer.peerAddress} - verification failed`);t._peer.channel.close(CloseType.INVALID_CHAIN_PROOF,"invalid chain proof")}}else Log.w(NanoConsensusAgent,`Unsolicited chain proof received from ${t._peer.peerAddress}`)})()}_applyOrphanedBlocks(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){for(const t of e._orphanedBlocks){if((yield e._blockchain.pushHeader(t))===NanoChain.ERR_INVALID){e._peer.channel.close(CloseType.RECEIVED_INVALID_BLOCK,"received invalid block");break}}e._orphanedBlocks=[]})()}_doRequestData(e){const t=[],r=[];for(const n of e)n.type===InvVector.Type.BLOCK?t.push(n):r.push(n);this._peer.channel.getHeader(t);this._peer.channel.getData(r)}_getBlock(e,t=!1){return this._blockchain.getBlock(e,t)}_getTransaction(e){return Promise.resolve(this._mempool.getTransaction(e))}_processHeader(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const e=yield r._blockchain.pushHeader(t);if(e===NanoChain.ERR_INVALID)r._peer.channel.close(CloseType.RECEIVED_INVALID_HEADER,"received invalid header");else if(e===NanoChain.ERR_ORPHAN){r._orphanedBlocks.push(t);r._synced&&r._requestChainProof()}})()}_processTransaction(e,t){this._localSubscription.matchesTransaction(t)||this._peer.channel.close(CloseType.RECEIVED_TRANSACTION_NOT_MATCHING_OUR_SUBSCRIPTION,"received transaction not matching our subscription");return this._mempool.pushTransaction(t)}_onGetChainProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const e=yield t._blockchain.getChainProof();e&&t._peer.channel.chainProof(e)})()}getAccounts(e,t){return this._synchronizer.push(()=>this._getAccounts(e,t))}_getAccounts(e,t){Assert.that(null===this._accountsRequest);Log.d(NanoConsensusAgent,`Requesting AccountsProof for ${t} from ${this._peer.peerAddress}`);return new Promise((r,n)=>{this._accountsRequest={addresses:t,blockHash:e,resolve:r,reject:n};this._peer.channel.getAccountsProof(e,t);this._peer.channel.expectMessage(Message.Type.ACCOUNTS_PROOF,()=>{this._peer.channel.close(CloseType.GET_ACCOUNTS_PROOF_TIMEOUT,"getAccountsProof timeout");n(new Error("timeout"))},NanoConsensusAgent.ACCOUNTSPROOF_REQUEST_TIMEOUT)})}_onAccountsProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Log.d(NanoConsensusAgent,`[ACCOUNTS-PROOF] Received from ${t._peer.peerAddress}: blockHash=${e.blockHash}, proof=${e.proof} (${e.serializedSize} bytes)`);if(!t._accountsRequest){Log.w(NanoConsensusAgent,`Unsolicited accounts proof received from ${t._peer.peerAddress}`);return}const r=t._accountsRequest.addresses,n=t._accountsRequest.blockHash,s=t._accountsRequest.resolve,i=t._accountsRequest.reject;t._accountsRequest=null;if(!e.hasProof()){i(new Error("Accounts request was rejected"));return}if(!n.equals(e.blockHash)){Log.w(NanoConsensusAgent,`Received AccountsProof for invalid reference block from ${t._peer.peerAddress}`);i(new Error("Invalid reference block"));return}const o=e.proof;if(!o.verify()){Log.w(NanoConsensusAgent,`Invalid AccountsProof received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.INVALID_ACCOUNTS_PROOF,"Invalid AccountsProof");i(new Error("Invalid AccountsProof"));return}const a=o.root();if(!(yield t._blockchain.getBlock(n)).accountsHash.equals(a)){Log.w(NanoConsensusAgent,`Invalid AccountsProof (root hash) received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.ACCOUNTS_PROOF_ROOT_HASH_MISMATCH,"AccountsProof root hash mismatch");i(new Error("AccountsProof root hash mismatch"));return}const c=[];for(const e of r)try{const r=o.getAccount(e);c.push(r)}catch(l){Log.w(NanoConsensusAgent,`Incomplete AccountsProof received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.INCOMPLETE_ACCOUNTS_PROOF,"Incomplete AccountsProof");i(new Error("Incomplete AccountsProof"));return}s(c)})()}getTransactionsProof(e,t){return this._synchronizer.push(()=>this._getTransactionsProof(e,t))}_getTransactionsProof(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){Assert.that(null===r._transactionsRequest);Log.d(NanoConsensusAgent,`Requesting TransactionsProof for ${t} from ${r._peer.peerAddress}`);const n=yield r._blockchain.getBlock(e);if(!n){Log.d(NanoConsensusAgent,`Requested block with hash ${e} not found`);return[]}return new Promise(function(s,i){r._transactionsRequest={addresses:t,blockHash:e,header:n.header,resolve:s,reject:i};r._peer.channel.getTransactionsProof(e,t);r._peer.channel.expectMessage(Message.Type.TRANSACTIONS_PROOF,function(){r._peer.channel.close(CloseType.GET_TRANSACTIONS_PROOF_TIMEOUT,"getTransactionsProof timeout");i(new Error("timeout"))},NanoConsensusAgent.TRANSACTIONSPROOF_REQUEST_TIMEOUT)})})()}_onTransactionsProof(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Log.d(NanoConsensusAgent,`[TRANSACTIONS-PROOF] Received from ${t._peer.peerAddress}: blockHash=${e.blockHash}, transactions=${e.transactions}, proof=${e.proof} (${e.serializedSize} bytes)`);if(!t._transactionsRequest){Log.w(NanoConsensusAgent,`Unsolicited transactions proof received from ${t._peer.peerAddress}`);return}const r=t._transactionsRequest.blockHash,n=t._transactionsRequest.header,s=t._transactionsRequest.resolve,i=t._transactionsRequest.reject;t._transactionsRequest=null;if(!e.hasProof()){Log.w(NanoConsensusAgent,`TransactionsProof request was rejected by ${t._peer.peerAddress}`);i(new Error("TransactionsProof request was rejected"));return}if(!r.equals(e.blockHash)){Log.w(NanoConsensusAgent,`Received TransactionsProof for invalid reference block from ${t._peer.peerAddress}`);i(new Error("Invalid reference block"));return}const o=e.proof;if(n.bodyHash.equals(o.root()))s(o.transactions);else{Log.w(NanoConsensusAgent,`Invalid TransactionsProof received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.INVALID_TRANSACTION_PROOF,"Invalid TransactionsProof");i(new Error("Invalid TransactionsProof"))}})()}getTransactionReceipts(e){this._peer.channel.getTransactionReceipts(e);this._requestedTransactionReceipts=!0;this._peer.channel.expectMessage(Message.Type.TRANSACTION_RECEIPTS,()=>{this._peer.channel.close(CloseType.GET_TRANSACTION_RECEIPTS_TIMEOUT,"getTransactionReceipts timeout")},NanoConsensusAgent.TRANSACTIONS_REQUEST_TIMEOUT)}_onTransactionReceipts(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){Log.d(NanoConsensusAgent,`[TRANSACTION-RECEIPTS] Received from ${t._peer.peerAddress}: ${e.transactionReceipts.length}`);if(t._requestedTransactionReceipts){t._requestedTransactionReceipts=!1;t.fire("transaction-receipts",e.transactionReceipts)}else Log.w(NanoConsensusAgent,`Unsolicited transaction receipts received from ${t._peer.peerAddress}`)})()}getFullBlock(e){return this._synchronizer.push(()=>this._getFullBlock(e))}_getFullBlock(e){Assert.that(null===this._blockRequest);Log.d(NanoConsensusAgent,`Requesting full block ${e} from ${this._peer.peerAddress}`);return new Promise((t,r)=>{this._blockRequest={hash:e,resolve:t,reject:r};const n=new InvVector(InvVector.Type.BLOCK,e);this._peer.channel.getData([n]);this._peer.channel.expectMessage([Message.Type.BLOCK,Message.Type.NOT_FOUND],()=>{r(new Error("timeout"))},BaseConsensusAgent.REQUEST_TIMEOUT)})}_onBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._blockRequest){Log.w(NanoConsensusAgent,`Unsolicited block message received from ${t._peer.peerAddress}, discarding`);return}const r=t._blockRequest.hash,n=t._blockRequest.resolve,s=t._blockRequest.reject;t._blockRequest=null;if(e.block.hash().equals(r))if(yield e.block.verify(t._time))n(e.block);else{Log.w(NanoConsensusAgent,`Invalid block received from ${t._peer.peerAddress}`);t._peer.channel.close(CloseType.INVALID_BLOCK,"Invalid block");s(new Error("Invalid block"))}else{Log.w(NanoConsensusAgent,`Unexpected block received from ${t._peer.peerAddress}, discarding`);s(new Error("Unexpected block"))}})()}_onNotFound(e){if(this._blockRequest&&1===e.vectors.length&&e.vectors[0].hash.equals(this._blockRequest.hash)){const e=this._blockRequest.reject;this._blockRequest=null;e(new Error("Block not found"))}super._onNotFound(e)}_onClose(){this._synchronizer.clear();super._onClose()}}NanoConsensusAgent.CHAINPROOF_REQUEST_TIMEOUT=45e3;NanoConsensusAgent.CHAINPROOF_CHUNK_TIMEOUT=1e4;NanoConsensusAgent.ACCOUNTSPROOF_REQUEST_TIMEOUT=5e3;NanoConsensusAgent.TRANSACTIONSPROOF_REQUEST_TIMEOUT=1e4;NanoConsensusAgent.TRANSACTIONS_REQUEST_TIMEOUT=15e3;NanoConsensusAgent.SUBSCRIPTION_CHANGE_THROTTLE=2e3;Class.register(NanoConsensusAgent);class NanoConsensus extends Observable{constructor(e,t,r){super();this._blockchain=e;this._mempool=t;this._network=r;this._agents=new HashMap;this._timers=new Timers;this._established=!1;this._syncPeer=null;this._addresses=[];r.on("peer-joined",e=>this._onPeerJoined(e));r.on("peer-left",e=>this._onPeerLeft(e));e.on("head-changed",e=>this._onHeadChanged(e))}_onPeerJoined(e){const t=new NanoConsensusAgent(this._blockchain,this._mempool,this._network.time,e);this._agents.put(e.id,t);t.on("close",()=>this._onPeerLeft(t.peer));t.on("sync",()=>this._onPeerSynced(t.peer));this.bubble(t,"sync-chain-proof","verify-chain-proof");t.subscribeAccounts(this._addresses);this._timers.resetTimeout("sync",this._syncBlockchain.bind(this),NanoConsensus.SYNC_THROTTLE)}_onPeerLeft(e){if(e.equals(this._syncPeer)){Log.w(NanoConsensus,`Peer ${e.peerAddress} left during sync`);this._syncPeer=null;this.fire("sync-failed",e.peerAddress)}this._agents.remove(e.id);this._syncBlockchain()}_syncBlockchain(){if(this._syncPeer)return;const e=this._agents.values().filter(e=>!e.synced),t=ArrayUtils.randomElement(e);if(t){this._syncPeer=t.peer;this._established||this.fire("syncing",t.peer.peerAddress,e.length-1);Log.v(NanoConsensus,`Syncing blockchain with peer ${t.peer.peerAddress}`);t.syncBlockchain()["catch"](Log.w.tag(NanoConsensusAgent))}else if(this._agents.length>0){if(!this._established){Log.i(NanoConsensus,`Synced with all connected peers (${this._agents.length}), consensus established.`);Log.d(NanoConsensus,`Blockchain: height=${this._blockchain.height}, headHash=${this._blockchain.headHash}`);this._established=!0;this.fire("established")}}else{this._established=!1;this.fire("lost")}}_onPeerSynced(e){if(e.equals(this._syncPeer)){Log.v(NanoConsensus,`Finished sync with peer ${e.peerAddress}`);this._syncPeer=null;this.fire("sync-finished",e.peerAddress)}this._syncBlockchain()}_onHeadChanged(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._established)return;for(const n of t._agents.values())n.relayBlock(e);const r=yield t.getTransactionsProof(t._addresses,e.hash());t._mempool.changeHead(e,r)})()}getAccount(e,t=null){var r=this;return(0,_asyncToGenerator3["default"])(function*(){return(yield r.getAccounts([e],t))[0]})()}getAccounts(e,t=null){var r=this;return(0,_asyncToGenerator3["default"])(function*(){t=t||r._blockchain.headHash;const n=r._agents.values().filter(function(e){return e.synced&&e.knowsBlock(t)&&!Services.isNanoNode(e.peer.peerAddress.services)});for(const r of n)try{return yield r.getAccounts(t,e)}catch(s){Log.w(NanoConsensus,`Failed to retrieve accounts ${e} from ${r.peer.peerAddress}: ${s}`)}throw new Error(`Failed to retrieve accounts ${e}`)})()}subscribeAccounts(e){this._addresses=e;for(const t of this._agents.values())t.subscribeAccounts(this._addresses)}getTransactionsProof(e,t=null){var r=this;return(0,_asyncToGenerator3["default"])(function*(){t=t||r._blockchain.headHash;const n=r._agents.values().filter(function(e){return e.synced&&e.knowsBlock(t)&&!Services.isNanoNode(e.peer.peerAddress.services)});for(const r of n)try{return yield r.getTransactionsProof(t,e)}catch(s){Log.w(NanoConsensus,`Failed to retrieve transactions for ${e} from ${r.peer.peerAddress}: ${s}`)}throw new Error(`Failed to retrieve transactions for ${e}`)})()}relayTransaction(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(!t._agents.values().some(function(e){return!Services.isNanoNode(e.peer.peerAddress.services)}))throw new Error("Failed to relay transaction - only nano nodes connected");if(!(yield t._mempool.pushTransaction(e)))throw new Error("Failed to relay transaction - mempool rejected transaction");let r=!1;for(const n of t._agents.values())r=n.relayTransaction(e)||r;if(!r)throw new Error("Failed to relay transaction - no agent relayed transaction")})()}getFullBlock(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=t._agents.values().filter(function(e){return e.synced&&!Services.isNanoNode(e.peer.peerAddress.services)});for(const t of r)try{return yield t.getFullBlock(e)}catch(n){Log.w(NanoConsensus,`Failed to retrieve full block ${e} from ${t.peer.peerAddress}: ${n}`)}throw new Error(`Failed to retrieve block ${e}`)})()}get established(){return this._established}get blockchain(){return this._blockchain}get mempool(){return this._mempool}get network(){return this._network}}NanoConsensus.SYNC_THROTTLE=1e3;Class.register(NanoConsensus);class NanoMempool extends Observable{constructor(e){super();this._blockchain=e;this._transactionsByHash=new HashMap;this._transactionSetByAddress=new HashMap}pushTransaction(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.hash();if(t._transactionsByHash.contains(r)){Log.v(Mempool,function(){return`Ignoring known transaction ${r.toBase64()}`});return!1}if(t._blockchain.height>=e.validityStartHeight+Policy.TRANSACTION_VALIDITY_WINDOW){Log.v(Mempool,function(){return`Ignoring expired transaction ${r.toBase64()}`});return!1}if(!e.verify())return!1;t._transactionsByHash.put(r,e);const n=t._transactionSetByAddress.get(e.sender)||new MempoolTransactionSet;n.add(e);t._transactionSetByAddress.put(e.sender,n);t.fire("transaction-added",e);return!0})()}getTransaction(e){return this._transactionsByHash.get(e)}getTransactions(e=5e3){return this._transactionsByHash.values().sort((e,t)=>e.compare(t)).slice(0,e)}getPendingTransactions(e){const t=this._transactionSetByAddress.get(e);return t?t.transactions:[]}changeHead(e,t){this._evictTransactions(e.height,t)}_evictTransactions(e,t){for(const r of this._transactionsByHash.values()){const t=r.hash();if(e>=r.validityStartHeight+Policy.TRANSACTION_VALIDITY_WINDOW){this._transactionsByHash.remove(t);const e=this._transactionSetByAddress.get(r.sender);e.remove(r);0===e.length&&this._transactionSetByAddress.remove(r.sender);this.fire("transaction-expired",r)}}for(const r of t){const e=r.hash();if(this._transactionsByHash.contains(e)){this._transactionsByHash.remove(e);const t=this._transactionSetByAddress.get(r.sender);t.remove(r);0===t.length&&this._transactionSetByAddress.remove(r.sender);this.fire("transaction-mined",r)}}}}Class.register(NanoMempool);class ConsensusDB extends JDB.JungleDB{static getFull(){return(0,_asyncToGenerator3["default"])(function*(){ConsensusDB._instance||(ConsensusDB._instance=yield new ConsensusDB("full-consensus"));return ConsensusDB._instance})()}static getLight(){return(0,_asyncToGenerator3["default"])(function*(){ConsensusDB._instance||(ConsensusDB._instance=yield new ConsensusDB("light-consensus"));return ConsensusDB._instance})()}constructor(e){super(e,ConsensusDB.VERSION);return this._init()}_init(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){AccountsTreeStore.initPersistent(e);ChainDataStore.initPersistent(e);TransactionStore.initPersistent(e);yield e.connect();return e})()}}ConsensusDB._instance=null;ConsensusDB.VERSION=3;Class.register(ConsensusDB);Class.register(class Consensus{static full(e=NetworkConfig.getDefault()){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();e.services=new Services(Services.FULL,Services.FULL);yield e.initPersistent();const t=new Time,r=yield ConsensusDB.getFull(),n=yield Accounts.getPersistent(r),s=yield TransactionStore.getPersistent(r),i=yield FullChain.getPersistent(r,n,t,s),o=new Mempool(i,n),a=new Network(i,e,t);return new FullConsensus(i,o,a)})()}static light(e=NetworkConfig.getDefault()){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();e.services=new Services(Services.LIGHT,Services.LIGHT|Services.FULL);yield e.initPersistent();const t=new Time,r=yield ConsensusDB.getLight(),n=yield Accounts.getPersistent(r),s=yield LightChain.getPersistent(r,n,t),i=new Mempool(s,n),o=new Network(s,e,t);return new LightConsensus(s,i,o)})()}static nano(e=NetworkConfig.getDefault()){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();e.services=new Services(Services.NANO,Services.NANO|Services.LIGHT|Services.FULL);yield e.initPersistent();const t=new Time,r=yield new NanoChain(t),n=new NanoMempool(r),s=new Network(r,e,t);return new NanoConsensus(r,n,s)})()}static volatileFull(e=NetworkConfig.getDefault()){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();e.services=new Services(Services.FULL,Services.FULL);yield e.initVolatile();const t=new Time,r=yield Accounts.createVolatile(),n=yield TransactionStore.createVolatile(),s=yield FullChain.createVolatile(r,t,n),i=new Mempool(s,r),o=new Network(s,e,t);return new FullConsensus(s,i,o)})()}static volatileLight(e=NetworkConfig.getDefault()){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();e.services=new Services(Services.LIGHT,Services.LIGHT|Services.FULL);yield e.initVolatile();const t=new Time,r=yield Accounts.createVolatile(),n=yield LightChain.createVolatile(r,t),s=new Mempool(n,r),i=new Network(n,e,t);return new LightConsensus(n,s,i)})()}static volatileNano(e=NetworkConfig.getDefault()){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();e.services=new Services(Services.NANO,Services.NANO|Services.LIGHT|Services.FULL);yield e.initVolatile();const t=new Time,r=yield new NanoChain(t),n=new NanoMempool(r),s=new Network(r,e,t);return new NanoConsensus(r,n,s)})()}});Block.GENESIS=new Block(new BlockHeader(new Hash(null),new Hash(null),Hash.fromBase64("giOIYTBojKQPmBLq5msCgObOL3KnQ9CKrIGb5HWz7E8="),Hash.fromBase64("xexmOOk+2oLBIhwkCD+caw2FsifB0U6tXlles8Tycts="),BlockUtils.difficultyToCompact(1),1,0,104295,BlockHeader.Version.V1),new BlockInterlink([],new Hash(null)),new BlockBody(Address.fromBase64("AAAAAAAAAAAAAAAAAAAAAAAAAAA="),[]));Block.GENESIS.HASH=Hash.fromBase64("ykmTb222PK189z6x6dpT3Ul607cGjzFzECR4WXO+m+Y=");Accounts.GENESIS="AAIP7R94Gl77Xrk4xvszHLBXdCzC9AAAAHKYqT3gAAh2jadJcsL852C50iDDRIdlFjsNAAAAcpipPeAA";class Protocol{}Protocol.DUMB=0;Protocol.WS=1;Protocol.RTC=2;Class.register(Protocol);class Message{constructor(e){if(!NumberUtils.isUint64(e))throw new Error("Malformed type");this._type=e}static peekType(e){const t=e.readPos;e.readPos=4;const r=e.readVarUint();e.readPos=t;return r}static peekLength(e){const t=e.readPos;e.readPos=4;e.readVarUint();const r=e.readUint32();e.readPos=t;return r}static unserialize(e){Assert.that(0===e.readPos,"Message.unserialize() requires buf.readPos == 0");const t=e.readUint32(),r=e.readVarUint();e.readUint32();const n=e.readUint32();if(t!==Message.MAGIC)throw"Malformed magic";Message._writeChecksum(r,e,0);if(n!==CRC32.compute(e))throw new Error("Invalid checksum");return new Message(r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);Assert.that(0===e.writePos,"Message.serialize() requires buf.writePos == 0");e.writeUint32(Message.MAGIC);e.writeVarUint(this._type);e.writeUint32(this.serializedSize);e.writeUint32(0);return e}get serializedSize(){return 4+SerialBuffer.varUintSize(this._type)+4+4}_setChecksum(e){const t=CRC32.compute(e);Message._writeChecksum(this._type,e,t)}static _writeChecksum(e,t,r){const n=t.writePos;t.writePos=4+SerialBuffer.varUintSize(e)+4;t.writeUint32(r);t.writePos=n}get type(){return this._type}}Message.MAGIC=1107566658;Message.Type={VERSION:0,INV:1,GET_DATA:2,GET_HEADER:3,NOT_FOUND:4,GET_BLOCKS:5,BLOCK:6,HEADER:7,TX:8,MEMPOOL:9,REJECT:10,SUBSCRIBE:11,ADDR:20,GET_ADDR:21,PING:22,PONG:23,SIGNAL:30,GET_CHAIN_PROOF:40,CHAIN_PROOF:41,GET_ACCOUNTS_PROOF:42,ACCOUNTS_PROOF:43,GET_ACCOUNTS_TREE_CHUNK:44,ACCOUNTS_TREE_CHUNK:45,GET_TRANSACTIONS_PROOF:47,TRANSACTIONS_PROOF:48,GET_TRANSACTION_RECEIPTS:49,TRANSACTION_RECEIPTS:50,VERACK:90};Class.register(Message);class AddrMessage extends Message{constructor(e){super(Message.Type.ADDR);if(!e||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof PeerAddress)))throw"Malformed addresses";this._addresses=e}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let n=0;n<t;++n)r.push(PeerAddress.unserialize(e));return new AddrMessage(r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint16(this._addresses.length);for(const t of this._addresses)t.serialize(e);super._setChecksum(e);return e}get serializedSize(){let e=super.serializedSize+2;for(const t of this._addresses)e+=t.serializedSize;return e}get addresses(){return this._addresses}}Class.register(AddrMessage);class BlockMessage extends Message{constructor(e){super(Message.Type.BLOCK);this._block=e}static unserialize(e){Message.unserialize(e);const t=Block.unserialize(e);return new BlockMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._block.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._block.serializedSize}get block(){return this._block}}Class.register(BlockMessage);class GetAddrMessage extends Message{constructor(e,t){super(Message.Type.GET_ADDR);if(!NumberUtils.isUint8(e))throw"Malformed protocolMask";if(!NumberUtils.isUint32(t))throw"Malformed serviceMask";this._protocolMask=e;this._serviceMask=t}static unserialize(e){Message.unserialize(e);const t=e.readUint8(),r=e.readUint32();return new GetAddrMessage(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint8(this._protocolMask);e.writeUint32(this._serviceMask);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+1+4}get protocolMask(){return this._protocolMask}get serviceMask(){return this._serviceMask}}Class.register(GetAddrMessage);class GetBlocksMessage extends Message{constructor(e,t=BaseInventoryMessage.VECTORS_MAX_COUNT,r=GetBlocksMessage.Direction.FORWARD){super(Message.Type.GET_BLOCKS);if(!e||!NumberUtils.isUint16(e.length)||e.some(e=>!Hash.isHash(e)))throw"Malformed locators";if(!NumberUtils.isUint16(t))throw"Malformed maxInvSize";if(!NumberUtils.isUint8(r))throw"Malformed direction";this._locators=e;this._maxInvSize=t;this._direction=r}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let i=0;i<t;i++)r.push(Hash.unserialize(e));const n=e.readUint16(),s=e.readUint8();return new GetBlocksMessage(r,n,s)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint16(this._locators.length);for(const t of this._locators)t.serialize(e);e.writeUint16(this._maxInvSize);e.writeUint8(this._direction);super._setChecksum(e);return e}get serializedSize(){let e=super.serializedSize+2+1+2;for(const t of this._locators)e+=t.serializedSize;return e}get locators(){return this._locators}get direction(){return this._direction}get maxInvSize(){return this._maxInvSize}}GetBlocksMessage.Direction={FORWARD:1,BACKWARD:2};Class.register(GetBlocksMessage);class HeaderMessage extends Message{constructor(e){super(Message.Type.HEADER);this._header=e}static unserialize(e){Message.unserialize(e);const t=BlockHeader.unserialize(e);return new HeaderMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._header.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._header.serializedSize}get header(){return this._header}}Class.register(HeaderMessage);class InvVector{static fromBlock(e){const t=e.hash();return new InvVector(InvVector.Type.BLOCK,t)}static fromHeader(e){const t=e.hash();return new InvVector(InvVector.Type.BLOCK,t)}static fromTransaction(e){const t=e.hash();return new InvVector(InvVector.Type.TRANSACTION,t)}constructor(e,t){if(!Hash.isHash(t))throw"Malformed hash";this._type=e;this._hash=t}static unserialize(e){const t=InvVector.Type.unserialize(e),r=Hash.unserialize(e);return new InvVector(t,r)}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeUint32(this._type);this._hash.serialize(e);return e}equals(e){return e instanceof InvVector&&this._type===e.type&&this._hash.equals(e.hash)}hashCode(){return`${this._type}|${this._hash}`}toString(){return`InvVector{type=${this._type}, hash=${this._hash}}`}get serializedSize(){return 4+this._hash.serializedSize}get type(){return this._type}get hash(){return this._hash}}InvVector.Type={ERROR:0,TRANSACTION:1,BLOCK:2,unserialize:function(e){return e.readUint32()}};Class.register(InvVector);class BaseInventoryMessage extends Message{constructor(e,t){super(e);if(!t||!NumberUtils.isUint16(t.length)||t.some(e=>!(e instanceof InvVector))||t.length>BaseInventoryMessage.VECTORS_MAX_COUNT)throw"Malformed vectors";this._vectors=t}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint16(this._vectors.length);for(const t of this._vectors)t.serialize(e);super._setChecksum(e);return e}get serializedSize(){let e=super.serializedSize+2;for(const t of this._vectors)e+=t.serializedSize;return e}get vectors(){return this._vectors}}BaseInventoryMessage.VECTORS_MAX_COUNT=1e3;Class.register(BaseInventoryMessage);class InvMessage extends BaseInventoryMessage{constructor(e){super(Message.Type.INV,e)}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let n=0;n<t;++n)r.push(InvVector.unserialize(e));return new InvMessage(r)}}Class.register(InvMessage);class GetDataMessage extends BaseInventoryMessage{constructor(e){super(Message.Type.GET_DATA,e)}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let n=0;n<t;++n)r.push(InvVector.unserialize(e));return new GetDataMessage(r)}}Class.register(GetDataMessage);class GetHeaderMessage extends BaseInventoryMessage{constructor(e){super(Message.Type.GET_HEADER,e)}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let n=0;n<t;++n)r.push(InvVector.unserialize(e));return new GetHeaderMessage(r)}}Class.register(GetHeaderMessage);class NotFoundMessage extends BaseInventoryMessage{constructor(e){super(Message.Type.NOT_FOUND,e)}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let n=0;n<t;++n)r.push(InvVector.unserialize(e));return new NotFoundMessage(r)}}Class.register(NotFoundMessage);class MempoolMessage extends Message{constructor(){super(Message.Type.MEMPOOL)}static unserialize(e){Message.unserialize(e);return new MempoolMessage}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize}}Class.register(MempoolMessage);class PingMessage extends Message{constructor(e){super(Message.Type.PING);if(!NumberUtils.isUint32(e))throw"Malformed nonce";this._nonce=e}static unserialize(e){Message.unserialize(e);const t=e.readUint32();return new PingMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint32(this._nonce);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+4}get nonce(){return this._nonce}}Class.register(PingMessage);class PongMessage extends Message{constructor(e){super(Message.Type.PONG);if(!NumberUtils.isUint32(e))throw"Malformed nonce";this._nonce=e}static unserialize(e){Message.unserialize(e);const t=e.readUint32();return new PongMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint32(this._nonce);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+4}get nonce(){return this._nonce}}Class.register(PongMessage);class RejectMessage extends Message{constructor(e,t,r,n=new Uint8Array(0)){super(Message.Type.REJECT);if(!NumberUtils.isUint64(e))throw new Error("Malformed type");if(!NumberUtils.isUint8(t))throw new Error("Malformed code");if(StringUtils.isMultibyte(r)||r.length>255)throw new Error("Malformed reason");if(!(n instanceof Uint8Array&&NumberUtils.isUint16(n.byteLength)))throw new Error("Malformed extraData");this._messageType=e;this._code=t;this._reason=r;this._extraData=n}static unserialize(e){Message.unserialize(e);const t=e.readVarUint(),r=e.readUint8(),n=e.readVarLengthString(),s=e.readUint16(),i=e.read(s);return new RejectMessage(t,r,n,i)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeVarUint(this._messageType);e.writeUint8(this._code);e.writeVarLengthString(this._reason);e.writeUint16(this._extraData.byteLength);e.write(this._extraData);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+SerialBuffer.varUintSize(this._messageType)+1+SerialBuffer.varLengthStringSize(this._reason)+2+this._extraData.byteLength}get messageType(){return this._messageType}get code(){return this._code}get reason(){return this._reason}get extraData(){return this._extraData}}RejectMessage.Code={REJECT_MALFORMED:1,REJECT_INVALID:16,REJECT_OBSOLETE:17,REJECT_DOUBLE:18,REJECT_DUST:65,REJECT_INSUFFICIENT_FEE:66};Class.register(RejectMessage);class SignalMessage extends Message{constructor(e,t,r,n,s=0,i=new Uint8Array(0),o,a){super(Message.Type.SIGNAL);if(!(e instanceof PeerId))throw"Malformed senderId";if(!(t instanceof PeerId))throw"Malformed recipientId";if(!NumberUtils.isUint32(r))throw"Malformed nonce";if(!NumberUtils.isUint8(n))throw"Malformed ttl";if(!NumberUtils.isUint8(s))throw"Malformed flags";if(!(i instanceof Uint8Array&&NumberUtils.isUint16(i.byteLength)))throw"Malformed payload";const c=i.byteLength>0;if(c&&!(a instanceof Signature))throw"Malformed signature";if(c&&!(o instanceof PublicKey))throw"Malformed public key";this._senderId=e;this._recipientId=t;this._nonce=r;this._ttl=n;this._flags=s;this._payload=i;this._senderPubKey=c?o:undefined;this._signature=c?a:undefined}static unserialize(e){Message.unserialize(e);const t=PeerId.unserialize(e),r=PeerId.unserialize(e),n=e.readUint32(),s=e.readUint8(),i=e.readUint8(),o=e.readUint16(),a=e.read(o),c=o>0?PublicKey.unserialize(e):undefined,l=o>0?Signature.unserialize(e):undefined;return new SignalMessage(t,r,n,s,i,a,c,l)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._senderId.serialize(e);this._recipientId.serialize(e);e.writeUint32(this._nonce);e.writeUint8(this._ttl);e.writeUint8(this._flags);e.writeUint16(this._payload.byteLength);e.write(this._payload);if(this._payload.byteLength>0){this._senderPubKey.serialize(e);this._signature.serialize(e)}super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._senderId.serializedSize+this._recipientId.serializedSize+4+1+1+2+this._payload.byteLength+(this._payload.byteLength>0?this._senderPubKey.serializedSize:0)+(this._payload.byteLength>0?this._signature.serializedSize:0)}verifySignature(){return!!this._signature&&(this._signature.verify(this._senderPubKey,this._payload)&&this._senderId.equals(this._senderPubKey.toPeerId()))}get senderId(){return this._senderId}get recipientId(){return this._recipientId}get nonce(){return this._nonce}get ttl(){return this._ttl}get flags(){return this._flags}get payload(){return this._payload}get signature(){return this._signature}get senderPubKey(){return this._senderPubKey}hasPayload(){return this._payload.byteLength>0}isUnroutable(){return 0!=(this._flags&SignalMessage.Flag.UNROUTABLE)}isTtlExceeded(){return 0!=(this._flags&SignalMessage.Flag.TTL_EXCEEDED)}}SignalMessage.Flag={UNROUTABLE:1,TTL_EXCEEDED:2};Class.register(SignalMessage);class SubscribeMessage extends Message{constructor(e){super(Message.Type.SUBSCRIBE);this._subscription=e}static unserialize(e){Message.unserialize(e);const t=Subscription.unserialize(e);return new SubscribeMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._subscription.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._subscription.serializedSize}get subscription(){return this._subscription}}Class.register(SubscribeMessage);class TxMessage extends Message{constructor(e,t){super(Message.Type.TX);this._transaction=e;this._accountsProof=t}static unserialize(e){Message.unserialize(e);const t=Transaction.unserialize(e);if(1===e.readUint8()){const r=AccountsProof.unserialize(e);return new TxMessage(t,r)}return new TxMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._transaction.serialize(e);e.writeUint8(this._accountsProof?1:0);this._accountsProof&&this._accountsProof.serialize(e);super._setChecksum(e);return e}get serializedSize(){let e=super.serializedSize+this._transaction.serializedSize+1;this._accountsProof&&(e+=this._accountsProof.serializedSize);return e}get transaction(){return this._transaction}get hasAccountsProof(){return!!this._accountsProof}get accountsProof(){return this._accountsProof}}Class.register(TxMessage);class VersionMessage extends Message{constructor(e,t,r,n,s){super(Message.Type.VERSION);if(!NumberUtils.isUint32(e))throw new Error("Malformed version");if(!(t instanceof PeerAddress))throw new Error("Malformed peerAddress");if(!Hash.isHash(r))throw new Error("Malformed genesisHash");if(!Hash.isHash(n))throw new Error("Malformed headHash");if(!(s instanceof Uint8Array)||32!==s.byteLength)throw new Error("Malformed challenge nonce");this._version=e;this._peerAddress=t;this._genesisHash=r;this._headHash=n;this._challengeNonce=s}static unserialize(e){Message.unserialize(e);const t=e.readUint32(),r=PeerAddress.unserialize(e),n=Hash.unserialize(e),s=Hash.unserialize(e),i=e.read(VersionMessage.CHALLENGE_SIZE);return new VersionMessage(t,r,n,s,i)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint32(this._version);this._peerAddress.serialize(e);this._genesisHash.serialize(e);this._headHash.serialize(e);e.write(this._challengeNonce);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+4+this._peerAddress.serializedSize+this._genesisHash.serializedSize+this._headHash.serializedSize+VersionMessage.CHALLENGE_SIZE}get version(){return this._version}get peerAddress(){return this._peerAddress}get genesisHash(){return this._genesisHash}get headHash(){return this._headHash}get challengeNonce(){return this._challengeNonce}}VersionMessage.CHALLENGE_SIZE=32;Class.register(VersionMessage);class VerAckMessage extends Message{constructor(e,t){super(Message.Type.VERACK);this._publicKey=e;this._signature=t}static unserialize(e){Message.unserialize(e);const t=PublicKey.unserialize(e),r=Signature.unserialize(e);return new VerAckMessage(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this.publicKey.serialize(e);this.signature.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._publicKey.serializedSize+this._signature.serializedSize}get publicKey(){return this._publicKey}get signature(){return this._signature}}Class.register(VerAckMessage);class AccountsProofMessage extends Message{constructor(e,t=null){super(Message.Type.ACCOUNTS_PROOF);if(!(e instanceof Hash))throw new Error("Malformed blockHash");if(t&&!(t instanceof AccountsProof))throw new Error("Malformed proof");this._blockHash=e;this._accountsProof=t}static unserialize(e){Message.unserialize(e);const t=Hash.unserialize(e);let r=null;0!==e.readUint8()&&(r=AccountsProof.unserialize(e));return new AccountsProofMessage(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._blockHash.serialize(e);e.writeUint8(this.hasProof()?1:0);this.hasProof()&&this._accountsProof.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+1+this._blockHash.serializedSize+(this.hasProof()?this._accountsProof.serializedSize:0)}hasProof(){return!!this._accountsProof}get blockHash(){return this._blockHash}get proof(){return this._accountsProof}}Class.register(AccountsProofMessage);class GetAccountsProofMessage extends Message{constructor(e,t){super(Message.Type.GET_ACCOUNTS_PROOF);if(!(e&&e instanceof Hash))throw new Error("Malformed block hash");if(!t||!NumberUtils.isUint16(t.length)||t.length<1||t.some(e=>!(e instanceof Address)))throw new Error("Malformed addresses");this._blockHash=e;this._addresses=t}static unserialize(e){Message.unserialize(e);const t=Hash.unserialize(e),r=e.readUint16(),n=[];for(let s=0;s<r;s++)n.push(Address.unserialize(e));return new GetAccountsProofMessage(t,n)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._blockHash.serialize(e);e.writeUint16(this._addresses.length);for(const t of this._addresses)t.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._blockHash.serializedSize+2+this._addresses.reduce((e,t)=>e+t.serializedSize,0)}get addresses(){return this._addresses}get blockHash(){return this._blockHash}}Class.register(GetAccountsProofMessage);class ChainProofMessage extends Message{constructor(e){super(Message.Type.CHAIN_PROOF);if(!(e instanceof ChainProof))throw"Malformed chainProof";this._proof=e}static unserialize(e){Message.unserialize(e);const t=ChainProof.unserialize(e);return new ChainProofMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._proof.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._proof.serializedSize}get proof(){return this._proof}}Class.register(ChainProofMessage);class GetChainProofMessage extends Message{constructor(){super(Message.Type.GET_CHAIN_PROOF)}static unserialize(e){Message.unserialize(e);return new GetChainProofMessage}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize}}Class.register(GetChainProofMessage);class AccountsTreeChunkMessage extends Message{constructor(e,t=null){super(Message.Type.ACCOUNTS_TREE_CHUNK);if(!(e instanceof Hash))throw"Malformed blockHash";if(t&&!(t instanceof AccountsTreeChunk))throw"Malformed chunk";this._blockHash=e;this._accountsTreeChunk=t}static unserialize(e){Message.unserialize(e);const t=Hash.unserialize(e);let r=null;0!==e.readUint8()&&(r=AccountsTreeChunk.unserialize(e));return new AccountsTreeChunkMessage(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._blockHash.serialize(e);e.writeUint8(this.hasChunk()?1:0);this.hasChunk()&&this._accountsTreeChunk.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+1+this._blockHash.serializedSize+(this.hasChunk()?this._accountsTreeChunk.serializedSize:0)}hasChunk(){return!!this._accountsTreeChunk}get blockHash(){return this._blockHash}get chunk(){return this._accountsTreeChunk}}Class.register(AccountsTreeChunkMessage);class GetAccountsTreeChunkMessage extends Message{constructor(e,t){super(Message.Type.GET_ACCOUNTS_TREE_CHUNK);if(!(e&&e instanceof Hash))throw"Malformed block hash";if(StringUtils.isMultibyte(t)||!NumberUtils.isUint8(t.length))throw"Malformed start prefix";this._blockHash=e;this._startPrefix=t}static unserialize(e){Message.unserialize(e);const t=Hash.unserialize(e),r=e.readVarLengthString();return new GetAccountsTreeChunkMessage(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._blockHash.serialize(e);e.writeVarLengthString(this._startPrefix);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._blockHash.serializedSize+SerialBuffer.varLengthStringSize(this._startPrefix)}get blockHash(){return this._blockHash}get startPrefix(){return this._startPrefix}}Class.register(GetAccountsTreeChunkMessage);class TransactionsProofMessage extends Message{constructor(e,t=null){super(Message.Type.TRANSACTIONS_PROOF);if(!(e instanceof Hash))throw new Error("Malformed blockHash");if(t&&!(t instanceof TransactionsProof))throw new Error("Malformed proof");this._blockHash=e;this._proof=t}static unserialize(e){Message.unserialize(e);const t=Hash.unserialize(e);let r=null;0!==e.readUint8()&&(r=TransactionsProof.unserialize(e));return new TransactionsProofMessage(t,r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._blockHash.serialize(e);e.writeUint8(this.hasProof()?1:0);this.hasProof()&&this._proof.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+1+this._blockHash.serializedSize+(this.hasProof()?this._proof.serializedSize:0)}hasProof(){return!!this._proof}get blockHash(){return this._blockHash}get proof(){return this._proof}}Class.register(TransactionsProofMessage);class GetTransactionsProofMessage extends Message{constructor(e,t){super(Message.Type.GET_TRANSACTIONS_PROOF);if(!(e&&e instanceof Hash))throw new Error("Malformed block hash");if(!t||!NumberUtils.isUint16(t.length)||t.some(e=>!(e instanceof Address)))throw new Error("Malformed addresses");this._blockHash=e;this._addresses=t}static unserialize(e){Message.unserialize(e);const t=Hash.unserialize(e),r=e.readUint16(),n=[];for(let s=0;s<r;s++)n.push(Address.unserialize(e));return new GetTransactionsProofMessage(t,n)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._blockHash.serialize(e);e.writeUint16(this._addresses.length);for(const t of this._addresses)t.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._blockHash.serializedSize+2+this._addresses.reduce((e,t)=>e+t.serializedSize,0)}get addresses(){return this._addresses}get blockHash(){return this._blockHash}}Class.register(GetTransactionsProofMessage);class GetTransactionReceiptsMessage extends Message{constructor(e){super(Message.Type.GET_TRANSACTION_RECEIPTS);if(!(e instanceof Address))throw new Error("Malformed address");this._address=e}static unserialize(e){Message.unserialize(e);const t=Address.unserialize(e);return new GetTransactionReceiptsMessage(t)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);this._address.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+this._address.serializedSize}get address(){return this._address}}Class.register(GetTransactionReceiptsMessage);class TransactionReceiptsMessage extends Message{constructor(e){super(Message.Type.TRANSACTION_RECEIPTS);if(!e||!NumberUtils.isUint16(e.length)||e.some(e=>!(e instanceof TransactionReceipt))||e.length>TransactionReceiptsMessage.RECEIPTS_MAX_COUNT)throw new Error("Malformed transactionReceipts");this._transactionReceipts=e}static unserialize(e){Message.unserialize(e);const t=e.readUint16(),r=[];for(let n=0;n<t;++n)r.push(TransactionReceipt.unserialize(e));return new TransactionReceiptsMessage(r)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeUint16(this._transactionReceipts.length);for(const t of this._transactionReceipts)t.serialize(e);super._setChecksum(e);return e}get serializedSize(){return super.serializedSize+2+this._transactionReceipts.reduce((e,t)=>e+t.serializedSize,0)}get transactionReceipts(){return this._transactionReceipts}}Class.register(TransactionReceiptsMessage);TransactionReceiptsMessage.RECEIPTS_MAX_COUNT=500;class MessageFactory{static peekType(e){return Message.peekType(e)}static parse(e){const t=Message.peekType(e),r=MessageFactory.CLASSES[t];if(!r||!r.unserialize)throw new Error(`Invalid message type: ${t}`);return r.unserialize(e)}}MessageFactory.CLASSES={};MessageFactory.CLASSES[Message.Type.VERSION]=VersionMessage;MessageFactory.CLASSES[Message.Type.INV]=InvMessage;MessageFactory.CLASSES[Message.Type.GET_DATA]=GetDataMessage;MessageFactory.CLASSES[Message.Type.GET_HEADER]=GetHeaderMessage;MessageFactory.CLASSES[Message.Type.NOT_FOUND]=NotFoundMessage;MessageFactory.CLASSES[Message.Type.BLOCK]=BlockMessage;MessageFactory.CLASSES[Message.Type.HEADER]=HeaderMessage;MessageFactory.CLASSES[Message.Type.TX]=TxMessage;MessageFactory.CLASSES[Message.Type.GET_BLOCKS]=GetBlocksMessage;MessageFactory.CLASSES[Message.Type.MEMPOOL]=MempoolMessage;MessageFactory.CLASSES[Message.Type.REJECT]=RejectMessage;MessageFactory.CLASSES[Message.Type.SUBSCRIBE]=SubscribeMessage;MessageFactory.CLASSES[Message.Type.ADDR]=AddrMessage;MessageFactory.CLASSES[Message.Type.GET_ADDR]=GetAddrMessage;MessageFactory.CLASSES[Message.Type.PING]=PingMessage;MessageFactory.CLASSES[Message.Type.PONG]=PongMessage;MessageFactory.CLASSES[Message.Type.SIGNAL]=SignalMessage;MessageFactory.CLASSES[Message.Type.GET_CHAIN_PROOF]=GetChainProofMessage;MessageFactory.CLASSES[Message.Type.CHAIN_PROOF]=ChainProofMessage;MessageFactory.CLASSES[Message.Type.GET_ACCOUNTS_PROOF]=GetAccountsProofMessage;MessageFactory.CLASSES[Message.Type.ACCOUNTS_PROOF]=AccountsProofMessage;MessageFactory.CLASSES[Message.Type.GET_ACCOUNTS_TREE_CHUNK]=GetAccountsTreeChunkMessage;MessageFactory.CLASSES[Message.Type.ACCOUNTS_TREE_CHUNK]=AccountsTreeChunkMessage;MessageFactory.CLASSES[Message.Type.GET_TRANSACTIONS_PROOF]=GetTransactionsProofMessage;MessageFactory.CLASSES[Message.Type.TRANSACTIONS_PROOF]=TransactionsProofMessage;MessageFactory.CLASSES[Message.Type.GET_TRANSACTION_RECEIPTS]=GetTransactionReceiptsMessage;MessageFactory.CLASSES[Message.Type.TRANSACTION_RECEIPTS]=TransactionReceiptsMessage;MessageFactory.CLASSES[Message.Type.VERACK]=VerAckMessage;Class.register(MessageFactory);class WebRtcConnector extends Observable{constructor(e){super();this._networkConfig=e;this._connectors=new HashMap;this._timers=new Timers}connect(e,t){if(e.protocol!==Protocol.RTC)throw"Malformed peerAddress";const r=e.peerId;if(this._connectors.contains(r))return!1;const n=new OutboundPeerConnector(this._networkConfig,e,t);n.on("connection",e=>this._onConnection(e,r));this._connectors.put(r,n);this._timers.setTimeout(`connect_${r}`,()=>{this._connectors.remove(r);this._timers.clearTimeout(`connect_${r}`);this.fire("error",e,"timeout")},WebRtcConnector.CONNECT_TIMEOUT);return!0}isValidSignal(e){return this._connectors.contains(e.senderId)&&this._connectors.get(e.senderId).nonce===e.nonce}onSignal(e,t){if(t.isUnroutable()||t.isTtlExceeded()){if(this.isValidSignal(t)&&this._connectors.get(t.senderId)instanceof OutboundPeerConnector){const e=this._connectors.get(t.senderId).peerAddress;this._connectors.remove(t.senderId);this._timers.clearTimeout(`connect_${t.senderId}`);const r=t.isUnroutable()?"unroutable":"ttl exceeded";this.fire("error",e,r)}return}let r;try{r=JSON.parse(BufferUtils.toAscii(t.payload))}catch(n){Log.e(WebRtcConnector,`Failed to parse signal payload from ${t.senderId}`);return}if(r)if("offer"===r.type){let n=this._connectors.get(t.senderId);if(n){if(t.recipientId.compare(t.senderId)>0){Log.d(WebRtcConnector,`Simultaneous connection, discarding offer from ${t.senderId} (<${t.recipientId})`);return}if(n instanceof InboundPeerConnector){Log.w(WebRtcConnector,`Duplicate offer received from ${t.senderId}`);n.onSignal(r);return}Log.d(WebRtcConnector,`Simultaneous connection, accepting offer from ${t.senderId} (>${t.recipientId})`);this._timers.clearTimeout(`connect_${t.senderId}`);this.fire("error",n.peerAddress,"simultaneous inbound connection")}(n=new InboundPeerConnector(this._networkConfig,e,t.senderId,r)).on("connection",e=>this._onConnection(e,t.senderId));this._connectors.put(t.senderId,n);this._timers.setTimeout(`connect_${t.senderId}`,()=>{this._timers.clearTimeout(`connect_${t.senderId}`);this._connectors.remove(t.senderId)},WebRtcConnector.CONNECT_TIMEOUT)}else this._connectors.contains(t.senderId)&&this._connectors.get(t.senderId).onSignal(r);else Log.d(WebRtcConnector,`Discarding signal from ${t.senderId} - empty payload`)}_onConnection(e,t){this._timers.clearTimeout(`connect_${t}`);e.on("close",()=>this._onClose(t));this.fire("connection",e)}_onClose(e){this._connectors.remove(e);this._timers.clearTimeout(`connect_${e}`)}}WebRtcConnector.CONNECT_TIMEOUT=5e3;Class.register(WebRtcConnector);class PeerConnector extends Observable{constructor(e,t,r,n){super();this._networkConfig=e;this._signalChannel=t;this._peerId=r;this._peerAddress=n;this._nonce=NumberUtils.randomUint32();this._rtcConnection=WebRtcFactory.newPeerConnection(this._networkConfig.rtcConfig);this._rtcConnection.onicecandidate=(e=>this._onIceCandidate(e));this._lastIceCandidate=null;this._iceCandidateQueue=[]}onSignal(e){e.sdp?this._rtcConnection.setRemoteDescription(WebRtcFactory.newSessionDescription(e)).then(()=>{"offer"===e.type&&this._rtcConnection.createAnswer().then(e=>this._onDescription(e))["catch"](Log.e.tag(PeerConnector));this._handleCandidateQueue()["catch"](Log.w.tag(PeerConnector))})["catch"](Log.e.tag(PeerConnector)):e.candidate&&this._addIceCandidate(e)["catch"](Log.w.tag(PeerConnector))}_addIceCandidate(e){this._lastIceCandidate=WebRtcFactory.newIceCandidate(e);if(!this._rtcConnection.remoteDescription||!this._rtcConnection.remoteDescription.type){this._iceCandidateQueue.push(e);return Promise.resolve()}return this._rtcConnection.addIceCandidate(this._lastIceCandidate)["catch"](Log.e.tag(PeerConnector))}_handleCandidateQueue(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){for(const t of e._iceCandidateQueue)yield e._addIceCandidate(t);e._iceCandidateQueue=[]})()}_signal(e){const t=BufferUtils.fromAscii(JSON.stringify(e)),r=this._networkConfig.keyPair,n=this._networkConfig.peerId;this._signalChannel.signal(n,this._peerId,this._nonce,Network.SIGNAL_TTL_INITIAL,0,t,r.publicKey,Signature.create(r.privateKey,r.publicKey,t))}_onIceCandidate(e){null!==e.candidate&&this._signal(e.candidate)}_onDescription(e){this._rtcConnection.setLocalDescription(e).then(()=>this._signal(this._rtcConnection.localDescription))["catch"](Log.e.tag(PeerConnector))}_onDataChannel(e){const t=new WebRtcDataChannel(e.channel||e.target);let r=null;if(this._lastIceCandidate)try{r=WebRtcUtils.candidateToNetAddress(this._lastIceCandidate)}catch(s){Log.w(PeerConnector,`Failed to parse IP from ICE candidate: ${this._lastIceCandidate}`)}else Log.w(PeerConnector,"No ICE candidate seen for inbound connection");const n=new NetworkConnection(t,Protocol.RTC,r,this._peerAddress);this.fire("connection",n)}get nonce(){return this._nonce}get peerAddress(){return this._peerAddress}}Class.register(PeerConnector);class OutboundPeerConnector extends PeerConnector{constructor(e,t,r){super(e,r,t.peerId,t);this._peerAddress=t;const n=this._rtcConnection.createDataChannel("data-channel");n.binaryType="arraybuffer";n.onopen=(e=>this._onDataChannel(e));this._rtcConnection.createOffer().then(e=>this._onDescription(e))["catch"](Log.e.tag(OutboundPeerConnector))}}Class.register(OutboundPeerConnector);class InboundPeerConnector extends PeerConnector{constructor(e,t,r,n){super(e,t,r,null);this._rtcConnection.ondatachannel=(e=>{e.channel.onopen=(e=>this._onDataChannel(e))});this.onSignal(n)}}Class.register(InboundPeerConnector);class WebRtcDataChannel extends DataChannel{constructor(e){super();Assert.that(e.ordered,"WebRtc data channel not ordered");this._channel=e;this._channel.onmessage=(e=>this._onMessage(e.data||e));this._channel.onclose=(()=>this._onClose());this._channel.onerror=(e=>this.fire("error",e,this))}_onMessage(e){if(e instanceof Blob){const t=new FileReader;t.onloadend=(()=>super._onMessage(t.result));t.readAsArrayBuffer(e)}else super._onMessage(e)}sendChunk(e){this._channel.send(e)}close(){this._channel.close()}get readyState(){return DataChannel.ReadyState.fromString(this._channel.readyState)}}Class.register(WebRtcDataChannel);class WebRtcUtils{static candidateToNetAddress(e){const t=e.candidate.split(" ");return t.length<6?null:NetAddress.fromIP(t[4])}}Class.register(WebRtcUtils);class WebSocketConnector extends Observable{constructor(e){super();if(e.peerAddress.protocol===Protocol.WS){this._wss=WebSocketFactory.newWebSocketServer(e);this._wss.on("connection",e=>this._onConnection(e));Log.d(WebSocketConnector,`WebSocketConnector listening on port ${e.peerAddress.port}`)}this._timers=new Timers}connect(e){if(e.protocol!==Protocol.WS)throw"Malformed peerAddress";const t=`connect_${e}`;if(this._timers.timeoutExists(t)){Log.w(WebSocketConnector,`Already connecting to ${e}`);return!1}const r=WebSocketFactory.newWebSocket(`wss://${e.host}:${e.port}`,{handshakeTimeout:WebSocketConnector.CONNECT_TIMEOUT});r.binaryType="arraybuffer";r.onopen=(()=>{this._timers.clearTimeout(t);r.onerror=(()=>{});const n=r._socket&&r._socket.remoteAddress?NetAddress.fromIP(r._socket.remoteAddress):null,s=new NetworkConnection(new WebSocketDataChannel(r),Protocol.WS,n,e);this.fire("connection",s)});r.onerror=(r=>{this._timers.clearTimeout(t);this.fire("error",e,r)});this._timers.setTimeout(t,()=>{this._timers.clearTimeout(t);r.onerror=(()=>{});r.onopen=(()=>{Log.w(WebSocketConnector,`Connection to ${e} succeeded after timeout - closing it`);r.close()});this.fire("error",e,"timeout")},WebSocketConnector.CONNECT_TIMEOUT);return!0}_onConnection(e){const t=NetAddress.fromIP(e._socket.remoteAddress),r=new NetworkConnection(new WebSocketDataChannel(e),Protocol.WS,t,null);this.fire("connection",r)}}WebSocketConnector.CONNECT_TIMEOUT=5e3;Class.register(WebSocketConnector);class WebSocketDataChannel extends DataChannel{constructor(e){super();this._ws=e;this._ws.onmessage=(e=>this._onMessage(e.data||e));this._ws.onclose=(()=>this._onClose());this._ws.onerror=(e=>this.fire("error",e))}close(){this._ws.close()}sendChunk(e){this._ws.send(e)}get readyState(){return this._ws.readyState}}Class.register(WebSocketDataChannel);class NetAddress{static fromIP(e){const t=NetUtils.sanitizeIP(e);return new NetAddress(t)}constructor(e){this._ip=e}static unserialize(e){const t=e.readVarLengthString();return t?NetAddress.fromIP(t):NetAddress.UNSPECIFIED}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).writeVarLengthString(this._ip);return e}get serializedSize(){return SerialBuffer.varLengthStringSize(this._ip)}equals(e){return e instanceof NetAddress&&this._ip===e.ip}hashCode(){return this.toString()}toString(){return`${this._ip}`}get ip(){return this._ip}isPseudo(){return!this._ip||NetAddress.UNKNOWN.equals(this)}isPrivate(){return this.isPseudo()||NetUtils.isPrivateIP(this._ip)}}NetAddress.UNSPECIFIED=new NetAddress("");NetAddress.UNKNOWN=new NetAddress("<unknown>");Class.register(NetAddress);class PeerId extends Primitive{static copy(e){if(!e)return e;const t=new Uint8Array(e._obj);return new PeerId(t)}constructor(e){super(e,Uint8Array,PeerId.SERIALIZED_SIZE)}static unserialize(e){return new PeerId(e.read(PeerId.SERIALIZED_SIZE))}serialize(e){(e=e||new SerialBuffer(this.serializedSize)).write(this._obj);return e}subarray(e,t){return this._obj.subarray(e,t)}get serializedSize(){return PeerId.SERIALIZED_SIZE}equals(e){return e instanceof PeerId&&super.equals(e)}toString(){return this.toHex()}static fromBase64(e){return new PeerId(BufferUtils.fromBase64(e))}static fromHex(e){return new PeerId(BufferUtils.fromHex(e))}}PeerId.SERIALIZED_SIZE=16;Class.register(PeerId);class PeerAddress{constructor(e,t,r,n,s,i,o){if(!NumberUtils.isUint8(i))throw new Error("Malformed distance");if(null!==s&&!(s instanceof PublicKey))throw new Error("Malformed publicKey");this._protocol=e;this._services=t;this._timestamp=r;this._netAddress=n||NetAddress.UNSPECIFIED;this._publicKey=s;this._distance=i;this._signature=o}static unserialize(e){const t=e.readUint8();switch(t){case Protocol.WS:return WsPeerAddress.unserialize(e);case Protocol.RTC:return RtcPeerAddress.unserialize(e);case Protocol.DUMB:return DumbPeerAddress.unserialize(e);default:throw`Malformed PeerAddress protocol ${t}`}}serialize(e){if(!this._publicKey)throw new Error("PeerAddress without publicKey may not be serialized.");if(!this._signature)throw new Error("PeerAddress without signature may not be serialized.");(e=e||new SerialBuffer(this.serializedSize)).writeUint8(this._protocol);e.writeUint32(this._services);e.writeUint64(this._timestamp);this._netAddress.isPrivate()?NetAddress.UNSPECIFIED.serialize(e):this._netAddress.serialize(e);this._publicKey.serialize(e);e.writeUint8(this._distance);this._signature.serialize(e);return e}serializeContent(e){(e=e||new SerialBuffer(this.serializedContentSize)).writeUint8(this._protocol);e.writeUint32(this._services);e.writeUint64(this._timestamp);return e}get serializedSize(){return 13+this._netAddress.serializedSize+this._publicKey.serializedSize+1+this._signature.serializedSize}get serializedContentSize(){return 13}equals(e){return e instanceof PeerAddress&&this.protocol===e.protocol&&(!this.publicKey||!e.publicKey||this.publicKey.equals(e.publicKey))&&(!this.peerId||!e.peerId||this.peerId.equals(e.peerId))}verifySignature(){this._signatureVerified===undefined&&(this._signatureVerified=this.signature.verify(this.publicKey,this.serializeContent()));return this._signatureVerified}get protocol(){return this._protocol}get services(){return this._services}get timestamp(){return this._timestamp}get netAddress(){return this._netAddress.isPseudo()?null:this._netAddress}set netAddress(e){this._netAddress=e||NetAddress.UNSPECIFIED}get publicKey(){return this._publicKey}get peerId(){return this._publicKey?this._publicKey.toPeerId():null}get distance(){return this._distance}get signature(){return this._signature}set signature(e){if(0===this._distance){this._signature=e;this._signatureVerified=undefined}}set distance(e){this._distance=e}isSeed(){return 0===this._timestamp}exceedsAge(){if(this.isSeed())return!1;const e=Date.now()-this.timestamp;switch(this.protocol){case Protocol.WS:return e>PeerAddressBook.MAX_AGE_WEBSOCKET;case Protocol.RTC:return e>PeerAddressBook.MAX_AGE_WEBRTC;case Protocol.DUMB:return e>PeerAddressBook.MAX_AGE_DUMB}return!1}}Class.register(PeerAddress);class WsPeerAddress extends PeerAddress{static seed(e,t,r){const n=r?new PublicKey(BufferUtils.fromHex(r)):null;return new WsPeerAddress(Services.FULL,0,NetAddress.UNSPECIFIED,n,0,e,t)}constructor(e,t,r,n,s,i,o,a){super(Protocol.WS,e,t,r,n,s,a);if(!i)throw new Error("Malformed host");if(!NumberUtils.isUint16(o))throw new Error("Malformed port");this._host=i;this._port=o}static unserialize(e){const t=e.readUint32(),r=e.readUint64(),n=NetAddress.unserialize(e),s=PublicKey.unserialize(e),i=e.readUint8(),o=Signature.unserialize(e),a=e.readVarLengthString(),c=e.readUint16();return new WsPeerAddress(t,r,n,s,i,a,c,o)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);e.writeVarLengthString(this._host);e.writeUint16(this._port);return e}serializeContent(e){e=e||new SerialBuffer(this.serializedContentSize);super.serializeContent(e);e.writeVarLengthString(this._host);e.writeUint16(this._port);return e}globallyReachable(){return NetUtils.hostGloballyReachable(this.host)}get serializedSize(){return super.serializedSize+SerialBuffer.varLengthStringSize(this._host)+2}get serializedContentSize(){return super.serializedContentSize+SerialBuffer.varLengthStringSize(this._host)+2}equals(e){return super.equals(e)&&e instanceof WsPeerAddress&&(!!this.peerId&&!!e.peerId||this._host===e.host&&this._port===e.port)}hashCode(){return this.peerId?`wss:///${this.peerId}`:`wss://${this._host}:${this._port}/`}toString(){return`wss://${this._host}:${this._port}/${this.peerId?this.peerId:""}`}withoutId(){return new WsPeerAddress(this.services,this.timestamp,this.netAddress,null,this.distance,this.host,this.port)}get host(){return this._host}get port(){return this._port}}Class.register(WsPeerAddress);class RtcPeerAddress extends PeerAddress{constructor(e,t,r,n,s,i){super(Protocol.RTC,e,t,r,n,s,i)}static unserialize(e){const t=e.readUint32(),r=e.readUint64(),n=NetAddress.unserialize(e),s=PublicKey.unserialize(e),i=e.readUint8(),o=Signature.unserialize(e);return new RtcPeerAddress(t,r,n,s,i,o)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);return e}get serializedSize(){return super.serializedSize}equals(e){return super.equals(e)&&e instanceof RtcPeerAddress}hashCode(){return this.toString()}toString(){return`rtc:///${this.peerId}`}}Class.register(RtcPeerAddress);class DumbPeerAddress extends PeerAddress{constructor(e,t,r,n,s,i){super(Protocol.DUMB,e,t,r,n,s,i)}static unserialize(e){const t=e.readUint32(),r=e.readUint64(),n=NetAddress.unserialize(e),s=PublicKey.unserialize(e),i=e.readUint8(),o=Signature.unserialize(e);return new DumbPeerAddress(t,r,n,s,i,o)}serialize(e){e=e||new SerialBuffer(this.serializedSize);super.serialize(e);return e}get serializedSize(){return super.serializedSize}equals(e){return super.equals(e)&&e instanceof DumbPeerAddress}hashCode(){return this.toString()}toString(){return`dumb:///${this.peerId}`}}Class.register(DumbPeerAddress);class PeerAddressState{constructor(e){this.peerAddress=e;this.state=PeerAddressState.NEW;this.lastConnected=-1;this.bannedUntil=-1;this.banBackoff=PeerAddressBook.INITIAL_FAILED_BACKOFF;this._signalRouter=new SignalRouter(e);this._failedAttempts=0;this._closeTypes=new Map}get signalRouter(){return this._signalRouter}get maxFailedAttempts(){switch(this.peerAddress.protocol){case Protocol.RTC:return PeerAddressBook.MAX_FAILED_ATTEMPTS_RTC;case Protocol.WS:return PeerAddressBook.MAX_FAILED_ATTEMPTS_WS;default:return 0}}get failedAttempts(){return this._signalRouter.bestRoute?this._signalRouter.bestRoute.failedAttempts:this._failedAttempts}set failedAttempts(e){if(this._signalRouter.bestRoute){this._signalRouter.bestRoute.failedAttempts=e;this._signalRouter.updateBestRoute()}else this._failedAttempts=e}close(e){if(e){this._closeTypes.has(e)?this._closeTypes.set(e,this._closeTypes.get(e)+1):this._closeTypes.set(e,1);this.state!==PeerAddressState.BANNED&&(CloseType.isBanningType(e)?this.state=PeerAddressState.BANNED:CloseType.isFailingType(e)?this.state=PeerAddressState.FAILED:this.state=PeerAddressState.TRIED)}}equals(e){return e instanceof PeerAddressState&&this.peerAddress.equals(e.peerAddress)}hashCode(){return this.peerAddress.hashCode()}toString(){return`PeerAddressState{peerAddress=${this.peerAddress}, state=${this.state}, `+`lastConnected=${this.lastConnected}, failedAttempts=${this.failedAttempts}, `+`bannedUntil=${this.bannedUntil}}`}}PeerAddressState.NEW=1;PeerAddressState.ESTABLISHED=2;PeerAddressState.TRIED=3;PeerAddressState.FAILED=4;PeerAddressState.BANNED=5;Class.register(PeerAddressState);class SignalRouter{constructor(e){this.peerAddress=e;this._bestRoute=null;this._routes=new HashSet}get bestRoute(){return this._bestRoute}addRoute(e,t,r){const n=this._routes.get(e),s=new SignalRoute(e,t,r);n&&(s.failedAttempts=n.failedAttempts);this._routes.add(s);if(!this._bestRoute||s.score>this._bestRoute.score||s.score===this._bestRoute.score&&r>this._bestRoute.timestamp){this._bestRoute=s;this.peerAddress.distance=this._bestRoute.distance}}deleteBestRoute(){this._bestRoute&&this.deleteRoute(this._bestRoute.signalChannel)}deleteRoute(e){this._routes.remove(e);this._bestRoute&&this._bestRoute.signalChannel.equals(e)&&this.updateBestRoute()}deleteAllRoutes(){this._bestRoute=null;this._routes=new HashSet}hasRoute(){return this._routes.length>0}updateBestRoute(){let e=null;for(const t of this._routes.values())(null===e||t.score>e.score||t.score===e.score&&t.timestamp>e.timestamp)&&(e=t);this._bestRoute=e;this._bestRoute?this.peerAddress.distance=this._bestRoute.distance:this.peerAddress.distance=PeerAddressBook.MAX_DISTANCE+1}equals(e){return e instanceof PeerAddressState&&this.peerAddress.equals(e.peerAddress)}hashCode(){return this.peerAddress.hashCode()}toString(){return`PeerAddressState{peerAddress=${this.peerAddress}, state=${this.state}, `+`lastConnected=${this.lastConnected}, failedAttempts=${this.failedAttempts}, `+`bannedUntil=${this.bannedUntil}}`}}Class.register(SignalRouter);class SignalRoute{constructor(e,t,r){this.failedAttempts=0;this.timestamp=r;this._signalChannel=e;this._distance=t}get signalChannel(){return this._signalChannel}get distance(){return this._distance}get score(){return(PeerAddressBook.MAX_DISTANCE-this._distance)/2*(1-this.failedAttempts/PeerAddressBook.MAX_FAILED_ATTEMPTS_RTC)}equals(e){return e instanceof SignalRoute&&this._signalChannel.equals(e._signalChannel)}hashCode(){return this._signalChannel.hashCode()}toString(){return`SignalRoute{signalChannel=${this._signalChannel}, distance=${this._distance}, timestamp=${this.timestamp}, failedAttempts=${this.failedAttempts}}`}}Class.register(SignalRoute);class PeerAddressBook extends Observable{constructor(e){super();this._store=new HashSet;this._peerIds=new HashMap;this._networkConfig=e;this.add(null,PeerAddressBook.SEED_PEERS);setInterval(()=>this._housekeeping(),PeerAddressBook.HOUSEKEEPING_INTERVAL)}values(){return this._store.values()}_get(e){if(e instanceof WsPeerAddress){const t=this._store.get(e.withoutId());if(t)return t}return this._store.get(e)}getState(e){return this._get(e)}get(e){const t=this._get(e);return t?t.peerAddress:null}getByPeerId(e){const t=this._peerIds.get(e);return t?t.peerAddress:null}getChannelByPeerId(e){const t=this._peerIds.get(e);return t&&t.signalRouter.bestRoute?t.signalRouter.bestRoute.signalChannel:null}query(e,t,r=1e3){const n=Date.now(),s=[];for(const i of this._store.values()){if(i.state===PeerAddressState.BANNED||i.state===PeerAddressState.FAILED)continue;const o=i.peerAddress;if(!o.isSeed()&&(0!=(o.protocol&e)&&0!=(o.services&t))){i.state===PeerAddressState.ESTABLISHED&&i.signalRouter.bestRoute&&(i.signalRouter.bestRoute.timestamp=n);if(!o.exceedsAge()){s.push(o);if(s.length>=r)break}}}return s}add(e,t){const r=Array.isArray(t)?t:[t],n=[];for(const s of r)this._add(e,s)&&n.push(s);n.length&&this.fire("added",n,this)}_add(e,t){if(this._store.length>=PeerAddressBook.MAX_SIZE)return!1;if(this._networkConfig.peerAddress.equals(t))return!1;if(e&&t.exceedsAge()){Log.d(PeerAddressBook,`Ignoring address ${t} - too old (${new Date(t.timestamp)})`);return!1}if(t.timestamp>Date.now()+PeerAddressBook.MAX_TIMESTAMP_DRIFT){Log.d(PeerAddressBook,`Ignoring addresses ${t} - timestamp in the future`);return!1}if(t.protocol===Protocol.RTC){t.distance++;if(t.distance>PeerAddressBook.MAX_DISTANCE){Log.d(PeerAddressBook,`Ignoring address ${t} - max distance exceeded`);const r=this._get(t);r&&r.signalRouter.deleteRoute(e);return!1}}let r=this._get(t);if(r){const e=r.peerAddress;if(r.state===PeerAddressState.BANNED)return!1;if(e.isSeed())return!1;e.netAddress&&!t.netAddress&&(t.netAddress=e.netAddress);if(t.protocol===Protocol.WS&&e.timestamp>=t.timestamp)return!1}else{r=new PeerAddressState(t);this._store.add(r);t.protocol===Protocol.RTC&&this._peerIds.put(t.peerId,r)}t.protocol===Protocol.RTC&&r.signalRouter.addRoute(e,t.distance,t.timestamp);r.peerAddress=t;return!0}established(e,t){let r=this._get(t);if(!r){r=new PeerAddressState(t);t.protocol===Protocol.RTC&&this._peerIds.put(t.peerId,r);this._store.add(r)}r.state=PeerAddressState.ESTABLISHED;r.lastConnected=Date.now();r.failedAttempts=0;r.bannedUntil=-1;r.banBackoff=PeerAddressBook.INITIAL_FAILED_BACKOFF;r.peerAddress.isSeed()||(r.peerAddress=t);t.protocol===Protocol.RTC&&r.signalRouter.addRoute(e,t.distance,t.timestamp)}close(e,t,r=null){const n=this._get(t);if(n){n.close(r);e&&this._removeBySignalChannel(e);if(CloseType.isBanningType(r))this._ban(t);else if(CloseType.isFailingType(r)){n.failedAttempts++;if(n.failedAttempts>=n.maxFailedAttempts)if(n.banBackoff>=PeerAddressBook.MAX_FAILED_BACKOFF)this._remove(t);else{n.bannedUntil=Date.now()+n.banBackoff;n.banBackoff=Math.min(PeerAddressBook.MAX_FAILED_BACKOFF,2*n.banBackoff)}}t.protocol===Protocol.DUMB&&this._remove(t)}}unroutable(e,t){if(!t)return;const r=this._get(t);if(r)if(r.signalRouter.bestRoute&&r.signalRouter.bestRoute.signalChannel.equals(e)){r.signalRouter.deleteBestRoute();r.signalRouter.hasRoute()||this._remove(r.peerAddress)}else Log.w(PeerAddressBook,`Got unroutable for ${t} on a channel other than the best route.`)}_ban(e,t=PeerAddressBook.DEFAULT_BAN_TIME){let r=this._get(e);if(!r){r=new PeerAddressState(e);this._store.add(r)}r.state=PeerAddressState.BANNED;r.bannedUntil=Date.now()+t;r.signalRouter.deleteAllRoutes()}isBanned(e){const t=this._get(e);return t&&t.state===PeerAddressState.BANNED&&!t.peerAddress.isSeed()}_remove(e){const t=this._get(e);if(t)if(t.peerAddress.isSeed())this._ban(e,t.banBackoff);else{e.protocol===Protocol.RTC&&this._peerIds.remove(e.peerId);t.state!==PeerAddressState.BANNED&&this._store.remove(e)}}_removeBySignalChannel(e){for(const t of this._store.values())if(t.peerAddress.protocol===Protocol.RTC){t.signalRouter.deleteRoute(e);t.signalRouter.hasRoute()||this._remove(t.peerAddress)}}_housekeeping(){const e=Date.now(),t=[];for(const r of this._store.values()){const n=r.peerAddress;switch(r.state){case PeerAddressState.NEW:case PeerAddressState.TRIED:case PeerAddressState.FAILED:if(n.exceedsAge()){Log.d(PeerAddressBook,`Deleting old peer address ${n}`);this._remove(n)}if(r.state===PeerAddressState.FAILED&&r.failedAttempts>=r.maxFailedAttempts&&r.bannedUntil>0&&r.bannedUntil<=e){r.bannedUntil=-1;r.failedAttempts=0;t.push(n)}break;case PeerAddressState.BANNED:if(r.bannedUntil<=e)if(n.isSeed()){r.state=PeerAddressState.NEW;r.failedAttempts=0;r.bannedUntil=-1;t.push(n)}else this._store.remove(n);break;case PeerAddressState.ESTABLISHED:r.signalRouter.bestRoute&&(r.signalRouter.bestRoute.timestamp=e)}}t.length&&this.fire("added",t,this)}get knownAddressesCount(){return this._store.length}}PeerAddressBook.MAX_AGE_WEBSOCKET=18e5;PeerAddressBook.MAX_AGE_WEBRTC=6e5;PeerAddressBook.MAX_AGE_DUMB=6e4;PeerAddressBook.MAX_DISTANCE=4;PeerAddressBook.MAX_FAILED_ATTEMPTS_WS=3;PeerAddressBook.MAX_FAILED_ATTEMPTS_RTC=2;PeerAddressBook.MAX_TIMESTAMP_DRIFT=6e5;PeerAddressBook.HOUSEKEEPING_INTERVAL=6e4;PeerAddressBook.DEFAULT_BAN_TIME=6e5;PeerAddressBook.INITIAL_FAILED_BACKOFF=3e4;PeerAddressBook.MAX_FAILED_BACKOFF=6e5;PeerAddressBook.MAX_SIZE=PlatformUtils.isBrowser()?1e4:2e5;PeerAddressBook.SEED_PEERS=[WsPeerAddress.seed("dev.nimiq-network.com",8080,"e65e39616662f2c16d62dc08915e5a1d104619db8c2b9cf9b389f96c8dce9837")];Class.register(PeerAddressBook);class CloseType{static isBanningType(e){return e>=100&&e<200}static isFailingType(e){return e>=200}}CloseType.GET_BLOCKS_TIMEOUT=1;CloseType.GET_CHAIN_PROOF_TIMEOUT=2;CloseType.GET_ACCOUNTS_TREE_CHUNK_TIMEOUT=3;CloseType.GET_HEADER_TIMEOUT=4;CloseType.INVALID_ACCOUNTS_TREE_CHUNK=5;CloseType.ACCOUNTS_TREE_CHUNCK_ROOT_HASH_MISMATCH=6;CloseType.INVALID_CHAIN_PROOF=7;CloseType.RECEIVED_WRONG_HEADER=8;CloseType.DID_NOT_GET_REQUESTED_HEADER=9;CloseType.ABORTED_SYNC=10;CloseType.GET_ACCOUNTS_PROOF_TIMEOUT=11;CloseType.GET_TRANSACTIONS_PROOF_TIMEOUT=12;CloseType.GET_TRANSACTION_RECEIPTS_TIMEOUT=13;CloseType.INVALID_ACCOUNTS_PROOF=14;CloseType.ACCOUNTS_PROOF_ROOT_HASH_MISMATCH=15;CloseType.INCOMPLETE_ACCOUNTS_PROOF=16;CloseType.INVALID_BLOCK=17;CloseType.INVALID_CHAIN_PROOF=18;CloseType.INVALID_TRANSACTION_PROOF=19;CloseType.SENDING_PING_MESSAGE_FAILED=22;CloseType.SENDING_OF_VERSION_MESSAGE_FAILED=29;CloseType.DUPLICATE_CONNECTION=30;CloseType.PEER_IS_BANNED=31;CloseType.CONNECTION_LIMIT_PER_IP=32;CloseType.MANUAL_NETWORK_DISCONNECT=33;CloseType.MANUAL_WEBSOCKET_DISCONNECT=34;CloseType.MAX_PEER_COUNT_REACHED=35;CloseType.PEER_CONNECTION_RECYCLED=36;CloseType.PEER_CONNECTION_RECYCLED_INBOUND_EXCHANGE=37;CloseType.RECEIVED_INVALID_BLOCK=100;CloseType.BLOCKCHAIN_SYNC_FAILED=101;CloseType.RECEIVED_INVALID_HEADER=102;CloseType.RECEIVED_TRANSACTION_NOT_MATCHING_OUR_SUBSCRIPTION=103;CloseType.ADDR_MESSAGE_TOO_LARGE=104;CloseType.INVALID_ADDR=105;CloseType.ADDR_NOT_GLOBALLY_REACHABLE=106;CloseType.INVALID_SIGNAL_TTL=107;CloseType.INVALID_SIGNATURE=108;CloseType.INCOMPATIBLE_VERSION=109;CloseType.INVALID_PUBLIC_KEY_IN_VERACK_MESSAGE=110;CloseType.INVALID_SIGNATURE_IN_VERACK_MESSAGE=111;CloseType.DIFFERENT_GENESIS_BLOCK=112;CloseType.INVALID_PEER_ADDRESS_IN_VERSION_MESSAGE=113;CloseType.UNEXPECTED_PEER_ADDRESS_IN_VERSION_MESSAGE=114;CloseType.CLOSED_BY_REMOTE=200;CloseType.PING_TIMEOUT=201;CloseType.CONNECTION_FAILED=202;CloseType.NETWORK_ERROR=203;CloseType.VERSION_TIMEOUT=204;CloseType.VERACK_TIMEOUT=205;Class.register(CloseType);class NetworkConnection extends Observable{constructor(e,t,r,n){super();this._channel=e;this._protocol=t;this._netAddress=r;this._peerAddress=n;this._bytesSent=0;this._bytesReceived=0;this._inbound=!n;this._closed=!1;this._lastError=null;this._id=NetworkConnection._instanceCount++;this._channel.on("message",e=>this._onMessage(e));this._channel.on("close",()=>this._onClose(CloseType.CLOSED_BY_REMOTE,"Closed by remote"));this._channel.on("error",e=>this._onError(e))}_onMessage(e){if(!this._closed){this._bytesReceived+=e.byteLength||e.length;this.fire("message",e,this)}}_onError(e){this._lastError=e;this.fire("error",e,this)}_onClose(e,t){if(!this._closed){this._closed=!0;if(e===CloseType.CLOSED_BY_REMOTE&&this._lastError){e=CloseType.NETWORK_ERROR;t=this._lastError}this.fire("close",e,t,this)}}_close(e,t){this._onClose(e,t);this._channel.close()}_isChannelOpen(){return this._channel.readyState===DataChannel.ReadyState.OPEN}_isChannelClosing(){return this._channel.readyState===DataChannel.ReadyState.CLOSING}_isChannelClosed(){return this._channel.readyState===DataChannel.ReadyState.CLOSED}send(e){const t=this._peerAddress||this._netAddress;if(this._closed)return!1;if(this._isChannelClosing()||this._isChannelClosed()){Log.w(NetworkConnection,`Not sending data to ${t} - channel closing/closed (${this._channel.readyState})`);this._onClose();return!1}if(!this._isChannelOpen()){Log.w(NetworkConnection,`Not sending data to ${t} - channel not open (${this._channel.readyState})`);return!1}try{this._channel.send(e);this._bytesSent+=e.byteLength||e.length;return!0}catch(r){Log.e(NetworkConnection,`Failed to send data to ${t}: ${r.message||r}`);return!1}}expectMessage(e,t,r,n){this._channel.expectMessage(e,t,r,n)}isExpectingMessage(e){return this._channel.isExpectingMessage(e)}close(e,t){const r=this._inbound?"inbound":"outbound";Log.d(NetworkConnection,`Closing ${r} connection #${this._id} ${this._peerAddress||this._netAddress}`+(t?` - ${t}`:"")+` (${e})`);this._close(e,t)}equals(e){return e instanceof NetworkConnection&&this._id===e.id}hashCode(){return this._id.toString()}toString(){return`NetworkConnection{id=${this._id}, protocol=${this._protocol}, peerAddress=${this._peerAddress}, netAddress=${this._netAddress}}`}get id(){return this._id}get protocol(){return this._protocol}get peerAddress(){return this._peerAddress}set peerAddress(e){this._peerAddress=e}get netAddress(){return this._netAddress}set netAddress(e){this._netAddress=e}get bytesSent(){return this._bytesSent}get bytesReceived(){return this._bytesReceived}get inbound(){return this._inbound}get outbound(){return!this._inbound}get closed(){return this._closed}}NetworkConnection._instanceCount=0;Class.register(NetworkConnection);class PeerChannel extends Observable{constructor(e){super();this._conn=e;this._conn.on("message",e=>this._onMessage(e));this.bubble(this._conn,"close","error")}_onMessage(e){let t=null,r=null;try{const s=new SerialBuffer(e);r=MessageFactory.peekType(s);t=MessageFactory.parse(s)}catch(n){Log.w(PeerChannel,`Failed to parse message from ${this.peerAddress||this.netAddress}`,n.message||n);if(!r||r===Message.Type.REJECT){this.close(CloseType.FAILED_TO_PARSE_MESSAGE_TYPE,"Failed to parse message type");return}this.reject(r,RejectMessage.Code.REJECT_MALFORMED,n.message||n);return}if(t)try{this.fire(PeerChannel.Event[t.type],t,this);this.fire("message-log",t,this)}catch(n){Log.w(PeerChannel,`Error while processing ${t.type} message from ${this.peerAddress||this.netAddress}: ${n}`)}}expectMessage(e,t,r,n){this._conn.expectMessage(e,t,r,n)}isExpectingMessage(e){return this._conn.isExpectingMessage(e)}_send(e){return this._conn.send(e.serialize())}close(e,t){this._conn.close(e,t)}version(e,t,r){return this._send(new VersionMessage(Version.CODE,e,Block.GENESIS.HASH,t,r))}verack(e,t){return this._send(new VerAckMessage(e,t))}inv(e){return this._send(new InvMessage(e))}notFound(e){return this._send(new NotFoundMessage(e))}getData(e){return this._send(new GetDataMessage(e))}getHeader(e){return this._send(new GetHeaderMessage(e))}block(e){return this._send(new BlockMessage(e))}header(e){return this._send(new HeaderMessage(e))}tx(e,t){return this._send(new TxMessage(e,t))}getBlocks(e,t=BaseInventoryMessage.VECTORS_MAX_COUNT,r=!0){return this._send(new GetBlocksMessage(e,t,r?GetBlocksMessage.Direction.FORWARD:GetBlocksMessage.Direction.BACKWARD))}mempool(){return this._send(new MempoolMessage)}reject(e,t,r,n){return this._send(new RejectMessage(e,t,r,n))}subscribe(e){return this._send(new SubscribeMessage(e))}addr(e){return this._send(new AddrMessage(e))}getAddr(e,t){return this._send(new GetAddrMessage(e,t))}ping(e){return this._send(new PingMessage(e))}pong(e){return this._send(new PongMessage(e))}signal(e,t,r,n,s,i,o,a){return this._send(new SignalMessage(e,t,r,n,s,i,o,a))}getAccountsProof(e,t){return this._send(new GetAccountsProofMessage(e,t))}accountsProof(e,t){return this._send(new AccountsProofMessage(e,t))}getChainProof(){return this._send(new GetChainProofMessage)}chainProof(e){return this._send(new ChainProofMessage(e))}getAccountsTreeChunk(e,t){return this._send(new GetAccountsTreeChunkMessage(e,t))}accountsTreeChunk(e,t){return this._send(new AccountsTreeChunkMessage(e,t))}getTransactionsProof(e,t){return this._send(new GetTransactionsProofMessage(e,t))}transactionsProof(e,t){return this._send(new TransactionsProofMessage(e,t))}getTransactionReceipts(e){return this._send(new GetTransactionReceiptsMessage(e))}transactionReceipts(e){return this._send(new TransactionReceiptsMessage(e))}equals(e){return e instanceof PeerChannel&&this._conn.equals(e.connection)}hashCode(){return this._conn.hashCode()}toString(){return`PeerChannel{conn=${this._conn}}`}get connection(){return this._conn}get id(){return this._conn.id}get protocol(){return this._conn.protocol}get peerAddress(){return this._conn.peerAddress}set peerAddress(e){this._conn.peerAddress=e}get netAddress(){return this._conn.netAddress}set netAddress(e){this._conn.netAddress=e}get closed(){return this._conn.closed}}Class.register(PeerChannel);PeerChannel.Event={};PeerChannel.Event[Message.Type.VERSION]="version";PeerChannel.Event[Message.Type.INV]="inv";PeerChannel.Event[Message.Type.GET_DATA]="get-data";PeerChannel.Event[Message.Type.GET_HEADER]="get-header";PeerChannel.Event[Message.Type.NOT_FOUND]="not-found";PeerChannel.Event[Message.Type.GET_BLOCKS]="get-blocks";PeerChannel.Event[Message.Type.BLOCK]="block";PeerChannel.Event[Message.Type.HEADER]="header";PeerChannel.Event[Message.Type.TX]="tx";PeerChannel.Event[Message.Type.MEMPOOL]="mempool";PeerChannel.Event[Message.Type.REJECT]="reject";PeerChannel.Event[Message.Type.SUBSCRIBE]="subscribe";PeerChannel.Event[Message.Type.ADDR]="addr";PeerChannel.Event[Message.Type.GET_ADDR]="get-addr";PeerChannel.Event[Message.Type.PING]="ping";PeerChannel.Event[Message.Type.PONG]="pong";PeerChannel.Event[Message.Type.SIGNAL]="signal";PeerChannel.Event[Message.Type.GET_CHAIN_PROOF]="get-chain-proof";PeerChannel.Event[Message.Type.CHAIN_PROOF]="chain-proof";PeerChannel.Event[Message.Type.GET_ACCOUNTS_PROOF]="get-accounts-proof";PeerChannel.Event[Message.Type.ACCOUNTS_PROOF]="accounts-proof";PeerChannel.Event[Message.Type.GET_ACCOUNTS_TREE_CHUNK]="get-accounts-tree-chunk";PeerChannel.Event[Message.Type.ACCOUNTS_TREE_CHUNK]="accounts-tree-chunk";PeerChannel.Event[Message.Type.GET_TRANSACTIONS_PROOF]="get-transactions-proof";PeerChannel.Event[Message.Type.TRANSACTIONS_PROOF]="transactions-proof";PeerChannel.Event[Message.Type.GET_TRANSACTION_RECEIPTS]="get-transaction-receipts";PeerChannel.Event[Message.Type.TRANSACTION_RECEIPTS]="transaction-receipts";PeerChannel.Event[Message.Type.VERACK]="verack";class NetworkAgent extends Observable{constructor(e,t,r,n){super();this._blockchain=e;this._addresses=t;this._networkConfig=r;this._channel=n;this._peer=null;this._knownAddresses=new HashSet;this._timers=new Timers;this._versionReceived=!1;this._verackReceived=!1;this._versionSent=!1;this._verackSent=!1;this._versionAttempts=0;this._peerAddressVerified=!1;this._peerChallengeNonce=null;this._pingTimes=new Map;this._challengeNonce=new Uint8Array(VersionMessage.CHALLENGE_SIZE);Crypto.lib.getRandomValues(this._challengeNonce);n.on("version",e=>this._onVersion(e));n.on("verack",e=>this._onVerAck(e));n.on("addr",e=>this._onAddr(e));n.on("get-addr",e=>this._onGetAddr(e));n.on("ping",e=>this._onPing(e));n.on("pong",e=>this._onPong(e));n.on("close",()=>this._onClose())}relayAddresses(e){if(!this._versionReceived||!this._versionSent)return;const t=e.filter(e=>{if(e.protocol===Protocol.RTC&&e.distance>=PeerAddressBook.MAX_DISTANCE)return!1;if(e.protocol===Protocol.DUMB)return!1;const t=this._knownAddresses.get(e);return!e.isSeed()&&(!t||t.timestamp<Date.now()-NetworkAgent.RELAY_THROTTLE)});if(t.length){this._channel.addr(t);for(const e of t)this._knownAddresses.add(e)}}handshake(){if(!this._versionSent)if(this._channel.version(this._networkConfig.peerAddress,this._blockchain.headHash,this._challengeNonce)){this._versionSent=!0;this._versionReceived?this._peerAddressVerified&&this._sendVerAck():this._timers.setTimeout("version",()=>{this._timers.clearTimeout("version");this._channel.close(CloseType.VERSION_TIMEOUT,"version timeout")},NetworkAgent.HANDSHAKE_TIMEOUT);this._timers.setTimeout("verack",()=>{this._timers.clearTimeout("verack");this._channel.close(CloseType.VERACK_TIMEOUT,"verack timeout")},NetworkAgent.HANDSHAKE_TIMEOUT)}else{this._versionAttempts++;if(this._versionAttempts>=NetworkAgent.VERSION_ATTEMPTS_MAX){this._channel.close(CloseType.SENDING_OF_VERSION_MESSAGE_FAILED,"sending of version message failed");return}setTimeout(this.handshake.bind(this),NetworkAgent.VERSION_RETRY_DELAY)}}_onVersion(e){Log.d(NetworkAgent,()=>`[VERSION] ${e.peerAddress} ${e.headHash.toBase64()}`);const t=Date.now();if(!this._canAcceptMessage(e))return;if(this._versionReceived){Log.d(NetworkAgent,()=>`Ignoring duplicate version message from ${this._channel.peerAddress}`);return}this._timers.clearTimeout("version");if(!Version.isCompatible(e.version)){this._channel.reject(Message.Type.VERSION,RejectMessage.Code.REJECT_OBSOLETE,`incompatible version (ours=${Version.CODE}, theirs=${e.version})`);this._channel.close(CloseType.INCOMPATIBLE_VERSION,`incompatible version (ours=${Version.CODE}, theirs=${e.version})`);return}if(!Block.GENESIS.HASH.equals(e.genesisHash)){this._channel.close(CloseType.DIFFERENT_GENESIS_BLOCK,`different genesis block (${e.genesisHash})`);return}if(!e.peerAddress.verifySignature()){this._channel.close(CloseType.INVALID_PEER_ADDRESS_IN_VERSION_MESSAGE,"invalid peerAddress in version message");return}const r=e.peerAddress;if(this._channel.peerAddress){if(!this._channel.peerAddress.equals(r)){this._channel.close(CloseType.UNEXPECTED_PEER_ADDRESS_IN_VERSION_MESSAGE,"unexpected peerAddress in version message");return}this._peerAddressVerified=!0}if(!r.netAddress||r.netAddress.isPseudo()){const e=this._addresses.get(r);e&&e.netAddress&&(r.netAddress=e.netAddress)}this._channel.peerAddress=r;this._peer=new Peer(this._channel,e.version,e.headHash,r.timestamp-t);this._peerChallengeNonce=e.challengeNonce;this._versionReceived=!0;this.fire("version",this._peer,this);if(!this._channel.closed)if(this._versionSent){this._peerAddressVerified&&this._sendVerAck();this._verackReceived&&this._finishHandshake()}else this.handshake()}_sendVerAck(){Assert.that(this._peerAddressVerified);const e=BufferUtils.concatTypedArrays(this._channel.peerAddress.peerId.serialize(),this._peerChallengeNonce),t=Signature.create(this._networkConfig.keyPair.privateKey,this._networkConfig.keyPair.publicKey,e);this._channel.verack(this._networkConfig.keyPair.publicKey,t);this._verackSent=!0}_onVerAck(e){Log.d(NetworkAgent,()=>`[VERACK] from ${this._channel.peerAddress}`);if(!this._canAcceptMessage(e))return;if(this._verackReceived){Log.d(NetworkAgent,()=>`Ignoring duplicate verack message from ${this._channel.peerAddress}`);return}this._timers.clearTimeout("verack");if(!e.publicKey.toPeerId().equals(this._channel.peerAddress.peerId)){this._channel.close(CloseType.INVALID_PUBLIC_KEY_IN_VERACK_MESSAGE,"Invalid public key in verack message");return}const t=BufferUtils.concatTypedArrays(this._networkConfig.peerAddress.peerId.serialize(),this._challengeNonce);if(e.signature.verify(e.publicKey,t)){if(!this._peerAddressVerified){this._peerAddressVerified=!0;this._sendVerAck()}this._knownAddresses.add(this._channel.peerAddress);this._verackReceived=!0;this._verackSent&&this._finishHandshake()}else this._channel.close(CloseType.INVALID_SIGNATURE_IN_VERACK_MESSAGE,"Invalid signature in verack message")}_finishHandshake(){this._timers.setInterval("connectivity",()=>this._checkConnectivity(),NetworkAgent.CONNECTIVITY_CHECK_INTERVAL);this._timers.setInterval("announce-addr",()=>this._channel.addr([this._networkConfig.peerAddress]),NetworkAgent.ANNOUNCE_ADDR_INTERVAL);this.fire("handshake",this._peer,this);this._requestAddresses()}_requestAddresses(){this._channel.getAddr(this._networkConfig.protocolMask,this._networkConfig.services.accepted)}_onAddr(e){if(this._canAcceptMessage(e))if(e.addresses.length>1e3){Log.w(NetworkAgent,"Rejecting addr message - too many addresses");this._channel.close(CloseType.ADDR_MESSAGE_TOO_LARGE,"addr message too large")}else{for(const t of e.addresses){if(!t.verifySignature()){this._channel.close(CloseType.INVALID_ADDR,"invalid addr");return}if(t.protocol===Protocol.WS&&!t.globallyReachable()){this._channel.close(CloseType.ADDR_NOT_GLOBALLY_REACHABLE,"addr not globally reachable");return}this._knownAddresses.add(t)}this._addresses.add(this._channel,e.addresses);this.fire("addr",e.addresses,this)}}_onGetAddr(e){if(!this._canAcceptMessage(e))return;const t=this._addresses.query(e.protocolMask,e.serviceMask).filter(e=>{if(e.protocol===Protocol.RTC&&e.distance>=PeerAddressBook.MAX_DISTANCE)return!1;const t=this._knownAddresses.get(e);return!t||t.timestamp<Date.now()-NetworkAgent.RELAY_THROTTLE});t.length&&this._channel.addr(t)}_checkConnectivity(){const e=NumberUtils.randomUint32();if(this._channel.ping(e)){this._pingTimes.set(e,Date.now());this._timers.setTimeout(`ping_${e}`,()=>{this._timers.clearTimeout(`ping_${e}`);this._channel.close(CloseType.PING_TIMEOUT,"ping timeout");this._pingTimes["delete"](e)},NetworkAgent.PING_TIMEOUT)}else this._channel.close(CloseType.SENDING_PING_MESSAGE_FAILED,"sending ping message failed")}_onPing(e){this._canAcceptMessage(e)&&this._channel.pong(e.nonce)}_onPong(e){this._timers.clearTimeout(`ping_${e.nonce}`);const t=this._pingTimes.get(e.nonce);if(t){const r=Date.now()-t;r>0&&this.fire("ping-pong",r);this._pingTimes["delete"](e.nonce)}}_onClose(){this._timers.clearAll()}_canAcceptMessage(e){if(!this._versionReceived&&e.type!==Message.Type.VERSION){Log.w(NetworkAgent,`Discarding '${PeerChannel.Event[e.type]||e.type}' message from ${this._channel}`+" - no version message received previously");return!1}if(this._versionReceived&&!this._verackReceived&&e.type!==Message.Type.VERACK){Log.w(NetworkAgent,`Discarding '${PeerChannel.Event[e.type]||e.type}' message from ${this._channel}`+" - no verack message received previously");return!1}return!0}get channel(){return this._channel}get peer(){return this._peer}}NetworkAgent.HANDSHAKE_TIMEOUT=4e3;NetworkAgent.PING_TIMEOUT=1e4;NetworkAgent.CONNECTIVITY_CHECK_INTERVAL=6e4;NetworkAgent.ANNOUNCE_ADDR_INTERVAL=3e5;NetworkAgent.RELAY_THROTTLE=12e4;NetworkAgent.VERSION_ATTEMPTS_MAX=10;NetworkAgent.VERSION_RETRY_DELAY=500;Class.register(NetworkAgent);class PeerConnectionStatistics{constructor(){this._latencies=[];this._messages=new HashMap}reset(){this._latencies=[];this._messages=new HashMap}addLatency(e){this._latencies.push(e)}addMessage(e){this._messages.put(e.type,this._messages.contains(e.type)?this._messages.get(e.type)+1:1)}getMessageCount(e){return this._messages.contains(e)?this._messages.get(e):0}get latencyMedian(){const e=this._latencies.length;if(0===e)return 0;this._latencies.sort((e,t)=>e-t);let t;return t=e%2==0?Math.round((this._latencies[e/2-1]+this._latencies[e/2])/2):this._latencies[(e-1)/2]}}Class.register(PeerConnectionStatistics);class PeerConnection{static getOutbound(e){const t=new PeerConnection;t._peerAddress=e;t._state=PeerConnectionState.CONNECTING;return t}static getInbound(e){const t=new PeerConnection;t._networkConnection=e;return t}constructor(){this._id=PeerConnection._instanceCount++;this._peerAddress=null;this._networkConnection=null;this._peerChannel=null;this._networkAgent=null;this._peer=null;this._state=PeerConnectionState.NEW;this._closingType=null;this._score=null;this._establishedSince=null;this._statistics=new PeerConnectionStatistics}get state(){return this._state}get peerAddress(){return this._peerAddress}set peerAddress(e){this._peerAddress=e}get networkConnection(){return this._networkConnection}set networkConnection(e){this._networkConnection=e;this._state=PeerConnectionState.CONNECTED}get peerChannel(){return this._peerChannel}set peerChannel(e){this._peerChannel=e}get networkAgent(){return this._networkAgent}set networkAgent(e){this._networkAgent=e;this._state=PeerConnectionState.NEGOTIATING}get peer(){return this._peer}set peer(e){this._peer=e;this._state=PeerConnectionState.ESTABLISHED;this._establishedSince=Date.now();this._networkAgent.on("ping-pong",e=>this._statistics.addLatency(e));this._peerChannel.on("message-log",e=>this._statistics.addMessage(e))}get score(){return this._score}set score(e){this._score=e}get establishedSince(){return this._establishedSince}get ageEstablished(){return Date.now()-this.establishedSince}get statistics(){return this._statistics}}PeerConnection._instanceCount=0;Class.register(PeerConnection);class PeerConnectionState{}PeerConnectionState.NEW=1;PeerConnectionState.CONNECTING=2;PeerConnectionState.CONNECTED=3;PeerConnectionState.NEGOTIATING=4;PeerConnectionState.ESTABLISHED=5;Class.register(PeerConnectionState);class SignalProcessor{constructor(e,t,r){this._addresses=e;this._networkConfig=t;this._rtcConnector=r;this._forwards=new SignalStore}onSignal(e,t){if(t.ttl>Network.SIGNAL_TTL_INITIAL){e.close(CloseType.INVALID_SIGNAL_TTL,"invalid signal ttl");return}if(t.hasPayload()&&!t.verifySignature()){e.close(CloseType.INVALID_SIGNATURE,"invalid signature");return}const r=this._networkConfig.peerAddress.peerId;if(t.senderId.equals(r)){Log.w(SignalProcessor,`Received signal from myself to ${t.recipientId} from ${e.peerAddress} (myId: ${r})`);return}if(t.isUnroutable()&&this._forwards.signalForwarded(t.recipientId,t.senderId,t.nonce)){const r=this._addresses.getByPeerId(t.senderId);this._addresses.unroutable(e,r)}if(t.recipientId.equals(r)){if(this._rtcConnector.isValidSignal(t)&&(t.isUnroutable()||t.isTtlExceeded())){const r=this._addresses.getByPeerId(t.senderId);this._addresses.unroutable(e,r)}this._rtcConnector.onSignal(e,t);return}if(t.ttl<=0){Log.d(SignalProcessor,`Discarding signal from ${t.senderId} to ${t.recipientId} - TTL reached`);0===t.flags&&e.signal(t.recipientId,t.senderId,t.nonce,Network.SIGNAL_TTL_INITIAL,SignalMessage.Flag.TTL_EXCEEDED);return}const n=this._addresses.getChannelByPeerId(t.recipientId);if(n)if(n.peerAddress.equals(e.peerAddress)){Log.w(SignalProcessor,`Discarding signal from ${t.senderId} to ${t.recipientId} - shortest route via sending peer`);0===t.flags&&e.signal(t.recipientId,t.senderId,t.nonce,Network.SIGNAL_TTL_INITIAL,SignalMessage.Flag.UNROUTABLE)}else{n.signal(t.senderId,t.recipientId,t.nonce,t.ttl-1,t.flags,t.payload,t.senderPubKey,t.signature);0===t.flags&&this._forwards.add(t.senderId,t.recipientId,t.nonce)}else{Log.d(SignalProcessor,`Failed to forward signal from ${t.senderId} to ${t.recipientId} - no route found`);0===t.flags&&e.signal(t.recipientId,t.senderId,t.nonce,Network.SIGNAL_TTL_INITIAL,SignalMessage.Flag.UNROUTABLE)}}}Class.register(SignalProcessor);class SignalStore{constructor(e=1e3){this._maxSize=e;this._queue=new Queue;this._store=new HashMap}get length(){return this._queue.length}add(e,t,r){if(this.contains(e,t,r)){const n=new ForwardedSignal(e,t,r);this._store.put(n,Date.now());this._queue.remove(n);this._queue.enqueue(n);return}if(this.length>=this._maxSize){const e=this._queue.dequeue();this._store.remove(e)}const n=new ForwardedSignal(e,t,r);this._queue.enqueue(n);this._store.put(n,Date.now())}contains(e,t,r){const n=new ForwardedSignal(e,t,r);return this._store.contains(n)}signalForwarded(e,t,r){const n=new ForwardedSignal(e,t,r),s=this._store.get(n);if(!s)return!1;const i=s+ForwardedSignal.SIGNAL_MAX_AGE>Date.now();if(!i){const e=this._queue.dequeueUntil(n);for(const t of e)this._store.remove(t)}return i}}SignalStore.SIGNAL_MAX_AGE=10;Class.register(SignalStore);class ForwardedSignal{constructor(e,t,r){this._senderId=e;this._recipientId=t;this._nonce=r}equals(e){return e instanceof ForwardedSignal&&this._senderId.equals(e._senderId)&&this._recipientId.equals(e._recipientId)&&this._nonce===e._nonce}hashCode(){return this.toString()}toString(){return`ForwardedSignal{senderId=${this._senderId}, recipientId=${this._recipientId}, nonce=${this._nonce}}`}}Class.register(ForwardedSignal);class ConnectionPool extends Observable{constructor(e,t,r,n){super();this._addresses=e;this._networkConfig=t;this._blockchain=r;this._time=n;this._connectionsByPeerAddress=new HashMap;this._connectionsByNetAddress=new HashMap;this._bytesSent=0;this._bytesReceived=0;this._wsConnector=new WebSocketConnector(this._networkConfig);this._wsConnector.on("connection",e=>this._onConnection(e));this._wsConnector.on("error",(e,t)=>this._onConnectError(e,t));this._rtcConnector=new WebRtcConnector(this._networkConfig);this._rtcConnector.on("connection",e=>this._onConnection(e));this._rtcConnector.on("error",(e,t)=>this._onConnectError(e,t));this._peerCountWs=0;this._peerCountRtc=0;this._peerCountDumb=0;this._peerCountFull=0;this._peerCountLight=0;this._peerCountNano=0;this._connectingCount=0;this._inboundCount=0;this._signalProcessor=new SignalProcessor(e,t,this._rtcConnector);this._allowInboundExchange=!1}values(){return Array.from(this._connectionsByPeerAddress.values())}getConnectionByPeerAddress(e){return this._connectionsByPeerAddress.get(e)}getConnectionsByNetAddress(e){return this._connectionsByNetAddress.get(e)||[]}isEstablished(e){const t=this.getConnectionByPeerAddress(e);return t&&t.state===PeerConnectionState.ESTABLISHED}_add(e){e.peerAddress&&this._connectionsByPeerAddress.put(e.peerAddress,e)}_remove(e){e.peerAddress&&this._connectionsByPeerAddress.remove(e.peerAddress);e.networkConnection&&e.networkConnection.netAddress&&this._removeNetAddress(e,e.networkConnection.netAddress)}_addNetAddress(e,t){this._connectionsByNetAddress.contains(t)?this._connectionsByNetAddress.get(t).push(e):this._connectionsByNetAddress.put(t,[e])}_removeNetAddress(e,t){if(this._connectionsByNetAddress.contains(t)){const r=this._connectionsByNetAddress.get(t),n=r.indexOf(e);n>=0&&r.splice(n,1);0===r.length&&this._connectionsByNetAddress.remove(t)}}_hasPriority(e){return 0===this.peerCountFull&&Services.isFullNode(e.services)}_checkOutboundConnectionRequest(e){if(null===e)return!1;if(e.protocol!==Protocol.WS&&e.protocol!==Protocol.RTC){Log.e(Network,"Cannot connect to {$this.peerAddress} - unsupported protocol");return!1}if(this._addresses.isBanned(e)){Log.e(Network,`Connecting to banned address ${e}`);return!1}if(this.getConnectionByPeerAddress(e)){Log.e(Network,`Duplicate connection to ${e}`);return!1}if(e.netAddress&&!e.netAddress.isPseudo()&&this.getConnectionsByNetAddress(e.netAddress).length>Network.PEER_COUNT_PER_IP_MAX){Log.e(ConnectionPool,`connection limit per ip (${Network.PEER_COUNT_PER_IP_MAX}) reached`);return!1}if(this.peerCount>=Network.PEER_COUNT_MAX&&!this._hasPriority(e)){Log.e(ConnectionPool,`max peer count reached (${Network.PEER_COUNT_MAX})`);return!1}return!0}_checkConnection(e){if(e.netAddress&&!e.netAddress.isPseudo()&&this.getConnectionsByNetAddress(e.netAddress).length>=Network.PEER_COUNT_PER_IP_MAX){e.close(CloseType.CONNECTION_LIMIT_PER_IP,`connection limit per ip (${Network.PEER_COUNT_PER_IP_MAX}) reached`);return!1}if(!(!(this.peerCount>=Network.PEER_COUNT_MAX)||e.outbound&&this._hasPriority(e.peerAddress)||e.inbound&&this._allowInboundExchange)){e.close(CloseType.MAX_PEER_COUNT_REACHED,`max peer count reached (${Network.PEER_COUNT_MAX})`);return!1}return!0}_checkHandshake(e,t){if(this.isEstablished(t.peerAddress)){e.peerChannel.close(CloseType.DUPLICATE_CONNECTION,`Duplicate connection to ${t.peerAddress} (post-handshake)`);return!1}if(this._addresses.isBanned(t.peerAddress)){e.peerChannel.close(CloseType.PEER_IS_BANNED,`Connection with banned address ${t.peerAddress} (post-handshake)`);return!1}if(t.netAddress&&!t.netAddress.isPseudo()&&this.getConnectionsByNetAddress(t.netAddress).length>Network.PEER_COUNT_PER_IP_MAX){e.peerChannel.close(CloseType.CONNECTION_LIMIT_PER_IP,`connection limit per ip (${Network.PEER_COUNT_PER_IP_MAX}) reached (post-handshake)`);return!1}return!0}connectOutbound(e){if(!this._checkOutboundConnectionRequest(e))return!1;const t=PeerConnection.getOutbound(e);this._add(t);let r=!1;if(e.protocol===Protocol.WS)r=this._wsConnector.connect(e);else{const t=this._addresses.getChannelByPeerId(e.peerId);r=this._rtcConnector.connect(e,t)}if(!r){this._remove(t);Log.d(Network,`Outbound attempt not connecting: ${e}`);return!1}this._connectingCount++;return!0}_onConnection(e){let t;if(e.outbound){this._connectingCount--;t=this.getConnectionByPeerAddress(e.peerAddress);Assert.that(t,`Connecting to outbound peer address not stored ${e.peerAddress}`);Assert.that(t.state===PeerConnectionState.CONNECTING,`PeerConnection state not CONNECTING ${e.peerAddress}`)}else{t=PeerConnection.getInbound(e);this._inboundCount++}t.networkConnection=e;e.on("close",(e,r)=>this._onClose(t,e,r));if(!this._checkConnection(e))return;e.netAddress&&!e.netAddress.isPseudo()&&this._addNetAddress(t,e.netAddress);const r=e.inbound?"inbound":"outbound";Log.d(ConnectionPool,`Connection established (${r}) #${e.id} ${e.netAddress||e.peerAddress||"<pending>"}`);this.fire("connection",e);const n=new PeerChannel(e);n.on("signal",e=>this._signalProcessor.onSignal(n,e));t.peerChannel=n;const s=new NetworkAgent(this._blockchain,this._addresses,this._networkConfig,n);s.on("version",e=>this._checkHandshake(t,e));s.on("handshake",e=>this._onHandshake(t,e));t.networkAgent=s;s.handshake()}_onHandshake(e,t){this.peerCount>=Network.PEER_COUNT_MAX&&this.fire("recycling-request");if(e.networkConnection.inbound){e.peerAddress=t.peerAddress;this._add(e);this._inboundCount--}e.peer=t;t.netAddress&&!t.netAddress.isPseudo()&&this.getConnectionsByNetAddress(t.netAddress).indexOf(e)<0&&this._addNetAddress(e,t.netAddress);this._updateConnectedPeerCount(t.peerAddress,1);this._addresses.established(t.channel,t.peerAddress);this.fire("peer-joined",t);this.fire("peers-changed");Log.d(ConnectionPool,()=>`[PEER-JOINED] ${t.peerAddress} ${t.netAddress} (version=${t.version}, services=${t.peerAddress.services}, headHash=${t.headHash.toBase64()})`)}_onClose(e,t,r){this._bytesSent+=e.networkConnection.bytesSent;this._bytesReceived+=e.networkConnection.bytesReceived;e.peerAddress&&this._addresses.close(e.peerChannel,e.peerAddress,t);this._remove(e);if(e.state===PeerConnectionState.ESTABLISHED){this._updateConnectedPeerCount(e.peerAddress,-1);this.fire("peer-left",e.peer);this.fire("peers-changed");const n=((e.networkConnection.bytesSent+e.networkConnection.bytesReceived)/1e3).toFixed(2);Log.d(ConnectionPool,`[PEER-LEFT] ${e.peerAddress} ${e.peer.netAddress} `+`(version=${e.peer.version}, transferred=${n} kB, closingType=${t} ${r})`)}else if(e.networkConnection.inbound){this._inboundCount--;Log.w(ConnectionPool,`Inbound connection closed pre-handshake: ${r} (${t})`)}else{Log.w(ConnectionPool,`Connection to ${e.peerAddress} closed pre-handshake: ${r} (${t})`);this.fire("connect-error",e.peerAddress,`${r} (${t})`)}this.fire("close",e,t,r)}_onConnectError(e,t){Log.w(ConnectionPool,`Connection to ${e} failed`+("string"==typeof t?` - ${t}`:""));const r=this.getConnectionByPeerAddress(e);Assert.that(r&&r.state===PeerConnectionState.CONNECTING);this._remove(r);this._connectingCount--;this._addresses.close(null,e,CloseType.CONNECTION_FAILED);this.fire("connect-error",e,t)}_updateConnectedPeerCount(e,t){switch(e.protocol){case Protocol.WS:this._peerCountWs+=t;break;case Protocol.RTC:this._peerCountRtc+=t;break;case Protocol.DUMB:this._peerCountDumb+=t;break;default:Log.w(PeerAddressBook,`Unknown protocol ${e.protocol}`)}Services.isFullNode(e.services)?this._peerCountFull+=t:Services.isLightNode(e.services)?this._peerCountLight+=t:this._peerCountNano+=t}disconnect(e){for(const t of this.values())t.peerChannel&&t.peerChannel.close(CloseType.MANUAL_NETWORK_DISCONNECT,e||"manual network disconnect")}disconnectWebSocket(){for(const e of this.values())e.peerChannel&&e.peerAddress&&e.peerAddress.protocol===Protocol.WS&&e.channel.close(CloseType.MANUAL_WEBSOCKET_DISCONNECT,"manual websocket disconnect")}get peerCountWs(){return this._peerCountWs}get peerCountRtc(){return this._peerCountRtc}get peerCountDumb(){return this._peerCountDumb}get peerCount(){return this._peerCountWs+this._peerCountRtc+this._peerCountDumb}get peerCountFull(){return this._peerCountFull}get peerCountLight(){return this._peerCountLight}get peerCountNano(){return this._peerCountNano}get connectingCount(){return this._connectingCount}get count(){return this._connectionsByPeerAddress.length+this._inboundCount}get bytesSent(){return this._bytesSent+this.values().reduce((e,t)=>e+(t.networkConnection?t.networkConnection.bytesSent:0),0)}get bytesReceived(){return this._bytesReceived+this.values().reduce((e,t)=>e+(t.networkConnection?t.networkConnection.bytesReceived:0),0)}set allowInboundExchange(e){this._allowInboundExchange=e}}Class.register(ConnectionPool);class PeerScorer extends Observable{constructor(e,t,r){super();this._networkConfig=e;this._addresses=t;this._connections=r;this._connectionScores=null}pickAddress(){const e=this._addresses.values(),t=e.length,r=Math.floor(Math.random()*t),n=Math.min(t,1e3),s=new HashMap;for(let o=0;o<t;o++){const i=e[(r+o)%t],a=this._scoreAddress(i);if(a>=0){s.put(a,i);if(s.length>=n)break}}if(0===s.length)return null;const i=s.keys().sort((e,t)=>t-e);return s.get(i[0]).peerAddress}_scoreAddress(e){const t=e.peerAddress;if(!this._networkConfig.canConnect(t.protocol))return-1;if(t.exceedsAge())return-1;if(this._connections.getConnectionByPeerAddress(t))return-1;if(t.exceedsAge())return-1;const r=(this._scoreProtocol(t)+this._scoreServices(t))*(t.timestamp/1e3+1);switch(e.state){case PeerAddressState.BANNED:return-1;case PeerAddressState.NEW:case PeerAddressState.TRIED:return r;case PeerAddressState.FAILED:return(1-(e.failedAttempts+1)/e.maxFailedAttempts)*r;default:return-1}}_scoreProtocol(e){let t=1;this._connections.peerCountWs<2?t*=e.protocol===Protocol.WS?3:1:t*=e.protocol===Protocol.RTC?3:1;e.protocol===Protocol.RTC&&(t*=1+(PeerAddressBook.MAX_DISTANCE-e.distance)/2);return t}_scoreServices(e){return this._connections.peerCount>2&&0===this._connections.peerCountFull&&Services.isFullNode(e.services)?10:0}scoreConnections(){const e=[];for(const t of this._connections.values())if(t.state===PeerConnectionState.ESTABLISHED){if(t.ageEstablished>PeerScorer._getMinAge(t.peerAddress)){t.score=this._scoreConnection(t);e.push(t)}t.statistics.reset()}this._connectionScores=e.sort((e,t)=>t.score-e.score)}recycleConnections(e,t,r){if(this._connectionScores)for(;e>0&&this._connectionScores.length>0;){const n=this._connectionScores.pop();if(n.state===PeerConnectionState.ESTABLISHED){n.peerChannel.close(t,`${r}`);e--}}}_scoreConnection(e){const t=this._scoreConnectionAge(e),r=e.networkConnection.inbound?0:1;let n=0;this._connections.peerCountWs/this._connections.peerCount<PeerScorer.BEST_PROTOCOL_WS_DISTRIBUTION&&e.peerAddress.protocol===Protocol.WS&&(n=1);const s=e.statistics.latencyMedian;let i=0;s>0&&s<NetworkAgent.PING_TIMEOUT&&(i=1-s/NetworkAgent.PING_TIMEOUT);return.4*t+.2*r+.2*n+.2*i}_scoreConnectionAge(e){const t=(e,t,r)=>Math.max(Math.min(1-(e-t)/r,1),0),r=e.ageEstablished,n=e.peerAddress.services;return Services.isFullNode(n)?r/(2*PeerScorer.BEST_AGE_FULL)+.5:Services.isLightNode(n)?t(r,PeerScorer.BEST_AGE_LIGHT,PeerScorer.MAX_AGE_LIGHT):t(r,PeerScorer.BEST_AGE_NANO,PeerScorer.MAX_AGE_NANO)}static _getMinAge(e){return Services.isFullNode(e.services)?PeerScorer.MIN_AGE_FULL:Services.isLightNode(e.services)?PeerScorer.MIN_AGE_LIGHT:PeerScorer.MIN_AGE_NANO}get connectionScores(){return this._connectionScores}get lowestConnectionScore(){return this._connectionScores&&this._connectionScores.length>0?this._connectionScores[this._connectionScores.length-1].score:null}}PeerScorer.MIN_AGE_FULL=3e5;PeerScorer.BEST_AGE_FULL=864e5;PeerScorer.MIN_AGE_LIGHT=12e4;PeerScorer.BEST_AGE_LIGHT=9e5;PeerScorer.MAX_AGE_LIGHT=216e5;PeerScorer.MIN_AGE_NANO=6e4;PeerScorer.BEST_AGE_NANO=3e5;PeerScorer.MAX_AGE_NANO=18e5;PeerScorer.BEST_PROTOCOL_WS_DISTRIBUTION=.15;Class.register(PeerScorer);class NetworkConfig{static getDefault(){return PlatformUtils.supportsWebRTC()?new RtcNetworkConfig:new DumbNetworkConfig}constructor(e){this._protocolMask=e;this._keyPair=null;this._peerId=null;this._services=null}initPersistent(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield PeerKeyStore.getPersistent();yield e._init(t)})()}initVolatile(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=PeerKeyStore.createVolatile();yield e._init(t)})()}_init(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(t._keyPair)return;let r=yield e.get("keys");if(!r){r=KeyPair.generate();yield e.put("keys",r)}t._keyPair=r;t._peerId=r.publicKey.toPeerId()})()}get protocolMask(){return this._protocolMask}get keyPair(){return this._keyPair}get publicKey(){return this._keyPair.publicKey}get peerId(){return this._peerId}get services(){return this._services}set services(e){this._services=e}get peerAddress(){throw new Error("Not implemented")}canConnect(e){return 0!=(e&this._protocolMask)}}Class.register(NetworkConfig);Class.register(class WsNetworkConfig extends NetworkConfig{constructor(e,t,r,n){super(Protocol.WS);this._host=e;this._port=t;this._key=r;this._cert=n;this._sslConfig={key:this._key,cert:this._cert}}get sslConfig(){return this._sslConfig}get peerAddress(){if(!this._services||!this._keyPair)throw"PeerAddress is not configured.";const e=new WsPeerAddress(this._services.provided,Date.now(),NetAddress.UNSPECIFIED,this.publicKey,0,this._host,this._port);if(!e.globallyReachable())throw"PeerAddress not globally reachable.";e.signature=Signature.create(this._keyPair.privateKey,this.publicKey,e.serializeContent());return e}});class RtcNetworkConfig extends NetworkConfig{constructor(){super(Protocol.WS|Protocol.RTC);this._rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.nimiq-network.com:19302"}]}}get rtcConfig(){return this._rtcConfig}get peerAddress(){if(!this._services||!this._keyPair)throw"PeerAddress is not configured.";const e=new RtcPeerAddress(this._services.provided,Date.now(),NetAddress.UNSPECIFIED,this.publicKey,0);e.signature=Signature.create(this._keyPair.privateKey,this.publicKey,e.serializeContent());return e}}Class.register(RtcNetworkConfig);class DumbNetworkConfig extends NetworkConfig{constructor(){super(Protocol.WS)}get peerAddress(){if(!this._services||!this._keyPair)throw"PeerAddress is not configured.";const e=new DumbPeerAddress(this._services.provided,Date.now(),NetAddress.UNSPECIFIED,this.publicKey,0);e.signature=Signature.create(this._keyPair.privateKey,this.publicKey,e.serializeContent());return e}}Class.register(DumbNetworkConfig);class Network extends Observable{constructor(e,t,r){super();this._blockchain=e;this._networkConfig=t;this._time=r;this._autoConnect=!1;this._backoff=Network.CONNECT_BACKOFF_INITIAL;this._backedOff=!1;this._addresses=new PeerAddressBook(this._networkConfig);this._addresses.on("added",e=>{this._relayAddresses(e);this._checkPeerCount()});this._connections=new ConnectionPool(this._addresses,t,e,r);this._connections.on("peer-joined",e=>this._onPeerJoined(e));this._connections.on("peer-left",e=>this._onPeerLeft(e));this._connections.on("peers-changed",()=>this._onPeersChanged());this._connections.on("recycling-request",()=>this._onRecyclingRequest());this._connections.on("connect-error",()=>this._checkPeerCount());this._scorer=new PeerScorer(this._networkConfig,this._addresses,this._connections);this._houseKeepingIntervalId=null}connect(){this._autoConnect=!0;this._houseKeepingIntervalId=setInterval(()=>this._housekeeping(),Network.HOUSEKEEPING_INTERVAL);this._checkPeerCount()}disconnect(e){this._autoConnect=!1;clearInterval(this._houseKeepingIntervalId);this._connections.disconnect(e)}disconnectWebSocket(){this._autoConnect=!1;this._connections.disconnectWebSocket()}_onPeerJoined(e){this._updateTimeOffset();this._relayAddresses([e.peerAddress]);this.fire("peer-joined",e)}_onPeerLeft(e){this._updateTimeOffset();this.fire("peer-left",e)}_onPeersChanged(){this._checkPeerCount();this.fire("peers-changed")}_onRecyclingRequest(){this._scorer.recycleConnections(1,CloseType.PEER_CONNECTION_RECYCLED_INBOUND_EXCHANGE,"Peer connection recycled inbound exchange");this._connections.allowInboundExchange=null!==this._scorer.lowestConnectionScore&&this._scorer.lowestConnectionScore<Network.SCORE_INBOUND_EXCHANGE}_relayAddresses(e){if(e.length>10)return;const t=this._connections.values();for(let r=0;r<Network.PEER_COUNT_RELAY;++r){const r=ArrayUtils.randomElement(t);r&&r.state===PeerConnectionState.ESTABLISHED&&r.networkAgent&&r.networkAgent.relayAddresses(e)}}_checkPeerCount(){if(this._autoConnect&&(this._connections.count<Network.PEER_COUNT_DESIRED||0===this._connections.peerCountFull)&&this._connections.connectingCount<Network.CONNECTING_COUNT_MAX){const e=this._scorer.pickAddress();if(!e){if(!this._backedOff){this._backedOff=!0;const e=this._backoff;this._backoff=Math.min(Network.CONNECT_BACKOFF_MAX,2*e);setTimeout(()=>{this._backedOff=!1;this._checkPeerCount()},e);0===this._connections.count&&this.fire("disconnected")}return}if(!this._connections.connectOutbound(e)){this._addresses.close(null,e,CloseType.CONNECTION_FAILED);setTimeout(()=>this._checkPeerCount(),0)}}this._backoff=Network.CONNECT_BACKOFF_INITIAL}_updateTimeOffset(){const e=[0];this._connections.values().forEach(t=>{t.state===PeerConnectionState.ESTABLISHED&&e.push(t.networkAgent.peer.timeOffset)});const t=e.length;e.sort((e,t)=>e-t);let r;r=t%2==0?Math.round((e[t/2-1]+e[t/2])/2):e[(t-1)/2];this._time.offset=Math.max(Math.min(r,Network.TIME_OFFSET_MAX),-Network.TIME_OFFSET_MAX)}_housekeeping(){this._scorer.scoreConnections();if(this.peerCount>Network.PEER_COUNT_RECYCLING_ACTIVE){const e=.19*(this.peerCount-Network.PEER_COUNT_RECYCLING_ACTIVE)/(Network.PEER_COUNT_MAX-Network.PEER_COUNT_RECYCLING_ACTIVE)+.01,t=Math.ceil(this.peerCount*e);this._scorer.recycleConnections(t,CloseType.PEER_CONNECTION_RECYCLED,"Peer connection recycled")}this._connections.allowInboundExchange=null!==this._scorer.lowestConnectionScore&&this._scorer.lowestConnectionScore<Network.SCORE_INBOUND_EXCHANGE}get time(){return this._time}get peerCount(){return this._connections.peerCount}get peerCountWebSocket(){return this._connections.peerCountWs}get peerCountWebRtc(){return this._connections.peerCountRtc}get peerCountDumb(){return this._connections.peerCountDumb}get peerCountConnecting(){return this._connections.connectingCount}get knownAddressesCount(){return this._addresses.knownAddressesCount}get bytesSent(){return this._connections.bytesSent}get bytesReceived(){return this._connections.bytesReceived}}Network.PEER_COUNT_MAX=PlatformUtils.isBrowser()?15:5e4;Network.PEER_COUNT_PER_IP_MAX=PlatformUtils.isBrowser()?2:25;Network.PEER_COUNT_RECYCLING_ACTIVE=PlatformUtils.isBrowser()?5:1e3;Network.PEER_COUNT_DESIRED=6;Network.PEER_COUNT_RELAY=4;Network.CONNECTING_COUNT_MAX=2;Network.SIGNAL_TTL_INITIAL=3;Network.ADDRESS_UPDATE_DELAY=1e3;Network.CONNECT_BACKOFF_INITIAL=1e3;Network.CONNECT_BACKOFF_MAX=3e5;Network.TIME_OFFSET_MAX=9e5;Network.HOUSEKEEPING_INTERVAL=3e5;Network.SCORE_INBOUND_EXCHANGE=.5;Class.register(Network);class NetUtils{static isPrivateIP(e){if(NetUtils.isLocalIP(e))return!0;if(NetUtils.isIPv4Address(e)){for(const t of NetUtils.IPv4_PRIVATE_NETWORK)if(NetUtils.isIPv4inSubnet(e,t))return!0;return!1}if(NetUtils.isIPv6Address(e)){const t=e.toLowerCase().split(":");return NetUtils.isIPv4Address(t[t.length-1])?NetUtils.isPrivateIP(t[t.length-1]):64512==(-512&parseInt(t[0],16))||65152==(-64&parseInt(t[0],16))}throw`Malformed IP address ${e}`}static isLocalIP(e){const t=NetUtils._normalizeIP(e);return NetUtils.isIPv4Address(e)?"127.0.0.1"===t:"::1"===t}static isIPv4inSubnet(e,t){let[r,n]=t.split("/");n=-1<<32-parseInt(n);return(NetUtils._IPv4toLong(e)&n)===NetUtils._IPv4toLong(r)}static isIPv4Address(e){const t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return!!t&&parseInt(t[1])<=255&&parseInt(t[2])<=255&&parseInt(t[3])<=255&&parseInt(t[4])<=255}static isIPv6Address(e){const t=e.toLowerCase().split(":");if(t.length>8||t.length<3)return!1;const r=NetUtils.isIPv4Address(t[t.length-1]);let n=!1;for(let s=0;s<t.length;++s){if(!(/^[a-f0-9]{0,4}$/.test(t[s])||s===t.length-1&&r&&t.length<8))return!1;if(0===t[s].length&&s>0&&s<t.length-1){if(n)return!1;n=!0}}if(r)for(let s=0;s<t.length-2;++s)if(!/^0{0,4}$/.test(t[s]))return!1;return 0===t[0].length?0===t[1].length:0===t[t.length-1].length?0===t[t.length-2].length:r&&t.length<7?n:!(t.length<8)||n}static sanitizeIP(e){const t=NetUtils._normalizeIP(e);if(NetUtils.IP_BLACKLIST.indexOf(t)>=0)throw`Malformed IP address ${e}`;return t}static hostGloballyReachable(e){return!NetUtils.isIPv4Address(e)&&!NetUtils.isIPv6Address(e)&&!!e.match(/.+\..+$/)}static _normalizeIP(e){if(NetUtils.isIPv4Address(e)){const t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return`${parseInt(t[1])}.${parseInt(t[2])}.${parseInt(t[3])}.${parseInt(t[4])}`}if(NetUtils.isIPv6Address(e)){const t=(e=e.toLowerCase()).split(":");if(NetUtils.isIPv4Address(t[t.length-1]))return NetUtils._normalizeIP(t[t.length-1]);const r=t.indexOf("");if(r>=0){t[r]="0";r>0&&""===t[r-1]&&(t[r-1]="0");r<t.length-1&&""===t[r+1]&&(t[r+1]="0");const e=8-t.length;for(let n=0;n<e;++n)t.splice(r,0,"0")}let n=-1,s=0,i=-1,o=1;for(let e=0;e<t.length;++e){t[e]=t[e].replace(/^0+([a-f0-9])/,"$1");if("0"===t[e])i<0?i=e:o++;else if(i>=0&&o>s){n=i;s=o;i=-1;o=1}}if(i>=0&&o>s){n=i;s=o}if(n>=0&&s>1){if(s===t.length)return"::";0===n||n+s===t.length?t.splice(n,s,":"):t.splice(n,s,"")}return t.join(":")}throw`Malformed IP address ${e}`}static _IPv4toLong(e){const t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return(parseInt(t[1])<<24)+(parseInt(t[2])<<16)+(parseInt(t[3])<<8)+parseInt(t[4])}}NetUtils.IP_BLACKLIST=["0.0.0.0","255.255.255.255","::"];NetUtils.IPv4_PRIVATE_NETWORK=["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","100.64.0.0/10","169.254.0.0/16"];Class.register(NetUtils);class PeerKeyStore{static getPersistent(){return(0,_asyncToGenerator3["default"])(function*(){if(!PeerKeyStore._instance){const e=new JDB.JungleDB("peer-key",PeerKeyStore.VERSION);e.createObjectStore(PeerKeyStore.KEY_DATABASE,new PeerKeyStoreCodec);yield e.connect();PeerKeyStore._instance=new PeerKeyStore(e.getObjectStore(PeerKeyStore.KEY_DATABASE))}return PeerKeyStore._instance})()}static createVolatile(){const e=JDB.JungleDB.createVolatileObjectStore();return new PeerKeyStore(e)}constructor(e){this._store=e}get(e){return this._store.get(e)}put(e,t){return this._store.put(e,t)}}PeerKeyStore._instance=null;PeerKeyStore.VERSION=2;PeerKeyStore.KEY_DATABASE="keys";Class.register(PeerKeyStore);class PeerKeyStoreCodec{encode(e){return e.serialize()}decode(e,t){return KeyPair.unserialize(new SerialBuffer(e))}get valueEncoding(){return"binary"}}class Peer{constructor(e,t,r,n){this._channel=e;this._version=t;this._headHash=r;this._timeOffset=n;this._setNetAddress()}_setNetAddress(){if(this.channel.netAddress){this.peerAddress.netAddress&&!this.peerAddress.netAddress.equals(this.channel.netAddress)&&Log.w(Peer,`Got different netAddress ${this.channel.netAddress} for ${this.peerAddress} `+`- advertised was ${this.peerAddress.netAddress}`);this.channel.netAddress.isPrivate()||(this.peerAddress.netAddress=this.channel.netAddress)}else this.channel.peerAddress.netAddress?this.channel.netAddress=this.channel.peerAddress.netAddress:this.channel.netAddress=NetAddress.UNKNOWN}get channel(){return this._channel}get version(){return this._version}get headHash(){return this._headHash}get timeOffset(){return this._timeOffset}get id(){return this._channel.id}get peerAddress(){return this._channel.peerAddress}get netAddress(){return this._channel.netAddress}equals(e){return e instanceof Peer&&this._channel.equals(e.channel)}hashCode(){return this._channel.hashCode()}toString(){return`Peer{version=${this._version}, headHash=${this._headHash}, `+`peerAddress=${this.peerAddress}, netAddress=${this.netAddress}}`}}Class.register(Peer);class Miner extends Observable{constructor(e,t,r,n,s,i=new Uint8Array(0)){super();this._blockchain=e;this._accounts=t;this._mempool=r;this._time=n;this._address=s;this._extraData=i;this._hashCount=0;this._lastHashrate=0;this._hashrateWorker=null;this._hashrate=0;this._lastHashCounts=[];this._totalHashCount=0;this._lastElapsed=[];this._totalElapsed=0;this._workerPool=new MinerWorkerPool;if("object"==typeof navigator&&navigator.hardwareConcurrency)this.threads=Math.ceil(navigator.hardwareConcurrency/2);else if(PlatformUtils.isNodeJs()){const e=require("os").cpus().length;this.threads=Math.ceil(e/2);1===e&&(this.throttleAfter=2)}else this.threads=1;this._workerPool.on("share",e=>this._onWorkerShare(e));this._workerPool.on("no-share",e=>this._onWorkerShare(e));this._mempoolChanged=!1;this._restarting=!1;this._lastRestart=0;this._submittingBlock=!1;this._mempool.on("transactions-ready",()=>this._startWork());this._mempool.on("transaction-added",()=>this._mempoolChanged=!0)}startWork(){if(!this.working){this._hashCount=0;this._lastElapsed=[];this._lastHashCounts=[];this._totalHashCount=0;this._totalElapsed=0;this._lastHashrate=Date.now();this._hashrateWorker=setInterval(()=>this._updateHashrate(),1e3);this._retry=0;this.fire("start",this);this._startWork()["catch"](Log.w.tag(Miner))}}_startWork(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if(e.working&&!e._restarting)try{e._lastRestart=Date.now();e._restarting=!0;e._mempoolChanged=!1;e._retry=0;const r=yield e.getNextBlock();Log.i(Miner,`Starting work on ${r.header}, transactionCount=${r.transactionCount}, hashrate=${e._hashrate} H/s`);e._workerPool.startMiningOnBlock(r)["catch"](Log.w.tag(Miner))}catch(t){Log.w(Miner,"Failed to start work, retrying in 100ms");e.stopWork();setTimeout(function(){return e.startWork()},100)}finally{e._restarting=!1}})()}_onWorkerShare(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){t._hashCount+=t._workerPool.noncesPerRun;if(e.block&&e.block.prevHash.equals(t._blockchain.headHash)){Log.d(Miner,function(){return`Received share: ${e.nonce} / ${e.hash.toHex()}`});if(BlockUtils.isProofOfWork(e.hash,e.block.target)&&!t._submittingBlock){e.block.header.nonce=e.nonce;t._submittingBlock=!0;if(yield e.block.header.verifyProofOfWork()){t.fire("block-mined",e.block,t);if((yield t._blockchain.pushBlock(e.block))<0){t._submittingBlock=!1;t._startWork()["catch"](Log.w.tag(Miner));return}t._submittingBlock=!1}else Log.d(Miner,`Ignoring invalid share: ${yield e.block.header.pow()}`)}}t._mempoolChanged&&t._lastRestart+Miner.MIN_TIME_ON_BLOCK<Date.now()&&t._startWork()["catch"](Log.w.tag(Miner))})()}getNextBlock(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._retry++;try{const r=yield e._blockchain.getNextTarget(),n=yield e._getNextInterlink(r),s=yield e._getNextBody(n.serializedSize),i=yield e._getNextHeader(r,n,s);return(yield e._blockchain.getNextTarget())!==r?e.getNextBlock():new Block(i,n,s)}catch(t){if(e._retry<=3)return e.getNextBlock();throw t}})()}_getNextHeader(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=n._blockchain.headHash,i=t.hash(),o=n._blockchain.height+1,a=yield n._accounts.transaction();let c;try{yield a.commitBlockBody(r,o,n._blockchain.transactionCache);c=yield a.hash();yield a.abort()}catch(d){yield a.abort();throw new Error(`Invalid block body: ${d.message}`)}const l=r.hash(),h=n._getNextTimestamp(),u=BlockUtils.targetToCompact(e);return new BlockHeader(s,i,l,c,u,o,h,0)})()}_getNextInterlink(e){return this._blockchain.head.getNextInterlink(e)}_getNextBody(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=Policy.BLOCK_SIZE_MAX-BlockHeader.SERIALIZED_SIZE-e-BlockBody.getMetadataSize(t._extraData),n=yield t._mempool.getTransactionsForBlock(r),s=yield t._accounts.gatherToBePrunedAccounts(n,t._blockchain.height+1,t._blockchain.transactionCache);return new BlockBody(t._address,n,t._extraData,s)})()}_getNextTimestamp(){const e=Math.floor(this._time.now()/1e3);return Math.max(e,this._blockchain.head.timestamp+1)}stopWork(){if(this.working){clearInterval(this._hashrateWorker);this._hashrateWorker=null;this._hashrate=0;this._lastElapsed=[];this._lastHashCounts=[];this._totalHashCount=0;this._totalElapsed=0;this._workerPool.stop();this.fire("stop",this);Log.i(Miner,"Stopped work")}}_updateHashrate(){const e=(Date.now()-this._lastHashrate)/1e3,t=this._hashCount;this._hashCount=0;this._lastHashrate=Date.now();this._lastElapsed.push(e);this._lastHashCounts.push(t);this._totalElapsed+=e;this._totalHashCount+=t;if(this._lastElapsed.length>Miner.MOVING_AVERAGE_MAX_SIZE){const e=this._lastElapsed.shift(),t=this._lastHashCounts.shift();this._totalElapsed-=e;this._totalHashCount-=t}this._hashrate=Math.round(this._totalHashCount/this._totalElapsed);this.fire("hashrate-changed",this._hashrate,this)}get address(){return this._address}get working(){return!!this._hashrateWorker}get hashrate(){return this._hashrate}get threads(){return this._workerPool.poolSize}set threads(e){this._workerPool.poolSize=e}get throttleWait(){return this._workerPool.cycleWait}set throttleWait(e){this._workerPool.cycleWait=e}get throttleAfter(){return this._workerPool.runsPerCycle}set throttleAfter(e){this._workerPool.runsPerCycle=e}}Miner.MIN_TIME_ON_BLOCK=1e4;Miner.MOVING_AVERAGE_MAX_SIZE=10;Class.register(Miner);class Wallet{static generate(){return(0,_asyncToGenerator3["default"])(function*(){yield Crypto.prepareSyncCryptoWorker();return new Wallet(KeyPair.generate())})()}static loadPlain(e){"string"==typeof e&&(e=BufferUtils.fromHex(e));if(!e||0===e.byteLength)throw new Error("Invalid wallet seed");return new Wallet(KeyPair.unserialize(new SerialBuffer(e)))}static loadEncrypted(e,t){return(0,_asyncToGenerator3["default"])(function*(){"string"==typeof e&&(e=BufferUtils.fromHex(e));"string"==typeof t&&(t=BufferUtils.fromAscii(t));return new Wallet(yield KeyPair.fromEncrypted(new SerialBuffer(e),t))})()}constructor(e){this._keyPair=e;this._address=this._keyPair.publicKey.toAddress()}createTransaction(e,t,r,n){const s=new BasicTransaction(this._keyPair.publicKey,e,t,r,n);s.signature=Signature.create(this._keyPair.privateKey,this._keyPair.publicKey,s.serializeContent());return s}exportPlain(){return this._keyPair.serialize()}exportEncrypted(e,t){"string"==typeof e&&(e=BufferUtils.fromAscii(e));"string"==typeof t&&(t=BufferUtils.fromAscii(t));return this._keyPair.exportEncrypted(e,t)}get isLocked(){return this.keyPair.isLocked}lock(e){"string"==typeof e&&(e=BufferUtils.fromAscii(e));return this.keyPair.lock(e)}relock(){this.keyPair.relock()}unlock(e){"string"==typeof e&&(e=BufferUtils.fromAscii(e));return this.keyPair.unlock(e)}equals(e){return e instanceof Wallet&&this.keyPair.equals(e.keyPair)&&this.address.equals(e.address)}get address(){return this._address}get publicKey(){return this._keyPair.publicKey}get keyPair(){return this._keyPair}}Class.register(Wallet);class MultiSigWallet extends Wallet{static fromPublicKeys(e,t,r){if(0===r.length)throw new Error("publicKeys may not be empty");if(t<=0)throw new Error("minSignatures must be greater than 0");if(!r.some(t=>t.equals(e.publicKey)))throw new Error("Own publicKey must be part of publicKeys");(r=r.slice()).sort((e,t)=>e.compare(t));const n=[...ArrayUtils.k_combinations(r,t)].map(e=>PublicKey.sum(e));return new MultiSigWallet(e,t,n)}static _loadMultiSig(e,t){const r=t.readUint8(),n=t.readUint8(),s=[];for(let i=0;i<n;++i)s.push(PublicKey.unserialize(t));return new MultiSigWallet(e,r,s)}static loadPlain(e){"string"==typeof e&&(e=BufferUtils.fromHex(e));if(!e||0===e.byteLength)throw new Error("Invalid wallet seed");const t=new SerialBuffer(e),r=KeyPair.unserialize(t);return MultiSigWallet._loadMultiSig(r,t)}static loadEncrypted(e,t){return(0,_asyncToGenerator3["default"])(function*(){"string"==typeof e&&(e=BufferUtils.fromHex(e));"string"==typeof t&&(t=BufferUtils.fromAscii(t));const r=new SerialBuffer(e),n=yield KeyPair.fromEncrypted(r,t);return MultiSigWallet._loadMultiSig(n,r)})()}constructor(e,t,r){super(e);this._minSignatures=t;this._publicKeys=r;this._publicKeys.sort((e,t)=>e.compare(t));const n=MerkleTree.computeRoot(this._publicKeys);this._address=Address.fromHash(n)}exportPlain(){const e=new SerialBuffer(this.exportedSize);this._keyPair.serialize(e);e.writeUint8(this._minSignatures);e.writeUint8(this._publicKeys.length);for(const t of this._publicKeys)t.serialize(e);return e}exportEncrypted(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){"string"==typeof e&&(e=BufferUtils.fromAscii(e));"string"==typeof t&&(t=BufferUtils.fromAscii(t));const n=new SerialBuffer(r.encryptedExportedSize);n.write(yield r._keyPair.exportEncrypted(e,t));n.writeUint8(r._minSignatures);n.writeUint8(r._publicKeys.length);for(const e of r._publicKeys)e.serialize(n);return n})()}get encryptedExportedSize(){return this._keyPair.encryptedSize+1+1+this._publicKeys.reduce((e,t)=>e+t.serializedSize,0)}get exportedSize(){return this._keyPair.serializedSize+1+1+this._publicKeys.reduce((e,t)=>e+t.serializedSize,0)}createTransaction(e,t,r,n){return new ExtendedTransaction(this._address,Account.Type.BASIC,e,Account.Type.BASIC,t,r,n,Transaction.Flag.NONE,new Uint8Array(0))}createCommitment(){return CommitmentPair.generate()}signTransaction(e,t,r,n){(t=t.slice()).sort((e,t)=>e.compare(t));return PartialSignature.create(this._keyPair.privateKey,this._keyPair.publicKey,t,n,r,e.serializeContent())}completeTransaction(e,t,r,n){if(n.length!==this._minSignatures)throw"Not enough signatures to complete this transaction";const s=Signature.fromPartialSignatures(r,n),i=SignatureProof.multiSig(t,this._publicKeys,s);e.proof=i.serialize();return e}get minSignatures(){return this._minSignatures}get publicKeys(){return this._publicKeys}}Class.register(MultiSigWallet);class WalletStore{constructor(e="wallet"){this._jdb=new JDB.JungleDB(e,WalletStore.VERSION);this._walletStore=null;this._multiSigStore=null;return this._init()}_init(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){e._walletStore=e._jdb.createObjectStore(WalletStore.WALLET_DATABASE,new WalletStoreCodec);e._multiSigStore=e._jdb.createObjectStore(WalletStore.MULTISIG_WALLET_DATABASE,new WalletStoreCodec);yield e._jdb.connect();return e})()}hasDefault(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){return!!(yield t._walletStore.get("default"))})()}getDefault(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=yield t._walletStore.get("default");if(!r){const e=yield Wallet.generate();yield t.put(e);yield t.setDefault(e.address);return e}const n=new Address(r);return t.get(n,e)})()}setDefault(e){const t=e.serialize();return this._walletStore.put("default",t)}get(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=e.toBase64(),s=yield r._walletStore.get(n);return t?Wallet.loadEncrypted(s,t):Wallet.loadPlain(s)})()}put(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=e.address.toBase64();let i=null;i=t?yield e.exportEncrypted(t,r):e.exportPlain();return n._walletStore.put(s,i)})()}remove(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){const r=e.toBase64(),n=t._walletStore.transaction();yield n.remove(r);let s=yield t._walletStore.get("default");if(s){s=new Address(s);e.equals(s)&&(yield n.remove("default"))}return n.commit()})()}list(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield e._walletStore.keys();return Array.from(t).filter(function(e){return"default"!==e}).map(function(e){return Address.fromBase64(e)})})()}getMultiSig(e,t){var r=this;return(0,_asyncToGenerator3["default"])(function*(){const n=e.toBase64(),s=yield r._multiSigStore.get(n);return t?MultiSigWallet.loadEncrypted(s,t):MultiSigWallet.loadPlain(s)})()}putMultiSig(e,t,r){var n=this;return(0,_asyncToGenerator3["default"])(function*(){const s=e.address.toBase64();let i=null;i=t?yield e.exportEncrypted(t,r):e.exportPlain();return n._multiSigStore.put(s,i)})()}removeMultiSig(e){const t=e.toBase64();return this._multiSigStore.remove(t)}listMultiSig(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){const t=yield e._multiSigStore.keys();return Array.from(t).map(function(e){return Address.fromBase64(e)})})()}close(){return this._jdb.close()}}Class.register(WalletStore);WalletStore._instance=null;WalletStore.VERSION=1;WalletStore.WALLET_DATABASE="wallets";WalletStore.MULTISIG_WALLET_DATABASE="multisig-wallets";class WalletStoreCodec{encode(e){return e}decode(e,t){return new Uint8Array(e)}get valueEncoding(){return"binary"}}class IWorker{static createProxy(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){return new(IWorker.Proxy(e))(r,t)})()}static startWorkerForProxy(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){if(IWorker._workersSupported){r||(r=`${Nimiq._path}worker.js`);return IWorker.createProxy(e,t,new Worker(window.URL.createObjectURL(new Blob([`Nimiq = {_path: '${Nimiq._path}'}; importScripts('${r.replace(/'/g,"")}');`]))))}yield IWorker._workerImplementation[e.name].init(t);return IWorker._workerImplementation[e.name]})()}static startWorkerPoolForProxy(e,t,r,n){return(0,_asyncToGenerator3["default"])(function*(){return new(IWorker.Pool(e))(function(t){return IWorker.startWorkerForProxy(e,t,n)},t,r).start()})()}static stubBaseOnMessage(e){return(0,_asyncToGenerator3["default"])(function*(){try{if("init"===e.data.command)if(IWorker._workerImplementation[e.data.args[0]]){const t=yield IWorker._workerImplementation[e.data.args[0]].init(e.data.args[1]);self.postMessage({status:"OK",result:t,id:e.data.id})}else self.postMessage({status:"error",result:"Unknown worker!",id:e.data.id});else self.postMessage({status:"error",result:"Worker not yet initialized!",id:e.data.id})}catch(t){self.postMessage({status:"error",result:t,id:e.data.id})}})()}static get _workersSupported(){return"undefined"!=typeof Worker}static get areWorkersAsync(){return IWorker._workersSupported}static get _insideWebWorker(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}static get _global(){return"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:null}static prepareForWorkerUse(e,t){IWorker._insideWebWorker&&(self.onmessage=IWorker.stubBaseOnMessage);IWorker._workerImplementation=IWorker._workerImplementation||{};IWorker._workerImplementation[e.name]=t}static fireModuleLoaded(e="Module"){if("function"==typeof IWorker._moduleLoadedCallbacks[e]){IWorker._moduleLoadedCallbacks[e]();IWorker._moduleLoadedCallbacks[e]=null}}static _loadBrowserScript(e,t){const r=document.getElementsByTagName("head")[0],n=document.createElement("script");n.type="text/javascript";n.src=e;const s=()=>window.setTimeout(t,100);n.onreadystatechange=s;n.onload=s;r.appendChild(n)}static Proxy(e){const t=class extends e{constructor(t,r){super();this._name=r;this._messageId=0;this._worker=t;this._worker.onmessage=this._receive.bind(this);this._waiting=new Map;return this._invoke("init",[e.name,r]).then(()=>this)}_receive(e){const t=this._waiting.get(e.data.id);if(t){this._waiting["delete"](e.data.id);"OK"===e.data.status?t.resolve(e.data.result):"error"===e.data.status&&t.error(e.data.result)}else Log.w(WorkerProxy,"Unknown reply",e)}importScript(e){return this._invoke("importScript",[e])}importWasm(e,t="Module"){return this._invoke("importWasm",[e,t])}_invoke(e,t=[]){return new Promise((r,n)=>{const s={command:e,args:t,id:this._messageId++};this._waiting.set(s.id,{resolve:r,error:n});this._worker.postMessage(s)})}destroy(){return this._invoke("destroy")}};for(const r of Object.getOwnPropertyNames(e.prototype))"function"==typeof e.prototype[r]&&"constructor"!==r&&(t.prototype[r]=function(...e){return this._invoke(r,e)});return t}static Stub(e){const t=class extends e{constructor(){super()}_result(e,t,r){self.postMessage({status:t,result:r,id:e.data.id})}_onmessage(e){try{const r=this._invoke(e.data.command,e.data.args);r instanceof Promise?r.then(t=>{this._result(e,"OK",t)}):this._result(e,"OK",r)}catch(t){this._result(e,"error",t.message||t)}}importScript(e,t="Module"){if(t&&IWorker._global[t]&&IWorker._global[t].asm)return!1;"undefined"!=typeof Nimiq&&Nimiq._path&&(e=`${Nimiq._path}${e}`);"string"==typeof __dirname&&-1===e.indexOf("/")&&(e=`${__dirname}/${e}`);const r=IWorker._global[t]||{};return new Promise((n=(0,_asyncToGenerator3["default"])(function*(n,s){if(t)switch(typeof r.preRun){case"undefined":r.preRun=function(){return n(!0)};break;case"function":r.preRun=[r,function(){return n(!0)}];break;case"object":r.preRun.push(function(){return n(!0)})}if("function"==typeof importScripts){yield new Promise(function(r){IWorker._moduleLoadedCallbacks[t]=r;importScripts(e)});IWorker._global[t]=IWorker._global[t](r);t||n(!0)}else if("object"==typeof window){yield new Promise(function(t){IWorker._loadBrowserScript(e,t)});IWorker._global[t]=IWorker._global[t](r);t||n(!0)}else if("function"==typeof require){IWorker._global[t]=require(e)(r);t||n(!0)}else s("No way to load scripts.")}),function(e,t){return n.apply(this,arguments)}));var n}importWasm(e,t="Module"){"undefined"!=typeof Nimiq&&Nimiq._path&&(e=`${Nimiq._path}${e}`);"string"==typeof __dirname&&-1===e.indexOf("/")&&(e=`${__dirname}/${e}`);if(!IWorker._global.WebAssembly){Log.w(IWorker,"No support for WebAssembly available.");return Promise.resolve(!1)}return new Promise(r=>{try{if(PlatformUtils.isNodeJs()){const n=function(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;++r)t[r]=e[r];return t};require("fs").readFile(e,(s,i)=>{if(s){Log.w(IWorker,`Failed to access WebAssembly module ${e}: ${s}`);r(!1)}else{IWorker._global[t]=IWorker._global[t]||{};IWorker._global[t].wasmBinary=n(i);r(!0)}})}else{const n=new XMLHttpRequest;n.open("GET",e,!0);n.responseType="arraybuffer";n.onload=function(){IWorker._global[t]=IWorker._global[t]||{};IWorker._global[t].wasmBinary=n.response;r(!0)};n.onerror=function(){Log.w(IWorker,`Failed to access WebAssembly module ${e}`);r(!1)};n.send(null)}}catch(n){Log.w(IWorker,`Failed to access WebAssembly module ${e}`);r(!1)}})}init(e){this._name=e;if(IWorker._insideWebWorker){self.name=e;self.onmessage=(e=>this._onmessage(e))}}_invoke(e,t){return this[e].apply(this,t)}destroy(){IWorker._insideWebWorker&&self.close()}};for(const r of Object.getOwnPropertyNames(e.prototype))"function"==typeof e.prototype[r]&&"constructor"!==r&&(t.prototype[r]=function(){throw`Not implemented in IWorker Stub: ${r}`});return t}static Pool(e){const t=class extends e{constructor(e,t="pool",r=1){super();this._proxyInitializer=e;this._name=t;this._poolSize=r;this._workers=[];this._freeWorkers=[];this._waitingCalls=[]}start(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){yield e._updateToSize();return e})()}get poolSize(){return this._poolSize}set poolSize(e){this._poolSize=e;this._updateToSize()["catch"](Log.w.tag(IWorker))}destroy(){this._poolSize=0;return this._updateToSize()}_invoke(e,t){return IWorker._workersSupported?new Promise((r,n)=>{this._waitingCalls.push({name:e,args:t,resolve:r,error:n});const s=this._freeWorkers.shift();s&&this._step(s)["catch"](Log.w.tag(IWorker))}):this._workers[0][e].apply(this._workers[0],t)}_step(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r=t._waitingCalls.shift();for(;r;){try{r.resolve(yield e[r.name].apply(e,r.args))}catch(n){r.error(n)}if(-1===t._workers.indexOf(e)){e.destroy();return}r=t._waitingCalls.shift()}t._freeWorkers.push(e)})()}_updateToSize(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){if("undefined"==typeof Worker&&e._poolSize>1){Log.d(IWorker,"Pool of size larger than 1 requires WebWorker support.");e._poolSize=1}const t=[];for(;e._workers.length+t.length<e._poolSize;)t.push(e._proxyInitializer(`${e._name}#${e._workers.length+t.length}`));const r=yield Promise.all(t);for(const n of r){e._workers.push(n);e._step(n)["catch"](Log.w.tag(IWorker))}for(;e._workers.length>e._poolSize;){const t=e._freeWorkers.shift()||e._workers.pop(),r=e._workers.indexOf(t);if(r>=0){e._workers.splice(r,1);t.destroy()}}return e})()}};for(const r of Object.getOwnPropertyNames(e.prototype))"function"==typeof e.prototype[r]&&"constructor"!==r&&(t.prototype[r]=function(...e){return this._invoke(r,e)});return t}}IWorker._moduleLoadedCallbacks={};IWorker._workerImplementation={};Class.register(IWorker);class CryptoWorker{computeBlake2b(e){return(0,_asyncToGenerator3["default"])(function*(){})()}computeArgon2d(e){return(0,_asyncToGenerator3["default"])(function*(){})()}computeArgon2dBatch(e){return(0,_asyncToGenerator3["default"])(function*(){})()}computeSha256(e){return(0,_asyncToGenerator3["default"])(function*(){})()}kdf(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){})()}publicKeyDerive(e){return(0,_asyncToGenerator3["default"])(function*(){})()}commitmentCreate(e){return(0,_asyncToGenerator3["default"])(function*(){})()}scalarsAdd(e,t){return(0,_asyncToGenerator3["default"])(function*(){})()}commitmentsAggregate(e){return(0,_asyncToGenerator3["default"])(function*(){})()}publicKeysHash(e){return(0,_asyncToGenerator3["default"])(function*(){})()}publicKeyDelinearize(e,t){return(0,_asyncToGenerator3["default"])(function*(){})()}publicKeysDelinearizeAndAggregate(e,t){return(0,_asyncToGenerator3["default"])(function*(){})()}privateKeyDelinearize(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){})()}delinearizedPartialSignatureCreate(e,t,r,n,s,i){return(0,_asyncToGenerator3["default"])(function*(){})()}signatureCreate(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){})()}signatureVerify(e,t,r){return(0,_asyncToGenerator3["default"])(function*(){})()}blockVerify(e,t,r,n){return(0,_asyncToGenerator3["default"])(function*(){})()}}CryptoWorker.ARGON2_HASH_SIZE=32;CryptoWorker.BLAKE2_HASH_SIZE=32;CryptoWorker.SHA256_HASH_SIZE=32;CryptoWorker.PUBLIC_KEY_SIZE=32;CryptoWorker.PRIVATE_KEY_SIZE=32;CryptoWorker.MULTISIG_RANDOMNESS_SIZE=32;CryptoWorker.SIGNATURE_SIZE=64;CryptoWorker.PARTIAL_SIGNATURE_SIZE=32;CryptoWorker.SIGNATURE_HASH_SIZE=64;Class.register(CryptoWorker);class CryptoWorkerImpl extends(IWorker.Stub(CryptoWorker)){constructor(){super();this._superInit=super.init}init(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){if(IWorker._insideWebWorker){Crypto._workerSync=t;Crypto._workerAsync=t}yield t._superInit.call(t,e);(yield t.importWasm("worker-wasm.wasm"))?yield t.importScript("worker-wasm.js"):yield t.importScript("worker-js.js");const r=Module._get_static_memory_start(),n=Module._get_static_memory_size();if(n<CryptoWorker.PUBLIC_KEY_SIZE+CryptoWorker.PRIVATE_KEY_SIZE+CryptoWorker.SIGNATURE_SIZE)throw Error("Static memory too small");let s=r;t._pubKeyPointer=s;t._pubKeyBuffer=new Uint8Array(Module.HEAP8.buffer,s,CryptoWorker.PUBLIC_KEY_SIZE);s+=CryptoWorker.PUBLIC_KEY_SIZE;t._privKeyPointer=s;t._privKeyBuffer=new Uint8Array(Module.HEAP8.buffer,s,CryptoWorker.PRIVATE_KEY_SIZE);s+=CryptoWorker.PRIVATE_KEY_SIZE;t._signaturePointer=s;t._signatureBuffer=new Uint8Array(Module.HEAP8.buffer,s,CryptoWorker.SIGNATURE_SIZE);s+=CryptoWorker.SIGNATURE_SIZE;t._messagePointer=s;t._messageBuffer=new Uint8Array(Module.HEAP8.buffer,s,r+n-s)})()}computeBlake2b(e){let t;try{t=Module.stackSave();const n=Module.stackAlloc(CryptoWorker.BLAKE2_HASH_SIZE),s=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,s,e.length).set(e);const i=Module._nimiq_blake2(n,s,e.length);if(0!==i)throw i;const o=new Uint8Array(CryptoWorker.BLAKE2_HASH_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,n,CryptoWorker.BLAKE2_HASH_SIZE));return o}catch(r){Log.w(CryptoWorkerImpl,r);throw r}finally{t!==undefined&&Module.stackRestore(t)}}computeArgon2d(e){let t;try{t=Module.stackSave();const n=Module.stackAlloc(CryptoWorker.ARGON2_HASH_SIZE),s=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,s,e.length).set(e);const i=Module._nimiq_argon2(n,s,e.length,512);if(0!==i)throw i;const o=new Uint8Array(CryptoWorker.ARGON2_HASH_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,n,CryptoWorker.ARGON2_HASH_SIZE));return o}catch(r){Log.w(CryptoWorkerImpl,r);throw r}finally{t!==undefined&&Module.stackRestore(t)}}computeArgon2dBatch(e){const t=[];let r;try{r=Module.stackSave();const s=Module.stackAlloc(CryptoWorker.ARGON2_HASH_SIZE),i=Module.stackSave();for(const r of e){Module.stackRestore(i);const e=Module.stackAlloc(r.length);new Uint8Array(Module.HEAPU8.buffer,e,r.length).set(r);const n=Module._nimiq_argon2(s,e,r.length,512);if(0!==n)throw n;const o=new Uint8Array(CryptoWorker.ARGON2_HASH_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,s,CryptoWorker.ARGON2_HASH_SIZE));t.push(o)}return t}catch(n){Log.w(CryptoWorkerImpl,n);throw n}finally{r!==undefined&&Module.stackRestore(r)}}computeSha256(e){let t;try{t=Module.stackSave();const n=Module.stackAlloc(CryptoWorker.SHA256_HASH_SIZE),s=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,s,e.length).set(e);Module._nimiq_sha256(n,s,e.length);const i=new Uint8Array(CryptoWorker.SHA256_HASH_SIZE);i.set(new Uint8Array(Module.HEAPU8.buffer,n,CryptoWorker.SHA256_HASH_SIZE));return i}catch(r){Log.w(CryptoWorkerImpl,r);throw r}finally{t!==undefined&&Module.stackRestore(t)}}kdf(e,t,r){let n;try{n=Module.stackSave();const i=Module.stackAlloc(CryptoWorker.ARGON2_HASH_SIZE),o=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,o,e.length).set(e);const a=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,a,t.length).set(t);const c=Module._nimiq_kdf(i,o,e.length,a,t.length,512,r);if(0!==c)throw c;const l=new Uint8Array(CryptoWorker.ARGON2_HASH_SIZE);l.set(new Uint8Array(Module.HEAPU8.buffer,i,CryptoWorker.ARGON2_HASH_SIZE));return l}catch(s){Log.w(CryptoWorkerImpl,s);throw s}finally{n!==undefined&&Module.stackRestore(n)}}publicKeyDerive(e){const t=new Uint8Array(CryptoWorker.PUBLIC_KEY_SIZE);if(e.byteLength!==CryptoWorker.PRIVATE_KEY_SIZE)throw Error("Wrong buffer size.");this._privKeyBuffer.set(e);Module._ed25519_public_key_derive(this._pubKeyPointer,this._privKeyPointer);this._privKeyBuffer.fill(0);t.set(this._pubKeyBuffer);return t}commitmentCreate(e){let t;try{t=Module.stackSave();const n=Module.stackAlloc(CryptoWorker.PUBLIC_KEY_SIZE),s=Module.stackAlloc(CryptoWorker.PRIVATE_KEY_SIZE),i=Module.stackAlloc(e.length);new Uint8Array(Module.HEAPU8.buffer,i,e.length).set(e);const o=Module._ed25519_create_commitment(s,n,i);if(1!==o)throw new Error(`Secret must not be 0 or 1: ${o}`);const a=new Uint8Array(CryptoWorker.PUBLIC_KEY_SIZE),c=new Uint8Array(CryptoWorker.PRIVATE_KEY_SIZE);a.set(new Uint8Array(Module.HEAPU8.buffer,n,CryptoWorker.PUBLIC_KEY_SIZE));c.set(new Uint8Array(Module.HEAPU8.buffer,s,CryptoWorker.PRIVATE_KEY_SIZE));return{commitment:a,secret:c}}catch(r){Log.w(CryptoWorkerImpl,r);throw r}finally{t!==undefined&&Module.stackRestore(t)}}scalarsAdd(e,t){if(e.byteLength!==CryptoWorker.PARTIAL_SIGNATURE_SIZE||t.byteLength!==CryptoWorker.PARTIAL_SIGNATURE_SIZE)throw Error("Wrong buffer size.");let r;try{r=Module.stackSave();const s=Module.stackAlloc(CryptoWorker.PARTIAL_SIGNATURE_SIZE),i=Module.stackAlloc(e.length),o=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,i,e.length).set(e);new Uint8Array(Module.HEAPU8.buffer,o,t.length).set(t);Module._ed25519_add_scalars(s,i,o);const a=new Uint8Array(CryptoWorker.PARTIAL_SIGNATURE_SIZE);a.set(new Uint8Array(Module.HEAPU8.buffer,s,CryptoWorker.PARTIAL_SIGNATURE_SIZE));return a}catch(n){Log.w(CryptoWorkerImpl,n);throw n}finally{r!==undefined&&Module.stackRestore(r)}}commitmentsAggregate(e){if(e.some(e=>e.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE))throw Error("Wrong buffer size.");const t=new Uint8Array(e.length*CryptoWorker.PUBLIC_KEY_SIZE);for(let s=0;s<e.length;++s)t.set(e[s],s*CryptoWorker.PUBLIC_KEY_SIZE);let r;try{r=Module.stackSave();const s=Module.stackAlloc(CryptoWorker.PUBLIC_KEY_SIZE),i=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,i,t.length).set(t);Module._ed25519_aggregate_commitments(s,i,e.length);const o=new Uint8Array(CryptoWorker.PUBLIC_KEY_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,s,CryptoWorker.PUBLIC_KEY_SIZE));return o}catch(n){Log.w(CryptoWorkerImpl,n);throw n}finally{r!==undefined&&Module.stackRestore(r)}}publicKeysHash(e){if(e.some(e=>e.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE))throw Error("Wrong buffer size.");const t=new Uint8Array(e.length*CryptoWorker.PUBLIC_KEY_SIZE);for(let s=0;s<e.length;++s)t.set(e[s],s*CryptoWorker.PUBLIC_KEY_SIZE);let r;try{r=Module.stackSave();const s=Module.stackAlloc(CryptoWorker.SIGNATURE_HASH_SIZE),i=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,i,t.length).set(t);Module._ed25519_hash_public_keys(s,i,e.length);const o=new Uint8Array(CryptoWorker.SIGNATURE_HASH_SIZE);o.set(new Uint8Array(Module.HEAPU8.buffer,s,CryptoWorker.SIGNATURE_HASH_SIZE));return o}catch(n){Log.w(CryptoWorkerImpl,n);throw n}finally{r!==undefined&&Module.stackRestore(r)}}publicKeyDelinearize(e,t){if(e.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE||t.byteLength!==CryptoWorker.SIGNATURE_HASH_SIZE)throw Error("Wrong buffer size.");let r;try{r=Module.stackSave();const s=Module.stackAlloc(CryptoWorker.PUBLIC_KEY_SIZE),i=Module.stackAlloc(e.length),o=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,i,e.length).set(e);new Uint8Array(Module.HEAPU8.buffer,o,t.length).set(t);Module._ed25519_delinearize_public_key(s,o,i);const a=new Uint8Array(CryptoWorker.PUBLIC_KEY_SIZE);a.set(new Uint8Array(Module.HEAPU8.buffer,s,CryptoWorker.PUBLIC_KEY_SIZE));return a}catch(n){Log.w(CryptoWorkerImpl,n);throw n}finally{r!==undefined&&Module.stackRestore(r)}}publicKeysDelinearizeAndAggregate(e,t){if(e.some(e=>e.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE)||t.byteLength!==CryptoWorker.SIGNATURE_HASH_SIZE)throw Error("Wrong buffer size.");const r=new Uint8Array(e.length*CryptoWorker.PUBLIC_KEY_SIZE);for(let i=0;i<e.length;++i)r.set(e[i],i*CryptoWorker.PUBLIC_KEY_SIZE);let n;try{n=Module.stackSave();const i=Module.stackAlloc(CryptoWorker.PUBLIC_KEY_SIZE),o=Module.stackAlloc(r.length),a=Module.stackAlloc(t.length);new Uint8Array(Module.HEAPU8.buffer,o,r.length).set(r);new Uint8Array(Module.HEAPU8.buffer,a,t.length).set(t);Module._ed25519_aggregate_delinearized_public_keys(i,a,o,e.length);const c=new Uint8Array(CryptoWorker.PUBLIC_KEY_SIZE);c.set(new Uint8Array(Module.HEAPU8.buffer,i,CryptoWorker.PUBLIC_KEY_SIZE));return c}catch(s){Log.w(CryptoWorkerImpl,s);throw s}finally{n!==undefined&&Module.stackRestore(n)}}privateKeyDelinearize(e,t,r){if(e.byteLength!==CryptoWorker.PRIVATE_KEY_SIZE||t.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE||r.byteLength!==CryptoWorker.SIGNATURE_HASH_SIZE)throw Error("Wrong buffer size.");let n;try{n=Module.stackSave();const i=Module.stackAlloc(CryptoWorker.PUBLIC_KEY_SIZE),o=Module.stackAlloc(e.length),a=Module.stackAlloc(t.length),c=Module.stackAlloc(r.length);new Uint8Array(Module.HEAPU8.buffer,o,e.length).set(e);new Uint8Array(Module.HEAPU8.buffer,a,t.length).set(t);new Uint8Array(Module.HEAPU8.buffer,c,r.length).set(r);Module._ed25519_derive_delinearized_private_key(i,c,a,o);const l=new Uint8Array(CryptoWorker.PRIVATE_KEY_SIZE);l.set(new Uint8Array(Module.HEAPU8.buffer,i,CryptoWorker.PRIVATE_KEY_SIZE));return l}catch(s){Log.w(CryptoWorkerImpl,s);throw s}finally{n!==undefined&&Module.stackRestore(n)}}delinearizedPartialSignatureCreate(e,t,r,n,s,i){if(e.some(e=>e.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE)||t.byteLength!==CryptoWorker.PRIVATE_KEY_SIZE||r.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE||n.byteLength!==CryptoWorker.PRIVATE_KEY_SIZE||s.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE)throw Error("Wrong buffer size.");const o=new Uint8Array(e.length*CryptoWorker.PUBLIC_KEY_SIZE);for(let l=0;l<e.length;++l)o.set(e[l],l*CryptoWorker.PUBLIC_KEY_SIZE);let a;try{a=Module.stackSave();const l=Module.stackAlloc(CryptoWorker.PARTIAL_SIGNATURE_SIZE),h=Module.stackAlloc(o.length),u=Module.stackAlloc(t.length),d=Module.stackAlloc(r.length),_=Module.stackAlloc(n.length),f=Module.stackAlloc(s.length),g=Module.stackAlloc(i.length);new Uint8Array(Module.HEAPU8.buffer,h,o.length).set(o);new Uint8Array(Module.HEAPU8.buffer,u,t.length).set(t);new Uint8Array(Module.HEAPU8.buffer,d,r.length).set(r);new Uint8Array(Module.HEAPU8.buffer,_,n.length).set(n);new Uint8Array(Module.HEAPU8.buffer,f,s.length).set(s);new Uint8Array(Module.HEAPU8.buffer,g,i.length).set(i);Module._ed25519_delinearized_partial_sign(l,g,i.length,f,_,h,e.length,d,u);const p=new Uint8Array(CryptoWorker.PARTIAL_SIGNATURE_SIZE);p.set(new Uint8Array(Module.HEAPU8.buffer,l,CryptoWorker.PARTIAL_SIGNATURE_SIZE));return p}catch(c){Log.w(CryptoWorkerImpl,c);throw c}finally{a!==undefined&&Module.stackRestore(a)}}signatureCreate(e,t,r){const n=new Uint8Array(CryptoWorker.SIGNATURE_SIZE),s=r.byteLength;if(s>this._messageBuffer.byteLength||t.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE||e.byteLength!==CryptoWorker.PRIVATE_KEY_SIZE)throw Error("Wrong buffer size.");this._messageBuffer.set(r);this._pubKeyBuffer.set(t);this._privKeyBuffer.set(e);Module._ed25519_sign(this._signaturePointer,this._messagePointer,s,this._pubKeyPointer,this._privKeyPointer);this._privKeyBuffer.fill(0);n.set(this._signatureBuffer);return n}signatureVerify(e,t,r){const n=t.byteLength;if(r.byteLength!==CryptoWorker.SIGNATURE_SIZE||t.byteLength>this._messageBuffer.byteLength||e.byteLength!==CryptoWorker.PUBLIC_KEY_SIZE)throw Error("Wrong buffer size.");this._signatureBuffer.set(r);this._messageBuffer.set(t);this._pubKeyBuffer.set(e);return!!Module._ed25519_verify(this._signaturePointer,this._messagePointer,n,this._pubKeyPointer)}blockVerify(e,t,r,n){return(0,_asyncToGenerator3["default"])(function*(){Block.GENESIS||(Block.GENESIS={HASH:Hash.unserialize(new SerialBuffer(n))});const s=Block.unserialize(new SerialBuffer(e));for(let e=0;e<t.length;e++)s.body.transactions[e]._valid=t[e];const i=yield s._verify(r),o=yield s.header.pow(),a=s.interlink.hash(),c=s.body.hash();return{valid:i,pow:o.serialize(),interlinkHash:a.serialize(),bodyHash:c.serialize()}})()}}IWorker.prepareForWorkerUse(CryptoWorker,new CryptoWorkerImpl);class MinerWorker{multiMine(e,t,r,n){return(0,_asyncToGenerator3["default"])(function*(){})()}}Class.register(MinerWorker);class MinerWorkerImpl extends(IWorker.Stub(MinerWorker)){constructor(){super();this._superInit=super.init}init(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){yield t._superInit.call(t,e);(yield t.importWasm("worker-wasm.wasm"))?yield t.importScript("worker-wasm.js"):yield t.importScript("worker-js.js")})()}multiMine(e,t,r,n){return(0,_asyncToGenerator3["default"])(function*(){const s=new Uint8Array(32);let i,o;try{i=Module._malloc(s.length);o=Module._malloc(e.length);Module.HEAPU8.set(e,o);const c=Module._nimiq_argon2_target(i,o,e.length,t,r,n,512);if(c===n)return!1;s.set(new Uint8Array(Module.HEAPU8.buffer,i,s.length));return{hash:s,nonce:c}}catch(a){Log.w(MinerWorkerImpl,a);throw a}finally{i!==undefined&&Module._free(i);o!==undefined&&Module._free(o)}})()}}IWorker.prepareForWorkerUse(MinerWorker,new MinerWorkerImpl);class MinerWorkerPool extends(IWorker.Pool(MinerWorker)){constructor(e=1){super(e=>IWorker.startWorkerForProxy(MinerWorker,e),"miner",e);this._miningEnabled=!1;this._activeNonces=[];this._block=null;this._noncesPerRun=256;this._observable=new Observable;this._shareCompact=Policy.BLOCK_TARGET_MAX;this._runsPerCycle=Infinity;this._cycleWait=100;this._superUpdateToSize=super._updateToSize;if(PlatformUtils.isNodeJs()){const e=require(`${__dirname}/nimiq_node`);this.multiMine=function(t,r,n,s){return new Promise((o,a)=>{e.nimiq_argon2_target_async((i=(0,_asyncToGenerator3["default"])(function*(e){try{if(e===s)o(!1);else{t.writePos-=4;t.writeUint32(e);const r=yield Crypto.argon2d(t);o({hash:r,nonce:e})}}catch(r){a(r)}}),function(e){return i.apply(this,arguments)}),t,r,n,s,512)});var i}}}get noncesPerRun(){return this._noncesPerRun}set noncesPerRun(e){this._noncesPerRun=e}get runsPerCycle(){return this._runsPerCycle}set runsPerCycle(e){this._runsPerCycle=e}get cycleWait(){return this._cycleWait}set cycleWait(e){this._cycleWait=e}on(e,t){this._observable.on(e,t)}off(e,t){this._observable.off(e,t)}startMiningOnBlock(e,t=e.nBits){var r=this;return(0,_asyncToGenerator3["default"])(function*(){r._block=e;r._shareCompact=t;if(r._miningEnabled)r._activeNonces=[{minNonce:0,maxNonce:0}];else{yield r._updateToSize();r._activeNonces=[];r._miningEnabled=!0;for(let e=0;e<r.poolSize;++e)r._startMiner()}})()}stop(){this._miningEnabled=!1}_updateToSize(){var e=this;return(0,_asyncToGenerator3["default"])(function*(){PlatformUtils.isNodeJs()||(yield e._superUpdateToSize.call(e));for(;e._miningEnabled&&e._activeNonces.length<e.poolSize;)e._startMiner()})()}_startMiner(){const e=0===this._activeNonces.length?0:Math.max.apply(null,this._activeNonces.map(e=>e.maxNonce)),t={minNonce:e,maxNonce:e+this._noncesPerRun};this._activeNonces.push(t);this._singleMiner(t)["catch"](e=>Log.e(MinerWorkerPool,e))}_singleMiner(e){var t=this;return(0,_asyncToGenerator3["default"])(function*(){let r=0;for(;t._miningEnabled&&(IWorker.areWorkersAsync||PlatformUtils.isNodeJs()||0===r)&&r<t._runsPerCycle;){r++;const n=t._block,s=yield t.multiMine(n.header.serialize(),t._shareCompact,e.minNonce,e.maxNonce);if(s){const e=new Hash(s.hash);t._observable.fire("share",{block:n,nonce:s.nonce,hash:e})}else t._observable.fire("no-share",{nonce:e.maxNonce});if(t._activeNonces.length>t.poolSize){t._activeNonces.splice(t._activeNonces.indexOf(e),1);return}{const r=Math.max.apply(null,t._activeNonces.map(function(e){return e.maxNonce})),n={minNonce:r,maxNonce:r+t._noncesPerRun};t._activeNonces.splice(t._activeNonces.indexOf(e),1,n);e=n}}t._miningEnabled&&setTimeout(function(){return t._singleMiner(e)},t._cycleWait)})()}}Class.register(MinerWorkerPool);e._loaded=!0;"function"==typeof e._onload&&e._onload()}(Nimiq);
//# sourceMappingURL=web-babel.js.map
